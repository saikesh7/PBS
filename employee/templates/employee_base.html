<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Employee Dashboard{% endblock %} - Points System</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
    <!-- DataTables CSS -->
    <link href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css" rel="stylesheet">
    <!-- Custom styles -->
    <link rel="stylesheet" href="{{ url_for('employee_dashboard.static', filename='employee.css') }}">
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@400;500;600&display=swap" rel="stylesheet">
    
    <style>
        /* Critical sidebar animations for mobile */
        @media (max-width: 992px) {
            .sidebar {
                transform: translateX(-100%);
                transition: transform 0.3s ease;
            }
            
            .sidebar.active {
                transform: translateX(0);
            }
            
            .sidebar-overlay {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background-color: rgba(0, 0, 0, 0.5);
                z-index: 999;
            }
            
            .sidebar-overlay.active {
                display: block;
            }
        }
        
        /* Sidebar toggle button styling */
        .sidebar-toggle {
            background: transparent;
            border: none;
            color: white;
            font-size: 1.25rem;
            cursor: pointer;
            padding: 0.25rem;
            margin-right: 1rem;
            transition: transform 0.3s ease;
        }
        
        .sidebar-toggle:hover {
            transform: scale(1.1);
        }
        
        /* Dashboard switcher styling */
        .dashboard-switcher-item {
            padding: 0.5rem 1rem;
            color: rgba(255, 255, 255, 0.8);
            text-decoration: none;
            display: flex;
            align-items: center;
            transition: all 0.3s ease;
            border-radius: 4px;
            margin: 0.25rem 0.5rem;
        }
        
        .dashboard-switcher-item:hover {
            background-color: rgba(255, 255, 255, 0.1);
            color: #fff;
        }
        
        .dashboard-switcher-item i {
            width: 20px;
            margin-right: 0.75rem;
            text-align: center;
        }
        
        /* Dashboard card styling */
        .dashboard-card {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            border: 1px solid #e0e0e0;
        }
        
        .dashboard-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        /* ‚úÖ REAL-TIME NOTIFICATION STYLES */
        .realtime-notification {
            position: fixed;
            top: 80px;
            right: 20px;
            z-index: 9999;
            min-width: 350px;
            max-width: 500px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            animation: slideInRight 0.4s ease-out;
            border-left: 4px solid;
        }
        
        .realtime-notification.alert-success {
            border-left-color: #28a745;
        }
        
        .realtime-notification.alert-info {
            border-left-color: #17a2b8;
        }
        
        .realtime-notification.alert-warning {
            border-left-color: #ffc107;
        }
        
        .realtime-notification.alert-danger {
            border-left-color: #dc3545;
        }
        
        @keyframes slideInRight {
            from { 
                transform: translateX(400px); 
                opacity: 0; 
            }
            to { 
                transform: translateX(0); 
                opacity: 1; 
            }
        }
        
        @keyframes slideOutRight {
            from { 
                transform: translateX(0); 
                opacity: 1; 
            }
            to { 
                transform: translateX(400px); 
                opacity: 0; 
            }
        }
        
        /* ‚úÖ NUMBER UPDATE ANIMATION */
        .number-update {
            animation: pulse 0.6s ease-in-out;
            color: #28a745 !important;
            font-weight: bold !important;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.15); }
        }
        
        
        
        /* ‚úÖ CONNECTION STATUS INDICATOR */
        .connection-status {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 9998;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
            display: flex;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }
        
        .connection-status.connected {
            background: #d4edda;
            color: #155724;
        }
        
        .connection-status.disconnected {
            background: #f8d7da;
            color: #721c24;
        }
        
        .connection-status .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 8px;
            animation: blink 1.5s infinite;
        }
        
        .connection-status.connected .status-dot {
            background: #28a745;
        }
        
        .connection-status.disconnected .status-dot {
            background: #dc3545;
        }
        
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }
    </style>
    
    {% block extra_css %}{% endblock %}
</head>

<body data-user-id="{{ user._id }}">
    <!-- ‚úÖ CONNECTION STATUS INDICATOR -->
    <div class="connection-status connected" id="connectionStatus" style="display: none;">
        <div class="status-dot"></div>
        <span id="connectionStatusText">Connected</span>
    </div>

    <!-- Topbar -->
    <div class="topbar">
        <div class="topbar-left">
            <button class="sidebar-toggle" id="sidebarToggle" type="button" aria-label="Toggle menu">
                <i class="fas fa-bars fa-lg"></i>
            </button>
            <div class="topbar-icon">
                <i class="fas fa-user-circle"></i>
            </div>
            <div class="topbar-info">
                <div class="topbar-title">{{ user.name }}</div>
                <div class="topbar-subtitle">
                    <span class="badge bg-light text-dark">{{ user.role }}</span>
                    {% if user.department %}
                    <span class="badge bg-secondary ms-1">{{ user.department }}</span>
                    {% endif %}
                    <!-- Show access badges -->
                    {% if session.get('dashboard_access') and session.get('dashboard_access')|length > 0 %}
                    <span class="badge bg-info ms-1" title="You have access to {{ session.get('dashboard_access')|length }} dashboard(s)">
                        <i class="fas fa-th-large"></i> {{ session.get('dashboard_access')|length }}
                    </span>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- Center Heading -->
        <div class="topbar-center">
            <h6 class="topbar-heading">
                <i class="fas fa-award me-2" style="color: gold;"></i>
                <span>POINTS BASED SYSTEM</span>
            </h6>
        </div>
        
        <!-- Right Section -->
        <div class="topbar-right">
            <div class="profile-pic-img" id="profileTrigger">
                {% if user_profile_pic_url %}
                <img src="{{ user_profile_pic_url }}" alt="{{ user.name }}'s Profile Picture" />
                {% else %}
                <div class="profile-pic-letter">{{ user.name[0]|upper }}</div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Sidebar Overlay -->
    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="d-flex flex-column align-items-center">
                <img src="https://www.prowesssoft.com/wp-content/uploads/2025/05/Prowess-white-logo.png" 
                     alt="PS Logo" class="sidebar-logo mb-1" style="max-height: 40px;">
                <div class="text-white" style="font-size: 12px; font-weight: 500;">PROWESS SOFT</div>
            </div>
        </div>
        
        <div class="sidebar-nav">
            <a href="{{ url_for('employee_dashboard.dashboard') }}" 
               class="sidebar-nav-item {% block nav_dashboard %}{% endblock %}">
                <div>
                    <i class="fas fa-tachometer-alt"></i>
                    <span>Dashboard</span>
                </div>
            </a>
            
            <a href="{{ url_for('employee_leaderboard.leaderboard') }}" 
               class="sidebar-nav-item {% block nav_leaderboard %}{% endblock %}">
                <div>
                    <i class="fas fa-trophy"></i>
                    <span>Leaderboard</span>
                </div>
            </a>
            
            <a href="{{ url_for('employee_raise_request.raise_request') }}" 
               class="sidebar-nav-item {% block nav_raise %}{% endblock %}">
                <div>
                    <i class="fas fa-plus-circle"></i>
                    <span>Raise Request</span>
                </div>
            </a>
            
            <a href="{{ url_for('employee_history.history') }}" 
               class="sidebar-nav-item {% block nav_history %}{% endblock %}">
                <div>
                    <i class="fas fa-history"></i>
                    <span>Request History</span>
                </div>
            </a>
            
            <a href="{{ url_for('employee_points_total.points_total') }}" 
               class="sidebar-nav-item {% block nav_points %}{% endblock %}">
                <div>
                    <i class="fas fa-chart-line"></i>
                    <span>Total Points History</span>
                </div>
            </a>
            
            <!-- Dashboard Switcher Based on dashboard_access -->
            {% if session.get('dashboard_access') and session.get('dashboard_access')|length > 0 %}
            <div class="sidebar-divider"></div>
            <div class="px-3 py-2">
                <small class="text-white-50 text-uppercase" style="font-size: 11px;">
                    <i class="fas fa-th-large me-1"></i> Switch Dashboard
                </small>
            </div>
            
            {% for dashboard in session.get('dashboard_access', []) %}
                {% if dashboard == 'pm' %}
                <a href="{{ url_for('pm.dashboard') }}" class="dashboard-switcher-item">
                    <i class="fas fa-project-diagram"></i>
                    <span>PM Dashboard</span>
                </a>
                {% elif dashboard == 'pmo' %}
                <a href="{{ url_for('pmo.dashboard') }}" class="dashboard-switcher-item">
                    <i class="fas fa-tasks"></i>
                    <span>PMO Dashboard</span>
                </a>
                {% elif dashboard == 'pm_arch' %}
                <a href="{{ url_for('pm_arch.dashboard') }}" class="dashboard-switcher-item">
                    <i class="fas fa-drafting-compass"></i>
                    <span>PM/Arch Dashboard</span>
                </a>
                {% elif dashboard == 'pmo_up' %}
                <a href="{{ url_for('pmo.updater_dashboard') }}" class="dashboard-switcher-item">
                <i class="fas fa-tasks"></i>
                <span>PMO Updater</span>
                </a>
                {% elif dashboard == 'pmo_va' %}
                <a href="{{ url_for('pmo.validator_dashboard') }}" class="dashboard-switcher-item">
                <i class="fas fa-clipboard-check"></i>
                <span>PMO Validator</span>
                </a>
                {% elif dashboard == 'ta_up' %}
                <a href="{{ url_for('ta.updater_dashboard') }}" class="dashboard-switcher-item">
                    <i class="fas fa-user-plus"></i>
                    <span>TA Updater</span>
                </a>
                {% elif dashboard == 'ta_va' %}
                <a href="{{ url_for('ta.validator_dashboard') }}" class="dashboard-switcher-item">
                    <i class="fas fa-user-check"></i>
                    <span>TA Validator</span>
                </a>
                {% elif dashboard == 'ld' %}
                <a href="{{ url_for('ld.dashboard') }}" class="dashboard-switcher-item">
                    <i class="fas fa-graduation-cap"></i>
                    <span>L&D Dashboard</span>
                </a>
                {% elif dashboard == 'ld_up' %}
                <a href="{{ url_for('ld.updater_dashboard') }}" class="dashboard-switcher-item">
                    <i class="fas fa-user-edit"></i>
                    <span>L&D Updater</span>
                </a>
                {% elif dashboard == 'ld_va' %}
                <a href="{{ url_for('ld.validator_dashboard') }}" class="dashboard-switcher-item">
                    <i class="fas fa-book-reader"></i>
                    <span>L&D Validator</span>
                </a>
                {% elif dashboard == 'marketing' %}
                <a href="{{ url_for('marketing_dashboard.dashboard') }}" class="dashboard-switcher-item">
                    <i class="fas fa-bullhorn"></i>
                    <span>Marketing Dashboard</span>
                </a>
                {% elif dashboard == 'presales' %}
                <a href="{{ url_for('presales.dashboard') }}" class="dashboard-switcher-item">
                    <i class="fas fa-handshake"></i>
                    <span>Pre-sales Dashboard</span>
                </a>
                {% elif dashboard == 'dp' %}
                <a href="{{ url_for('dp.dashboard') }}" class="dashboard-switcher-item">
                    <i class="fas fa-hands-helping"></i>
                    <span>DP Dashboard</span>
                </a>
                {% elif dashboard == 'central' %}
                <a href="{{ url_for('central.dashboard') }}" class="dashboard-switcher-item">
                    <i class="fas fa-building"></i>
                    <span>Central Dashboard</span>
                </a>
                {% elif dashboard == 'hr' %}
                <a href="{{ url_for('hr_analytics.pbs_analytics') }}" class="dashboard-switcher-item">
                    <i class="fas fa-chart-line"></i>
                    <span>HR Analytics</span>
                </a>
                {% elif dashboard == 'hr_va' %}
                <a href="{{ url_for('hr_roles.validator_dashboard') }}" class="dashboard-switcher-item">
                    <i class="fas fa-user-check"></i>
                    <span>HR Validator</span>
                </a>
                {% elif dashboard == 'hr_up' %}
                <a href="{{ url_for('hr_roles.updater_dashboard') }}" class="dashboard-switcher-item">
                    <i class="fas fa-user-edit"></i>
                    <span>HR Updater</span>
                </a>
                
                {% endif %}
            {% endfor %}
            {% endif %}
            
            <div class="sidebar-divider"></div>
            
            <a href="{{ url_for('auth.logout') }}" class="sidebar-nav-item">
                <div>
                    <i class="fas fa-sign-out-alt"></i>
                    <span>Logout</span>
                </div>
            </a>
        </div>
    </div>

    <!-- Main Content -->
    <div class="content-wrapper">
        <!-- Flash messages -->
        {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
        <div id="flashMessagesContainer">
            {% for category, message in messages %}
            <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert" data-auto-dismiss="true">
                {{ message|safe }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
            {% endfor %}
        </div>
        {% endif %}
        {% endwith %}

        <!-- Dashboard Access Cards (shown on main dashboard page) -->
        {% if request.endpoint == 'employee_dashboard.dashboard' and session.get('dashboard_access') and session.get('dashboard_access')|length > 0 %}
        <div class="dashboard-access-section mb-4">
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-th-large"></i> Your Dashboard Access
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        {% for dashboard in session.get('dashboard_access', []) %}
                        <div class="col-md-3 col-sm-6 mb-3">
                            <div class="card h-100 text-center dashboard-card">
                                <div class="card-body">
                                    {% if dashboard == 'pm' %}
                                        <i class="fas fa-project-diagram fa-3x text-primary mb-3"></i>
                                        <h6>PM Dashboard</h6>
                                        <p class="small text-muted">Project Management</p>
                                        <a href="{{ url_for('pm.dashboard') }}" class="btn btn-sm btn-primary">
                                            <i class="fas fa-arrow-right"></i> Open
                                        </a>
                                    {% elif dashboard == 'pmo' %}
                                        <i class="fas fa-tasks fa-3x text-success mb-3"></i>
                                        <h6>PMO Dashboard</h6>
                                        <p class="small text-muted">PMO Management</p>
                                        <a href="{{ url_for('pmo.dashboard') }}" class="btn btn-sm btn-success">
                                            <i class="fas fa-arrow-right"></i> Open
                                        </a>
                                    {% elif dashboard == 'pm_arch' %}
                                        <i class="fas fa-drafting-compass fa-3x text-warning mb-3"></i>
                                        <h6>PM/Arch Dashboard</h6>
                                        <p class="small text-muted">Architecture & PM</p>
                                        <a href="{{ url_for('pm_arch.dashboard') }}" class="btn btn-sm btn-warning">
                                            <i class="fas fa-arrow-right"></i> Open
                                        </a>
                                    {% elif dashboard == 'pmo_up' %}
                                        <i class="fas fa-tasks fa-3x text-success mb-3"></i>
                                        <h6>PMO Updater</h6>
                                        <p class="small text-muted">PMO - Updater Role</p>
                                        <a href="{{ url_for('pmo.updater_dashboard') }}" class="btn btn-sm btn-success">
                                        <i class="fas fa-arrow-right"></i> Open
                                        </a>
                                        {% elif dashboard == 'pmo_va' %}
                                        <i class="fas fa-clipboard-check fa-3x text-info mb-3"></i>
                                        <h6>PMO Validator</h6>
                                        <p class="small text-muted">PMO - Validator Role</p>
                                        <a href="{{ url_for('pmo.validator_dashboard') }}" class="btn btn-sm btn-info">
                                        <i class="fas fa-arrow-right"></i> Open
                                        </a>
                                    
                                    {% elif dashboard == 'ta_up' %}
                                        <i class="fas fa-user-plus fa-3x text-info mb-3"></i>
                                        <h6>TA Updater</h6>
                                        <p class="small text-muted">Talent Acquisition - Updater</p>
                                        <a href="{{ url_for('ta.updater_dashboard') }}" class="btn btn-sm btn-info">
                                            <i class="fas fa-arrow-right"></i> Open
                                        </a>
                                    {% elif dashboard == 'ta_va' %}
                                        <i class="fas fa-user-check fa-3x text-success mb-3"></i>
                                        <h6>TA Validator</h6>
                                        <p class="small text-muted">Talent Acquisition - Validator</p>
                                        <a href="{{ url_for('ta.validator_dashboard') }}" class="btn btn-sm btn-success">
                                            <i class="fas fa-arrow-right"></i> Open
                                        </a>
                                    {% elif dashboard == 'ld' %}
                                        <i class="fas fa-graduation-cap fa-3x text-secondary mb-3"></i>
                                        <h6>L&D Dashboard</h6>
                                        <p class="small text-muted">Learning & Development</p>
                                        <a href="{{ url_for('ld.dashboard') }}" class="btn btn-sm btn-secondary">
                                            <i class="fas fa-arrow-right"></i> Open
                                        </a>
                                    {% elif dashboard == 'ld_up' %}
                                        <i class="fas fa-chalkboard-teacher fa-3x text-info mb-3"></i>
                                        <h6>L&D Updater</h6>
                                        <p class="small text-muted">Learning & Development - Updater</p>
                                        <a href="{{ url_for('ld.updater_dashboard') }}" class="btn btn-sm btn-info">
                                            <i class="fas fa-arrow-right"></i> Open
                                        </a>
                                    {% elif dashboard == 'ld_va' %}
                                        <i class="fas fa-user-graduate fa-3x text-success mb-3"></i>
                                        <h6>L&D Validator</h6>
                                        <p class="small text-muted">Learning & Development - Validator</p>
                                        <a href="{{ url_for('ld.validator_dashboard') }}" class="btn btn-sm btn-success">
                                            <i class="fas fa-arrow-right"></i> Open
                                        </a>
                                    {% elif dashboard == 'dp' %}
                                        <i class="fas fa-hands-helping fa-3x text-primary mb-3"></i>
                                        <h6>DP Dashboard</h6>
                                        <p class="small text-muted">Delivery Partner</p>
                                        <a href="{{ url_for('dp.dashboard') }}" class="btn btn-sm btn-primary">
                                            <i class="fas fa-arrow-right"></i> Open
                                        </a>
                                    {% elif dashboard == 'marketing' %}
                                        <i class="fas fa-bullhorn fa-3x text-danger mb-3"></i>
                                        <h6>Marketing Dashboard</h6>
                                        <p class="small text-muted">Marketing Management</p>
                                        <a href="{{ url_for('marketing_dashboard.dashboard') }}" class="btn btn-sm btn-danger">
                                            <i class="fas fa-arrow-right"></i> Open
                                        </a>
                                    {% elif dashboard == 'presales' %}
                                        <i class="fas fa-handshake fa-3x text-dark mb-3"></i>
                                        <h6>Pre-sales Dashboard</h6>
                                        <p class="small text-muted">Pre-sales Management</p>
                                        <a href="{{ url_for('presales.dashboard') }}" class="btn btn-sm btn-dark">
                                            <i class="fas fa-arrow-right"></i> Open
                                        </a>
                                    {% elif dashboard == 'central' %}
                                        <i class="fas fa-building fa-3x text-primary mb-3"></i>
                                        <h6>Central Dashboard</h6>
                                        <p class="small text-muted">Central Management</p>
                                        <a href="{{ url_for('central.dashboard') }}" class="btn btn-sm btn-primary">
                                            <i class="fas fa-arrow-right"></i> Open
                                        </a>
                                    {% elif dashboard == 'hr' %}
                                        <i class="fas fa-chart-line fa-3x text-success mb-3"></i>
                                        <h6>HR Analytics</h6>
                                        <p class="small text-muted">HR Analytics & Reports</p>
                                        <a href="{{ url_for('hr_analytics.pbs_analytics') }}" class="btn btn-sm btn-success">
                                            <i class="fas fa-arrow-right"></i> Open
                                        </a>
                                    {% elif dashboard == 'hr_va' %}
                                        <i class="fas fa-user-check fa-3x text-info mb-3"></i>
                                        <h6>HR Validator</h6>
                                        <p class="small text-muted">HR - Validator Role</p>
                                        <a href="{{ url_for('hr_roles.validator_dashboard') }}" class="btn btn-sm btn-info">
                                            <i class="fas fa-arrow-right"></i> Open
                                        </a>
                                    {% elif dashboard == 'hr_up' %}
                                        <i class="fas fa-user-edit fa-3x text-warning mb-3"></i>
                                        <h6>HR Updater</h6>
                                        <p class="small text-muted">HR - Updater Role</p>
                                        <a href="{{ url_for('hr_roles.updater_dashboard') }}" class="btn btn-sm btn-warning">
                                            <i class="fas fa-arrow-right"></i> Open
                                        </a>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        {% block content %}{% endblock %}
    </div>

    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
    
    <!-- ‚úÖ SOCKET.IO -->
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    
    <!-- Original employee scripts -->
    <script src="{{ url_for('employee_dashboard.static', filename='employee.js') }}"></script>
    
    <!-- ‚úÖ REAL-TIME EMPLOYEE MANAGER -->
   <!-- ‚úÖ REAL-TIME EMPLOYEE MANAGER -->
<script>
    /**
     * ‚úÖ CENTRALIZED REAL-TIME MANAGER FOR EMPLOYEE DASHBOARD
     * Simple notification + page reload
     */
    (function() {
        'use strict';
        
        class EmployeeRealtimeManager {
            constructor() {
                this.socket = null;
                this.userId = null;
                this.connected = false;
                this.reconnectAttempts = 0;
                this.maxReconnectAttempts = 5;
            }
            
            init(userId) {
                if (!userId) {
                    console.error('‚ùå User ID required for real-time');
                    return;
                }
                
                this.userId = userId;
                this.connect();
            }
            
            connect() {
                this.socket = io({
                    transports: ['polling', 'websocket'],  // Try polling first for better browser compatibility
                    reconnection: true,
                    reconnectionAttempts: 10,  // Increased attempts
                    reconnectionDelay: 1000,
                    reconnectionDelayMax: 5000,
                    timeout: 20000,  // Increased timeout
                    upgrade: true,  // Allow upgrade from polling to websocket
                    rememberUpgrade: true,  // Remember successful upgrade
                    forceNew: false,
                    reconnectionAttempts: this.maxReconnectAttempts,
                    reconnectionDelay: 1000,
                    timeout: 10000
                });
                
                this.setupEventHandlers();
            }
            
            setupEventHandlers() {
                // Connection events
                this.socket.on('connect', () => {
                    this.connected = true;
                    this.reconnectAttempts = 0;
                    this.updateConnectionStatus(true);
                    this.registerUser();
                });
                
                this.socket.on('disconnect', (reason) => {
                    this.connected = false;
                    this.updateConnectionStatus(false);
                });
                
                this.socket.on('connect_error', (error) => {
                    this.reconnectAttempts++;
                });
                
                this.socket.on('connected', (data) => {
                    // User registered
                });
                
                // ‚úÖ REAL-TIME EVENT HANDLERS
                this.socket.on('points_awarded', (data) => this.handlePointsAwarded(data));
                this.socket.on('bonus_points_awarded', (data) => this.handleBonusPointsAwarded(data));
                this.socket.on('request_status_changed', (data) => this.handleRequestStatusChanged(data));
                this.socket.on('leaderboard_update', (data) => this.handleLeaderboardUpdate(data));
            }
            
            registerUser() {
                if (!this.socket || !this.connected) return;
                
                this.socket.emit('register_user', {
                    user_id: this.userId,
                    user_type: 'employee',
                    role: 'employee'
                });
            }
            
            // ===== EVENT HANDLERS =====
            
            handlePointsAwarded(data) {
                // Check if this is a utilization/billable category
                let message;
                if (data.utilization_percentage !== null && data.utilization_percentage !== undefined) {
                    // Display utilization percentage
                    message = `üéâ Your ${data.category_name} of ${data.utilization_percentage}% has been approved!`;
                } else {
                    // Display points
                    message = `üéâ You received ${data.points} points for ${data.category_name}!`;
                }
                
                this.showNotification(message, 'success');
                
                this.playSound('success');
                
                // ‚úÖ RELOAD AFTER 2 SECONDS
                setTimeout(() => {
                    window.location.reload();
                }, 2000);
            }
            
            handleBonusPointsAwarded(data) {
                // Display bonus points notification with special styling
                const message = `üéâ ${data.title || 'Bonus Points Awarded!'}<br>` +
                               `<strong>+${data.points} bonus points</strong> for ${data.milestones}<br>` +
                               `<small>Quarter: ${data.quarter} | Awarded by: ${data.awarded_by}</small>`;
                
                this.showNotification(message, 'success');
                this.playSound('success');
                
                // ‚úÖ RELOAD AFTER 3 SECONDS TO SHOW UPDATED POINTS
                setTimeout(() => {
                    window.location.reload();
                }, 3000);
            }
            
            handleRequestStatusChanged(data) {
                if (data.new_status === 'Approved') {
                    let message;
                    if (data.utilization_percentage !== null && data.utilization_percentage !== undefined) {
                        // Display utilization percentage
                        message = `‚úÖ Your ${data.category_name || 'request'} of ${data.utilization_percentage}% was approved!`;
                    } else {
                        // Display points
                        message = `‚úÖ Your request for ${data.points} points was approved!`;
                    }
                    this.showNotification(message, 'success');
                    this.playSound('success');
                } else if (data.new_status === 'Rejected') {
                    this.showNotification(
                        `‚ùå Your request was rejected`,
                        'danger'
                    );
                }
                
                // ‚úÖ RELOAD AFTER 2 SECONDS
                setTimeout(() => {
                    window.location.reload();
                }, 2000);
            }
            
            handleLeaderboardUpdate(data) {
                // ‚úÖ ONLY REFRESH IF ON LEADERBOARD PAGE
                if (window.location.pathname.includes('leaderboard')) {
                    setTimeout(() => {
                        window.location.reload();
                    }, 1500);
                }
            }
            
            // ===== UTILITY FUNCTIONS =====
            
            updateConnectionStatus(connected) {
                const statusEl = document.getElementById('connectionStatus');
                const statusText = document.getElementById('connectionStatusText');
                
                if (!statusEl || !statusText) return;
                
                statusEl.style.display = 'flex';
                
                if (connected) {
                    statusEl.className = 'connection-status connected';
                    statusText.textContent = 'Live Updates';
                    
                    // Hide after 3 seconds
                    setTimeout(() => {
                        statusEl.style.display = 'none';
                    }, 3000);
                } else {
                    statusEl.className = 'connection-status disconnected';
                    statusText.textContent = 'Reconnecting...';
                }
            }
            
            showNotification(message, type = 'info') {
                const notification = document.createElement('div');
                notification.className = `alert alert-${type} realtime-notification`;
                notification.innerHTML = `
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1"><strong>${message}</strong></div>
                        <button type="button" class="btn-close" onclick="this.parentElement.parentElement.remove()"></button>
                    </div>
                `;
                
                document.body.appendChild(notification);
                
                // Auto-remove after 5 seconds
                setTimeout(() => {
                    notification.style.animation = 'slideOutRight 0.3s ease-in';
                    setTimeout(() => notification.remove(), 300);
                }, 5000);
            }
            
            playSound(type) {
                try {
                    const audio = new Audio(`/static/sounds/${type === 'success' ? 'success.mp3' : 'notification.mp3'}`);
                    audio.volume = 0.5;
                    audio.play().catch(e => {});
                } catch (e) {
                    // Audio not available
                }
            }
            
            ping() {
                if (this.socket && this.connected) {
                    this.socket.emit('ping');
                }
            }
        }
        
        // ‚úÖ CREATE GLOBAL INSTANCE
        window.EmployeeRealtime = new EmployeeRealtimeManager();
        
    })();
</script>
    
    <!-- ‚úÖ AUTO-INITIALIZE REAL-TIME -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            {% if user and user._id %}
            const userId = '{{ user._id }}';
            
            // Initialize real-time manager
            window.EmployeeRealtime.init(userId);
            
            // Ping server every 30 seconds to keep connection alive
            setInterval(() => {
                window.EmployeeRealtime.ping();
            }, 30000);
            {% else %}
            console.warn('‚ö†Ô∏è User not authenticated, real-time disabled');
            {% endif %}
        });
    </script>
    
    <script>
        // Auto-dismiss flash messages after 3 seconds
        document.addEventListener('DOMContentLoaded', function() {
            const alerts = document.querySelectorAll('.alert[data-auto-dismiss="true"]');
            alerts.forEach(function(alert) {
                setTimeout(function() {
                    const bsAlert = new bootstrap.Alert(alert);
                    bsAlert.close();
                }, 3000); // 3 seconds
            });
        });
        
        // Sidebar toggle functionality
        document.addEventListener('DOMContentLoaded', function() {
            // Get DOM elements
            const sidebarToggle = document.getElementById('sidebarToggle');
            const sidebar = document.getElementById('sidebar');
            const sidebarOverlay = document.getElementById('sidebarOverlay');
            
            // Toggle sidebar function
            function toggleSidebar() {
                sidebar.classList.toggle('active');
                sidebarOverlay.classList.toggle('active');
            }
            
            // Event listeners
            if (sidebarToggle) {
                sidebarToggle.addEventListener('click', function(e) {
                    e.preventDefault();
                    toggleSidebar();
                });
            }
            
            // Close sidebar when clicking on overlay
            if (sidebarOverlay) {
                sidebarOverlay.addEventListener('click', function() {
                    sidebar.classList.remove('active');
                    sidebarOverlay.classList.remove('active');
                });
            }
            
            // Close sidebar when clicking a nav item (on mobile)
            document.querySelectorAll('.sidebar-nav-item, .dashboard-switcher-item').forEach(function(item) {
                item.addEventListener('click', function() {
                    if (window.innerWidth < 992) {
                        sidebar.classList.remove('active');
                        sidebarOverlay.classList.remove('active');
                    }
                });
            });
            
            // Ensure proper state on resize
            window.addEventListener('resize', function() {
                if (window.innerWidth >= 992) {
                    sidebar.classList.remove('active');
                    sidebarOverlay.classList.remove('active');
                }
            });
        });
    </script>
    
    {% block scripts %}{% endblock %}
</body>
</html>
