<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Central Leaderboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('central.static', filename='central.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@400;500;600&display=swap" rel="stylesheet">
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <img src="https://www.prowesssoft.com/wp-content/uploads/2023/06/Prowess_soft_logo1.png" alt="Prowess Soft Logo" class="sidebar-logo">
        </div>
        <div class="pt-2 pb-2 ps-3 pe-3 text-white">
            <div>Dashboard</div>
        </div>
        <div class="sidebar-nav">
            <a href="/central/dashboard" class="sidebar-nav-item">
                <div><i class="fas fa-users"></i><span>All Employees</span></div>
            </a>
            {% if user and user.dashboard_access %}
                {% set dashboard_list = user.dashboard_access if user.dashboard_access is iterable and user.dashboard_access is not string else [user.dashboard_access] %}
                {% if 'central' in dashboard_list %}
            <a href="/central/export-data" class="sidebar-nav-item">
                <div><i class="fas fa-file-export"></i><span>Export Data</span></div>
            </a>
                {% endif %}
            {% endif %}
            <div class="sidebar-divider"></div>
            <a href="/central/config" class="sidebar-nav-item">
                <div><i class="fas fa-cog"></i><span>Configure Rewards</span></div>
            </a>
            <a href="/central/leaderboard" class="sidebar-nav-item active">
                <div><i class="fas fa-trophy"></i><span>Leaderboard</span></div>
            </a>
           
            <a href="#" class="sidebar-nav-item" data-bs-toggle="modal" data-bs-target="#helpModal">
                <div><i class="fas fa-question-circle"></i><span>Help</span></div>
            </a>
            
            <div class="sidebar-divider"></div>
            
            <!-- Dashboard Switcher -->
            <div class="px-3 py-2">
                <small class="text-white-50 text-uppercase" style="font-size: 11px;">
                    <i class="fas fa-th-large me-1"></i> Switch Dashboard
                </small>
            </div>
            
            <!-- ALWAYS show Employee View as first option -->
            <a href="{{ url_for('employee_dashboard.dashboard') }}" class="sidebar-nav-item">
                <div><i class="fas fa-user"></i><span>Employee View</span></div>
            </a>
            
            <!-- Show other dashboards if user has access -->
            {% if user and user.dashboard_access %}
                {% set dashboard_list = user.dashboard_access if user.dashboard_access is iterable and user.dashboard_access is not string else [user.dashboard_access] %}
                
                {% for dashboard in dashboard_list %}
                    {# Don't show current dashboard (central) in switcher #}
                    {% if dashboard == 'pmo_up' %}
                    <a href="{{ url_for('pmo.updater_dashboard') }}" class="sidebar-nav-item">
                        <div><i class="fas fa-tasks"></i><span>PMO Updater</span></div>
                    </a>
                    {% elif dashboard == 'pmo_va' %}
                    <a href="{{ url_for('pmo.validator_dashboard') }}" class="sidebar-nav-item">
                        <div><i class="fas fa-clipboard-check"></i><span>PMO Validator</span></div>
                    </a>
                    {% elif dashboard == 'pm_arch' or dashboard == 'pmarch' %}
                    <a href="{{ url_for('pm_arch.dashboard') }}" class="sidebar-nav-item">
                        <div><i class="fas fa-drafting-compass"></i><span>PM/Arch Dashboard</span></div>
                    </a>
                    {% elif dashboard == 'pm' %}
                    <a href="{{ url_for('pm.dashboard') }}" class="sidebar-nav-item">
                        <div><i class="fas fa-project-diagram"></i><span>PM Dashboard</span></div>
                    </a>
                    {% elif dashboard == 'ta_up' %}
                    <a href="{{ url_for('ta.updater_dashboard') }}" class="sidebar-nav-item">
                        <div><i class="fas fa-user-plus"></i><span>TA Updater</span></div>
                    </a>
                    {% elif dashboard == 'ta_va' %}
                    <a href="{{ url_for('ta.validator_dashboard') }}" class="sidebar-nav-item">
                        <div><i class="fas fa-user-check"></i><span>TA Validator</span></div>
                    </a>
                    {% elif dashboard == 'ld' %}
                    <a href="{{ url_for('ld.dashboard') }}" class="sidebar-nav-item">
                        <div><i class="fas fa-graduation-cap"></i><span>L&D Dashboard</span></div>
                    </a>
                    {% elif dashboard == 'ld_up' %}
                    <a href="{{ url_for('ld.updater_dashboard') }}" class="sidebar-nav-item">
                        <div><i class="fas fa-user-edit"></i><span>L&D Updater</span></div>
                    </a>
                    {% elif dashboard == 'ld_va' %}
                    <a href="{{ url_for('ld.validator_dashboard') }}" class="sidebar-nav-item">
                        <div><i class="fas fa-book-reader"></i><span>L&D Validator</span></div>
                    </a>
                    {% elif dashboard == 'hr_up' %}
                    <a href="{{ url_for('hr_roles.updater_dashboard') }}" class="sidebar-nav-item">
                        <div><i class="fas fa-user-edit"></i><span>HR Updater</span></div>
                    </a>
                    {% elif dashboard == 'hr_va' %}
                    <a href="{{ url_for('hr_roles.validator_dashboard') }}" class="sidebar-nav-item">
                        <div><i class="fas fa-user-check"></i><span>HR Validator</span></div>
                    </a>
                    {% elif dashboard == 'hr' %}
                    <a href="{{ url_for('hr_analytics.pbs_analytics') }}" class="sidebar-nav-item">
                        <div><i class="fas fa-chart-line"></i><span>HR Analytics</span></div>
                    </a>
                    {% elif dashboard == 'marketing' %}
                    <a href="{{ url_for('marketing_dashboard.dashboard') }}" class="sidebar-nav-item">
                        <div><i class="fas fa-bullhorn"></i><span>Marketing Dashboard</span></div>
                    </a>
                    {% elif dashboard == 'presales' %}
                    <a href="{{ url_for('presales.dashboard') }}" class="sidebar-nav-item">
                        <div><i class="fas fa-handshake"></i><span>Presales Dashboard</span></div>
                    </a>
                    {% elif dashboard == 'dp' %}
                    <a href="{{ url_for('dp.dashboard') }}" class="sidebar-nav-item">
                        <div><i class="fas fa-hands-helping"></i><span>DP Dashboard</span></div>
                    </a>
                    {% endif %}
                {% endfor %}
            {% endif %}
            
            <div class="sidebar-divider"></div>
            <a href="{{ url_for('auth.logout') }}" class="sidebar-nav-item">
                <div><i class="fas fa-sign-out-alt"></i><span>Logout</span></div>
            </a>
        </div>
    </div>

    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <!-- Topbar -->
    <div class="topbar">
        <div class="topbar-left">
            <button class="sidebar-toggle d-lg-none" id="sidebarToggle">
                <i class="fas fa-bars"></i>
            </button>
            <div class="topbar-icon"><i class="fas fa-trophy"></i></div>
            <div class="topbar-info">
                <div class="topbar-title">Leaderboard</div>
                <div class="topbar-subtitle">
                    <span class="topbar-badge bg-primary">
                        {% if selected_quarter.startswith('All-') %}
                            All Quarters
                        {% else %}
                            {{ selected_quarter.split('-')[0] }}
                        {% endif %}
                    </span>
                    {% set has_any_bonus = leaderboard|selectattr('bonus_points', 'gt', 0)|list|length > 0 %}
                    <span class="topbar-badge {% if include_bonus %}bg-warning text-dark{% elif has_any_bonus %}bg-success{% else %}bg-info{% endif %}">
                        {% if include_bonus %}Bonus Only{% elif has_any_bonus %}Bonus Included{% else %}All Points{% endif %}
                    </span>
                </div>
            </div>
        </div>
        <div class="topbar-center">
            <h6 class="topbar-heading">
                <i class="fas fa-award me-2" style="color: gold;"></i>
                <span>POINTS BASED SYSTEM</span>
            </h6>
        </div>
    </div>

    <!-- Main Content -->
    <div class="content-wrapper">
        <div class="dashboard-header">
            <h4 class="mb-0">
                Central Leaderboard
                {% if grade_filter %}
                <span class="badge bg-primary ms-2">{{ grade_filter }}</span>
                {% endif %}
                {% if selected_category %}
                {% for category in categories %}
                {% if category._id|string == selected_category %}
                <span class="badge bg-info ms-2">{{ category.name }}</span>
                {% endif %}
                {% endfor %}
                {% endif %}
            </h4>
            <div>
                <a href="/central/dashboard#all" class="btn btn-outline-primary">
                    <i class="fas fa-arrow-left"></i> Back
                </a>
            </div>
        </div>

        <!-- Filters -->
        <div class="card mb-4">
            <div class="card-header yellow-header">
                <div class="d-flex align-items-center">
                    <i class="fas fa-filter me-2"></i>
                    <span>Leaderboard Filters</span>
                </div>
            </div>
            <div class="card-body">
                <form id="filter-form">
                    <div class="row g-3">
                        <div class="col-md-2">
                            <label for="year" class="form-label small fw-bold">Year</label>
                            <select id="year" name="year" class="form-select form-select-sm">
                                {% for year in available_years %}
                                <option value="{{ year }}" {% if year==selected_year %}selected{% endif %}>
                                    {% if year == 'all' %}All Years{% else %}{{ year }}-{{ ((year|int + 1)|string)[-2:] }}{% endif %}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label for="quarter" class="form-label small fw-bold">Quarter</label>
                            <select id="quarter" name="quarter" class="form-select form-select-sm">
                                {% for qtr in quarters %}
                                <option value="{{ qtr.name }}" {% if qtr.name==selected_quarter %}selected{% endif %}>
                                    {% if qtr.name.startswith('All-') and qtr.name != 'All-all' %}
                                        All Quarters
                                    {% elif qtr.name == 'All-all' %}
                                        All Quarters
                                    {% elif qtr.name.endswith('-all') %}
                                        {% set q_num = qtr.name.split('-')[0] %}
                                        {% if q_num == 'Q1' %}Q1 (Apr-Jun){% elif q_num == 'Q2' %}Q2 (Jul-Sep){% elif q_num == 'Q3' %}Q3 (Oct-Dec){% elif q_num == 'Q4' %}Q4 (Jan-Mar){% else %}{{ q_num }}{% endif %}
                                    {% else %}
                                        {% set q_num = qtr.name.split('-')[0] %}
                                        {% if q_num == 'Q1' %}Q1 (Apr-Jun){% elif q_num == 'Q2' %}Q2 (Jul-Sep){% elif q_num == 'Q3' %}Q3 (Oct-Dec){% elif q_num == 'Q4' %}Q4 (Jan-Mar){% else %}{{ q_num }}{% endif %}
                                    {% endif %}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="category" class="form-label small fw-bold">Category</label>
                            <select id="category" name="category" class="form-select form-select-sm">
                                <option value="" {% if not selected_category %}selected{% endif %}>All Categories</option>
                                {% for category in categories %}
                                <option value="{{ category._id }}" {% if category._id|string==selected_category %}selected{% endif %}>{{ category.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label for="grade" class="form-label small fw-bold">Grade</label>
                            <select id="grade" name="grade" class="form-select form-select-sm">
                                <option value="" {% if not grade_filter %}selected{% endif %}>All Grades</option>
                                {% for grade in all_grades %}
                                <option value="{{ grade }}" {% if grade==grade_filter %}selected{% endif %}>{{ grade }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-3 d-flex align-items-end">
                            <div class="form-check ms-2">
                                <input class="form-check-input" type="checkbox" id="include_bonus" name="include_bonus" value="true" {% if include_bonus %}checked{% endif %}>
                                <label class="form-check-label small" for="include_bonus">Show only bonus points</label>
                            </div>
                        </div>
                        <div class="col-12 d-flex justify-content-end">
                            <button type="button" id="apply-filters" class="btn btn-primary btn-sm me-2">
                                <i class="fas fa-check me-1"></i>Apply Filters
                            </button>
                            <button type="button" id="reset-filters" class="btn btn-secondary btn-sm">
                                <i class="fas fa-undo me-1"></i>Reset Filters
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        {% if leaderboard|length > 0 %}
        <!-- Top 3 Performers -->
        <div class="row mb-4">
            {% for i in range(3) %}
            {% if leaderboard|length > i %}
            {% set emp = leaderboard[i] %}
            <div class="col-md-4">
                <div class="card h-100 border-0" style="background: linear-gradient(135deg, 
                    {% if i == 0 %}#ffecd2 0%, #fcb69f 100%{% elif i == 1 %}#E0EAFC 0%, #CFDEF3 100%{% else %}#ffd1b3 0%, #ffb199 100%{% endif %});">
                    <div class="card-body position-relative">
                        <div class="position-absolute top-0 end-0 mt-3 me-3">
                            <div class="d-flex align-items-center justify-content-center" style="width: 40px; height: 40px; border-radius: 50%; font-weight: bold; font-size: 1.2rem;
                                {% if i == 0 %}background-color: #ffd700; color: #7D6608;{% elif i == 1 %}background-color: #C0C0C0; color: #444;{% else %}background-color: #CD7F32; color: white;{% endif %}">
                                {{ i + 1 }}
                            </div>
                        </div>
                        <h5 class="text-uppercase mb-1" style="font-size: 0.8rem; color: rgba(0, 0, 0, 0.6);">
                            {% if i == 0 %}Top Performer{% elif i == 1 %}Runner Up{% else %}Third Place{% endif %}
                        </h5>
                        <h3 class="mb-1">{{ emp.name }}</h3>
                        <div class="d-flex align-items-center mb-3">
                            <span class="me-3"><i class="fas fa-certificate me-1"></i>{{ emp.grade }}</span>
                            <span><i class="fas fa-building me-1"></i>{{ emp.department }}</span>
                        </div>
                        <div class="mt-4">
                            <div class="mb-3">
                                <div class="d-flex justify-content-between">
                                    <small class="text-uppercase fw-bold" style="color: rgba(0, 0, 0, 0.6);">
                                        {% if selected_category %}{{ selected_category_name }} Points{% else %}Total Points{% endif %}
                                    </small>
                                    <span class="fw-bold">{{ emp.total_points|int }}</span>
                                </div>
                                {% if emp.bonus_points > 0 %}
                                <div class="small">
                                    <span class="text-success">+ {{ emp.bonus_points }} bonus</span>
                                    {% if include_bonus %}
                                    <span class="badge bg-warning text-dark" style="font-size: 0.65rem;">(bonus only)</span>
                                    {% else %}
                                    <span class="badge bg-success" style="font-size: 0.65rem;">(included)</span>
                                    {% endif %}
                                </div>
                                {% endif %}
                            </div>
                            <div>
                                <div class="d-flex justify-content-between">
                                    <small class="text-uppercase fw-bold" style="color: rgba(0, 0, 0, 0.6);">Progress</small>
                                    <span class="fw-bold">{{ emp.progress }}%</span>
                                </div>
                                <div class="progress mt-1" style="height: 8px;">
                                    <div class="progress-bar" style="width: {% if emp.progress > 100 %}100{% else %}{{ emp.progress }}{% endif %}%;
                                        {% if i == 0 %}background-color: #ffd700;{% elif i == 1 %}background-color: #C0C0C0;{% else %}background-color: #CD7F32;{% endif %}"></div>
                                </div>
                            </div>
                            <div class="mt-3">
                                <div class="d-flex justify-content-between">
                                    <small class="text-uppercase fw-bold" style="color: rgba(0, 0, 0, 0.6);">Utilization</small>
                                    <span class="fw-bold">{{ emp.utilization }}%</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% else %}
            <div class="col-md-4">
                <div class="card h-100 border-0" style="background: linear-gradient(135deg, 
                    {% if i == 0 %}#ffecd2 0%, #fcb69f 100%{% elif i == 1 %}#E0EAFC 0%, #CFDEF3 100%{% else %}#ffd1b3 0%, #ffb199 100%{% endif %});">
                    <div class="card-body text-center py-5">
                        <i class="fas fa-user-plus fa-4x opacity-25"></i>
                        <p class="mt-3">No employee ranked yet</p>
                    </div>
                </div>
            </div>
            {% endif %}
            {% endfor %}
        </div>

        <!-- Rankings Table -->
        <div class="card mb-4">
            <div class="card-header yellow-header">
                <div class="d-flex align-items-center">
                    <i class="fas fa-trophy me-2"></i>
                    <span>Central Rankings - 
                        {% if selected_quarter.startswith('All-') %}
                            All Quarters
                        {% else %}
                            {{ selected_quarter.split('-')[0] }}
                        {% endif %}
                    </span>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="bg-light">
                            <tr>
                                <th>Rank</th>
                                <th>Employee</th>
                                <th>Grade</th>
                                <th>Department</th>
                                <th>Points</th>
                                <th>Progress</th>
                                <th>Utilization</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for employee in leaderboard %}
                            <tr>
                                <td>
                                    <span class="d-flex align-items-center justify-content-center" style="width: 30px; height: 30px; border-radius: 50%; font-weight: bold; font-size: 0.9rem;
                                        {% if employee.rank == 1 %}background-color: #ffd700; color: #7D6608;
                                        {% elif employee.rank == 2 %}background-color: #C0C0C0; color: #444;
                                        {% elif employee.rank == 3 %}background-color: #CD7F32; color: white;
                                        {% else %}background-color: #f8f9fa; color: #6c757d;{% endif %}">
                                        {{ employee.rank }}
                                    </span>
                                </td>
                                <td>{{ employee.name }}</td>
                                <td>{{ employee.grade }}</td>
                                <td>{{ employee.department }}</td>
                                <td>
                                    <strong class="text-primary">{{ employee.total_points|round(2) }}</strong>
                                    {% if employee.bonus_points > 0 %}
                                    <div class="small">
                                        <span class="text-success">+ {{ employee.bonus_points|round(2) }} bonus</span>
                                        {% if include_bonus %}
                                        <span class="badge bg-warning text-dark" style="font-size: 0.65rem;">(bonus only)</span>
                                        {% else %}
                                        <span class="badge bg-success" style="font-size: 0.65rem;">(included)</span>
                                        {% endif %}
                                    </div>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="progress" style="height: 6px; width: 100px;">
                                        <div class="progress-bar {% if employee.progress >= 100 %}bg-success{% endif %}"
                                            style="width: {% if employee.progress > 100 %}100{% else %}{{ employee.progress }}{% endif %}%;"></div>
                                    </div>
                                    <small>{{ employee.progress }}%</small>
                                </td>
                                <td>
                                    <span class="badge {% if employee.utilization >= 80 %}bg-success{% elif employee.utilization >= 60 %}bg-warning{% else %}bg-danger{% endif %}">
                                        {{ employee.utilization }}%
                                    </span>
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-outline-primary details-btn" data-employee-id="{{ employee.id }}">
                                        <i class="fas fa-info-circle"></i> Details
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Charts -->
        <div class="card mb-4">
            <div class="card-header yellow-header">
                <i class="fas fa-chart-pie me-2"></i>
                <span>Points by Category Distribution</span>
            </div>
            <div class="card-body p-3">
                <div class="row">
                    <div class="col-md-7">
                        <div style="height: 250px; position: relative;">
                            <canvas id="categoryChart"></canvas>
                        </div>
                    </div>
                    <div class="col-md-5">
                        <h6 class="mb-2 fw-bold">Category Breakdown</h6>
                        <div style="max-height: 230px; overflow-y: auto;">
                            {% set category_totals = {} %}
                            {% for employee in leaderboard %}
                            {% for category_id, category in employee.categories_breakdown.items() %}
                            {% if category_id in category_totals %}
                            {% set _ = category_totals.update({category_id: {'name': category.name, 'points': category_totals[category_id].points + category.points}}) %}
                            {% else %}
                            {% set _ = category_totals.update({category_id: {'name': category.name, 'points': category.points}}) %}
                            {% endif %}
                            {% endfor %}
                            {% endfor %}

                            <div class="list-group list-group-flush">
                                {% for category_id, data in category_totals.items()|sort(attribute='1.points', reverse=true) %}
                                <div class="list-group-item d-flex justify-content-between align-items-center p-2 border-0">
                                    <div>
                                        <span class="d-inline-block me-2" style="width:12px; height:12px; background-color:{{ ['#4361EE', '#3A0CA3', '#F72585', '#4CC9F0', '#F1C40F', '#E74C3C', '#2ECC71', '#9B59B6', '#34495E', '#1ABC9C'][loop.index0 % 10] }}; border-radius:50%;"></span>
                                        {{ data.name }}
                                    </div>
                                    <span class="badge bg-primary rounded-pill">{{ data.points }}</span>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card h-100">
                    <div class="card-header yellow-header">
                        <i class="fas fa-building me-2"></i>
                        <span>Department Rankings</span>
                    </div>
                    <div class="card-body p-3">
                        <div style="height: 220px; position: relative;">
                            <canvas id="departmentChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <div class="card h-100">
                    <div class="card-header yellow-header">
                        <i class="fas fa-certificate me-2"></i>
                        <span>Grade-wise Distribution</span>
                    </div>
                    <div class="card-body p-3">
                        <div style="height: 220px; position: relative;">
                            <canvas id="gradeChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        {% else %}
        <div class="card">
            <div class="card-body text-center py-5">
                <i class="fas fa-trophy fa-3x text-muted mb-3"></i>
                <h4>No employees found</h4>
                <p class="text-muted">No employees match the selected filters or have earned points in the selected quarter.</p>
                <a href="{{ url_for('central.leaderboard') }}" class="btn btn-primary mt-2">Reset Filters</a>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Details Modal -->
    <div class="modal fade" id="detailsModal" tabindex="-1">
        <div class="modal-dialog" style="max-width: 800px;">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Employee Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" style="padding: 15px;">
                    <div id="employeeDetailsContent">
                        <div class="text-center">
                            <div class="spinner-border"></div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Notes Modal -->
    <div class="modal fade" id="notesModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content" style="border-radius: 14px; border: none; box-shadow: 0 8px 24px rgba(0,0,0,0.15);">
                <div class="modal-header" style="background: #0d6efd; color: white; border-radius: 14px 14px 0 0; padding: 20px 24px; border: none;">
                    <h5 class="modal-title" style="font-weight: 600; font-size: 1.25rem;">
                        <i class="fas fa-sticky-note me-2"></i>Request Details
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" style="max-height: 70vh; overflow-y: auto; padding: 20px; background: #f8f9fa;">
                    <div class="mb-2"><strong id="notesLabel">Notes:</strong></div>
                    <div id="modal-notes-content" style="white-space: pre-wrap; word-wrap: break-word; font-size: 1rem; line-height: 1.8; background: white; padding: 20px; border-radius: 8px; border-left: 4px solid #17a2b8;"></div>
                </div>
                <div class="modal-footer" style="border-top: 1px solid #dee2e6; padding: 16px 24px; background: #f8f9fa; border-radius: 0 0 14px 14px;">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Help Modal -->
    <div class="modal fade" id="helpModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Central Leaderboard Help</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <h5>Central Leaderboard</h5>
                    <p>Displays employee and manager rankings based on earned points in the Points Based Reward System. This is a central analysis view for administrators.</p>
                    <h5>Filtering Options</h5>
                    <ul>
                        <li><strong>Year:</strong> Select the year to view leaderboard data (quarters update automatically)</li>
                        <li><strong>Quarter:</strong> Select specific quarter to view point accumulation</li>
                        <li><strong>Category:</strong> Filter by point category</li>
                        <li><strong>Grade:</strong> Filter by employee grade</li>
                        <li><strong>Show only bonus points:</strong> Filter to display only bonus points (excludes regular points)</li>
                    </ul>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Available quarters from database (passed from backend)
        var availableQuarters = [
            {% for q in all_available_quarters %}
            "{{ q }}"{% if not loop.last %},{% endif %}
            {% endfor %}
        ];
        var selectedQuarterValue = "{{ selected_quarter }}";
        // Current quarter info for defaulting
        var currentQuarter = {{ current_qtr if current_qtr is defined else 1 }};
        var currentYear = {{ current_year if current_year is defined else 2025 }};
    </script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            if (history.scrollRestoration) history.scrollRestoration = 'manual';
            window.scrollTo(0, 0);

            // Sidebar
            const sidebar = document.getElementById('sidebar');
            const toggle = document.getElementById('sidebarToggle');
            const overlay = document.getElementById('sidebarOverlay');

            toggle?.addEventListener('click', () => {
                sidebar.classList.toggle('show');
                overlay.classList.toggle('show');
                const icon = toggle.querySelector('i');
                icon.className = sidebar.classList.contains('show') ? 'fas fa-times' : 'fas fa-bars';
            });

            overlay?.addEventListener('click', () => {
                sidebar.classList.remove('show');
                overlay.classList.remove('show');
                const icon = toggle?.querySelector('i');
                if (icon) icon.className = 'fas fa-bars';
            });

            // ✅ HELPER: Update quarter options based on selected year (Dynamic from database)
            function updateQuarterOptions(selectedYear) {
                const quarterSelect = document.getElementById('quarter');
                if (!quarterSelect) return;
                
                // Clear existing options
                quarterSelect.innerHTML = '';
                
                // Quarter label mapping (Fiscal Year: Apr-Mar)
                const quarterLabelsGeneric = {
                    'Q1': 'Q1 (Apr-Jun)',
                    'Q2': 'Q2 (Jul-Sep)',
                    'Q3': 'Q3 (Oct-Dec)',
                    'Q4': 'Q4 (Jan-Mar)'
                };
                
                // ✅ Handle "All Years" case
                if (selectedYear === 'all') {
                    // Add "All Quarters" option first
                    const allOption = document.createElement('option');
                    allOption.value = 'All-all';
                    allOption.textContent = 'All Quarters';
                    quarterSelect.appendChild(allOption);
                    
                    // Get unique quarter numbers from available quarters
                    const uniqueQuarters = new Set();
                    availableQuarters.forEach(q => {
                        if (q.startsWith('Q') && !q.startsWith('All')) {
                            const qNum = q.split('-')[0]; // e.g., "Q1" from "Q1-2025"
                            uniqueQuarters.add(qNum);
                        }
                    });
                    
                    // Add quarters that have data
                    ['Q1', 'Q2', 'Q3', 'Q4'].forEach(qNum => {
                        if (uniqueQuarters.has(qNum)) {
                            const option = document.createElement('option');
                            option.value = `${qNum}-all`;
                            option.textContent = quarterLabelsGeneric[qNum];
                            quarterSelect.appendChild(option);
                        }
                    });
                    
                    quarterSelect.value = 'All-all';
                } else {
                    const year = parseInt(selectedYear);
                    const nextYear = year + 1;
                    
                    // Add "All Quarters" option first
                    const allOption = document.createElement('option');
                    allOption.value = `All-${selectedYear}`;
                    allOption.textContent = 'All Quarters';
                    quarterSelect.appendChild(allOption);
                    
                    // Filter quarters for the selected year from available quarters
                    const yearQuarters = availableQuarters.filter(q => {
                        if (q.startsWith('All')) return false;
                        const qYear = q.split('-')[1];
                        return qYear === String(year);
                    });
                    
                    // Sort and add quarters
                    yearQuarters.sort((a, b) => {
                        const qNumA = parseInt(a.split('-')[0].substring(1));
                        const qNumB = parseInt(b.split('-')[0].substring(1));
                        return qNumA - qNumB;
                    });
                    
                    yearQuarters.forEach(q => {
                        const qNum = q.split('-')[0];
                        let label;
                        if (qNum === 'Q1') label = `Q1 (Apr-Jun ${year})`;
                        else if (qNum === 'Q2') label = `Q2 (Jul-Sep ${year})`;
                        else if (qNum === 'Q3') label = `Q3 (Oct-Dec ${year})`;
                        else if (qNum === 'Q4') label = `Q4 (Jan-Mar ${nextYear})`;
                        
                        const option = document.createElement('option');
                        option.value = q;
                        option.textContent = label;
                        quarterSelect.appendChild(option);
                    });
                    
                    // ✅ Default to CURRENT quarter if available, otherwise "All Quarters"
                    const currentQuarterValue = `Q${currentQuarter}-${selectedYear}`;
                    if (yearQuarters.includes(currentQuarterValue)) {
                        quarterSelect.value = currentQuarterValue;
                    } else {
                        quarterSelect.value = `All-${selectedYear}`;
                    }
                }
                
                // Try to restore selected quarter if it exists
                if (selectedQuarterValue && quarterSelect.querySelector(`option[value="${selectedQuarterValue}"]`)) {
                    quarterSelect.value = selectedQuarterValue;
                }
            }
            
            // Year change handler - update quarters dynamically
            document.getElementById('year')?.addEventListener('change', function() {
                updateQuarterOptions(this.value);
            });
            
            // Initialize quarter options on page load
            const initialYear = document.getElementById('year')?.value;
            if (initialYear) {
                updateQuarterOptions(initialYear);
            }

            // Filters
            document.getElementById('apply-filters')?.addEventListener('click', function() {
                const btn = this;
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Applying...';

                const params = new URLSearchParams();
                params.set('year', document.getElementById('year').value);
                params.set('quarter', document.getElementById('quarter').value);
                const category = document.getElementById('category').value;
                if (category) params.set('category', category);
                const grade = document.getElementById('grade').value;
                if (grade) params.set('grade', grade);
                if (document.getElementById('include_bonus').checked) params.set('include_bonus', 'true');

                window.location.href = `{{ url_for('central.leaderboard') }}?${params.toString()}`;
            });

            document.getElementById('reset-filters')?.addEventListener('click', function() {
                window.location.href = '{{ url_for('central.leaderboard') }}';
            });

            // Employee Details
            document.querySelectorAll('.details-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const employeeId = this.getAttribute('data-employee-id');
                    const modal = new bootstrap.Modal(document.getElementById('detailsModal'));
                    const content = document.getElementById('employeeDetailsContent');
                    
                    content.innerHTML = '<div class="text-center"><div class="spinner-border"></div></div>';
                    modal.show();

                    // Build URL with filters - pass ALL active filters
                    let url = `/central/employee-details/${employeeId}?quarter={{ selected_quarter }}`;
                    {% if selected_category %}
                    url += '&category={{ selected_category }}';
                    {% endif %}
                    {% if include_bonus %}
                    url += '&include_bonus=true';
                    {% endif %}
                    {% if grade_filter %}
                    url += '&grade={{ grade_filter }}';
                    {% endif %}
                    
                    fetch(url)
                        .then(res => res.json())
                        .then(data => {
                            // Check if there are any records
                            const hasRecords = data.points_records && data.points_records.length > 0;
                            const hasCategoryData = data.summary_by_category && data.summary_by_category.length > 0;
                            
                            let html = `
                                <h5 class="mb-2">${data.employee.name} (${data.employee.grade})</h5>
                                <p class="text-muted mb-3" style="font-size: 0.9em;">${data.employee.email}</p>
                                ${data.selected_category ? `<div class="alert alert-info py-1 px-2 mb-2"><small><i class="fas fa-filter"></i> Filtered by category: <strong>${data.selected_category}</strong></small></div>` : ''}
                                <div class="row g-2 mb-3">
                                    <div class="col-md-6">
                                        <div class="card h-100">
                                            <div class="card-header bg-light py-2"><small><strong>Summary for ${data.quarter}</strong></small></div>
                                            <div class="card-body py-2">
                                                <p class="mb-1"><small><strong>Regular Points:</strong> ${parseFloat(data.total_regular_points).toFixed(2)}</small></p>
                                                <p class="mb-1"><small><strong>Bonus Points:</strong> <span class="text-success">${parseFloat(data.total_bonus_points).toFixed(2)}</span> ${parseFloat(data.total_bonus_points) > 0 ? '<span class="badge bg-success">Included</span>' : '<span class="badge bg-secondary">Not Included</span>'}</small></p>
                                                <p class="mb-1"><small><strong>Progress:</strong> ${parseFloat(data.quarterly_progress).toFixed(1)}%</small></p>
                                                <p class="mb-1"><small><strong>Average Utilization:</strong> <span class="fw-bold ${data.average_utilization >= 80 ? 'text-success' : data.average_utilization >= 60 ? 'text-warning' : 'text-danger'}">${parseFloat(data.average_utilization).toFixed(1)}%</span></small></p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="card h-100">
                                            <div class="card-header bg-light py-2"><small><strong>Category Breakdown</strong></small></div>
                                            <div class="card-body py-2" style="max-height: 150px; overflow-y: auto;">
                                                ${hasCategoryData ? `
                                                <ul class="list-group list-group-flush">
                                                    ${data.summary_by_category.map(cat => `<li class="list-group-item d-flex justify-content-between align-items-center py-1 px-0"><small>${cat.category}</small><span class="badge bg-primary">${cat.points}</span></li>`).join('')}
                                                </ul>
                                                ` : '<p class="text-muted text-center mb-0"><small>No records</small></p>'}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <h6 class="mt-2 mb-2">Point History</h6>
                                <div style="max-height: 300px; overflow-y: auto;">
                                ${hasRecords ? `
                                <table class="table table-sm table-hover mb-0">
                                    <thead class="table-light">
                                        <tr>
                                            <th style="font-size: 0.85em; width: 20%;">Date</th>
                                            <th style="font-size: 0.85em; width: 35%;">Category</th>
                                            <th style="font-size: 0.85em; width: 25%;">Points</th>
                                            <th style="font-size: 0.85em; width: 20%;">Notes</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${data.points_records.map(rec => {
                                            // Escape quotes and special characters in notes
                                            const notes = (rec.notes || rec.manager_notes || rec.submission_notes || 'No notes available')
                                                .replace(/"/g, '&quot;')
                                                .replace(/'/g, '&#39;')
                                                .replace(/\n/g, '<br>');
                                            return `
                                            <tr>
                                                <td>${rec.date}</td>
                                                <td>${rec.category}</td>
                                                <td>
                                                    ${rec.is_utilization && rec.utilization ? 
                                                        `<span class="badge bg-info">${rec.utilization}</span>` : 
                                                        `${rec.points} ${rec.is_bonus ? '<span class="badge bg-success">Bonus</span>' : ''}`
                                                    }
                                                </td>
                                                <td><button class="btn btn-sm btn-outline-primary view-notes-btn" data-notes="${notes}" data-status="${rec.status || ''}" data-hr-modified="${rec.hr_modified ? 'true' : 'false'}">View</button></td>
                                            </tr>
                                            `;
                                        }).join('')}
                                    </tbody>
                                </table>
                                ` : '<p class="text-muted text-center"><small>No records</small></p>'}
                                </div>
                            `;
                            content.innerHTML = html;
                        })
                        .catch(err => {
                            content.innerHTML = `<div class="alert alert-danger">Error: ${err.message}</div>`;
                        });
                });
            });

            // Helper function to decode HTML entities
            function decodeHtmlEntities(text) {
                if (!text) return '';
                const textarea = document.createElement('textarea');
                textarea.innerHTML = text;
                return textarea.value;
            }
            
            // Notes modal - show full notes with HR Portal styling
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('view-notes-btn')) {
                    const rawNotes = e.target.getAttribute('data-notes') || 'No notes available';
                    const notes = decodeHtmlEntities(rawNotes);
                    const status = e.target.getAttribute('data-status');
                    const hrModified = e.target.getAttribute('data-hr-modified') === 'true';
                    const notesElement = document.getElementById('modal-notes-content');
                    const notesLabel = document.getElementById('notesLabel');
                    
                    // Add HR UPDATED prefix if modified by HR
                    if (hrModified && notes && notes !== 'No notes available') {
                        notesElement.textContent = 'HR UPDATED: ' + notes;
                    } else {
                        notesElement.textContent = notes;
                    }
                    
                    // Update styling based on status
                    if (status === 'Approved') {
                        if (notesLabel) notesLabel.textContent = 'Approval Notes:';
                        notesElement.style.backgroundColor = '#e8f5e9';
                        notesElement.style.borderLeftColor = '#4caf50';
                    } else if (status === 'Rejected') {
                        if (notesLabel) notesLabel.textContent = 'Rejection Notes:';
                        notesElement.style.backgroundColor = '#ffebee';
                        notesElement.style.borderLeftColor = '#f44336';
                    } else {
                        if (notesLabel) notesLabel.textContent = 'Notes:';
                        notesElement.style.backgroundColor = '#f8f9fa';
                        notesElement.style.borderLeftColor = '#17a2b8';
                    }
                    
                    new bootstrap.Modal(document.getElementById('notesModal')).show();
                }
            });

            // Charts
            {% if leaderboard|length > 0 %}
            const colors = ['rgba(67, 97, 238, 0.7)', 'rgba(58, 12, 163, 0.7)', 'rgba(247, 37, 133, 0.7)', 'rgba(76, 201, 240, 0.7)', 'rgba(241, 196, 15, 0.7)', 'rgba(231, 76, 60, 0.7)', 'rgba(46, 204, 113, 0.7)', 'rgba(155, 89, 182, 0.7)', 'rgba(52, 73, 94, 0.7)', 'rgba(26, 188, 156, 0.7)'];

            {% set category_totals = {} %}
            {% for employee in leaderboard %}
            {% for category_id, category in employee.categories_breakdown.items() %}
            {% if category_id in category_totals %}
            {% set _ = category_totals.update({category_id: {'name': category.name, 'points': category_totals[category_id].points + category.points}}) %}
            {% else %}
            {% set _ = category_totals.update({category_id: {'name': category.name, 'points': category.points}}) %}
            {% endif %}
            {% endfor %}
            {% endfor %}

            new Chart(document.getElementById('categoryChart'), {
                type: 'doughnut',
                data: {
                    labels: [{% for _, data in category_totals.items() %}"{{ data.name }}",{% endfor %}],
                    datasets: [{
                        data: [{% for _, data in category_totals.items() %}{{ data.points }},{% endfor %}],
                        backgroundColor: colors,
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '65%',
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: ctx => {
                                    const total = ctx.dataset.data.reduce((a, b) => a + b, 0);
                                    const pct = Math.round((ctx.raw / total) * 100);
                                    return `${ctx.label}: ${ctx.raw} pts (${pct}%)`;
                                }
                            }
                        }
                    }
                }
            });

            {% set dept_totals = {} %}
            {% for emp in leaderboard %}
            {% set dept = emp.department|default('Other') %}
            {% if dept in dept_totals %}
            {% set _ = dept_totals.update({dept: dept_totals[dept] + emp.total_points}) %}
            {% else %}
            {% set _ = dept_totals.update({dept: emp.total_points}) %}
            {% endif %}
            {% endfor %}

            new Chart(document.getElementById('departmentChart'), {
                type: 'bar',
                data: {
                    labels: [{% for dept, _ in dept_totals.items() %}"{{ dept }}",{% endfor %}],
                    datasets: [{
                        label: 'Points',
                        data: [{% for _, pts in dept_totals.items() %}{{ pts }},{% endfor %}],
                        backgroundColor: colors[0],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true } },
                    plugins: { legend: { display: false } }
                }
            });

            {% set grade_totals = {} %}
            {% for emp in leaderboard %}
            {% set grade = emp.grade|default('Unknown') %}
            {% if grade in grade_totals %}
            {% set _ = grade_totals.update({grade: grade_totals[grade] + emp.total_points}) %}
            {% else %}
            {% set _ = grade_totals.update({grade: emp.total_points}) %}
            {% endif %}
            {% endfor %}

            new Chart(document.getElementById('gradeChart'), {
                type: 'bar',
                data: {
                    labels: [{% for grade, _ in grade_totals.items()|sort %}"{{ grade }}",{% endfor %}],
                    datasets: [{
                        label: 'Points',
                        data: [{% for _, pts in grade_totals.items()|sort %}{{ pts }},{% endfor %}],
                        backgroundColor: colors[2],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    scales: { x: { beginAtZero: true } },
                    plugins: { legend: { display: false } }
                }
            });
            {% endif %}
        });
    </script>
</body>
</html>