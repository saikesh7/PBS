{% extends "ta_base.html" %}

{% block title %}TA Validator Dashboard{% endblock %}
{% block dashboard_title %}TA Validator Dashboard{% endblock %}

{% block extra_css %}
<!-- Cross-browser compatibility styles for all browsers and systems -->
<style>
    /* ========================================
       Cross-browser reset and normalize
       ======================================== */
    *, *::before, *::after {
        -webkit-box-sizing: border-box;
        -moz-box-sizing: border-box;
        box-sizing: border-box;
    }
    
    /* ========================================
       Cross-browser flexbox support
       ======================================== */
    .d-flex {
        display: -webkit-box !important;
        display: -webkit-flex !important;
        display: -moz-box !important;
        display: -ms-flexbox !important;
        display: flex !important;
    }
    
    .justify-content-between {
        -webkit-box-pack: justify !important;
        -webkit-justify-content: space-between !important;
        -moz-box-pack: justify !important;
        -ms-flex-pack: justify !important;
        justify-content: space-between !important;
    }
    
    .justify-content-center {
        -webkit-box-pack: center !important;
        -webkit-justify-content: center !important;
        -moz-box-pack: center !important;
        -ms-flex-pack: center !important;
        justify-content: center !important;
    }
    
    .justify-content-end {
        -webkit-box-pack: end !important;
        -webkit-justify-content: flex-end !important;
        -moz-box-pack: end !important;
        -ms-flex-pack: end !important;
        justify-content: flex-end !important;
    }
    
    .align-items-center {
        -webkit-box-align: center !important;
        -webkit-align-items: center !important;
        -moz-box-align: center !important;
        -ms-flex-align: center !important;
        align-items: center !important;
    }
    
    .align-items-end {
        -webkit-box-align: end !important;
        -webkit-align-items: flex-end !important;
        -moz-box-align: end !important;
        -ms-flex-align: end !important;
        align-items: flex-end !important;
    }
    
    .flex-grow-1 {
        -webkit-box-flex: 1 !important;
        -webkit-flex-grow: 1 !important;
        -moz-box-flex: 1 !important;
        -ms-flex-positive: 1 !important;
        flex-grow: 1 !important;
    }
    
    .gap-1 {
        gap: 0.25rem !important;
    }
    
    .gap-2 {
        gap: 0.5rem !important;
    }
    
    /* ========================================
       Cross-browser form controls & filters
       ======================================== */
    .form-control, .form-select {
        display: block;
        width: 100%;
        padding: 0.375rem 0.75rem;
        font-size: 1rem;
        font-weight: 400;
        line-height: 1.5;
        color: #212529;
        background-color: #fff;
        background-clip: padding-box;
        border: 1px solid #ced4da;
        -webkit-appearance: none;
        -moz-appearance: none;
        appearance: none;
        -webkit-border-radius: 0.25rem;
        -moz-border-radius: 0.25rem;
        border-radius: 0.25rem;
        -webkit-transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
        -moz-transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
        -o-transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
        transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
    }
    
    .form-select {
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23343a40' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M2 5l6 6 6-6'/%3e%3c/svg%3e");
        background-repeat: no-repeat;
        background-position: right 0.75rem center;
        background-size: 16px 12px;
        padding-right: 2.25rem;
    }
    
    .form-control:focus, .form-select:focus {
        color: #212529;
        background-color: #fff;
        border-color: #86b7fe;
        outline: 0;
        -webkit-box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
        -moz-box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
        box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
    }
    
    .form-select-sm {
        padding-top: 0.25rem;
        padding-bottom: 0.25rem;
        padding-left: 0.5rem;
        font-size: 0.875rem;
        -webkit-border-radius: 0.2rem;
        -moz-border-radius: 0.2rem;
        border-radius: 0.2rem;
    }
    
    .form-control-sm {
        min-height: calc(1.5em + 0.5rem + 2px);
        padding: 0.25rem 0.5rem;
        font-size: 0.875rem;
        -webkit-border-radius: 0.2rem;
        -moz-border-radius: 0.2rem;
        border-radius: 0.2rem;
    }
    
    /* ========================================
       Cross-browser button styling
       ======================================== */
    .btn {
        display: inline-block;
        font-weight: 400;
        line-height: 1.5;
        text-align: center;
        text-decoration: none;
        vertical-align: middle;
        cursor: pointer;
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
        border: 1px solid transparent;
        padding: 0.375rem 0.75rem;
        font-size: 1rem;
        -webkit-border-radius: 0.25rem;
        -moz-border-radius: 0.25rem;
        border-radius: 0.25rem;
        -webkit-transition: color 0.15s ease-in-out, background-color 0.15s ease-in-out, border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
        -moz-transition: color 0.15s ease-in-out, background-color 0.15s ease-in-out, border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
        -o-transition: color 0.15s ease-in-out, background-color 0.15s ease-in-out, border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
        transition: color 0.15s ease-in-out, background-color 0.15s ease-in-out, border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
    }
    
    .btn:focus, .btn:active {
        outline: none;
        -webkit-box-shadow: 0 0 0 0.2rem rgba(0,123,255,.25);
        -moz-box-shadow: 0 0 0 0.2rem rgba(0,123,255,.25);
        box-shadow: 0 0 0 0.2rem rgba(0,123,255,.25);
    }
    
    .btn-sm {
        padding: 0.25rem 0.5rem;
        font-size: 0.875rem;
        -webkit-border-radius: 0.2rem;
        -moz-border-radius: 0.2rem;
        border-radius: 0.2rem;
    }
    
    /* ========================================
       Cross-browser table styles
       ======================================== */
    .table-responsive {
        display: block;
        width: 100%;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        scrollbar-width: thin;
    }
    
    .table-responsive::-webkit-scrollbar {
        height: 8px;
    }
    
    .table-responsive::-webkit-scrollbar-track {
        background: #f1f1f1;
        -webkit-border-radius: 4px;
        border-radius: 4px;
    }
    
    .table-responsive::-webkit-scrollbar-thumb {
        background: #888;
        -webkit-border-radius: 4px;
        border-radius: 4px;
    }
    
    /* Sticky table header - cross-browser */
    .sticky-top, thead.sticky-top th {
        position: -webkit-sticky;
        position: sticky;
        top: 0;
        z-index: 10;
    }
    
    /* ========================================
       Cross-browser modal fixes
       ======================================== */
    .modal {
        display: none;
        position: fixed;
        z-index: 1050;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow-x: hidden;
        overflow-y: auto;
        outline: 0;
        -webkit-overflow-scrolling: touch;
    }

    .modal.show {
        display: block !important;
    }
    
    /* Fix modal backdrop blocking issue */
    .modal-backdrop {
        position: fixed;
        top: 0;
        left: 0;
        z-index: 1040;
        width: 100vw;
        height: 100vh;
        background-color: #000;
        pointer-events: none !important;
    }
    
    .modal-backdrop.show {
        opacity: 0.5;
        pointer-events: none !important;
    }
    
    /* Ensure modal dialog is above backdrop and clickable */
    .modal-dialog {
        position: relative;
        z-index: 1050;
        pointer-events: auto !important;
    }

    .modal-dialog-centered {
        display: -webkit-box;
        display: -webkit-flex;
        display: -moz-box;
        display: -ms-flexbox;
        display: flex;
        -webkit-box-align: center;
        -webkit-align-items: center;
        -moz-box-align: center;
        -ms-flex-align: center;
        align-items: center;
        min-height: calc(100% - 1rem);
        min-height: -webkit-calc(100% - 1rem);
    }

    .modal-content {
        position: relative;
        display: -webkit-box;
        display: -webkit-flex;
        display: -moz-box;
        display: -ms-flexbox;
        display: flex;
        -webkit-box-orient: vertical;
        -webkit-flex-direction: column;
        -ms-flex-direction: column;
        flex-direction: column;
        width: 100%;
        pointer-events: auto;
        background-color: #fff;
        background-clip: padding-box;
        border: 1px solid rgba(0,0,0,.2);
        -webkit-border-radius: 0.3rem;
        -moz-border-radius: 0.3rem;
        border-radius: 0.3rem;
        outline: 0;
    }
    
    /* ========================================
       Cross-browser badge styles
       ======================================== */
    .badge {
        display: inline-block;
        padding: 0.35em 0.65em;
        font-size: 0.75em;
        font-weight: 700;
        line-height: 1;
        text-align: center;
        white-space: nowrap;
        vertical-align: baseline;
        -webkit-border-radius: 0.25rem;
        -moz-border-radius: 0.25rem;
        border-radius: 0.25rem;
    }
    
    .rounded-pill {
        -webkit-border-radius: 50rem !important;
        -moz-border-radius: 50rem !important;
        border-radius: 50rem !important;
    }
    
    /* ========================================
       Cross-browser card styles
       ======================================== */
    .card {
        -webkit-box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
        -moz-box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
        box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
    }
    
    .shadow-sm {
        -webkit-box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075) !important;
        -moz-box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075) !important;
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075) !important;
    }
    
    /* ========================================
       Cross-browser row/column grid
       ======================================== */
    .row {
        display: -webkit-box;
        display: -webkit-flex;
        display: -moz-box;
        display: -ms-flexbox;
        display: flex;
        -webkit-flex-wrap: wrap;
        -ms-flex-wrap: wrap;
        flex-wrap: wrap;
        margin-right: -0.75rem;
        margin-left: -0.75rem;
    }
    
    .g-2 {
        --bs-gutter-x: 0.5rem;
        --bs-gutter-y: 0.5rem;
    }
    
    .g-2 > * {
        padding-right: calc(var(--bs-gutter-x, 0.5rem) * 0.5);
        padding-left: calc(var(--bs-gutter-x, 0.5rem) * 0.5);
        margin-top: var(--bs-gutter-y, 0);
    }
    
    /* ========================================
       Firefox specific fixes
       ======================================== */
    @-moz-document url-prefix() {
        .form-select {
            text-indent: 0.01px;
            text-overflow: '';
        }
        
        .btn::-moz-focus-inner {
            border: 0;
        }
    }
    
    /* ========================================
       IE/Edge specific fixes
       ======================================== */
    @supports (-ms-ime-align: auto) {
        .form-control, .form-select {
            padding-right: 0.75rem;
        }
    }
    
    /* IE11 flexbox fixes */
    @media all and (-ms-high-contrast: none), (-ms-high-contrast: active) {
        .d-flex {
            display: -ms-flexbox !important;
        }
        .align-items-center {
            -ms-flex-align: center !important;
        }
        .justify-content-between {
            -ms-flex-pack: justify !important;
        }
    }
</style>

<!-- Preserve tab state on page reload -->
<!-- Prevent flash of wrong tab on page load -->
<script>
    // Flag to prevent base template's tab initialization from interfering
    // This MUST be set before any other scripts run
    window.TA_VALIDATOR_PAGE = true;
    
    // This runs IMMEDIATELY before page renders to prevent flash
    (function() {
        // Dashboard Switch Detection Logic
        const DASHBOARD_KEY = 'current_dashboard';
        const CURRENT_DASHBOARD = 'ta_validator';
        
        // Check if we're coming from a different dashboard
        const lastDashboard = sessionStorage.getItem(DASHBOARD_KEY);
        const isDashboardSwitch = lastDashboard && lastDashboard !== CURRENT_DASHBOARD;
        
        // Update current dashboard in sessionStorage
        sessionStorage.setItem(DASHBOARD_KEY, CURRENT_DASHBOARD);
        
        // ✅ Check URL parameter FIRST (primary source of truth)
        const urlParams = new URLSearchParams(window.location.search);
        const urlTab = urlParams.get('tab');
        
        // Determine which tab to show
        let activeTab;
        if (urlTab) {
            // URL parameter takes highest priority
            activeTab = urlTab;
        } else if (isDashboardSwitch) {
            // Coming from different dashboard → go to Overview
            activeTab = 'overview';
            localStorage.setItem('ta_validator_current_tab', 'overview');
        } else {
            // Same dashboard (page reload) → restore saved tab
            activeTab = localStorage.getItem('ta_validator_current_tab') || 'overview';
        }
        
        if (activeTab && activeTab !== 'overview') {
            // Add CSS to hide overview tab and show active tab
            document.write('<style id="tab-preload-style">');
            document.write('#overview-tab { display: none !important; }');
            document.write('#' + activeTab + '-tab { display: block !important; }');
            document.write('</style>');
        }
    })();
</script>
{% endblock %}

{% block sidebar_nav %}
<!-- Validator Navigation Items -->
<a href="javascript:void(0);" class="sidebar-nav-item tab-link active" data-tab="overview">
    <div>
        <i class="fas fa-tachometer-alt"></i>
        <span>Dashboard</span>
    </div>
</a>

<a href="javascript:void(0);" class="sidebar-nav-item tab-link" data-tab="review">
    <div>
        <i class="fas fa-check-square"></i>
        <span>Review Requests</span>
        <span class="badge bg-warning" style="display: {{ 'inline-block' if pending_count > 0 else 'none' }};">{{ pending_count if pending_count > 0 else '0' }}</span>
    </div>
</a>

<a href="javascript:void(0);" class="sidebar-nav-item tab-link" data-tab="history">
    <div>
        <i class="fas fa-history"></i>
        <span>History</span>
    </div>
</a>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Overview Tab (Dashboard Summary) -->
    <div class="tab-content-section active" id="overview-tab">
        <!-- Stats Cards Row -->
        <div class="row mb-4">
            <div class="col-xl-3 col-md-6 mb-3">
                <div class="card border-left-primary shadow h-100">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col">
                                <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">Total Submitted</div>
                                <div class="h5 mb-0 font-weight-bold">{{ (pending_count + (history_data|length if history_data else 0)) }}</div>
                            </div>
                            <div class="col-auto">
                                <i class="fas fa-paper-plane fa-2x text-primary" style="opacity: 0.3;"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-xl-3 col-md-6 mb-3">
                <div class="card border-left-success shadow h-100">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col">
                                <div class="text-xs font-weight-bold text-success text-uppercase mb-1">Approved</div>
                                <div class="h5 mb-0 font-weight-bold">{{ history_data|selectattr('status', 'equalto', 'Approved')|list|length if history_data else 0 }}</div>
                            </div>
                            <div class="col-auto">
                                <i class="fas fa-check-circle fa-2x text-success" style="opacity: 0.3;"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-xl-3 col-md-6 mb-3">
                <div class="card border-left-danger shadow h-100">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col">
                                <div class="text-xs font-weight-bold text-danger text-uppercase mb-1">Rejected</div>
                                <div class="h5 mb-0 font-weight-bold">{{ history_data|selectattr('status', 'equalto', 'Rejected')|list|length if history_data else 0 }}</div>
                            </div>
                            <div class="col-auto">
                                <i class="fas fa-times-circle fa-2x text-danger" style="opacity: 0.3;"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-xl-3 col-md-6 mb-3">
                <div class="card border-left-warning shadow h-100">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col">
                                <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">Pending Requests</div>
                                <div class="h5 mb-0 font-weight-bold" data-pending-count>{{ pending_count }}</div>
                            </div>
                            <div class="col-auto">
                                <i class="fas fa-clock fa-2x text-warning" style="opacity: 0.3;"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Action Button -->
        {% if pending_count > 0 %}
        <div class="row mb-4">
            <div class="col-12">
                <div class="card shadow-sm border-0" style="background-color: #2c5aa0 !important;">
                    <div class="card-body text-white text-center py-4" style="background-color: #2c5aa0 !important;">
                        <h4 class="mb-3"><i class="fas fa-bell me-2"></i>{{ pending_count }} Request(s) Awaiting Your Review</h4>
                        <button class="btn btn-light btn-lg px-5" onclick="switchValidatorTab('review')">
                            <i class="fas fa-check-square me-2"></i>Review Requests
                        </button>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Recent Activity and Categories Row -->
        <div class="row">
            <!-- Recent Activity Section -->
            <div class="col-lg-8 mb-4">
                <div class="card shadow-sm">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="fas fa-clock me-2"></i>Recent Activity</h5>
                    </div>
                    <div class="card-body p-0">
                        {% if history_data %}
                        <div class="list-group list-group-flush">
                            {% for item in history_data[:5] %}
                            <div class="list-group-item">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div class="flex-grow-1">
                                        <div class="d-flex align-items-center mb-1">
                                            <span class="badge bg-{{ 'success' if item.status == 'Approved' else 'danger' if item.status == 'Rejected' else 'warning' }} me-2">
                                                {{ item.status }}
                                            </span>
                                            <strong>{{ item.employee }}</strong>
                                        </div>
                                        <div class="text-muted small">
                                            <i class="fas fa-tag me-1"></i>{{ item.category }}
                                            <span class="mx-2">•</span>
                                            <i class="fas fa-coins me-1"></i>{{ item.points }} points
                                        </div>
                                    </div>
                                    <div class="text-end text-muted small">
                                        {{ item.event_date if item.event_date else 'N/A' }}
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        {% else %}
                        <div class="text-center text-muted py-4">
                            <i class="fas fa-inbox fa-3x mb-3 d-block opacity-25"></i>
                            <p>No activity yet.</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Categories Section -->
            <div class="col-lg-4 mb-4">
                <div class="card shadow-sm border-0">
                    <div class="card-header text-white" style="background: linear-gradient(135deg, #17a2b8 0%, #20c9e0 100%); border-radius: 8px 8px 0 0;">
                        <h5 class="mb-0">
                            <i class="fas fa-th-large me-2"></i> Categories
                        </h5>
                    </div>
                    <div class="card-body p-0">
                        {% if ta_categories %}
                            <div class="list-group list-group-flush">
                                {% for category in ta_categories %}
                                {% set pending_count = validator_requests|selectattr('category_name', 'equalto', category.name)|list|length if validator_requests else 0 %}
                                {% set history_count = history_data|selectattr('category', 'equalto', category.name)|list|length if history_data else 0 %}
                                {% set total_count = pending_count + history_count %}
                                <div class="list-group-item d-flex justify-content-between align-items-center">
                                    <div>
                                        <i class="fas fa-tag text-primary me-2"></i>
                                        <span>{{ category.name }}</span>
                                    </div>
                                    <span class="badge bg-primary rounded-pill">
                                        {{ total_count }}
                                    </span>
                                </div>
                                {% endfor %}
                            </div>
                        {% else %}
                            <div class="p-4 text-center text-muted">
                                <i class="fas fa-folder-open fa-3x mb-3"></i>
                                <p>No categories available</p>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Review Requests Tab -->
    <div class="tab-content-section" id="review-tab">
        <div class="card shadow-sm border-0">
            <div class="card-header" style="background-color: #2c5aa0; padding: 15px 20px;">
                <h5 class="mb-0 text-white" style="font-weight: 600;">
                    <i class="fas fa-check-square"></i> Review Pending Requests
                </h5>
            </div>
            <div class="card-body p-4" style="background-color: #ffffff;">
                {% if validator_requests %}
                <form method="POST" action="{{ url_for('ta.validator_dashboard') }}" id="reviewForm">
                    <input type="hidden" name="action_type" id="action_type">
                    <input type="hidden" name="current_tab" id="current_tab_field" value="review">
                    
                    <!-- Pagination Controls Top -->
                    <div class="row mb-3 align-items-center">
                        <div class="col-md-6">
                            <div class="d-flex align-items-center">
                                <span class="me-2 small">Show</span>
                                <select class="form-select form-select-sm" style="width: 80px;" id="reviewPageSize" onchange="changeReviewPageSize()">
                                    <option value="10" selected>10</option>
                                    <option value="25">25</option>
                                    <option value="50">50</option>
                                </select>
                                <span class="ms-2 small">entries</span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="d-flex gap-2 align-items-center justify-content-end">
                                <span class="small">Search:</span>
                                <input type="text" class="form-control form-control-sm" placeholder="Search..." id="reviewSearchInput" onkeyup="searchReviewTable()" onkeydown="if(event.key === 'Enter') event.preventDefault();" style="max-width: 200px;">
                            </div>
                        </div>
                    </div>

                    
                    <div class="table-responsive" style="max-height: 500px; overflow-y: auto;">
                        <table class="table table-hover mb-0" style="font-size: 0.9rem;" id="reviewRequestsTable">
                            <thead style="position: sticky; top: 0; z-index: 10; background-color: #f8f9fa;">
                                <tr style="border-bottom: 2px solid #dee2e6;">
                                    <th style="width: 50px; padding: 12px 8px; white-space: nowrap;"><input type="checkbox" id="selectAll"></th>
                                    <th style="width: 120px; padding: 12px 8px; font-weight: 600; color: #495057; white-space: nowrap; text-transform: uppercase; font-size: 0.75rem;">EVENT DATE</th>
                                    <th style="width: 180px; padding: 12px 8px; font-weight: 600; color: #495057; white-space: nowrap; text-transform: uppercase; font-size: 0.75rem;">EMPLOYEE</th>
                                    <th style="width: 130px; padding: 12px 8px; font-weight: 600; color: #495057; white-space: nowrap; text-transform: uppercase; font-size: 0.75rem; text-align: center;">SUBMITTED BY</th>
                                    <th style="width: 160px; padding: 12px 8px; font-weight: 600; color: #495057; white-space: nowrap; text-transform: uppercase; font-size: 0.75rem;">CATEGORY</th>
                                    <th style="width: 130px; padding: 12px 8px; font-weight: 600; color: #495057; white-space: nowrap; text-transform: uppercase; font-size: 0.75rem; text-align: center;">POINTS</th>
                                    <th style="width: 150px; padding: 12px 8px; font-weight: 600; color: #495057; white-space: nowrap; text-transform: uppercase; font-size: 0.75rem; text-align: center;">REQUEST NOTES</th>
                                    <th style="width: 130px; padding: 12px 8px; font-weight: 600; color: #495057; white-space: nowrap; text-transform: uppercase; font-size: 0.75rem; text-align: center;">ACTIONS</th>
                                </tr>
                            </thead>
                            <tbody id="reviewRequestsBody">
                                {% for req in validator_requests %}
                                <tr class="review-row">
                                    <td style="padding: 10px 8px;"><input type="checkbox" name="selected_requests" value="{{ req.request_id }}"></td>
                                    <td style="padding: 10px 8px;">{{ req.event_date }}</td>
                                    <td style="padding: 10px 8px;">{{ req.employee_name }} ({{ req.employee_id }})</td>
                                    <td style="padding: 10px 8px; text-align: center;">
                                        {% set updater_lower = req.updater_name|lower if req.updater_name else '' %}
                                        {% if 'self' in updater_lower or 'employee' in updater_lower %}
                                        <span class="badge" style="background-color: #6c757d; color: white; padding: 5px 10px; -webkit-border-radius: 4px; -moz-border-radius: 4px; border-radius: 4px; font-size: 11px; font-weight: 600;">{{ req.updater_name }}</span>
                                        {% elif 'hr' in updater_lower %}
                                        <span class="badge" style="background-color: #0d6efd; color: white; padding: 5px 10px; -webkit-border-radius: 4px; -moz-border-radius: 4px; border-radius: 4px; font-size: 11px; font-weight: 600;">{{ req.updater_name }}</span>
                                        {% elif 'pmo' in updater_lower %}
                                        <span class="badge" style="background-color: #198754; color: white; padding: 5px 10px; -webkit-border-radius: 4px; -moz-border-radius: 4px; border-radius: 4px; font-size: 11px; font-weight: 600;">{{ req.updater_name }}</span>
                                        {% elif 'ta' in updater_lower or 'talent' in updater_lower %}
                                        <span class="badge" style="background-color: #fd7e14; color: white; padding: 5px 10px; -webkit-border-radius: 4px; -moz-border-radius: 4px; border-radius: 4px; font-size: 11px; font-weight: 600;">{{ req.updater_name }}</span>
                                        {% elif 'ld' in updater_lower or 'l&d' in updater_lower or 'learning' in updater_lower %}
                                        <span class="badge" style="background-color: #6f42c1; color: white; padding: 5px 10px; -webkit-border-radius: 4px; -moz-border-radius: 4px; border-radius: 4px; font-size: 11px; font-weight: 600;">{{ req.updater_name }}</span>
                                        {% else %}
                                        <span class="badge" style="background-color: #fd7e14; color: white; padding: 5px 10px; -webkit-border-radius: 4px; -moz-border-radius: 4px; border-radius: 4px; font-size: 11px; font-weight: 600;">{{ req.updater_name }}</span>
                                        {% endif %}
                                    </td>
                                    <td style="padding: 10px 8px;">{{ req.category_name }}</td>
                                    <td style="padding: 10px 8px; text-align: center;">{{ req.points }} pts</td>
                                    <td style="padding: 10px 8px; text-align: center;">
                                        <button type="button" class="btn btn-sm btn-info view-notes-btn" style="padding: 4px 12px; white-space: nowrap;" 
                                                data-notes="{{ (req.notes if req.notes else 'No notes provided') | replace('"', '&quot;') | replace("'", '&#39;') }}" 
                                                title="View Notes">
                                            View
                                        </button>
                                    </td>
                                    <td style="padding: 10px 8px; text-align: center;">
                                        <button type="button" class="btn btn-sm btn-success me-1" 
                                                onclick="singleAction('{{ req.request_id }}', 'approve')" style="padding: 4px 8px;">
                                            <i class="fas fa-check"></i>
                                        </button>
                                        <button type="button" class="btn btn-sm btn-danger" 
                                                onclick="singleAction('{{ req.request_id }}', 'reject')" style="padding: 4px 8px;">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    <!-- Pagination Bottom -->
                    <div class="d-flex justify-content-between align-items-center mt-3">
                        <div class="small text-muted" id="reviewInfoBottom">Showing 1 to 10 of {{ validator_requests|length }} entries</div>
                        <nav>
                            <ul class="pagination pagination-sm mb-0" id="reviewPagination">
                                <li class="page-item disabled"><a class="page-link" href="#" onclick="changeReviewPage('prev'); return false;">Previous</a></li>
                                <li class="page-item active"><a class="page-link" href="#" onclick="changeReviewPage(1); return false;">1</a></li>
                                <li class="page-item"><a class="page-link" href="#" onclick="changeReviewPage('next'); return false;">Next</a></li>
                            </ul>
                        </nav>
                    </div>
                    
                    <!-- Bulk Action Buttons -->
                    <div class="d-flex justify-content-end gap-2 mt-3">
                        <button type="button" class="btn btn-success" onclick="bulkAction('bulk_approve')">
                            <i class="fas fa-check me-2"></i>Approve Selected
                        </button>
                        <button type="button" class="btn btn-danger" onclick="bulkAction('bulk_reject')">
                            <i class="fas fa-times me-2"></i>Reject Selected
                        </button>
                    </div>
                </form>
                {% else %}
                <div class="alert alert-info text-center">
                    <i class="fas fa-info-circle fa-3x mb-3"></i>
                    <h5>No Pending Requests</h5>
                    <p class="mb-0">All requests have been reviewed</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- History Tab -->
    <div class="tab-content-section" id="history-tab">
        <div class="card shadow-sm border-0">
            <div class="card-header" style="background-color: #2c5aa0; padding: 15px 20px;">
                <h5 class="mb-0 text-white" style="font-weight: 600;">
                    <i class="fas fa-history"></i> Action History
                </h5>
            </div>
            <div class="card-body p-4" style="overflow: visible;">
                <!-- Filters Row -->
                <div class="row mb-3 g-2" style="position: relative; z-index: 100;">
                    <div class="col-md-2">
                        <label class="form-label small text-muted mb-1">Year</label>
                        <select class="form-select form-select-sm" id="historyYearFilter" style="position: relative; z-index: 101;">
                            <option value="">All Years</option>
                            {# Calculate fiscal years from data - fiscal year runs Apr-Mar #}
                            {% set fiscal_years = [] %}
                            {% for h in history_data %}
                            {% if h.event_date and h.event_date != 'N/A' %}
                            {% set month = h.event_date.split('-')[1]|int %}
                            {% set year = h.event_date.split('-')[2]|int %}
                            {% set fiscal_year = year - 1 if month in [1,2,3] else year %}
                            {% if fiscal_year not in fiscal_years %}
                            {% set _ = fiscal_years.append(fiscal_year) %}
                            {% endif %}
                            {% endif %}
                            {% endfor %}
                            {% for fy in fiscal_years|sort(reverse=True) %}
                            <option value="{{ fy }}">{{ fy }}-{{ ((fy|int + 1)|string)[-2:] }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label small text-muted mb-1">Quarter</label>
                        <select class="form-select form-select-sm" id="historyQuarterFilter" style="position: relative; z-index: 101;">
                            <option value="">All Quarters</option>
                            <!-- Quarters populated dynamically from data via JS -->
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label small text-muted mb-1">Category</label>
                        <select class="form-select form-select-sm" id="historyCategoryFilter" style="position: relative; z-index: 101;">
                            <option value="">All Categories</option>
                            {% if history_data %}
                                {% set categories = [] %}
                                {% for record in history_data %}
                                    {% if record.category and record.category not in categories %}
                                        {% set _ = categories.append(record.category) %}
                                    {% endif %}
                                {% endfor %}
                                {% for cat in categories|sort %}
                                <option value="{{ cat }}">{{ cat }}</option>
                                {% endfor %}
                            {% endif %}
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label small text-muted mb-1">Grade</label>
                        <select class="form-select form-select-sm" id="historyGradeFilter" style="position: relative; z-index: 101;">
                            <option value="">All</option>
                            {% for grade in grades %}
                            <option value="{{ grade }}">{{ grade }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label small text-muted mb-1">Status</label>
                        <select class="form-select form-select-sm" id="historyStatusFilter" style="position: relative; z-index: 101;">
                            <option value="">All</option>
                            {% if history_data %}
                                {% set statuses = [] %}
                                {% for record in history_data %}
                                    {% if record.status not in statuses %}
                                        {% set _ = statuses.append(record.status) %}
                                    {% endif %}
                                {% endfor %}
                                {% if 'Approved' in statuses %}
                                <option value="Approved">Approved</option>
                                {% endif %}
                                {% if 'Rejected' in statuses %}
                                <option value="Rejected">Rejected</option>
                                {% endif %}
                                {% if 'Pending' in statuses %}
                                <option value="Pending">Pending</option>
                                {% endif %}
                            {% endif %}
                        </select>
                    </div>
                    <div class="col-md-2 d-flex align-items-end gap-1">
                        <button class="btn btn-sm btn-primary" onclick="filterHistoryTable()" style="flex: 1;">
                            <i class="fas fa-filter"></i> Apply
                        </button>
                        <button class="btn btn-sm btn-outline-secondary" onclick="resetHistoryFilters()" style="flex: 1;">
                            <i class="fas fa-redo"></i> Reset
                        </button>
                    </div>
                </div>

                <div class="row mb-3 align-items-center" style="position: relative; z-index: 50;">
                    <div class="col-md-3">
                        <div class="d-flex align-items-center">
                            <span class="me-2 small">Show</span>
                            <select class="form-select form-select-sm" style="width: 80px;" id="historyPageSize" onchange="changeHistoryPageSize()">
                                <option value="10" selected>10</option>
                                <option value="25">25</option>
                                <option value="50">50</option>
                            </select>
                            <span class="ms-2 small">entries</span>
                        </div>
                    </div>
                    <div class="col-md-6"></div>
                    <div class="col-md-3">
                        <div class="d-flex gap-2 align-items-center justify-content-end">
                            <span class="small">Search:</span>
                            <input type="text" class="form-control form-control-sm" placeholder="Search..." id="historySearchInput" onkeyup="filterHistoryTable()" style="max-width: 200px;">
                        </div>
                    </div>
                </div>

                <!-- Table -->
                <div class="table-responsive" style="max-height: 400px; overflow-y: auto; overflow-x: visible; position: relative; z-index: 1;">
                    <table class="table table-hover mb-0" style="font-size: 0.9rem;">
                        <thead style="position: sticky; top: 0; z-index: 5; background-color: #f8f9fa;">
                            <tr style="border-bottom: 2px solid #dee2e6;">
                                <th style="padding: 12px 8px; font-weight: 600; color: #495057; white-space: nowrap; text-transform: uppercase; font-size: 0.75rem;">EVENT DATE</th>
                                <th style="padding: 12px 8px; font-weight: 600; color: #495057; white-space: nowrap; text-transform: uppercase; font-size: 0.75rem;">EMPLOYEE</th>
                                <th style="padding: 12px 8px; font-weight: 600; color: #495057; white-space: nowrap; text-transform: uppercase; font-size: 0.75rem;">DEPARTMENT</th>
                                <th style="padding: 12px 8px; font-weight: 600; color: #495057; white-space: nowrap; text-transform: uppercase; font-size: 0.75rem;">GRADE</th>
                                <th style="padding: 12px 8px; font-weight: 600; color: #495057; white-space: nowrap; text-transform: uppercase; font-size: 0.75rem;">QUARTER</th>
                                <th style="padding: 12px 8px; font-weight: 600; color: #495057; white-space: nowrap; text-transform: uppercase; font-size: 0.75rem;">CATEGORY</th>
                                <th style="padding: 12px 8px; font-weight: 600; color: #495057; white-space: nowrap; text-transform: uppercase; font-size: 0.75rem; text-align: center;">POINTS</th>
                                <th style="padding: 12px 8px; font-weight: 600; color: #495057; white-space: nowrap; text-transform: uppercase; font-size: 0.75rem; text-align: center;">SUBMITTED BY</th>
                                <th style="padding: 12px 8px; font-weight: 600; color: #495057; white-space: nowrap; text-transform: uppercase; font-size: 0.75rem; text-align: center;">STATUS</th>
                                <th style="padding: 12px 8px; font-weight: 600; color: #495057; white-space: nowrap; text-transform: uppercase; font-size: 0.75rem; text-align: center;">NOTES</th>
                            </tr>
                        </thead>
                        <tbody id="historyTableBody">
                            {% if history_data %}
                            {% for h in history_data %}
                            {% set month = h.event_date.split('-')[1]|int if h.event_date and h.event_date != 'N/A' else 0 %}
                            {% set year = h.event_date.split('-')[2]|int if h.event_date and h.event_date != 'N/A' else 0 %}
                            {% set quarter = 'Q1' if month in [4,5,6] else 'Q2' if month in [7,8,9] else 'Q3' if month in [10,11,12] else 'Q4' if month in [1,2,3] else '' %}
                            {% set fiscal_year = (year - 1) if (year and month in [1,2,3]) else year %}
                            <tr class="history-row"
                                data-year="{{ fiscal_year if fiscal_year else '' }}"
                                data-quarter="{{ quarter }}"
                                data-category="{{ h.category }}"
                                data-grade="{{ h.grade }}"
                                data-status="{{ h.status }}">
                                <td style="padding: 10px 8px; white-space: nowrap;">{{ h.event_date }}</td>
                                <td style="padding: 10px 8px; white-space: nowrap;">
                                    <strong>{{ h.employee }}</strong>
                                    {% if h.employee_id and h.employee_id != 'N/A' %}
                                    <br><small class="text-muted">{{ h.employee_id }}</small>
                                    {% endif %}
                                </td>
                                <td style="padding: 10px 8px;">{{ h.department if h.department else 'N/A' }}</td>
                                <td style="padding: 10px 8px;"><span class="badge bg-secondary">{{ h.grade }}</span></td>
                                <td style="padding: 10px 8px; text-align: center;">
                                    <span class="badge" style="background-color: #17a2b8; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px;">{{ quarter if quarter else 'N/A' }}</span>
                                </td>
                                <td style="padding: 10px 8px;">{{ h.category }}</td>
                                <td style="padding: 10px 8px; text-align: center; font-weight: 600;">{{ h.points }}</td>
                                <td style="padding: 10px 8px; text-align: center;">
                                    {% if h.updater_name %}
                                    {% set updater_lower = h.updater_name|lower %}
                                    {% if 'self' in updater_lower or 'employee' in updater_lower %}
                                    <span class="badge" style="background-color: #6c757d; color: white; padding: 5px 10px; -webkit-border-radius: 4px; -moz-border-radius: 4px; border-radius: 4px; font-size: 11px; font-weight: 600;">{{ h.updater_name }}</span>
                                    {% elif 'hr' in updater_lower %}
                                    <span class="badge" style="background-color: #0d6efd; color: white; padding: 5px 10px; -webkit-border-radius: 4px; -moz-border-radius: 4px; border-radius: 4px; font-size: 11px; font-weight: 600;">{{ h.updater_name }}</span>
                                    {% elif 'pmo' in updater_lower %}
                                    <span class="badge" style="background-color: #198754; color: white; padding: 5px 10px; -webkit-border-radius: 4px; -moz-border-radius: 4px; border-radius: 4px; font-size: 11px; font-weight: 600;">{{ h.updater_name }}</span>
                                    {% elif 'ta' in updater_lower or 'talent' in updater_lower %}
                                    <span class="badge" style="background-color: #fd7e14; color: white; padding: 5px 10px; -webkit-border-radius: 4px; -moz-border-radius: 4px; border-radius: 4px; font-size: 11px; font-weight: 600;">{{ h.updater_name }}</span>
                                    {% elif 'ld' in updater_lower or 'l&d' in updater_lower or 'learning' in updater_lower %}
                                    <span class="badge" style="background-color: #6f42c1; color: white; padding: 5px 10px; -webkit-border-radius: 4px; -moz-border-radius: 4px; border-radius: 4px; font-size: 11px; font-weight: 600;">{{ h.updater_name }}</span>
                                    {% else %}
                                    <span class="badge" style="background-color: #fd7e14; color: white; padding: 5px 10px; -webkit-border-radius: 4px; -moz-border-radius: 4px; border-radius: 4px; font-size: 11px; font-weight: 600;">{{ h.updater_name }}</span>
                                    {% endif %}
                                    {% else %}
                                    <span class="text-muted small">Unknown</span>
                                    {% endif %}
                                </td>
                                <td style="padding: 10px 8px; text-align: center;">
                                    <span class="badge" style="background-color: {{ '#28a745' if h.status == 'Approved' else '#dc3545' }}; color: #fff; font-weight: 600; padding: 4px 12px;">
                                        {{ h.status }}
                                    </span>
                                </td>
                                <td style="padding: 10px 8px; text-align: center;">
                                    <button type="button" class="btn btn-sm view-history-notes-btn" 
                                            style="padding: 6px 16px; background-color: #17a2b8; color: #ffffff; border: 1px solid #17a2b8; border-radius: 4px; font-weight: 500; cursor: pointer; display: inline-block; text-align: center; white-space: nowrap; vertical-align: middle; user-select: none; line-height: 1.5; transition: all 0.15s ease-in-out;" 
                                            data-notes="{{ (h.notes if h.notes else 'No notes') | replace('"', '&quot;') | replace("'", '&#39;') }}"
                                            data-status="{{ h.status }}"
                                            data-hr-modified="{{ 'true' if h.hr_modified else 'false' }}"
                                            title="View Notes"
                                            onmouseover="this.style.backgroundColor='#138496'; this.style.borderColor='#117a8b';"
                                            onmouseout="this.style.backgroundColor='#17a2b8'; this.style.borderColor='#17a2b8';">
                                        <i class="fas fa-eye"></i> View
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                            {% else %}
                            <tr>
                                <td colspan="10" class="text-center text-muted py-4">No entries found</td>
                            </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>

                <!-- Pagination -->
                <div class="d-flex justify-content-between align-items-center mt-3">
                    <div class="small text-muted" id="historyInfo">Showing 1 to 10 of entries</div>
                    <nav>
                        <ul class="pagination pagination-sm mb-0" id="historyPagination">
                            <li class="page-item disabled"><a class="page-link" href="#">Previous</a></li>
                            <li class="page-item active"><a class="page-link" href="#">1</a></li>
                            <li class="page-item"><a class="page-link" href="#">Next</a></li>
                        </ul>
                    </nav>
                </div>
            </div>
        </div>
    </div>

    <!-- Notes Modal -->
    <div class="modal fade" id="notesModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header" style="background: #0d6efd; color: white;">
                    <h5 class="modal-title"><i class="fas fa-sticky-note me-2"></i>Request Details</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" style="max-height: 70vh; overflow-y: auto; padding: 20px;">
                    <div class="mb-2"><strong id="notesLabel">Notes:</strong></div>
                    <div id="modalNotes" style="white-space: pre-wrap; word-wrap: break-word; font-size: 1rem; line-height: 1.8; background: #f8f9fa; padding: 20px; border-radius: 8px; border-left: 4px solid #17a2b8;"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Action Confirmation Modal -->
    <div class="modal fade" id="actionConfirmModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header" id="actionModalHeader">
                    <h5 class="modal-title" id="actionModalTitle"></h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <form id="actionConfirmForm">
                    <div class="modal-body">
                        <input type="hidden" id="action_request_id">
                        <input type="hidden" id="action_type_value">
                        
                        <div class="mb-3">
                            <p id="actionConfirmMessage" class="mb-3"></p>
                        </div>
                        
                        <div class="mb-3">
                            <label for="action_notes" class="form-label fw-bold">
                                Notes <span class="text-danger">*</span>
                            </label>
                            <textarea class="form-control" id="action_notes" name="notes" rows="4" 
                                      placeholder="Enter your notes for this action..." required></textarea>
                            <small class="text-muted">Please provide a reason or comment for this action</small>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            <i class="fas fa-times me-1"></i> Cancel
                        </button>
                        <button type="submit" class="btn" id="actionConfirmBtn">
                            <i class="fas fa-check me-1"></i> Confirm
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Bulk Confirmation Modal -->
    <div class="modal fade" id="bulkConfirmModal" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content" style="max-height: 90vh; display: -webkit-box; display: -webkit-flex; display: -moz-box; display: -ms-flexbox; display: flex; -webkit-box-orient: vertical; -webkit-flex-direction: column; -ms-flex-direction: column; flex-direction: column;">
                <div class="modal-header" id="bulkModalHeader" style="-webkit-flex-shrink: 0; -ms-flex-negative: 0; flex-shrink: 0;">
                    <h5 class="modal-title" id="bulkModalTitle"></h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" style="-webkit-flex: 1 1 auto; -ms-flex: 1 1 auto; flex: 1 1 auto; overflow-y: auto; overflow-x: hidden; -webkit-overflow-scrolling: touch;">
                    <div class="alert alert-info mb-3" id="bulkSummary"></div>
                    
                    <h6 class="mb-3">Selected Requests:</h6>
                    <div class="table-responsive" style="overflow-x: auto; overflow-y: visible;">
                        <table class="table table-sm table-hover">
                            <thead class="table-light" style="position: -webkit-sticky; position: sticky; top: 0; z-index: 1; background-color: #f8f9fa;">
                                <tr>
                                    <th>Employee</th>
                                    <th>Category</th>
                                    <th>Points</th>
                                    <th>Date</th>
                                </tr>
                            </thead>
                            <tbody id="bulkRequestsList"></tbody>
                        </table>
                    </div>
                    
                    <div class="mt-3" id="bulkNotesSection" style="display: none;">
                        <label for="bulk_notes" class="form-label fw-bold">
                            Notes <span class="text-danger">*</span>
                        </label>
                        <textarea class="form-control" id="bulk_notes" rows="3" 
                                  placeholder="Enter notes for this bulk action..." required></textarea>
                    </div>
                </div>
                <div class="modal-footer" style="-webkit-flex-shrink: 0; -ms-flex-negative: 0; flex-shrink: 0;">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i> Cancel
                    </button>
                    <button type="button" class="btn" id="bulkConfirmBtn" onclick="confirmBulkAction()">
                        <i class="fas fa-check me-1"></i> Confirm
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Loading Overlay -->
<div id="loadingOverlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; justify-content: center; align-items: center;">
    <div style="text-align: center; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
        <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-3 mb-0" style="font-size: 1.1rem; color: #333;">Processing your request...</p>
    </div>
</div>

<!-- Notification Modal -->
<div class="modal fade" id="notificationModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered modal-sm">
        <div class="modal-content" style="border-radius: 10px; border: none; box-shadow: 0 5px 15px rgba(0,0,0,0.3);">
            <div class="modal-header border-0 pb-0" id="notificationModalHeader" style="background-color: #dc3545; color: white; border-radius: 10px 10px 0 0;">
                <h6 class="modal-title" id="notificationModalTitle" style="font-weight: 600;">
                    <i class="fas fa-exclamation-circle me-2"></i>Error
                </h6>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center py-4">
                <p id="notificationModalMessage" class="mb-0" style="font-size: 0.95rem; color: #333;"></p>
            </div>
            <div class="modal-footer border-0 pt-0 justify-content-center">
                <button type="button" class="btn btn-primary px-4" data-bs-dismiss="modal" style="border-radius: 20px;">OK</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Duplicate Detection Module -->
<script src="{{ url_for('static', filename='js/duplicate_detection.js') }}"></script>

<style>
    /* Tab visibility control - ensure only active tab shows */
    .tab-content-section {
        display: none !important;
    }
    .tab-content-section.active {
        display: block !important;
    }
    
    /* Stat card styling */
    .border-left-warning {
        border-left: 4px solid #f6c23e;
    }
    .border-left-success {
        border-left: 4px solid #1cc88a;
    }
    .border-left-danger {
        border-left: 4px solid #e74a3b;
    }
    .text-xs {
        font-size: 0.7rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    .h5 {
        font-size: 1.75rem;
        font-weight: 700;
    }
    
    /* Timeline styling */
    .timeline {
        max-height: 400px;
        overflow-y: auto;
    }
    .timeline-item {
        transition: all 0.2s;
        padding: 0.75rem;
        border-radius: 6px;
    }
    .timeline-item:hover {
        background-color: #f8f9fa;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    .opacity-25 {
        opacity: 0.25 !important;
    }
    
    /* ========================================
       Cross-browser single scrollbar fix for bulk modal
       ======================================== */
    #bulkConfirmModal .modal-body {
        /* Firefox scrollbar */
        scrollbar-width: thin;
        scrollbar-color: #888 #f1f1f1;
    }
    
    /* Webkit scrollbar (Chrome, Safari, Edge, Opera) */
    #bulkConfirmModal .modal-body::-webkit-scrollbar {
        width: 8px;
    }
    
    #bulkConfirmModal .modal-body::-webkit-scrollbar-track {
        background: #f1f1f1;
        -webkit-border-radius: 4px;
        border-radius: 4px;
    }
    
    #bulkConfirmModal .modal-body::-webkit-scrollbar-thumb {
        background: #888;
        -webkit-border-radius: 4px;
        border-radius: 4px;
    }
    
    #bulkConfirmModal .modal-body::-webkit-scrollbar-thumb:hover {
        background: #555;
    }
    
    /* IE/Edge legacy scrollbar */
    #bulkConfirmModal .modal-body {
        -ms-overflow-style: -ms-autohiding-scrollbar;
    }
    
    /* ========================================
       History filter dropdown z-index fix
       ======================================== */
    #history-tab .form-select {
        position: relative;
        z-index: 101;
    }
    
    #history-tab .row.mb-3 {
        position: relative;
        z-index: 100;
    }
    
    /* Table should be below filter dropdowns */
    #history-tab .table-responsive {
        position: relative;
        z-index: 1;
    }
    
    /* Sticky header should not overlap dropdown */
    #history-tab thead {
        z-index: 5 !important;
    }

    
    /* Cross-browser button compatibility */
    .view-notes-btn,
    .view-history-notes-btn {
        -webkit-appearance: button;
        -moz-appearance: button;
        appearance: button;
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
        background-color: #17a2b8 !important;
        color: #ffffff !important;
        border: 1px solid #17a2b8 !important;
        border-radius: 4px;
        padding: 6px 16px;
        font-weight: 500;
        cursor: pointer;
        display: inline-block;
        text-align: center;
        white-space: nowrap;
        vertical-align: middle;
        line-height: 1.5;
        transition: all 0.15s ease-in-out;
        -webkit-transition: all 0.15s ease-in-out;
        -moz-transition: all 0.15s ease-in-out;
        -o-transition: all 0.15s ease-in-out;
    }
    
    .view-notes-btn:hover,
    .view-history-notes-btn:hover {
        background-color: #138496 !important;
        border-color: #117a8b !important;
        color: #ffffff !important;
    }
    
    .view-notes-btn:focus,
    .view-history-notes-btn:focus {
        outline: 2px solid #17a2b8;
        outline-offset: 2px;
    }
    
    /* Ensure buttons work in Opera Mini */
    @media all and (-webkit-min-device-pixel-ratio:0) and (min-resolution: .001dpcm) {
        .view-notes-btn,
        .view-history-notes-btn {
            -webkit-appearance: none;
        }
    }
    
    /* Firefox specific fixes */
    @-moz-document url-prefix() {
        .view-notes-btn,
        .view-history-notes-btn {
            padding: 7px 16px;
        }
    }
    
    /* Edge specific fixes */
    @supports (-ms-ime-align:auto) {
        .view-notes-btn,
        .view-history-notes-btn {
            padding: 7px 16px;
        }
    }
</style>

<script>
// Store available quarters per year from data (e.g., {2024: ['Q4'], 2025: ['Q1', 'Q2', 'Q3', 'Q4']})
var historyQuartersByYear = {};
var quarterLabels = {'Q1': 'Q1 (Apr-Jun)', 'Q2': 'Q2 (Jul-Sep)', 'Q3': 'Q3 (Oct-Dec)', 'Q4': 'Q4 (Jan-Mar)'};

// ✅ HELPER: Update quarter options based on selected year - only show quarters with data for that year
function updateHistoryQuarterOptions(selectedYear) {
    const quarterSelect = document.getElementById('historyQuarterFilter');
    if (!quarterSelect) return;
    
    const currentValue = quarterSelect.value;
    quarterSelect.innerHTML = '<option value="">All Quarters</option>';
    
    var quarterOrder = ['Q1', 'Q2', 'Q3', 'Q4'];
    
    if (selectedYear && selectedYear !== '') {
        // Show only quarters that have data for the selected year
        const year = parseInt(selectedYear);
        const nextYear = year + 1;
        const quartersForYear = historyQuartersByYear[year] || [];
        
        quarterOrder.forEach(function(q) {
            if (quartersForYear.includes(q)) {
                var label = q === 'Q4' ? `${q} (Jan-Mar ${nextYear})` : `${q} (${quarterLabels[q].split('(')[1].split(')')[0]} ${year})`;
                quarterSelect.innerHTML += `<option value="${q}">${label}</option>`;
            }
        });
    } else {
        // Show all quarters that have data across all years
        var allQuarters = new Set();
        Object.values(historyQuartersByYear).forEach(function(quarters) {
            quarters.forEach(function(q) { allQuarters.add(q); });
        });
        
        quarterOrder.forEach(function(q) {
            if (allQuarters.has(q)) {
                quarterSelect.innerHTML += `<option value="${q}">${quarterLabels[q]}</option>`;
            }
        });
    }
    
    if (currentValue && quarterSelect.querySelector(`option[value="${currentValue}"]`)) {
        quarterSelect.value = currentValue;
    }
}

// Initialize quarter options on page load and add year change listener
document.addEventListener('DOMContentLoaded', function() {
    // Collect available quarters per year from history table rows
    document.querySelectorAll('.history-row').forEach(function(row) {
        var quarter = row.getAttribute('data-quarter');
        var year = row.getAttribute('data-year');
        if (quarter && quarter.trim() !== '' && year && year.trim() !== '') {
            var q = quarter.toUpperCase();
            var y = parseInt(year);
            if (!historyQuartersByYear[y]) {
                historyQuartersByYear[y] = [];
            }
            if (!historyQuartersByYear[y].includes(q)) {
                historyQuartersByYear[y].push(q);
            }
        }
    });
    
    const yearFilter = document.getElementById('historyYearFilter');
    if (yearFilter) {
        yearFilter.addEventListener('change', function() {
            updateHistoryQuarterOptions(this.value);
        });
        // Initialize quarter options
        updateHistoryQuarterOptions(yearFilter.value);
    }
});

let currentReviewPage = 1;
let reviewPageSize = 10;
let currentHistoryPage = 1;
let historyPageSize = 10;
let filteredHistoryRows = [];

function switchValidatorTab(tabName) {
    // Remove preload styles if they exist
    const preloadStyle = document.getElementById('tab-preload-style');
    if (preloadStyle) {
        preloadStyle.remove();
    }
    
    // Hide all tabs
    document.querySelectorAll('.tab-content-section').forEach(tab => {
        tab.classList.remove('active');
    });
    
    // Show selected tab
    const targetTab = document.getElementById(tabName + '-tab');
    if (targetTab) {
        targetTab.classList.add('active');
    }
    
    // Update sidebar active state
    document.querySelectorAll('.sidebar-nav-item.tab-link').forEach(link => {
        link.classList.remove('active');
    });
    const activeLink = document.querySelector(`[data-tab="${tabName}"]`);
    if (activeLink) {
        activeLink.classList.add('active');
    }
    
    // ✅ Update URL with ?tab= parameter (ensures refresh stays on same tab - RULE 2)
    const url = new URL(window.location);
    url.searchParams.set('tab', tabName);
    window.history.replaceState({}, '', url);
    
    // Save current tab to localStorage (backup mechanism)
    localStorage.setItem('ta_validator_current_tab', tabName);
    
    // ✅ Update hidden form field for tab preservation on form submit
    const currentTabField = document.getElementById('current_tab_field');
    if (currentTabField) {
        currentTabField.value = tabName;
    }
    
    // Scroll to top
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

// Override the base template's switchTab for this page
window.switchTab = switchValidatorTab;

// Initialize tabs on page load - Always start with Dashboard
(function() {
    // Wait for DOM to be ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initializeTabs);
    } else {
        // DOM is already ready
        initializeTabs();
    }
    
    function initializeTabs() {
        // Add click handlers to sidebar nav items
        document.querySelectorAll('.sidebar-nav-item.tab-link').forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                const tabName = this.getAttribute('data-tab');
                switchValidatorTab(tabName);
            });
        });
        
        // Dashboard switch detection and tab management
        const urlParams = new URLSearchParams(window.location.search);
        const urlTab = urlParams.get('tab');
        const lastDashboard = sessionStorage.getItem('last_dashboard');
        const currentDashboard = 'ta_validator';
        
        // ✅ FIX: Detect cross-dashboard navigation
        // Check both sessionStorage tracker AND referrer URL to catch all dashboard switches
        let isDashboardSwitch = false;
        
        if (lastDashboard !== null && lastDashboard !== currentDashboard) {
            // Coming from a tracked dashboard that's different
            isDashboardSwitch = true;
        } else if (document.referrer) {
            // Check if referrer is from a different dashboard path
            const referrerPath = new URL(document.referrer).pathname;
            const currentPath = window.location.pathname;
            // If referrer has a different dashboard path (not /ta/), it's a switch
            if (referrerPath.includes('/') && !referrerPath.includes('/ta/') && currentPath.includes('/ta/')) {
                isDashboardSwitch = true;
            }
        }
        
        // Always update current dashboard tracker
        sessionStorage.setItem('last_dashboard', currentDashboard);
        
        let activeTabName;
        
        if (isDashboardSwitch) {
            // Coming from a different dashboard → force overview tab
            activeTabName = 'overview';
            localStorage.removeItem('ta_validator_current_tab');
            const url = new URL(window.location);
            url.searchParams.set('tab', 'overview');
            window.history.replaceState({}, '', url);
        } else if (urlTab) {
            // URL has explicit tab parameter → use it
            const validTabs = ['overview', 'review', 'history'];
            activeTabName = validTabs.includes(urlTab) ? urlTab : 'overview';
        } else {
            // Same dashboard refresh → restore last active tab
            activeTabName = localStorage.getItem('ta_validator_current_tab') || 'overview';
        }
        
        // Remove all active states first
        document.querySelectorAll('.tab-content-section').forEach(tab => {
            tab.classList.remove('active');
        });
        document.querySelectorAll('.sidebar-nav-item.tab-link').forEach(link => {
            link.classList.remove('active');
        });
        
        // Activate the saved tab
        const activeTab = document.getElementById(activeTabName + '-tab');
        if (activeTab) {
            activeTab.classList.add('active');
        }
        const activeLink = document.querySelector('[data-tab="' + activeTabName + '"]');
        if (activeLink) {
            activeLink.classList.add('active');
        }
        
        // Update URL with tab parameter
        const url = new URL(window.location);
        url.searchParams.set('tab', activeTabName);
        window.history.replaceState({}, '', url);
    }
})();

// Additional initialization after DOM is fully loaded
document.addEventListener('DOMContentLoaded', function() {
    
    // ✅ Refresh Detector - Only clear on MANUAL refresh (F5 or Ctrl+R)
    // Method 1: Check navigation type
    const navigationEntries = performance.getEntriesByType('navigation');
    const isManualRefresh = navigationEntries.length > 0 && navigationEntries[0].type === 'reload';
    
    // Method 2: Check persistence flag (set by form submissions)
    const persistFlag = sessionStorage.getItem('ta_validator_persist_selections');
    
    // Method 3: Check if page was loaded via form submission (POST request)
    const isFormSubmission = persistFlag === 'true';
    
    // Decision logic:
    // 1. If persist flag exists -> Form submission -> Keep selections
    // 2. If manual refresh detected -> Clear selections
    // 3. Otherwise (new requests, navigation) -> Keep selections
    
    if (isFormSubmission) {
        // Form was submitted - definitely keep selections and clear the flag
        sessionStorage.removeItem('ta_validator_persist_selections');
        console.log('TA Validator: Form submission detected - keeping selections');
    } else if (isManualRefresh) {
        // Manual refresh detected (F5 or Ctrl+R) - clear selections
        localStorage.removeItem('ta_validator_selections');
        console.log('TA Validator: Manual refresh detected - clearing selections');
    } else {
        // New requests came in or normal navigation - keep selections
        console.log('TA Validator: Normal load - keeping selections');
    }
    
    // ✅ Reset history filters on page load (fixes browser form caching issue)
    // This ensures filters are cleared on refresh across all browsers
    const historyYearFilter = document.getElementById('historyYearFilter');
    const historyQuarterFilter = document.getElementById('historyQuarterFilter');
    const historyCategoryFilter = document.getElementById('historyCategoryFilter');
    const historyGradeFilter = document.getElementById('historyGradeFilter');
    const historyStatusFilter = document.getElementById('historyStatusFilter');
    const historySearchInput = document.getElementById('historySearchInput');
    
    if (historyYearFilter) historyYearFilter.value = '';
    if (historyQuarterFilter) historyQuarterFilter.value = '';
    if (historyCategoryFilter) historyCategoryFilter.value = '';
    if (historyGradeFilter) historyGradeFilter.value = '';
    if (historyStatusFilter) historyStatusFilter.value = '';
    if (historySearchInput) historySearchInput.value = '';
    
    // Initialize pagination to show only 10 records by default (only if review tab exists)
    if (document.getElementById('reviewRequestsBody')) {
        updateReviewPagination();
    }
    
    // Initialize history pagination on page load (only if history tab exists)
    if (document.getElementById('historyTableBody')) {
        // Initialize filtered rows with all rows
        filteredHistoryRows = Array.from(document.querySelectorAll('#historyTableBody .history-row'));
        updateHistoryPagination();
    }
    
    // Restore selected checkboxes from localStorage (always restore unless manually refreshed)
    const savedSelections = JSON.parse(localStorage.getItem('ta_validator_selections') || '[]');
    console.log('TA Validator: Restoring selections:', savedSelections);
    if (savedSelections.length > 0) {
        document.querySelectorAll('input[name="selected_requests"]').forEach(cb => {
            if (savedSelections.includes(cb.value)) {
                cb.checked = true;
            }
        });
        // Update select all checkbox state
        updateSelectAllCheckbox();
    }
    
    // Select all checkbox - only if it exists
    const selectAllCheckbox = document.getElementById('selectAll');
    if (selectAllCheckbox) {
        selectAllCheckbox.addEventListener('change', function() {
            // Only select checkboxes in visible rows (current page only)
            const rows = document.querySelectorAll('#reviewRequestsBody .review-row');
            rows.forEach(row => {
                // Check if row is visible (not hidden by pagination or search)
                if (!row.classList.contains('d-none') && row.style.display !== 'none') {
                    const checkbox = row.querySelector('input[name="selected_requests"]');
                    if (checkbox) {
                        checkbox.checked = selectAllCheckbox.checked;
                    }
                }
            });
            saveSelections();
        });
    }
    
    // Save selections when individual checkboxes change
    document.querySelectorAll('input[name="selected_requests"]').forEach(cb => {
        cb.addEventListener('change', function() {
            saveSelections();
            updateSelectAllCheckbox();
        });
    });
    
    // View notes buttons - using event delegation for dynamically loaded content with HR Portal styling
    document.body.addEventListener('click', function(e) {
        const btn = e.target.closest('.view-notes-btn') || e.target.closest('.view-history-notes-btn');
        if (btn) {
            e.preventDefault();
            e.stopPropagation();
            
            const notes = btn.getAttribute('data-notes');
            const status = btn.getAttribute('data-status');
            const hrModified = btn.getAttribute('data-hr-modified') === 'true';
            showNotesModal(notes, status, hrModified);
        }
    });
    
    // Fix aria-hidden accessibility warning by properly handling modal focus
    const notesModalElement = document.getElementById('notesModal');
    if (notesModalElement) {
        // When modal is about to be hidden, remove focus from any buttons inside
        notesModalElement.addEventListener('hide.bs.modal', function(e) {
            // Remove focus from any focused element inside the modal
            const focusedElement = notesModalElement.querySelector(':focus');
            if (focusedElement) {
                focusedElement.blur();
            }
        });
        
        // After modal is completely hidden, ensure focus returns to body
        notesModalElement.addEventListener('hidden.bs.modal', function(e) {
            document.body.focus();
        });
    }
});

// Save selected checkboxes to localStorage
function saveSelections() {
    const selected = [];
    document.querySelectorAll('input[name="selected_requests"]:checked').forEach(cb => {
        selected.push(cb.value);
    });
    localStorage.setItem('ta_validator_selections', JSON.stringify(selected));
    console.log('TA Validator: Saved selections:', selected);
}

// Update select all checkbox based on individual selections
function updateSelectAllCheckbox() {
    // Only consider checkboxes in visible rows (current page only)
    const rows = document.querySelectorAll('#reviewRequestsBody .review-row');
    let visibleCheckboxes = [];
    let checkedCount = 0;
    
    rows.forEach(row => {
        // Check if row is visible (not hidden by pagination or search)
        if (!row.classList.contains('d-none') && row.style.display !== 'none') {
            const checkbox = row.querySelector('input[name="selected_requests"]');
            if (checkbox) {
                visibleCheckboxes.push(checkbox);
                if (checkbox.checked) {
                    checkedCount++;
                }
            }
        }
    });
    
    const selectAllCheckbox = document.getElementById('selectAll');
    if (selectAllCheckbox && visibleCheckboxes.length > 0) {
        selectAllCheckbox.checked = visibleCheckboxes.length === checkedCount;
        selectAllCheckbox.indeterminate = checkedCount > 0 && checkedCount < visibleCheckboxes.length;
    }
}

// Function to show notification modal
function showNotification(title, message, type = 'error') {
    const modal = document.getElementById('notificationModal');
    const header = document.getElementById('notificationModalHeader');
    const titleElement = document.getElementById('notificationModalTitle');
    const messageElement = document.getElementById('notificationModalMessage');
    
    // Set colors and icons based on type
    const config = {
        error: { bg: '#dc3545', icon: 'fa-exclamation-circle', title: title || 'Error' },
        warning: { bg: '#ffc107', icon: 'fa-exclamation-triangle', title: title || 'Warning' },
        success: { bg: '#28a745', icon: 'fa-check-circle', title: title || 'Success' },
        info: { bg: '#17a2b8', icon: 'fa-info-circle', title: title || 'Information' }
    };
    
    const settings = config[type] || config.error;
    header.style.backgroundColor = settings.bg;
    titleElement.innerHTML = `<i class="fas ${settings.icon} me-2"></i>${settings.title}`;
    messageElement.textContent = message;
    
    const bsModal = new bootstrap.Modal(modal);
    bsModal.show();
}

// Function to show notes modal - works across all browsers with HR Portal styling
function showNotesModal(notes, status, hrModified) {
    const modalNotesElement = document.getElementById('modalNotes');
    const notesModalElement = document.getElementById('notesModal');
    
    if (modalNotesElement && notesModalElement) {
        // Add HR UPDATED prefix if modified by HR
        if (hrModified && notes && notes !== 'No notes available' && notes !== 'No notes') {
            modalNotesElement.textContent = 'HR UPDATED: ' + notes;
        } else {
            modalNotesElement.textContent = notes || 'No notes available';
        }
        
        // Update styling based on status
        const notesLabel = document.getElementById('notesLabel');
        if (status === 'Approved') {
            if (notesLabel) notesLabel.textContent = 'Approval Notes:';
            modalNotesElement.style.backgroundColor = '#e8f5e9';
            modalNotesElement.style.borderLeftColor = '#4caf50';
        } else if (status === 'Rejected') {
            if (notesLabel) notesLabel.textContent = 'Rejection Notes:';
            modalNotesElement.style.backgroundColor = '#ffebee';
            modalNotesElement.style.borderLeftColor = '#f44336';
        } else {
            if (notesLabel) notesLabel.textContent = 'Notes:';
            modalNotesElement.style.backgroundColor = '#f8f9fa';
            modalNotesElement.style.borderLeftColor = '#17a2b8';
        }
        
        // Get or create modal instance
        let modal = bootstrap.Modal.getInstance(notesModalElement);
        if (!modal) {
            modal = new bootstrap.Modal(notesModalElement, {
                backdrop: true,
                keyboard: true,
                focus: true
            });
        }
        
        modal.show();
    } else {
        showNotification('Error', 'Unable to display notes. Please refresh the page and try again.', 'error');
    }
}

function singleAction(requestId, action) {
    // Check for duplicates only for approve action (not reject)
    if (window.DuplicateDetection && action === 'approve') {
        window.DuplicateDetection.checkValidatorAction(requestId, action, function(isDuplicate, duplicateInfo) {
            if (isDuplicate) {
                // Show duplicate warning
                window.DuplicateDetection.showDuplicateWarning(
                    duplicateInfo,
                    function() {
                        // User confirmed - proceed with action
                        showTAActionModal(requestId, action);
                    },
                    function() {
                        // User cancelled - do nothing
                    }
                );
            } else {
                // No duplicate - proceed with action
                showTAActionModal(requestId, action);
            }
        });
    } else {
        // For reject or if DuplicateDetection not available, proceed directly
        showTAActionModal(requestId, action);
    }
}

function showTAActionModal(requestId, action) {
    const modal = document.getElementById('actionConfirmModal');
    const header = document.getElementById('actionModalHeader');
    const title = document.getElementById('actionModalTitle');
    const message = document.getElementById('actionConfirmMessage');
    const btn = document.getElementById('actionConfirmBtn');
    
    document.getElementById('action_request_id').value = requestId;
    document.getElementById('action_type_value').value = action;
    document.getElementById('action_notes').value = '';
    
    if (action === 'approve') {
        header.style.backgroundColor = '#28a745';
        header.style.color = 'white';
        title.innerHTML = '<i class="fas fa-check-circle me-2"></i>Approve Request';
        message.textContent = 'Are you sure you want to approve this request?';
        btn.className = 'btn btn-success';
        btn.innerHTML = '<i class="fas fa-check me-1"></i> Approve';
    } else {
        header.style.backgroundColor = '#dc3545';
        header.style.color = 'white';
        title.innerHTML = '<i class="fas fa-times-circle me-2"></i>Reject Request';
        message.textContent = 'Are you sure you want to reject this request?';
        btn.className = 'btn btn-danger';
        btn.innerHTML = '<i class="fas fa-times me-1"></i> Reject';
    }
    
    new bootstrap.Modal(modal).show();
}

const actionConfirmForm = document.getElementById('actionConfirmForm');
if (actionConfirmForm) {
    actionConfirmForm.addEventListener('submit', function(e) {
        e.preventDefault();
        const form = document.getElementById('reviewForm');
        const requestId = document.getElementById('action_request_id').value;
        const action = document.getElementById('action_type_value').value;
        const notes = document.getElementById('action_notes').value;
    
    // Show loading state on button
    const submitBtn = document.getElementById('actionConfirmBtn');
    const originalBtnContent = submitBtn.innerHTML;
    submitBtn.disabled = true;
    
    if (action === 'approve') {
        submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Approving...';
    } else {
        submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Rejecting...';
    }
    
    // Show loading overlay
    const overlay = document.getElementById('loadingOverlay');
    if (overlay) {
        overlay.style.display = 'flex';
    }
    
    form.querySelector('#action_type').value = 'single_action';
    
    // Add hidden fields for single action
    let requestIdInput = form.querySelector('input[name="request_id"]');
    if (!requestIdInput) {
        requestIdInput = document.createElement('input');
        requestIdInput.type = 'hidden';
        requestIdInput.name = 'request_id';
        form.appendChild(requestIdInput);
    }
    requestIdInput.value = requestId;
    
    let actionInput = form.querySelector('input[name="action"]');
    if (!actionInput) {
        actionInput = document.createElement('input');
        actionInput.type = 'hidden';
        actionInput.name = 'action';
        form.appendChild(actionInput);
    }
    actionInput.value = action;
    
    let notesInput = form.querySelector('input[name="response_notes"]');
    if (!notesInput) {
        notesInput = document.createElement('input');
        notesInput.type = 'hidden';
        notesInput.name = 'response_notes';
        form.appendChild(notesInput);
    }
    notesInput.value = notes;
    
    // ✅ Set persistence flag before form submission
    sessionStorage.setItem('ta_validator_persist_selections', 'true');
    console.log('TA Validator: Single action - setting persist flag');
    
    bootstrap.Modal.getInstance(document.getElementById('actionConfirmModal')).hide();
    form.submit();
    });
}

function bulkAction(actionType) {
    const checkboxes = document.querySelectorAll('input[name="selected_requests"]:checked');
    if (checkboxes.length === 0) {
        showNotification('No Selection', 'Please select at least one request', 'warning');
        return;
    }
    
    // Check for duplicates only for bulk approve (not bulk reject)
    if (window.DuplicateDetection && actionType === 'bulk_approve') {
        // Collect request IDs
        const requestIds = [];
        checkboxes.forEach(checkbox => {
            requestIds.push(checkbox.value);
        });
        
        // Use the bulk validator action check API
        window.DuplicateDetection.checkBulkValidatorAction(requestIds, actionType, function(duplicates) {
            if (duplicates.length > 0) {
                // Show bulk duplicates warning with action type for proper button labels
                window.DuplicateDetection.showBulkDuplicatesWarning(
                    duplicates,
                    function() {
                        // User confirmed - proceed with bulk action
                        showTABulkActionModal(actionType, checkboxes);
                    },
                    function() {
                        // User cancelled - do nothing
                    },
                    { actionType: actionType }
                );
            } else {
                // No duplicates - proceed with bulk action
                showTABulkActionModal(actionType, checkboxes);
            }
        });
    } else {
        // For bulk reject or if DuplicateDetection not available, proceed directly
        showTABulkActionModal(actionType, checkboxes);
    }
}

// ✅ REMOVED: checkTABulkDuplicates function - now using window.DuplicateDetection.checkBulkValidatorAction directly

function showTABulkActionModal(actionType, checkboxes) {
    const modal = document.getElementById('bulkConfirmModal');
    const header = document.getElementById('bulkModalHeader');
    const title = document.getElementById('bulkModalTitle');
    const summary = document.getElementById('bulkSummary');
    const btn = document.getElementById('bulkConfirmBtn');
    const notesSection = document.getElementById('bulkNotesSection');
    const notesLabel = notesSection.querySelector('label');
    
    if (actionType === 'bulk_approve') {
        header.style.backgroundColor = '#28a745';
        header.style.color = 'white';
        title.innerHTML = '<i class="fas fa-check-circle me-2"></i>Bulk Approve';
        summary.innerHTML = `<i class="fas fa-info-circle me-2"></i>You are about to approve <strong>${checkboxes.length}</strong> request(s).`;
        btn.className = 'btn btn-success';
        btn.innerHTML = '<i class="fas fa-check me-1"></i> Approve All';
        notesSection.style.display = 'block';
        notesLabel.innerHTML = 'Notes <span class="text-danger">*</span>';
        document.getElementById('bulk_notes').placeholder = 'Enter your notes for this action...';
        document.getElementById('bulk_notes').value = '';
    } else {
        header.style.backgroundColor = '#dc3545';
        header.style.color = 'white';
        title.innerHTML = '<i class="fas fa-times-circle me-2"></i>Bulk Reject';
        summary.innerHTML = `<i class="fas fa-exclamation-triangle me-2"></i>You are about to reject <strong>${checkboxes.length}</strong> request(s).`;
        btn.className = 'btn btn-danger';
        btn.innerHTML = '<i class="fas fa-times me-1"></i> Reject All';
        notesSection.style.display = 'block';
        notesLabel.innerHTML = 'Reason <span class="text-danger">*</span>';
        document.getElementById('bulk_notes').placeholder = 'Enter rejection reason...';
        document.getElementById('bulk_notes').value = '';
    }
    
    // Build list of selected requests
    const tbody = document.getElementById('bulkRequestsList');
    tbody.innerHTML = '';
    checkboxes.forEach(cb => {
        const row = cb.closest('tr');
        const cells = row.querySelectorAll('td');
        tbody.innerHTML += `<tr>
            <td>${cells[2].textContent}</td>
            <td>${cells[4].textContent}</td>
            <td>${cells[5].textContent}</td>
            <td>${cells[1].textContent}</td>
        </tr>`;
    });
    
    btn.setAttribute('data-action', actionType);
    new bootstrap.Modal(modal).show();
}

function confirmBulkAction() {
    const actionType = document.getElementById('bulkConfirmBtn').getAttribute('data-action');
    const form = document.getElementById('reviewForm');
    const notes = document.getElementById('bulk_notes').value.trim();
    
    // Validate notes for both approve and reject
    if (!notes) {
        showNotification('Notes Required', 'Please provide notes for this action', 'warning');
        return;
    }
    
    // Show loading state on button
    const submitBtn = document.getElementById('bulkConfirmBtn');
    const originalBtnContent = submitBtn.innerHTML;
    submitBtn.disabled = true;
    
    if (actionType === 'bulk_approve') {
        submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Approving...';
    } else {
        submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Rejecting...';
    }
    
    // Show loading overlay
    const overlay = document.getElementById('loadingOverlay');
    if (overlay) {
        overlay.style.display = 'flex';
    }
    
    // Add notes to form based on action type
    if (actionType === 'bulk_approve') {
        let notesInput = form.querySelector('input[name="response_notes"]');
        if (!notesInput) {
            notesInput = document.createElement('input');
            notesInput.type = 'hidden';
            notesInput.name = 'response_notes';
            form.appendChild(notesInput);
        }
        notesInput.value = notes;
    } else if (actionType === 'bulk_reject') {
        let notesInput = form.querySelector('input[name="rejection_notes"]');
        if (!notesInput) {
            notesInput = document.createElement('input');
            notesInput.type = 'hidden';
            notesInput.name = 'rejection_notes';
            form.appendChild(notesInput);
        }
        notesInput.value = notes;
    }
    
    form.querySelector('#action_type').value = actionType;
    
    // ✅ Set persistence flag before form submission
    sessionStorage.setItem('ta_validator_persist_selections', 'true');
    console.log('TA Validator: Bulk action - setting persist flag');
    
    bootstrap.Modal.getInstance(document.getElementById('bulkConfirmModal')).hide();
    form.submit();
}

// Review table pagination and search
function searchReviewTable() {
    const input = document.getElementById('reviewSearchInput').value.toLowerCase();
    const rows = document.querySelectorAll('#reviewRequestsBody .review-row');
    
    rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(input) ? '' : 'none';
    });
    
    currentReviewPage = 1;
    updateReviewPagination();
}

function changeReviewPageSize() {
    reviewPageSize = parseInt(document.getElementById('reviewPageSize').value);
    currentReviewPage = 1;
    updateReviewPagination();
}

function changeReviewPage(page) {
    const rows = Array.from(document.querySelectorAll('#reviewRequestsBody .review-row')).filter(r => r.style.display !== 'none');
    const totalPages = Math.ceil(rows.length / reviewPageSize);
    
    if (page === 'prev') currentReviewPage = Math.max(1, currentReviewPage - 1);
    else if (page === 'next') currentReviewPage = Math.min(totalPages, currentReviewPage + 1);
    else currentReviewPage = page;
    
    updateReviewPagination();
}

function updateReviewPagination() {
    const rows = Array.from(document.querySelectorAll('#reviewRequestsBody .review-row'));
    const visibleRows = rows.filter(r => r.style.display !== 'none');
    const totalPages = Math.ceil(visibleRows.length / reviewPageSize);
    
    // Hide all rows first
    rows.forEach(r => r.classList.add('d-none'));
    
    // Show current page rows
    const start = (currentReviewPage - 1) * reviewPageSize;
    const end = start + reviewPageSize;
    visibleRows.slice(start, end).forEach(r => r.classList.remove('d-none'));
    
    // Update info - check if element exists
    const infoElement = document.getElementById('reviewInfoBottom');
    if (infoElement) {
        infoElement.textContent = 
            `Showing ${start + 1} to ${Math.min(end, visibleRows.length)} of ${visibleRows.length} entries`;
    }
    
    // Update pagination buttons - check if element exists
    const pagination = document.getElementById('reviewPagination');
    if (!pagination) return;
    
    pagination.innerHTML = '';
    
    // Previous button
    const prevLi = document.createElement('li');
    prevLi.className = `page-item ${currentReviewPage === 1 ? 'disabled' : ''}`;
    prevLi.innerHTML = `<a class="page-link" href="#" onclick="changeReviewPage('prev'); return false;">Previous</a>`;
    pagination.appendChild(prevLi);
    
    // Page numbers
    for (let i = 1; i <= totalPages; i++) {
        if (i === 1 || i === totalPages || (i >= currentReviewPage - 1 && i <= currentReviewPage + 1)) {
            const li = document.createElement('li');
            li.className = `page-item ${i === currentReviewPage ? 'active' : ''}`;
            li.innerHTML = `<a class="page-link" href="#" onclick="changeReviewPage(${i}); return false;">${i}</a>`;
            pagination.appendChild(li);
        } else if (i === currentReviewPage - 2 || i === currentReviewPage + 2) {
            const li = document.createElement('li');
            li.className = 'page-item disabled';
            li.innerHTML = '<a class="page-link" href="#">...</a>';
            pagination.appendChild(li);
        }
    }
    
    // Next button
    const nextLi = document.createElement('li');
    nextLi.className = `page-item ${currentReviewPage === totalPages ? 'disabled' : ''}`;
    nextLi.innerHTML = `<a class="page-link" href="#" onclick="changeReviewPage('next'); return false;">Next</a>`;
    pagination.appendChild(nextLi);
    
    // Update select all checkbox state after page change
    updateSelectAllCheckbox();
}

// History table filtering and pagination
function filterHistoryTable() {
    const year = document.getElementById('historyYearFilter').value;
    const quarter = document.getElementById('historyQuarterFilter').value;
    const category = document.getElementById('historyCategoryFilter').value;
    const grade = document.getElementById('historyGradeFilter').value;
    const status = document.getElementById('historyStatusFilter').value;
    const searchText = document.getElementById('historySearchInput').value.toLowerCase();
    
    const rows = document.querySelectorAll('#historyTableBody .history-row');
    filteredHistoryRows = [];
    
    rows.forEach(row => {
        const matchYear = !year || row.getAttribute('data-year') === year;
        const matchQuarter = !quarter || row.getAttribute('data-quarter') === quarter;
        const matchCategory = !category || row.getAttribute('data-category') === category;
        const matchGrade = !grade || row.getAttribute('data-grade') === grade;
        const matchStatus = !status || row.getAttribute('data-status') === status;
        
        // Search in all text content
        const matchSearch = !searchText || row.textContent.toLowerCase().includes(searchText);
        
        const isVisible = matchYear && matchQuarter && matchCategory && matchGrade && matchStatus && matchSearch;
        
        if (isVisible) {
            filteredHistoryRows.push(row);
        }
        
        row.style.display = 'none'; // Hide all initially
    });
    
    // Reset to first page
    currentHistoryPage = 1;
    updateHistoryPagination();
}

function resetHistoryFilters() {
    document.getElementById('historyYearFilter').value = '';
    document.getElementById('historyQuarterFilter').value = '';
    document.getElementById('historyCategoryFilter').value = '';
    document.getElementById('historyGradeFilter').value = '';
    document.getElementById('historyStatusFilter').value = '';
    document.getElementById('historySearchInput').value = '';
    
    // Reset filtered rows to all rows
    filteredHistoryRows = Array.from(document.querySelectorAll('#historyTableBody .history-row'));
    currentHistoryPage = 1;
    updateHistoryPagination();
}

function changeHistoryPageSize() {
    historyPageSize = parseInt(document.getElementById('historyPageSize').value);
    currentHistoryPage = 1;
    updateHistoryPagination();
}

function updateHistoryPagination() {
    const totalRows = filteredHistoryRows.length;
    const totalPages = Math.ceil(totalRows / historyPageSize);
    
    // Hide all rows first
    document.querySelectorAll('#historyTableBody .history-row').forEach(row => {
        row.style.display = 'none';
    });
    
    // Show only current page rows
    const startIndex = (currentHistoryPage - 1) * historyPageSize;
    const endIndex = Math.min(startIndex + historyPageSize, totalRows);
    
    for (let i = startIndex; i < endIndex; i++) {
        if (filteredHistoryRows[i]) {
            filteredHistoryRows[i].style.display = '';
        }
    }
    
    // Update info text
    const infoText = totalRows === 0 
        ? 'Showing 0 to 0 of 0 entries'
        : `Showing ${startIndex + 1} to ${endIndex} of ${totalRows} entries`;
    document.getElementById('historyInfo').textContent = infoText;
    
    // Update pagination buttons
    const paginationEl = document.getElementById('historyPagination');
    let paginationHTML = '';
    
    // Previous button
    paginationHTML += `<li class="page-item ${currentHistoryPage === 1 ? 'disabled' : ''}">
        <a class="page-link" href="#" onclick="goToHistoryPage(${currentHistoryPage - 1}); return false;">Previous</a>
    </li>`;
    
    // Page numbers
    const maxVisiblePages = 5;
    let startPage = Math.max(1, currentHistoryPage - Math.floor(maxVisiblePages / 2));
    let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
    
    if (endPage - startPage < maxVisiblePages - 1) {
        startPage = Math.max(1, endPage - maxVisiblePages + 1);
    }
    
    for (let i = startPage; i <= endPage; i++) {
        paginationHTML += `<li class="page-item ${i === currentHistoryPage ? 'active' : ''}">
            <a class="page-link" href="#" onclick="goToHistoryPage(${i}); return false;">${i}</a>
        </li>`;
    }
    
    // Next button
    paginationHTML += `<li class="page-item ${currentHistoryPage === totalPages || totalPages === 0 ? 'disabled' : ''}">
        <a class="page-link" href="#" onclick="goToHistoryPage(${currentHistoryPage + 1}); return false;">Next</a>
    </li>`;
    
    paginationEl.innerHTML = paginationHTML;
}

function goToHistoryPage(page) {
    const totalPages = Math.ceil(filteredHistoryRows.length / historyPageSize);
    if (page < 1 || page > totalPages) return;
    currentHistoryPage = page;
    updateHistoryPagination();
}
</script>
{% endblock %}
