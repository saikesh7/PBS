<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Validator Dashboard</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
    <!-- DataTables CSS -->
    <link href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css" rel="stylesheet">
    <!-- DataTables Buttons CSS -->
    <link href="https://cdn.datatables.net/buttons/2.4.1/css/buttons.bootstrap5.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('ta.static', filename='ta_validator.css') }}">
    <!-- google fonts-->
    <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@400;500;600&display=swap" rel="stylesheet">

    <style>
        .action-btns {
            min-width: 40px;
        }

        /* Notification popup styles */
        .new-request-popup {
            position: fixed;
            top: 100px;
            right: 20px;
            width: 350px;
            background: #fff;
            border: 2px solid #ffc107;
            border-radius: 10px;
            box-shadow: 0 5px 25px rgba(0,0,0,0.2);
            z-index: 10000;
            display: none;
            animation: slideInRight 0.5s ease-out;
        }

        @keyframes slideInRight {
            from { transform: translateX(400px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .popup-header {
            background: #ffc107;
            color: #212529;
            padding: 15px;
            border-radius: 8px 8px 0 0;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .popup-close { cursor: pointer; font-size: 20px; }
        .popup-body { padding: 20px; }
        .popup-footer { padding: 15px; border-top: 1px solid #dee2e6; text-align: center; }

        .popup-request-item {
            padding: 10px;
            margin-bottom: 10px;
            background: #f8f9fa;
            border-radius: 5px;
            border-left: 3px solid #ffc107;
        }

        .refresh-indicator {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.9);
            padding: 8px 15px;
            border-radius: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: none;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            z-index: 1000;
        }

        /* Badge pulse animation */
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }

        .badge-pulse { animation: pulse 0.6s ease-in-out 3; }

        /* Prevent date column from wrapping */
        #historyTable td:first-child, #historyTable th:first-child {
            white-space: nowrap;
        }
        /* Add spacing between filter dropdowns in the interview history filter row */
        .row.g-3 > [class^='col-'],
        .row.g-3 > .form-group {
            margin-bottom: 0 !important;
            margin-right: 16px;
        }
        .row.g-3 > [class^='col-']:last-child,
        .row.g-3 > .form-group:last-child {
            margin-right: 0;
        }
        /* For smaller screens, stack filters with spacing */
        @media (max-width: 991.98px) {
            .row.g-3 > [class^='col-'],
            .row.g-3 > .form-group {
                margin-right: 0;
                margin-bottom: 16px !important;
            }
        }
        /* Add this to your <style> section */
        .filter-row-fixed .form-select {
            min-width: 100%;
            max-width: 100%;
        }
        th.date-col,
        td.date-col {
            white-space: nowrap;
        }





        table th,
        table td {
            padding: 8px 12px; /* consistent padding for all columns */
            vertical-align: middle;
            text-align: center;
            font-weight: 500;
        }

/* First column (checkbox): make slightly narrower but preserve vertical alignment */
table th:first-child,
table td:first-child {
    width: 20px;
    padding: 8px; /* match others for consistent vertical alignment */
    font-weight: bold;
}

/* Checkbox styling */
table input[type="checkbox"] {
    margin: 0 auto;
    display: block;
    vertical-align: middle;
    width: 16px;
    height: 16px;
    accent-color: #55c704;
}

th {
    white-space: nowrap;       /* Prevent text wrapping */
    vertical-align: middle;    /* Align text vertically */
    text-align: center;        /* Optional: center align text */
    padding: 8px 12px;         /* Consistent spacing */
}

th.sorting, th.sorting_asc, th.sorting_desc {
    white-space: nowrap;       /* Important for DataTables sorting arrows */
}

table.dataTable thead th {
    min-width: 100px;          /* Ensure all columns are wide enough */
}
/* Prevent wrapping and add uniform spacing */
table.dataTable thead th {
    white-space: nowrap;
    text-align: center;
    vertical-align: middle;
    padding: 8px 16px;
}

/* Optional: make all columns equal width (adjust percentages if needed) */
table.dataTable th:nth-child(1) { width: 12%; }  /* Date */
table.dataTable th:nth-child(2) { width: 12%; }  /* Quarter */
table.dataTable th:nth-child(3) { width: 12%; }  /* Employee */
table.dataTable th:nth-child(4) { width: 12%; }  /* Category */
table.dataTable th:nth-child(5) { width: 10%; }  /* Points */
table.dataTable th:nth-child(6) { width: 12%; }  /* Status */
table.dataTable th:nth-child(7) { width: 15%; }  /* Submitted By */
table.dataTable th:nth-child(8) { width: 15%; }  /* Action Notes */
.modal-body table {
    width: 100%;
    table-layout: auto;
}

.table-responsive {
    padding-bottom: 23px; /* Creates space INSIDE the container, pushing the scrollbar down */
}
    </style>
    
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="d-flex flex-column align-items-center">
                <img src="https://www.prowesssoft.com/wp-content/uploads/2025/05/Prowess-white-logo.png" alt="PS Logo" class="sidebar-logo mb-1" style="max-height: 40px;">
                <div class="text-success" style="font-size: 12px; font-weight: 500;">PROWESS SOFT</div>
            </div>
        </div>
        <div class="pt-2 pb-2 ps-3 pe-3 text-white">
        </div>
        <div class="sidebar-nav">
            <!-- Reward Points -->
            <a href="#assignPointsTab" class="sidebar-nav-item  d-flex align-items-center justify-content-between" data-bs-toggle="tab" data-bs-target="#assignPointsTab">
                <span class="d-flex align-items-center">
                    <i class="fas fa-plus-circle"></i>
                    <span>Reward Points</span>
                </span>
                <span id="pending-badge" class="badge bg-warning ms-2">{{ validator_requests | length }}</span>
            </a>

            <!-- Interview History -->
            <a href="#history" class="sidebar-nav-item" data-bs-toggle="tab" data-bs-target="#history">
              <div>
                <i class="fas fa-history"></i>
                <span>Interview History</span>
              </div>
            </a>
            
            <div class="sidebar-divider"></div>

            <!-- Back to Employee Dashboard -->
            <a href="{{ url_for('employee.dashboard') }}" class="sidebar-nav-item">
                <div>
                    <i class="fas fa-home"></i>
                    <span>Employee Dashboard</span>
                </div>
            </a>

            <!-- Logout -->
            <a href="{{ url_for('auth.logout') }}" class="sidebar-nav-item" id="logoutLink">
                <div>
                    <i class="fas fa-sign-out-alt"></i>
                    <span>Logout</span>
                </div>
            </a>
        </div>
    </div>
    <!-- Sidebar Overlay (for mobile) -->
    <div class="sidebar-overlay" id="sidebarOverlay"></div>
    
    <!-- Topbar -->
    <div class="topbar">
        <div class="topbar-left">
            <button class="sidebar-toggle" id="sidebarToggle">
                <i class="fas fa-bars"></i>
            </button>
            <div class="topbar-icon">
                <i class="fas fa-chart-line"></i>
            </div>
            <div class="topbar-info">
                <div class="topbar-title"> TA Validator Dashboard</div>
                <div class="topbar-subtitle">
                    <span class="topbar-badge bg-primary">{{ current_quarter }}</span>
                    <span class="topbar-badge bg-secondary">{{ current_month }}</span>
                </div>
            </div>
        </div>
        
        <!-- Center Heading -->
        <div class="topbar-center">
            <h6 class="topbar-heading">
                <i class="fas fa-award me-2" style="color: gold;"></i><span>POINTS BASED SYSTEM</span>
            </h6>
        </div>
    </div>

    <!-- Main Content -->
    <div class="content-wrapper">
        <!-- Flash messages with animation -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div id="flash-message" class="flash-message alert alert-{{ category }}">
                        {{ message }}
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}
       
        <!-- Main tabs -->
        <!-- Hidden Tab Navigation (for Bootstrap tab functionality) -->
        <ul class="nav nav-tabs" id="taTabs" role="tablist" style="display:none;">
            <!-- Reward Points Tab -->
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="assignPoints2Tab" data-bs-toggle="tab" data-bs-target="#assignPointsTab" type="button" role="tab" aria-selected="true">
                    Reward Points
                </button>
            </li>
            <!-- Interview History Tab -->
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="history-tab" data-bs-toggle="tab" data-bs-target="#history" type="button" role="tab" aria-selected="false">Interview History</button>
            </li>
        </ul>

        <!-- Tab Content -->
        <div class="tab-content" id="maintaTabContent">
            <!-- Reward Points Tab -->
            <div class="tab-pane fade show active" id="assignPointsTab" role="tabpanel" aria-labelledby="assignPoints2Tab">
                <div class="container mt-5">
                    <div class="card shadow">
                        <div class="card-header bg-warning text-dark">
                            <h4 class="mb-0"><i class="fas fa-user-check me-2"></i> Validator Approval - Interview Points</h4>
                        </div>
                        <div class="card-body">
                            <div id="pendingRequestsSection" {% if not validator_requests %}style="display:none;"{% endif %}>
                                <div class="table-responsive">
                                    <table class="table table-bordered table-hover align-middle text-center" id="pendingRequestsTable">
                                        <thead class="table-light">
                                            <tr>
                                                <th><input type="checkbox" id="select-all" style="accent-color: #55c704;"/></th>
                                                <th>Date</th>
                                                <th>Event Date</th>
                                                <th>Employee</th>
                                                <th>Grade</th>
                                                <th>Interviews</th>
                                                <th>Points</th>
                                                <th>Notes</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for req in validator_requests %}
                                            <tr>
                                                <td>
                                                    <input type="checkbox" style="accent-color: #55c704;"
                                                          name="selected_requests"
                                                          value="{{ req.request_id }}"
                                                          class="select-checkbox"
                                                          form="bulk-form"
                                                          data-date="{{ req.request_date }}"
                                                          data-event-date="{{ req.event_date }}"
                                                          data-employee="{{ req.employee_name }}"
                                                          data-grade="{{ req.grade }}"
                                                          data-interviews="{{ req.interviews_count }}"
                                                          data-points="{{ req.points }}"
                                                          data-notes="{{ req.notes or '-' }}" />
                                                </td>
                                                <td>{{ req.request_date }}</td>
                                                <td>{{ req.event_date }}</td>
                                                <td>{{ req.employee_name }}</td>
                                                <td>{{ req.grade }}</td>
                                                <td>{{ req.interviews_count }}</td>
                                                <td>{{ req.points }}</td>
                                                <td>
                                                    <button class="btn btn-sm btn-outline-primary view-notes-btn"
                                                            data-bs-toggle="modal"
                                                            data-bs-target="#viewNotesModal"
                                                            data-notes="{{ req.notes | e }}">
                                                        View
                                                    </button>
                                                </td>
                                                <td>
                                                    <div class="action-btns d-flex flex-row justify-content-center gap-2" style="display: flex !important; align-items: center !important;justify-content: center !important;">
                                                        <button class="btn btn-success btn-sm" title="Approve" onclick="openSingleConfirmModal('{{ req.request_id }}', 'approve')">
                                                            <i class="fas fa-check"></i>
                                                        </button>
                                                        <button class="btn btn-danger btn-sm" title="Reject" onclick="openSingleConfirmModal('{{ req.request_id }}', 'reject')">
                                                            <i class="fas fa-times"></i>
                                                        </button>
                                                    </div>
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                                <form method="post" action="{{ url_for('ta.validate_bulk_requests') }}" id="bulk-form">
                                    <input type="hidden" name="bulk_action" id="bulk_action_input" />
                                    <div class="d-flex justify-content-end mt-3 gap-2">
                                        <button type="button" class="btn btn-success" onclick="openBulkModal('approve')">
                                            <i class="fas fa-check-double me-1"></i> Bulk Approve Selected
                                        </button>
                                        <button type="button" class="btn btn-danger" onclick="openBulkModal('reject')">
                                            <i class="fas fa-times-circle me-1"></i> Bulk Reject Selected
                                        </button>
                                    </div>
                                </form>
                            </div>
                            <div class="alert alert-info text-center" id="noRequestsAlert" {% if validator_requests %}style="display:none;"{% endif %}>
                                <i class="fas fa-info-circle me-2"></i>No pending interview point requests for approval.
                            </div>
                        </div>
                    </div>  
                </div>

                <!-- Bulk Confirmation Modal -->
                <div class="modal fade" id="bulkConfirmModal" tabindex="-1" aria-labelledby="bulkConfirmLabel" aria-hidden="true">
                    <div class="modal-dialog modal-dialog-centered modal-lg">
                        <div class="modal-content">
                            <div class="modal-header bg-warning">
                                <h5 class="modal-title" id="bulkConfirmLabel"><i class="fas fa-exclamation-triangle me-2"></i>Confirm Bulk Action</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <p id="bulkConfirmText" class="mb-2 fw-semibold text-start"></p>
                                <div class="table-responsive">
                                    <table class="table table-sm table-bordered table-striped mb-0 text-center">
                                        <thead class="table-light">
                                            <tr>
                                                <th style="white-space: nowrap;">Date</th>
                                                <th style="white-space: nowrap;">Event Date</th> <!-- Corrected line -->
                                                <th>Employee</th>
                                                <th>Grade</th>
                                                <th>Interviews</th>
                                                <th>Points</th>
                                                <th>Notes</th>
                                            </tr>
                                        </thead>
                                        <tbody id="bulkConfirmTableBody"></tbody>
                                    </table>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                <button type="button" class="btn btn-primary" id="confirm-bulk-action-btn" onclick="submitBulkForm()">
                                    <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true" style="display: none;"></span>
                                    <span class="button-text">Confirm</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Single Request Confirmation Modal -->
            <div class="modal fade" id="singleConfirmModal" tabindex="-1" aria-labelledby="singleConfirmLabel" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered modal-lg">
                    <div class="modal-content">
                        <div class="modal-header bg-warning">
                            <h5 class="modal-title" id="singleConfirmLabel"><i class="fas fa-exclamation-triangle me-2"></i>Confirm Action</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <p class="fw-semibold mb-2" id="singleConfirmText"></p>
                            <div class="table-responsive">
                                <table class="table table-bordered text-center mb-0">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Date</th>
                                            <th>Event Date</th>
                                            <th>Employee</th>
                                            <th>Grade</th>
                                            <th>Interviews</th>
                                            <th>Points</th>
                                            
                                        </tr>
                                    </thead>
                                    <tbody id="singleConfirmTableBody"></tbody>
                                </table>
                            </div>
                        </div>
                        <div class="modal-footer justify-content-center">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="button" class="btn btn-primary" id="confirm-single-action-btn" onclick="submitSingleAction()">
                                <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true" style="display: none;"></span>
                                <span class="button-text">Confirm</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Notification popup HTML -->
            <div id="newRequestPopup" class="new-request-popup">
                <div class="popup-header">
                    <span><i class="fas fa-bell"></i> New Validation Request!</span>
                    <span class="popup-close" onclick="closeNotificationPopup()">&times;</span>
                </div>
                <div class="popup-body" id="popupBody">
                    <!-- Dynamic content will be inserted here -->
                </div>
                <div class="popup-footer">
                    <button class="btn btn-warning btn-sm" onclick="goToPendingTab()">
                        <i class="fas fa-arrow-right"></i> Review Requests
                    </button>
                </div>
            </div>

            <!-- Auto-refresh indicator -->
            <div class="refresh-indicator" id="refreshIndicator">
                <div class="refresh-spinner"></div>
                <span>Checking for updates...</span>
            </div>

                         <!-- Interview History Tab (Default Active) -->
            <div class="tab-pane fade " id="history" role="tabpanel" aria-labelledby="history-tab">
                <!-- Filters for interview history -->
                <div class="card">
                    <div class="card-header bg-info text-white">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-history me-2"></i>
                            <span>Interview Points History</span>
                        </div>
                    </div>
                    <!-- Filter Row: All filters in one line, always -->
                    <div class="row filter-row-fixed g-3 px-3 pt-3 pb-0">
                        <div class="col-12 col-md-2">
                            <div class="form-group">
                                <label for="yearFilter"><i class="fas fa-calendar me-1"></i> Year</label>
                                <select class="form-select" id="yearFilter">
                                    <option value="">All Years</option>
                                    {% for year in year_options %}
                                        <option value="{{ year }}">{{ year }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="col-12 col-md-2">
                            <div class="form-group">
                                <label for="quarterFilter"><i class="fas fa-calendar-alt me-1"></i> Quarter</label>
                                <select class="form-select" id="quarterFilter">
                                    <option value="">All Quarters</option>
                                    {% for quarter in quarter_options %}
                                        <option value="{{ quarter }}">{{ quarter }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="col-12 col-md-2">
                            <div class="form-group">
                                <label for="gradeFilter"><i class="fas fa-layer-group me-1"></i> Grade</label>
                                <select class="form-select" id="gradeFilter">
                                    <option value="">All Grades</option>
                                    {% for grade in grades %}
                                        <option value="{{ grade }}">{{ grade }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="col-12 col-md-2">
                            <div class="form-group">
                                <label for="statusFilter"><i class="fa fa-check-circle me-1 text-primary"></i> Status</label>
                                <select class="form-select" id="statusFilter">
                                    <option value="">All Status</option>
                                    <option value="Approved">Approved</option>
                                    <option value="Rejected">Rejected</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="d-flex justify-content-end px-4 pb-2 pt-3">
                        <button id="resetFilters" class="btn btn-outline-secondary me-2">
                            <i class="fas fa-undo me-1"></i> Reset Filters
                        </button>
                        <button id="applyFilters" class="btn btn-primary">
                            <i class="fas fa-filter me-1"></i> Apply Filters
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped" id="historyTable" style="width:100%;">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Event Date</th>
                                        <th>Employee</th>
                                        <th>Grade</th>
                                        <th>Interviews</th>
                                        <th>Points</th>
                                        <th>Notes</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Table rows will be populated by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div> 
        </div>
    </div>
    
    <!-- View Full Notes Modal -->
    <div class="modal fade" id="viewNotesModal" tabindex="-1" aria-labelledby="viewNotesModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header" style="background: linear-gradient(135deg, #17a2b8, #20c997); color: white;">
                    <h5 class="modal-title" id="viewNotesModalLabel">
                        <i class="fas fa-file-alt me-2"></i>Submission Notes
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" style="max-height: 70vh; overflow-y: auto; padding: 20px;">
                    <div id="fullNotesText" style="white-space: pre-wrap; word-wrap: break-word; font-size: 1rem; line-height: 1.8; background: #f8f9fa; padding: 20px; border-radius: 8px; border-left: 4px solid #17a2b8;"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Hidden Forms -->
    <form id="assignInterviewForm" method="post" action="{{ url_for('ta.dashboard') }}" style="display: none;">
        <input type="hidden" name="action_type" value="assign_interview_points">
        <input type="hidden" name="employee_id" id="form_employee_id">
        <input type="hidden" name="number_of_interviews" id="form_interviews">
        <input type="hidden" name="notes" id="form_notes">
        <input type="hidden" name="confirmed" value="true">
    </form>
    
    <form id="bulkUploadForm" method="post" action="{{ url_for('ta.dashboard') }}" enctype="multipart/form-data" style="display: none;">
        <input type="hidden" name="action_type" value="bulk_upload">
        <input type="file" id="form_csv_file" name="csv_file">
    </form>

    <form id="singleActionForm" method="post" action="{{ url_for('ta.validate_request_action') }}" style="display: none;">
        <input type="hidden" name="request_id" id="single_request_id">
        <input type="hidden" name="action" id="single_action">
    </form>

    <!-- JavaScript Libraries -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.1/js/dataTables.buttons.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.bootstrap5.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.html5.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.print.min.js"></script>
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>

    <script>
        // Auto-refresh configuration
        const REFRESH_INTERVAL = 1000;
        let lastCheckTime = new Date().toISOString();
        let lastPendingCount = {{ validator_requests|length }};
        let checkInterval = null;
        let popupTimeout = null;

        // Initialize auto-refresh
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Starting auto-refresh for TA Validator dashboard...');
            startAutoRefresh();
        });

        function startAutoRefresh() {
            setTimeout(checkForNewRequests, 3000);
            checkInterval = setInterval(checkForNewRequests, REFRESH_INTERVAL);
        }

        function checkForNewRequests() {
            console.log('Checking for new TA validation requests...');
            showRefreshIndicator();
            
            fetch(`/talent-acquisition/validator/check-new-requests?last_check=${encodeURIComponent(lastCheckTime)}`)
                .then(response => response.json())
                .then(data => {
                    hideRefreshIndicator();
                    console.log('Check complete:', data);
                    
                    if (data.error) {
                        console.error('Error:', data.error);
                        return;
                    }
                    
                    lastCheckTime = data.timestamp || new Date().toISOString();
                    
                    const hasNewRequests = data.new_requests && data.new_requests.length > 0;
                    const countChanged = data.pending_count !== lastPendingCount;

                    if (hasNewRequests) {
                        console.log(`${data.new_requests.length} new requests detected!`);
                        showNewRequestNotification(data.new_requests);
                        playNotificationSound();
                    }

                    if (countChanged) {
                        fetchAndUpdatePendingRequests();
                        updatePendingBadge(data.pending_count);
                        lastPendingCount = data.pending_count;
                    }
                })
                .catch(error => {
                    hideRefreshIndicator();
                    console.error('Error checking for new requests:', error);
                });
        }

        function showRefreshIndicator() { 
            const indicator = document.getElementById('refreshIndicator'); 
            if (indicator) indicator.style.display = 'flex'; 
        }
        
        function hideRefreshIndicator() { 
            const indicator = document.getElementById('refreshIndicator'); 
            if (indicator) setTimeout(() => indicator.style.display = 'none', 500); 
        }

        function showNewRequestNotification(newRequests) {
            const popup = document.getElementById('newRequestPopup');
            const popupBody = document.getElementById('popupBody');
            
            let content = `<p class="mb-3"><strong>${newRequests.length} new request${newRequests.length > 1 ? 's' : ''} to validate!</strong></p>`;
            
            const requestsToShow = newRequests.slice(0, 3);
            requestsToShow.forEach(req => {
                content += `
                    <div class="popup-request-item">
                        <div class="d-flex justify-content-between align-items-start">
                            <strong>${req.employee_name}</strong>
                            <span class="badge bg-warning text-dark">${req.points} pts</span>
                        </div>
                        <small class="text-muted">${req.category_name} - ${req.interviews_count} interviews</small>
                        ${req.notes ? `<div class="small mt-1">${req.notes.substring(0, 50)}${req.notes.length > 50 ? '...' : ''}</div>` : ''}
                    </div>
                `;
            });
            
            if (newRequests.length > 3) {
                content += `<p class="text-muted text-center mb-0 mt-2">...and ${newRequests.length - 3} more</p>`;
            }
            
            popupBody.innerHTML = content;
            popup.style.display = 'block';
            
            if (popupTimeout) clearTimeout(popupTimeout);
            popupTimeout = setTimeout(() => closeNotificationPopup(), 10000);
            
            // Automatically reload the page when a new request notification appears
            setTimeout(() => location.reload(), 5000);
        }

        function closeNotificationPopup() { 
            const popup = document.getElementById('newRequestPopup'); 
            if (popup) popup.style.display = 'none'; 
        }

        function goToPendingTab() {
            closeNotificationPopup();
            const pendingTab = document.querySelector('[data-bs-target="#assignPointsTab"]');
            if (pendingTab) pendingTab.click();
            setTimeout(() => location.reload(), 100); // Restored reload on notification
        }

        function updatePendingBadge(count) {
            const badge = document.getElementById('pending-badge');
            if (badge) {
                badge.textContent = count;
                badge.classList.add('badge-pulse');
                setTimeout(() => badge.classList.remove('badge-pulse'), 1800);
            }
        }

        function playNotificationSound() { 
            try { 
                const audio = new Audio('data:audio/wav;base64,UklGRl4GAABXQVZFZm10IBAAAAABAAEAIlYAAESsAAACABAAZGF0YToGAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA='); 
                audio.volume = 0.3; 
                audio.play().catch(() => {}); 
            } catch (e) {} 
        }

        document.addEventListener('visibilitychange', function() { 
            if (document.hidden) { 
                clearInterval(checkInterval); 
            } else { 
                startAutoRefresh(); 
            } 
        });
    </script>

    <script>
        // Global variables for filters
        let historyDataTable;
        

        // Initialize sidebar toggle functionality
        document.addEventListener('DOMContentLoaded', function() {
            initializeSidebar();
            initializePendingRequestsTable();
            initializeHistoryTable({{ history_data | tojson }});
            setupEventListeners();
        });

        function initializeSidebar() {
            const sidebar = document.getElementById('sidebar');
            const sidebarToggle = document.getElementById('sidebarToggle');
            const sidebarOverlay = document.getElementById('sidebarOverlay');
            
            if (sidebarToggle) {
                sidebarToggle.addEventListener('click', function() {
                    sidebar.classList.toggle('show');
                    sidebarOverlay.classList.toggle('show');
                    
                    const toggleIcon = sidebarToggle.querySelector('i');
                    if (sidebar.classList.contains('show')) {
                        toggleIcon.classList.remove('fa-bars');
                        toggleIcon.classList.add('fa-times');
                    } else {
                        toggleIcon.classList.remove('fa-times');
                        toggleIcon.classList.add('fa-bars');
                    }
                });
            }
            
            if (sidebarOverlay) {
                sidebarOverlay.addEventListener('click', function() {
                    sidebar.classList.remove('show');
                    sidebarOverlay.classList.remove('show');
                    
                    const toggleIcon = sidebarToggle.querySelector('i');
                    toggleIcon.classList.remove('fa-times');
                    toggleIcon.classList.add('fa-bars');
                });
            }
            
            window.addEventListener('resize', function() {
                if (window.innerWidth > 992 && sidebar.classList.contains('show')) {
                    sidebar.classList.remove('show');
                    sidebarOverlay.classList.remove('show');
                    
                    const toggleIcon = sidebarToggle.querySelector('i');
                    toggleIcon.classList.remove('fa-times');
                    toggleIcon.classList.add('fa-bars');
                }
            });
            
            const sidebarNavItems = document.querySelectorAll('.sidebar-nav-item');
            sidebarNavItems.forEach(item => {
                item.addEventListener('click', function(e) {
                    const target = this.getAttribute('data-bs-target');
                    if (target) {
                        e.preventDefault();
                        const tabEl = document.querySelector(`#taTabs button[data-bs-target="${target}"]`);
                        if (tabEl) {
                            const tab = new bootstrap.Tab(tabEl);
                            tab.show();
                        }
                        
                        sidebarNavItems.forEach(navItem => navItem.classList.remove('active'));
                        this.classList.add('active');
                    }
                    
                    if (window.innerWidth <= 992) {
                        setTimeout(() => {
                            sidebar.classList.remove('show');
                            sidebarOverlay.classList.remove('show');
                            
                            const toggleIcon = sidebarToggle.querySelector('i');
                            toggleIcon.classList.remove('fa-times');
                            toggleIcon.classList.add('fa-bars');
                        }, 100);
                    }
                });
            });
        }

        function initializePendingRequestsTable() {
            if (window.jQuery && window.jQuery.fn.DataTable) {
                $('#pendingRequestsTable').DataTable({
                    order: [[1, 'desc']],
                    pageLength: 10,
                    lengthMenu: [5, 10, 20, 25],
                    dom: '<"row"<"col-sm-12 col-md-6"l><"col-sm-12 col-md-6"f>>' +
                         '<"row"<"col-sm-12"t>>' +
                         '<"row"<"col-sm-12 col-md-5"i><"col-sm-12 col-md-7"p>>',
                    language: {
                        search: 'Search:',
                        searchPlaceholder: "Search...",
                        lengthMenu: "Show _MENU_ entries",
                        info: "Showing _START_ to _END_ of _TOTAL_ entries",
                        infoEmpty: "Showing 0 to 0 of 0 entries",
                        infoFiltered: "(filtered from _MAX_ total entries)",
                        paginate: {
                            previous: 'Previous',
                            next: 'Next'
                        }
                    },
                    columnDefs: [
                        { orderable: false, targets: [0, 7, 8] }
                    ]
                });
            }
        }

         function initializeHistoryTable(initialData) {
        historyDataTable = $('#historyTable').DataTable({
            data: initialData, // Use the data passed from the server
            order: [[0, 'desc']],
            pageLength: 10,
            columns: [
                { data: 'date' },
                { data: 'event_date' },
                { data: 'employee' },
                { data: 'grade' },
                { data: 'interviews' },
                { data: 'points' },
                {
                    data: 'notes',
                    render: function (data, type, row) {
                        const encoded = (data || 'No notes provided')
                            .replace(/&/g, '&amp;')
                            .replace(/</g, '&lt;')
                            .replace(/>/g, '&gt;')
                            .replace(/"/g, '&#34;');
                        return `
                            <button class="btn btn-sm btn-outline-primary view-notes-btn"
                                    data-bs-toggle="modal"
                                    data-bs-target="#viewNotesModal"
                                    data-notes="${encoded}">
                                View
                            </button>`;
                    }
                },
                {
                    data: 'status', 
                    render: function (data, type, row) {
                        return `<span class="badge ${data === 'Approved' ? 'bg-success' :
                            data === 'Pending' ? 'bg-warning' :
                            data === 'Rejected' ? 'bg-danger' : 'bg-secondary'}">${data}</span>`;
                    }
                }
            ],
            dom: '<"row"<"col-sm-12 col-md-6"l><"col-sm-12 col-md-6"f>>' +
                 '<"row"<"col-sm-12"t>>' +
                 '<"row"<"col-sm-12 col-md-5"i><"col-sm-12 col-md-7"p>>',
            language: {
                search: 'Search:',
                searchPlaceholder: 'Searchâ€¦',
                lengthMenu: 'Show _MENU_ entries',
                info: 'Showing _START_ to _END_ of _TOTAL_ entries',
                infoEmpty: 'Showing 0 to 0 of 0 entries',
                infoFiltered: '(filtered from _MAX_ total entries)',
                paginate: {
                    previous: '<i class="fas fa-chevron-left"></i>',
                    next: '<i class="fas fa-chevron-right"></i>'
                }
            }
        });

        // Populate filters based on the initial data
        populateFilterDropdowns(initialData);
    }

        function setupEventListeners() {
            // Apply filters button
            $('#applyFilters').on('click', function() {
                applyAllFilters();
            });

            // Reset filters button
            $('#resetFilters').on('click', function() {
                $('#yearFilter, #quarterFilter, #gradeFilter, #statusFilter').val('');
                applyAllFilters();
            });

            // Select all checkbox
            document.getElementById('select-all').addEventListener('change', function () {
                document.querySelectorAll('.select-checkbox').forEach(cb => cb.checked = this.checked);
            });
        }

        
        function populateFilterDropdowns(data) {
            const years = new Set();
            const quarters = new Set();
            const grades = new Set();
            const statuses = new Set();

            data.forEach(item => {
                if (item.date) {
                    const dateObj = parseDisplayDate(item.date);
                    if (!isNaN(dateObj.getTime())) {
                        years.add(dateObj.getFullYear());
                        const q = getQuarterFromDate(item.date);
                        if (q) quarters.add(q);
                    }
                }
                if (item.grade) grades.add(item.grade);
                if (item.status) statuses.add(item.status);
            });

            fillDropdown($('#yearFilter'), 'All Years', years, (a, b) => b - a);
            fillDropdown($('#quarterFilter'), 'All Quarters', quarters, (a, b) => a.localeCompare(b));
            fillDropdown($('#gradeFilter'), 'All Grades', grades, (a, b) => a.localeCompare(b));
            fillDropdown($('#statusFilter'), 'All Status', statuses, (a, b) => a.localeCompare(b));
        }

        function fillDropdown($selector, defaultText, items, sortFn) {
            const currentVal = $selector.val();
            $selector.empty().append(`<option value="">${defaultText}</option>`);
            Array.from(items).sort(sortFn).forEach(v =>
                $selector.append(`<option value="${v}">${v}</option>`)
            );
            if (Array.from(items).map(String).includes(String(currentVal))) {
                $selector.val(currentVal);
            }
        }

        function applyAllFilters() {
            const year = $('#yearFilter').val();
            const quarter = $('#quarterFilter').val();
            const grade = $('#gradeFilter').val();
            const status = $('#statusFilter').val();

            console.log("Applying filters - Year:", year, "| Quarter:", quarter, "| Grade:", grade, "| Status:", status);

            // Clear existing search filters
            $.fn.dataTable.ext.search = [];

            // Add custom filter
            $.fn.dataTable.ext.search.push(function(settings, searchData, dataIndex) {
                if (settings.nTable.id !== 'historyTable') return true;

                // Get the original data
                const rowData = historyDataTable.row(dataIndex).data();
                
                // Year and Quarter filter
                if (year || quarter) {
                    const dateObj = parseDisplayDate(rowData.date);
                    if (!isNaN(dateObj.getTime())) {
                        const rowYear = dateObj.getFullYear();
                        const rowQuarter = getQuarterFromDate(rowData.date);
                        
                        if (year && parseInt(year) !== rowYear) return false;
                        if (quarter && quarter !== rowQuarter) return false;
                    }
                }
                
                // Grade filter
                if (grade && rowData.grade !== grade) return false;
                
                // Status filter
                if (status && rowData.status !== status) return false;
                
                return true;
            });

            // Redraw the table
            historyDataTable.draw();
        }

        function parseDisplayDate(dateStr) {
            if (!dateStr || typeof dateStr !== 'string') return new Date(NaN);
            
            const parts = dateStr.split('-');
            if (parts.length === 3) {
                const day = parseInt(parts[0], 10);
                const month = parseInt(parts[1], 10) - 1;
                const year = parseInt(parts[2], 10);
                if (!isNaN(day) && !isNaN(month) && !isNaN(year)) {
                    return new Date(year, month, day);
                }
            }
            return new Date(NaN);
        }

        function getQuarterFromDate(dateStr) {
            const d = parseDisplayDate(dateStr);
            if (isNaN(d.getTime())) return null;
            const m = d.getMonth();
            if (m >= 3 && m <= 5) return 'Q1';
            else if (m >= 6 && m <= 8) return 'Q2';
            else if (m >= 9 && m <= 11) return 'Q3';
            else return 'Q4';
        }

        // Modal functions
       function openBulkModal(action) {
            const selected = document.querySelectorAll('.select-checkbox:checked');
            if (selected.length === 0) {
                alert("No requests selected!");
                return false;
            }

            document.getElementById('bulk_action_input').value = action;
            document.getElementById('bulkConfirmText').textContent = 
                `Are you sure you want to ${action} the following ${selected.length} request(s)?`;

            const tbody = document.getElementById('bulkConfirmTableBody');
            tbody.innerHTML = '';
            selected.forEach(cb => {
                const row = document.createElement('tr');
                const notes = cb.getAttribute('data-notes') || 'No notes provided';
                const cells = [
                    cb.getAttribute('data-date'),
                    cb.getAttribute('data-event-date'),
                    cb.getAttribute('data-employee'),
                    cb.getAttribute('data-grade'),
                    cb.getAttribute('data-interviews'),
                    cb.getAttribute('data-points'),
                    `<button class="btn btn-sm btn-outline-primary view-notes-btn" data-bs-toggle="modal" data-bs-target="#viewNotesModal" data-notes="${escapeHtml(notes)}" data-hr-modified="${cb.getAttribute('data-hr-modified') || 'false'}">View</button>`
                ];
                
                // Loop with index to target specific cells
                cells.forEach((html, index) => {
                    const td = document.createElement('td');
                    td.innerHTML = html;
                    
                    // CRUCIAL FIX: Apply style to the Date (index 0) and Event Date (index 1) columns
                    if (index === 0 || index === 1) {
                        td.style.whiteSpace = 'nowrap';
                    }
                    
                    row.appendChild(td);
                });
                tbody.appendChild(row);
            });

            const modal = new bootstrap.Modal(document.getElementById('bulkConfirmModal'));
            modal.show();
        }
        function submitBulkForm() {
    const form = document.getElementById('bulk-form');
    if (form) {
        // --- Start: Added processing state logic ---
        const confirmBtn = document.getElementById('confirm-bulk-action-btn');
        const spinner = confirmBtn.querySelector('.spinner-border');
        const buttonText = confirmBtn.querySelector('.button-text');

        // 1. Disable the button to prevent multiple submissions
        confirmBtn.disabled = true;

        // 2. Show the spinner and update the button text
        if (spinner) spinner.style.display = 'inline-block';
        if (buttonText) buttonText.textContent = 'Processing...';
        
        // --- End: Added processing state logic ---

        // 3. Submit the form after a short delay to let the UI update
        setTimeout(() => {
            form.submit();
        }, 150); // 150ms is usually enough time for the browser to render the changes
    } else {
        alert("Form not found.");
    }
}

        function openSingleConfirmModal(requestId, action) {
            document.getElementById('single_request_id').value = requestId;
            document.getElementById('single_action').value = action;

            const actionText = action === 'approve' ? 'approve' : 'reject';
            document.getElementById('singleConfirmText').textContent = 
                `Are you sure you want to ${actionText} the following 1 request(s)?`;

            const checkbox = document.querySelector(`.select-checkbox[value="${requestId}"]`);
            if (!checkbox) {
                alert('Request not found.');
                return;
            }

            const row = checkbox.closest('tr');
            const date = row.children[1]?.innerText || '-';
            const event_date = row.children[2]?.innerText || '-';
            const employee = row.children[3]?.innerText || '-';
            const grade = row.children[4]?.innerText || '-';
            const interviews = row.children[5]?.innerText || '-';
            const points = row.children[6]?.innerText || '-';
            const notes = row.children[7]?.innerText || 'No notes provided';

            const tbody = document.getElementById('singleConfirmTableBody');
            tbody.innerHTML = `
                <tr>
                    <td style="white-space: nowrap;">${date}</td>
                    <td style="white-space: nowrap;">${event_date}</td>
                    <td>${employee}</td>
                    <td>${grade}</td>
                    <td>${interviews}</td>
                    <td>${points}</td>
                    
                </tr>
            `;

            const modal = new bootstrap.Modal(document.getElementById('singleConfirmModal'));
            modal.show();
        }

        function submitSingleAction() {
    const form = document.getElementById('singleActionForm');
    if (form) {
        const confirmBtn = document.getElementById('confirm-single-action-btn');
        const spinner = confirmBtn.querySelector('.spinner-border');
        const buttonText = confirmBtn.querySelector('.button-text');

        // Get the action type ('approve' or 'reject') from the hidden input
        const action = document.getElementById('single_action').value;
        const processingText = action === 'approve' ? 'Approving...' : 'Rejecting...';

        // 1. Disable the button to prevent multiple clicks
        confirmBtn.disabled = true;

        // 2. Show the spinner and set the dynamic "Approving..." or "Rejecting..." text
        if (spinner) spinner.style.display = 'inline-block';
        if (buttonText) buttonText.textContent = processingText;

        // 3. Submit the form after a short delay to allow the UI to update
        setTimeout(() => {
            form.submit();
        }, 150);
    }
}

        // Helper functions
        function escapeHtml(text) {
            return (text || '').replace(/&/g, '&amp;')
                              .replace(/</g, '&lt;')
                              .replace(/>/g, '&gt;')
                              .replace(/"/g, '&#34;');
        }

        function fetchAndUpdatePendingRequests() {
            $.ajax({
                url: "{{ url_for('ta.ta_validator_check_new_requests') }}",  // âœ… CORRECT!
                method: "GET",  // Changed from POST to GET
                success: function(response) {
                    if (response.success) {
                        updatePendingRequestsTable(response.requests);
                    }
                }
            });
        }

        function updatePendingRequestsTable(requests) {
            const pendingTable = document.getElementById('pendingRequestsTable');
            const tbody = pendingTable ? pendingTable.querySelector('tbody') : null;
            const pendingRequestsSection = document.getElementById('pendingRequestsSection');
            const noRequestsAlert = document.getElementById('noRequestsAlert');
            
            if (requests.length === 0) {
                if (pendingRequestsSection) pendingRequestsSection.style.display = 'none';
                if (noRequestsAlert) noRequestsAlert.style.display = 'block';
                if (tbody) tbody.innerHTML = '';
                // Destroy DataTable if exists
                if ($.fn.DataTable.isDataTable('#pendingRequestsTable')) {
                    $('#pendingRequestsTable').DataTable().clear().destroy();
                }
                return;
            } else {
                if (pendingRequestsSection) pendingRequestsSection.style.display = '';
                if (noRequestsAlert) noRequestsAlert.style.display = 'none';
                if (tbody) {
                    tbody.innerHTML = '';
                    requests.forEach(function(req) {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td><input type="checkbox" name="selected_requests" value="${req.request_id}" class="select-checkbox" form="bulk-form"
                                data-date="${req.request_date}"
                                data-event-date="${req.event_date}"
                                data-employee="${req.employee_name}"
                                data-grade="${req.grade}"
                                data-interviews="${req.interviews_count}"
                                data-points="${req.points}"
                                data-notes="${req.notes || '-'}" /></td>
                            <td style="white-space: nowrap;">${req.request_date}</td>
                            <td style="white-space: nowrap;">${req.event_date}</td>
                            <td>${req.employee_name}</td>
                            <td>${req.grade}</td>
                            <td>${req.interviews_count}</td>
                            <td>${req.points}</td>
                            <td>
                                <button class="btn btn-sm btn-outline-primary view-notes-btn"
                                        data-bs-toggle="modal"
                                        data-bs-target="#viewNotesModal"
                                        data-notes="${escapeHtml(req.notes)}">
                                    View
                                </button>
                            </td>
                            <td>
                                <div class="action-btns d-flex flex-row justify-content-center gap-2">
                                    <button class="btn btn-success btn-sm" title="Approve" onclick="openSingleConfirmModal('${req.request_id}', 'approve')">
                                        <i class="fas fa-check"></i>
                                    </button>
                                    <button class="btn btn-danger btn-sm" title="Reject" onclick="openSingleConfirmModal('${req.request_id}', 'reject')">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </td>
                        `;
                        tbody.appendChild(tr);
                    });
                }
                // Destroy and re-initialize DataTable
                if ($.fn.DataTable.isDataTable('#pendingRequestsTable')) {
                    $('#pendingRequestsTable').DataTable().clear().destroy();
                }
                $('#pendingRequestsTable').DataTable({
                    order: [[1, 'desc']],
                    pageLength: 10,
                    lengthMenu: [5, 10, 20, 25],
                    dom: '<"row"<"col-sm-12 col-md-6"l><"col-sm-12 col-md-6"f>>' +
                         '<"row"<"col-sm-12"t>>' +
                         '<"row"<"col-sm-12 col-md-5"i><"col-sm-12 col-md-7"p>>',
                    language: {
                        search: 'Search:',
                        searchPlaceholder: "Search...",
                        lengthMenu: "Show _MENU_ entries",
                        info: "Showing _START_ to _END_ of _TOTAL_ entries",
                        infoEmpty: "Showing 0 to 0 of 0 entries",
                        infoFiltered: "(filtered from _MAX_ total entries)",
                        paginate: {
                            previous: 'Previous',
                            next: 'Next'
                        }
                    },
                    columnDefs: [
                        { orderable: false, targets: [0, 7, 8] }
                    ]
                });
            }
            attachCheckboxEventListeners();
        }

        // Bulk selection persistence
        let selectedRequests = new Set();

        function attachCheckboxEventListeners() {
            // Individual checkboxes
            document.querySelectorAll('.select-checkbox').forEach(checkbox => {
                // Set checked state based on selectedRequests
                checkbox.checked = selectedRequests.has(checkbox.value);

                checkbox.addEventListener('change', function() {
                    if (this.checked) {
                        selectedRequests.add(this.value);
                    } else {
                        selectedRequests.delete(this.value);
                    }
                    // Update "select all" checkbox for current page
                    updateSelectAllCheckbox();
                });
            });

            // "Select all" checkbox
            const selectAllCheckbox = document.getElementById('select-all');
            if (selectAllCheckbox) {
                selectAllCheckbox.addEventListener('change', function() {
                    // Only affect checkboxes on the current page
                    document.querySelectorAll('.select-checkbox').forEach(cb => {
                        cb.checked = this.checked;
                        if (this.checked) {
                            selectedRequests.add(cb.value);
                        } else {
                            selectedRequests.delete(cb.value);
                        }
                    });
                });
            }
        }

        function updateSelectAllCheckbox() {
            const selectAllCheckbox = document.getElementById('select-all');
            const checkboxes = document.querySelectorAll('.select-checkbox');
            if (!selectAllCheckbox || checkboxes.length === 0) return;
            const allChecked = Array.from(checkboxes).every(cb => cb.checked);
            selectAllCheckbox.checked = allChecked;
        }

        // After DataTable draw, re-attach listeners and restore checked state
        $('#pendingRequestsTable').on('draw.dt', function() {
            attachCheckboxEventListeners();
            updateSelectAllCheckbox();
        });

        // When updating the table (e.g., after AJAX), call this:
        function updatePendingRequestsTable(requests) {
            // ... your code to update table rows ...
            // After updating rows and re-initializing DataTable:
            $('#pendingRequestsTable').DataTable().on('draw', function() {
                attachCheckboxEventListeners();
                updateSelectAllCheckbox();
            });
            // Initial call for the first draw
            attachCheckboxEventListeners();
            updateSelectAllCheckbox();
        }

        // Tab persistence
        document.addEventListener('DOMContentLoaded', function () {
            const TAB_KEY = 'validatorActiveTab';
            const defaultTab = '#assignPointsTab';
            let activeTab = localStorage.getItem(TAB_KEY) || defaultTab;

            const tabTrigger = document.querySelector(`.sidebar-nav-item[data-bs-target="${activeTab}"]`);
            const tabButton = document.querySelector(`#taTabs button[data-bs-target="${activeTab}"]`);
            if (tabTrigger && tabButton) {
                document.querySelectorAll('.sidebar-nav-item').forEach(item => item.classList.remove('active'));
                tabTrigger.classList.add('active');
                new bootstrap.Tab(tabButton).show();
                setTimeout(() => {
                    const tabPane = document.querySelector(activeTab);
                    if (tabPane) tabPane.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                }, 200);
            }

            document.querySelectorAll('.sidebar-nav-item[data-bs-target]').forEach(tab => {
                tab.addEventListener('click', function () {
                    const target = this.getAttribute('data-bs-target');
                    if (target) {
                        localStorage.setItem(TAB_KEY, target);
                        // No reload here
                    }
                });
            });
        });

        // Logout cleanup
        document.addEventListener('DOMContentLoaded', function () {
            const logoutLink = document.getElementById('logoutLink');
            if (logoutLink) {
                logoutLink.addEventListener('click', function() {
                    localStorage.removeItem('validatorActiveTab');
                });
            }
        });

        // View notes functionality - show full notes
        document.body.addEventListener('click', function (e) {
            const target = e.target.closest('.view-notes-btn');
            if (target) {
                const raw = target.getAttribute('data-notes') || 'No notes provided';
                const decoded = raw
                    .replace(/&lt;/g, '<')
                    .replace(/&gt;/g, '>')
                    .replace(/&amp;/g, '&')
                    .replace(/&#34;/g, '"');

                document.getElementById('fullNotesText').textContent = decoded;
            }
        });

        // Flash messages
        document.addEventListener('DOMContentLoaded', function() {
            const flashMessages = document.querySelectorAll('.flash-message');
            if (flashMessages.length > 0) {
                flashMessages.forEach(message => {
                    setTimeout(() => {
                        message.style.display = 'none';
                    }, 5000);
                });
            }
        });
    </script>
    <script>
        // Helper to clear DataTable search
        function clearTableSearch(tableSelector) {
            if ($.fn.DataTable.isDataTable(tableSelector)) {
                $(tableSelector).DataTable().search('').draw();
                // Also clear the input box visually
                $(`${tableSelector}_filter input`).val('');
            }
        }

        // Listen for tab switches (sidebar and nav-tabs)
        document.addEventListener('DOMContentLoaded', function () {
            clearTableSearch('#pendingRequestsTable');
            clearTableSearch('#historyTable');

            document.querySelectorAll('.sidebar-nav-item[data-bs-target], #taTabs button[data-bs-toggle="tab"]').forEach(tab => {
                tab.addEventListener('click', function () {
                    // Clear both tables' search boxes
                    clearTableSearch('#pendingRequestsTable');
                    clearTableSearch('#historyTable');
                });
            });
        });
    </script>
</body>
</html>