name: Python Application Deployment via SSH

on:
  push:
    branches:
      - main

env:
  SSH_PORT: 22
  SSH_USER: prod
  PM2_APP_NAME: app          # PM2 process name (use process name, not filename)
  APP_DIRECTORY: /var/www/prod/PBS/project_root
  TEMP_ARTIFACT_NAME: deploy-artifact.zip

jobs:
  deploy:
    runs-on: ubuntu-latest

    permissions:
      contents: read

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Python (runner)
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Python dependencies (CI-only)
        run: |
          python -m pip install --upgrade pip
          cd project_root || exit 0
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          cd ..

      - name: Create deployment artifact (ZIP)
        run: |
          echo "Creating deployment ZIP: ${{ env.TEMP_ARTIFACT_NAME }}"
          zip -r "${{ env.TEMP_ARTIFACT_NAME }}" . \
            -x "*.git*" \
            -x "venv/*" \
            -x "*/__pycache__/*" \
            -x "*.DS_Store" \
            -x "*.zip" \
            -x "node_modules/*"

      # ---- Upload artifact to remote server using SCP action ----
      - name: Upload artifact to server (SCP)
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ env.SSH_USER }}
          port: ${{ env.SSH_PORT }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: ${{ env.TEMP_ARTIFACT_NAME }}
          target: ~/
          # optional: timeout, passphrase, etc

      # ---- Run remote commands via SSH (no source/target here) ----
      - name: Deploy code and restart application via SSH
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ env.SSH_USER }}
          port: ${{ env.SSH_PORT }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -e
            echo "--- Starting Remote Deployment ---"
            TEMP_PATH=~/${{ env.TEMP_ARTIFACT_NAME }}

            mkdir -p "${{ env.APP_DIRECTORY }}"
            echo "Unzipping ${TEMP_PATH} into ${{ env.APP_DIRECTORY }}"
            unzip -o "$TEMP_PATH" -d "${{ env.APP_DIRECTORY }}"
            rm -f "$TEMP_PATH"

            cd "${{ env.APP_DIRECTORY }}"

            # create/activate venv, install requirements
            python3 -m venv venv || echo "venv exists"
            # ensure venv is executable
            source venv/bin/activate
            if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

            # optional: run migrations (uncomment if using django/flask/alembic)
            # python manage.py migrate

            echo "Restarting application via pm2..."
            # prefer using the pm2 process name (or ecosystem file)
            pm2 restart "${{ env.PM2_APP_NAME }}" || pm2 start app.py --name "${{ env.PM2_APP_NAME }}" --interpreter python3

            echo "--- Deployment Complete ---"
