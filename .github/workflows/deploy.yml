name: Python Application Deployment to Contabo

on:
  push:
    branches:
      - main  # 1. This triggers the process whenever you push code

env:
  SSH_PORT: 22
  SSH_USER: prod
  PM2_APP_NAME: app                  
  DEPLOY_ROOT: /var/www/prod/PBS
  APP_DIRECTORY: /var/www/prod/PBS/current
  TEMP_ARTIFACT_NAME: deploy-artifact.zip

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # 2. Package the code from GitHub to send to the server
      - name: Create deployment artifact (ZIP)
        run: |
          zip -r "${{ env.TEMP_ARTIFACT_NAME }}" . \
            -x "*.git*" -x "venv/*" -x "*/__pycache__/*" -x "*.zip" -x ".env"

      # 3. PUSH the code to the Contabo server
      - name: Upload artifact to server (SCP)
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ env.SSH_USER }}
          port: ${{ env.SSH_PORT }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: ${{ env.TEMP_ARTIFACT_NAME }}
          target: /home/prod/

      # 4. EXECUTE update and RESTART the server application
      - name: Deploy code and Restart Application
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ env.SSH_USER }}
          port: ${{ env.SSH_PORT }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -e
            
            # Save the PREVIOUS release path for rollback
            PREVIOUS_RELEASE=$(readlink -f ${{ env.APP_DIRECTORY }} || echo "")
            TIMESTAMP=$(date +%Y%m%d%H%M%S)
            RELEASE_PATH="${{ env.DEPLOY_ROOT }}/releases/$TIMESTAMP"
            CURRENT_SYMLINK="${{ env.APP_DIRECTORY }}"
            
            echo "--- Deploying to: $RELEASE_PATH ---"

            mkdir -p "$RELEASE_PATH"
            unzip -o /home/prod/${{ env.TEMP_ARTIFACT_NAME }} -d "$RELEASE_PATH"
            rm -f /home/prod/${{ env.TEMP_ARTIFACT_NAME }}

            cd "$RELEASE_PATH"
            python3 -m venv venv
            source venv/bin/activate
            pip install --upgrade pip
            if [ -f requirements.txt ]; then pip install -r requirements.txt --no-cache-dir; fi
            
            # Atomic Switch (Updates the code folder)
            ln -sfn "$RELEASE_PATH" "$CURRENT_SYMLINK"
            
            # RESTART COMMANDS
            PM2_BIN=$(which pm2 || echo "/usr/local/bin/pm2")
            NEW_VENV_PYTHON="$RELEASE_PATH/venv/bin/python3"

            # Restart the app fresh
            $PM2_BIN delete ${{ env.PM2_APP_NAME }} || true
            $PM2_BIN start "$CURRENT_SYMLINK/app.py" \
              --name "${{ env.PM2_APP_NAME }}" \
              --interpreter "$NEW_VENV_PYTHON" \
              --cwd "$CURRENT_SYMLINK"
            $PM2_BIN save

            # 5. HEALTH CHECK & AUTO-ROLLBACK
            echo "Waiting 10s for health check..."
            sleep 10
            
            if ! $PM2_BIN status ${{ env.PM2_APP_NAME }} | grep -q "online"; then
              echo "❌ DEPLOY FAILED! Rolling back to: $PREVIOUS_RELEASE"
              ln -sfn "$PREVIOUS_RELEASE" "$CURRENT_SYMLINK"
              $PM2_BIN delete ${{ env.PM2_APP_NAME }} || true
              $PM2_BIN start "$CURRENT_SYMLINK/app.py" \
                --name "${{ env.PM2_APP_NAME }}" \
                --interpreter "$PREVIOUS_RELEASE/venv/bin/python3" \
                --cwd "$CURRENT_SYMLINK"
              exit 1
            fi

            echo "✅ Deployment Successful!"
            ls -td "${{ env.DEPLOY_ROOT }}/releases/"*/ | tail -n +6 | xargs rm -rf --
