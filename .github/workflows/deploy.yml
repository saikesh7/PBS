name: Python Application Deployment via SSH (Versioned)

on:
  push:
    branches:
      - main

env:
  SSH_PORT: 22
  SSH_USER: prod
  PM2_APP_NAME: app
  # --- ENVIRONMENT VARIABLES ---
  DEPLOY_ROOT: /var/www/prod/PBS         # Base directory for all releases and the current symlink
  APP_DIRECTORY: /var/www/prod/PBS/current # This will now be a symlink to the latest working release
  TEMP_ARTIFACT_NAME: deploy-artifact.zip
  # The HEALT_CHECK variables are removed as they are not used
  # -----------------------------

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Python (runner)
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          
      - name: Install Python dependencies (CI-only)
        run: |
          python -m pip install --upgrade pip
          cd project_root || exit 0
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          cd ..

      - name: Create deployment artifact (ZIP)
        run: |
          echo "Creating deployment ZIP: ${{ env.TEMP_ARTIFACT_NAME }}"
          zip -r "${{ env.TEMP_ARTIFACT_NAME }}" . \
            -x "*.git*" \
            -x "venv/*" \
            -x "*/__pycache__/*" \
            -x "*.DS_Store" \
            -x "*.zip" \
            -x "node_modules/*"

      # ---- Upload artifact to remote server using SCP action ----
      - name: Upload artifact to server (SCP)
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ env.SSH_USER }}
          port: ${{ env.SSH_PORT }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: ${{ env.TEMP_ARTIFACT_NAME }}
          target: ~/

      # ---- Run remote commands via SSH (VERSIONED DEPLOYMENT) ----
      - name: Deploy code and Restart Application
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ env.SSH_USER }}
          port: ${{ env.SSH_PORT }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            # Exit immediately if a command exits with a non-zero status.
            set -e
            echo "--- Starting Versioned Remote Deployment ---"
            
            # Define version paths
            TIMESTAMP=$(date +%Y%m%d%H%M%S)
            RELEASE_PATH="${{ env.DEPLOY_ROOT }}/releases/$TIMESTAMP"
            CURRENT_SYMLINK="${{ env.DEPLOY_ROOT }}/current"
            
            # 1. Prepare new release directory
            mkdir -p "$RELEASE_PATH"
            TEMP_PATH=~/${{ env.TEMP_ARTIFACT_NAME }}
            echo "Unzipping $TEMP_PATH into $RELEASE_PATH"
            unzip -o "$TEMP_PATH" -d "$RELEASE_PATH"
            rm -f "$TEMP_PATH"

            # 2. Setup VENV and Install Dependencies in the new release folder
            cd "$RELEASE_PATH"
            python3 -m venv venv || echo "venv exists"
            source venv/bin/activate
            if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
            
            # optional: run migrations here, before symlink switch
            # python manage.py migrate

            # 3. SWAP SYMLINK (Atomic switch to the new code base)
            echo "Switching symlink to $RELEASE_PATH"
            # ln -sfn ensures an atomic switch
            ln -sfn "$RELEASE_PATH" "$CURRENT_SYMLINK"
            
            # 4. RESTART APP via PM2 (Points to the new symlink)
            echo "Restarting application via pm2..."
            
            # --- PM2 Logic to restart/start using the 'current' symlink ---
            if pm2 describe ${{ env.PM2_APP_NAME }} > /dev/null 2>&1; then
              pm2 reload ${{ env.PM2_APP_NAME }}
              echo "PM2 process reloaded."
            else
              # IMPORTANT: Ensure your PM2 'start' command uses the APP_DIRECTORY symlink
              pm2 start "$CURRENT_SYMLINK"/app.py --name "${{ env.PM2_APP_NAME }}" --interpreter python3
              echo "PM2 process started for the first time."
            fi
            # -----------------------------------------------------------

            echo "--- Deployment Complete (No Health Check/Rollback after Restart) ---"
            
            # 5. Cleanup old releases (Recommended to save disk space)
            echo "Cleaning up old releases, keeping the last 5..."
            ls -td "${{ env.DEPLOY_ROOT }}/releases/"*/ | tail -n +6 | xargs rm -rf
