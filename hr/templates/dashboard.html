{% extends "base.html" %}

{% block title %}HR Dashboard - HR Portal{% endblock %}

{% block extra_css %}
<style>
  .dashboard-checkbox-group {
    max-height: 200px;
    overflow-y: auto;
    border: 1px solid #ced4da;
    border-radius: 0.25rem;
    padding: 0.5rem;
  }
  .dashboard-checkbox-group .form-check {
    margin-bottom: 0.5rem;
  }
  .active-status-switch {
    transform: scale(1.2);
  }
  .required-field::after {
    content: " *";
    color: red;
  }
  
  /* Modal Styles */
  .modal-header.bg-success {
    background-color: #28a745 !important;
    color: white;
  }
  .modal-header.bg-warning {
    background-color: #ffc107 !important;
    color: #212529;
  }
  .result-section {
    max-height: 300px;
    overflow-y: auto;
    margin-bottom: 1rem;
  }
  .result-item {
    padding: 0.5rem;
    margin-bottom: 0.5rem;
    border-radius: 0.25rem;
    background-color: #f8f9fa;
  }
  .result-item.success {
    border-left: 4px solid #28a745;
  }
  .result-item.error {
    border-left: 4px solid #dc3545;
  }
  .result-item.warning {
    border-left: 4px solid #ffc107;
  }
</style>
{% endblock %}

{% block content %}
  
  <!-- Single Registration -->
  <div class="card mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
      <span>Register Single Employee</span>
      <span class="badge bg-primary">Form</span>
    </div>
    <div class="card-body">
      <form method="POST">
        <input type="hidden" name="register_single">

        <!-- Basic Information -->
        <div class="row mb-3">
          <div class="col-md-6">
            <label class="form-label required-field">Name</label>
            <input type="text" name="name" class="form-control form-control-2" required>
          </div>
          <div class="col-md-6">
            <label class="form-label required-field">Email</label>
            <input type="email" name="email" class="form-control form-control-2" required>
          </div>
        </div>

        <div class="row mb-3">
          <div class="col-md-6">
            <label class="form-label required-field">Phone</label>
            <input type="text" name="phone" class="form-control form-control-2" required>
          </div>
          <div class="col-md-6">
            <label class="form-label required-field">Employee ID</label>
            <input type="text" name="employee_id" class="form-control form-control-2" required>
          </div>
        </div>

        <div class="row mb-3">
          <div class="col-md-6">
            <label class="form-label required-field">Password</label>
            <div class="input-group">
              <input type="password" name="password" id="password" class="form-control form-control-2" required>
              <button class="btn btn-outline-secondary" type="button" id="togglePassword">
                <i class="fas fa-eye"></i>
              </button>
            </div>
          </div>
          <div class="col-md-6">
            <label class="form-label required-field">Grade</label>
            <select name="grade" class="form-select" required>
              <option value="">-- Select Grade --</option>
              {% for g in grades %}
                <option value="{{ g }}">{{ g }}</option>
              {% endfor %}
            </select>
          </div>
        </div>

        <!-- Department and Location -->
        <div class="row mb-3">
          <div class="col-md-6">
            <label class="form-label required-field">Department</label>
            <select name="department" class="form-select form-control-2" required>
              <option value="">-- Select Department --</option>
              {% for dept in departments %}
                <option value="{{ dept }}">{{ dept }}</option>
              {% endfor %}
            </select>
          </div>
          
          <div class="col-md-6">
            <label class="form-label required-field">Location</label>
            <select name="location" class="form-select form-control-2" required>
              <option value="">-- Select Location --</option>
              {% for loc in locations %}
                <option value="{{ loc }}">{{ loc }}</option>
              {% endfor %}
            </select>
          </div>
        </div>

        <!-- Employee Level and Active Status -->
        <div class="row mb-3">
          <div class="col-md-6">
            <label class="form-label required-field">Employee Level</label>
            <select name="employee_level" class="form-select" required>
              <option value="">-- Select Employee Level --</option>
              {% for level in employee_levels %}
                <option value="{{ level }}">{{ level }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-6">
            <label class="form-label">Active Status</label>
            <div class="form-check form-switch mt-2">
              <input class="form-check-input active-status-switch" type="checkbox" name="is_active" id="isActive" checked>
              <label class="form-check-label" for="isActive">
                <span id="activeStatusText">Active</span>
              </label>
            </div>
          </div>
        </div>

        <!-- Dates -->
        <div class="row mb-3">
          <div class="col-md-6">
            <label class="form-label required-field">Joining Date</label>
            <input type="date" name="joining_date" class="form-control form-control-2" required>
          </div>
          <div class="col-md-6">
            <label class="form-label">Exit Date (optional)</label>
            <input type="date" name="exit_date" class="form-control form-control-2">
          </div>
        </div>

        <!-- Manager and DP Assignment -->
        <div class="row mb-3">
          <div class="col-md-6">
            <label class="form-label">Assign Manager (PM Dashboard Access)</label>
            <select name="manager_id" class="form-select">
              <option value="">-- Select Manager --</option>
              {% for manager in managers %}
                <option value="{{ manager._id }}">{{ manager.name }} ({{ manager.email }})</option>
              {% endfor %}
            </select>
            <small class="text-muted">Only users with PM dashboard access</small>
          </div>
          <div class="col-md-6">
            <label class="form-label">Assign DP (DP Dashboard Access)</label>
            <select name="dp_id" class="form-select">
              <option value="">-- Select DP --</option>
              {% for dp in dps %}
                <option value="{{ dp._id }}">{{ dp.name }} ({{ dp.email }})</option>
              {% endfor %}
            </select>
            <small class="text-muted">Only users with DP dashboard access</small>
          </div>
        </div>

        <!-- Dashboard Access Section -->
        <div class="card mb-3 bg-light">
          <div class="card-header">
            <h6 class="mb-0">Dashboard Access</h6>
            <small class="text-muted">Select which dashboards this employee can access (employee_db is mandatory)</small>
          </div>
          <div class="card-body">
            <div class="dashboard-checkbox-group">
              {% for dashboard in dashboard_access_options %}
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" 
                         name="dashboard_access[]" 
                         value="{{ dashboard }}" 
                         id="dashboard_{{ dashboard }}"
                         {% if dashboard == 'employee_db' %}checked disabled{% endif %}>
                  <label class="form-check-label" for="dashboard_{{ dashboard }}">
                    {{ dashboard|replace('_', ' ')|title }}
                    {% if dashboard == 'employee_db' %}
                      <span class="badge bg-secondary ms-2">Required</span>
                    {% endif %}
                  </label>
                </div>
              {% endfor %}
            </div>
          </div>
        </div>

        <div class="d-flex justify-content-end">
          <button type="reset" class="btn btn-light me-2">Reset</button>
          <button type="submit" class="btn btn-primary">
            <i class="fas fa-user-plus me-2"></i>Register Employee
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Bulk CSV Upload -->
  <div class="card mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
      <span>Bulk Register Employees</span>
      <span class="badge bg-success">CSV Import</span>
    </div>
    <div class="card-body">
      <form method="POST" enctype="multipart/form-data" id="bulkUploadForm">
        <input type="hidden" name="register_bulk" value="true">

        <div class="mb-3">
          <label for="csv_file" class="form-label">Upload CSV File:</label>
          <input type="file" name="csv_file" id="csv_file" class="form-control form-control-2" accept=".csv" required>
        </div>

        <div class="d-flex justify-content-end">
          <button type="submit" class="btn btn-success">
            <i class="fas fa-file-upload me-2"></i>Upload and Process
          </button>
        </div>
      </form>

      <div class="card mt-4 border border-light">
        <div class="card-header py-2 px-3 bg-light">
          <strong>Expected CSV Format</strong>
        </div>
        <div class="card-body py-2 px-3">
          <p><strong>Required Fields:</strong></p>
          <code>name, email, phone, employee_id, password, grade, department, location, employee_level, joining_date</code>
          <p class="mt-2"><strong>Optional Fields:</strong></p>
          <code>manager_name, dp_name, is_active, dashboard_access, exit_date</code>
        </div>
        <div class="card-footer py-2 px-3">
          <strong>Available Options:</strong><br>
          <strong>Grades:</strong> {{ grades|join(', ') }}<br>
          <strong>Departments:</strong> {{ departments|join(', ') }}<br>
          <strong>Locations:</strong> {{ locations|join(', ') }}<br>
          <strong>Employee Levels:</strong> {{ employee_levels|join(', ') }}<br>
          <strong>Dashboard Access:</strong> {{ dashboard_access_options|join(', ') }}<br>
          <strong>Active Status:</strong> true/false, yes/no, 1/0, on/off, active/inactive<br>
          <strong>Note:</strong> Manager and DP names should match registered names or use email addresses. Dashboard access should be comma-separated values (e.g., employee_db,analytics_db,pm). By default, employee_db is always included.
        </div>
      </div>

      <div class="mt-3">
        <a href="{{ url_for('hr_registration.download_csv_template') }}" class="btn btn-outline-primary">
          <i class="fas fa-download me-2"></i>Download Sample CSV Template
        </a>
      </div>
    </div>
  </div>

  <!-- Manage Dynamic Fields Button -->
  <div class="text-end mb-4">
    <a href="{{ url_for('hr_registration.manage_fields') }}" class="btn btn-info">
      <i class="fas fa-cog me-2"></i>Manage Dynamic Fields
    </a>
  </div>

  <!-- Bulk Upload Results Modal -->
  <div class="modal fade" id="bulkUploadResultsModal" tabindex="-1" aria-labelledby="bulkUploadResultsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header" id="modalHeader">
          <h5 class="modal-title" id="bulkUploadResultsModalLabel">Bulk Upload Results</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="alert alert-info" id="modalSummary">
            <h6 class="alert-heading"><i class="fas fa-info-circle me-2"></i>Upload Summary</h6>
            <p class="mb-0" id="summaryText"></p>
          </div>
          
          <div id="successSection" class="result-section" style="display: none;">
            <h6 class="text-success"><i class="fas fa-check-circle me-2"></i>Successfully Added (<span id="successCount">0</span>)</h6>
            <div id="successList"></div>
          </div>
          
          <div id="errorSection" class="result-section" style="display: none;">
            <h6 class="text-danger"><i class="fas fa-times-circle me-2"></i>Errors/Skipped (<span id="errorCount">0</span>)</h6>
            <div id="errorList"></div>
          </div>
          
          <div id="warningSection" class="result-section" style="display: none;">
            <h6 class="text-warning"><i class="fas fa-exclamation-triangle me-2"></i>Warnings (<span id="warningCount">0</span>)</h6>
            <div id="warningList"></div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

{% endblock %}

{% block scripts %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
<script>
  // Toggle password visibility
  document.getElementById('togglePassword')?.addEventListener('click', function () {
    const passwordInput = document.getElementById('password');
    const icon = this.querySelector('i');

    if (passwordInput.type === 'password') {
      passwordInput.type = 'text';
      icon.classList.remove('fa-eye');
      icon.classList.add('fa-eye-slash');
    } else {
      passwordInput.type = 'password';
      icon.classList.remove('fa-eye-slash');
      icon.classList.add('fa-eye');
    }
  });

  // Handle active status toggle
  document.getElementById('isActive')?.addEventListener('change', function() {
    const statusText = document.getElementById('activeStatusText');
    statusText.textContent = this.checked ? 'Active' : 'Inactive';
    statusText.className = this.checked ? 'text-success' : 'text-danger';
  });

  // Ensure employee_db checkbox is always checked
  document.addEventListener("DOMContentLoaded", () => {
    const employeeDbCheckbox = document.getElementById('dashboard_employee_db');
    if (employeeDbCheckbox) {
      employeeDbCheckbox.checked = true;
      employeeDbCheckbox.addEventListener('click', function(e) {
        if (!this.checked) {
          this.checked = true;
          e.preventDefault();
        }
      });
    }
    
    // Check if there are flash messages and show modal
    processFlashMessages();
  });

  // Process flash messages and show modal for bulk upload results
  function processFlashMessages() {
    const flashMessages = document.querySelectorAll('.alert');
    let successCount = 0;
    let errorCount = 0;
    let warningMessages = [];
    let mainMessage = '';
    
    flashMessages.forEach(alert => {
      const text = alert.textContent.trim();
      
      // Check if this is a bulk upload success message
      if (text.includes('employees added') && text.includes('skipped')) {
        const match = text.match(/(\d+)\s+employees added,\s+(\d+)\s+skipped/);
        if (match) {
          successCount = parseInt(match[1]);
          errorCount = parseInt(match[2]);
          mainMessage = text;
        }
      }
      // Collect warning messages
      else if (alert.classList.contains('alert-warning')) {
        warningMessages.push(text);
      }
    });
    
    // Show modal if bulk upload was performed
    if (mainMessage && (successCount > 0 || errorCount > 0)) {
      showBulkUploadModal(successCount, errorCount, warningMessages, mainMessage);
    }
  }

  function showBulkUploadModal(successCount, errorCount, warnings, summary) {
    const modal = new bootstrap.Modal(document.getElementById('bulkUploadResultsModal'));
    const modalHeader = document.getElementById('modalHeader');
    const summaryText = document.getElementById('summaryText');
    
    // Update summary
    summaryText.textContent = summary;
    
    // Set modal header color based on results
    if (errorCount === 0) {
      modalHeader.className = 'modal-header bg-success';
    } else if (successCount === 0) {
      modalHeader.className = 'modal-header bg-danger';
    } else {
      modalHeader.className = 'modal-header bg-warning';
    }
    
    // Show success section
    if (successCount > 0) {
      document.getElementById('successSection').style.display = 'block';
      document.getElementById('successCount').textContent = successCount;
      document.getElementById('successList').innerHTML = `
        <div class="result-item success">
          <i class="fas fa-check-circle text-success me-2"></i>
          ${successCount} employee(s) successfully registered
        </div>
      `;
    }
    
    // Show error section
    if (errorCount > 0) {
      document.getElementById('errorSection').style.display = 'block';
      document.getElementById('errorCount').textContent = errorCount;
      document.getElementById('errorList').innerHTML = `
        <div class="result-item error">
          <i class="fas fa-times-circle text-danger me-2"></i>
          ${errorCount} row(s) skipped due to errors
        </div>
      `;
    }
    
    // Show warnings section
    if (warnings.length > 0) {
      document.getElementById('warningSection').style.display = 'block';
      document.getElementById('warningCount').textContent = warnings.length;
      
      let warningHtml = '';
      warnings.forEach(warning => {
        warningHtml += `
          <div class="result-item warning">
            <i class="fas fa-exclamation-triangle text-warning me-2"></i>
            ${warning}
          </div>
        `;
      });
      document.getElementById('warningList').innerHTML = warningHtml;
    }
    
    modal.show();
  }

  // Dynamic field loading (for future AJAX implementation)
  function loadDynamicFields(fieldType) {
    fetch(`/hr/api/get-fields/${fieldType}`)
      .then(response => response.json())
      .then(data => {
        console.log(`Loaded ${fieldType}:`, data);
        // Update dropdowns dynamically if needed
      })
      .catch(error => console.error('Error loading fields:', error));
  }
</script>
{% endblock %}