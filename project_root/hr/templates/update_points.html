{% extends "base.html" %}

{% block title %}Update Employee Points - HR Portal{% endblock %}

{% block extra_css %}
<style>
    .filters-section select.form-select {
        border-radius: 0.5rem;
        border: 1px solid #ccc;
    }
    
    .btn-same-size {
        min-width: 70px;
    }
    
    .card {
        border: none;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .badge-lg {
        font-size: 1.1rem;
        padding: 0.5rem 1rem;
    }
    
    .points-summary-card {
        border-left: 4px solid #4e73df;
    }
    
    .table-actions {
        white-space: nowrap;
    }
</style>
{% endblock %}

{% block content %}
{% if can_access_update_points_page %}

<div class="container-fluid pt-4">
    <!-- Page Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3 class="mb-0">Update Employee Points</h3>
    </div>

    <!-- Search Card -->
    <div class="card mb-4">
        <div class="card-header bg-light">
            <h5 class="mb-0"><i class="fas fa-search me-2"></i>Search Employee</h5>
        </div>
        <div class="card-body">
            <form method="POST" action="{{ url_for('hr_points_mgmt.update_user_points_page') }}">
                <div class="input-group">
                    <span class="input-group-text"><i class="fas fa-user"></i></span>
                    <input 
                        type="text" 
                        name="search_query" 
                        class="form-control" 
                        placeholder="Enter Email or Employee ID" 
                        value="{{ search_query if search_query else '' }}" 
                        required>
                    <button 
                        type="submit" 
                        name="search_employee" 
                        class="btn btn-primary">
                        <i class="fas fa-search me-2"></i>Search
                    </button>
                </div>
                <small class="form-text text-muted">Search by email address or employee ID to view and manage points</small>
            </form>
        </div>
    </div>

    {% if show_form and user %}
    <!-- Employee Details Card -->
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0">
                <i class="fas fa-user-circle me-2"></i>
                Employee: {{ user.name }}
            </h5>
        </div> 
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <strong><i class="fas fa-id-card me-2"></i>Employee ID:</strong>
                        <span id="employee_id_display">{{ user.employee_id }}</span>
                    </div>
                    <div class="mb-3">
                        <strong><i class="fas fa-envelope me-2"></i>Email:</strong>
                        <span id="email_display">{{ user.email }}</span>
                    </div>
                    <div class="mb-3">
                        <strong><i class="fas fa-layer-group me-2"></i>Grade:</strong>
                        <span class="badge bg-info" id="grade_display">{{ user.grade | default('N/A') }}</span>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card points-summary-card h-100">
                        <div class="card-body text-center">
                            <h6 class="text-muted mb-2">Total Points (All Time)</h6>
                            <h2 class="mb-0">
                                <span class="badge bg-success badge-lg" id="total_points_all_time_badge">
                                    {{ total_points_all_time | default(0) }}
                                </span>
                            </h2>
                        </div>
                    </div>
                </div>
            </div>

            <hr class="my-4">

            <!-- Points Breakdown -->
            <div class="row">
                <div class="col-md-6">
                    <h6 class="fw-semibold mb-3"><i class="fas fa-chart-bar me-2"></i>Quarterly Breakdown</h6>
                    <ul class="list-group" id="quarterly_breakdown_list">
                        {% if quarterly_breakdown %}
                            {% for quarter, points in quarterly_breakdown.items() %}
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                {{ quarter }}
                                <span class="badge bg-primary rounded-pill">{{ points }}</span>
                            </li>
                            {% endfor %}
                        {% else %}
                            <li class="list-group-item text-muted">No quarterly data available</li>
                        {% endif %}
                    </ul>
                </div>
                <div class="col-md-6">
                    <h6 class="fw-semibold mb-3"><i class="fas fa-calendar-alt me-2"></i>Yearly Summary</h6>
                    <ul class="list-group" id="yearly_summary_list">
                        {% if yearly_summary %}
                            {% for year, points in yearly_summary.items() %}
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                FY {{ year }}
                                <span class="badge bg-success rounded-pill">{{ points }}</span>
                            </li>
                            {% endfor %}
                        {% else %}
                            <li class="list-group-item text-muted">No yearly data available</li>
                        {% endif %}
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Points History Card -->
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-light">
            <h5 class="mb-0"><i class="fas fa-history me-2"></i>Points History</h5>
        </div>
        <div class="card-body">
            <!-- Filters -->
            <div class="row mb-4">
                <div class="col-md-3 mb-2">
                    <label for="categoryFilter" class="form-label">Category</label>
                    <select class="form-select" id="categoryFilter">
                        <option value="all">All Categories</option>
                        {% for category_name in unique_categories_for_filter %}
                        <option value="{{ category_name }}">{{ category_name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3 mb-2">
                    <label for="awardedByFilter" class="form-label">Awarded By</label>
                    <select class="form-select" id="awardedByFilter">
                        <option value="all">All Sources</option>
                        {% for awarded_by_name in unique_awarded_by_for_filter %}
                        <option value="{{ awarded_by_name }}">{{ awarded_by_name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3 mb-2">
                    <label for="periodFilter" class="form-label">Period</label>
                    <select class="form-select" id="periodFilter">
                        <option value="all">All Periods</option>
                        {% for period_name in unique_periods_for_filter %}
                        <option value="{{ period_name }}">{{ period_name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3 mb-2 d-flex align-items-end gap-2">
                    <button type="button" class="btn btn-primary flex-fill" id="applyFiltersBtn">
                        <i class="fas fa-filter me-1"></i>Apply
                    </button>
                    <button type="button" class="btn btn-secondary flex-fill" id="resetFiltersBtn">
                        <i class="fas fa-undo me-1"></i>Reset
                    </button>
                </div>
            </div>

            <!-- Points History Table -->
            <div class="table-responsive">
                <table class="table table-bordered table-hover table-sm" id="pointsHistoryTable">
                    <thead class="table-light">
                        <tr>
                            <th>Category</th>
                            <th>Points</th>
                            <th>Awarded By</th>
                            <th>Notes</th>
                            <th>Date / Period</th>
                            <th style="width: 160px;">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% if points_history %}
                            {% for point in points_history %}
                            <tr data-category="{{ point.category }}" 
                                data-awarded-by="{{ point.awarded_by }}" 
                                data-period="{{ point.period }}">
                                <td>
                                    {{ point.category }}
                                    {% if point.is_bonus %}
                                    <span class="badge bg-warning text-dark ms-1">Bonus</span>
                                    {% endif %}
                                </td>
                                <td><strong>{{ point.points }}</strong></td>
                                <td>
                                    {{ point.awarded_by }}
                                    {% if point.is_bonus and point.bonus_approver_name %}
                                    <br><small class="text-muted">(Approved: {{ point.bonus_approver_name }})</small>
                                    {% endif %}
                                </td>
                                <td>
                                    <button type="button" 
                                            class="btn btn-outline-primary btn-sm" 
                                            onclick="showFullNotes(`{{ point.notes | replace('`', '\\`') | replace('\n', '\\n') }}`)">
                                        <i class="fas fa-eye"></i> View
                                    </button>
                                </td>
                                <td>
                                    {{ point.award_date }}
                                    <br><small class="text-muted">{{ point.period }}</small>
                                </td>
                                <td class="table-actions">
                                    <div class="d-flex gap-2">
                                        <button type="button" 
                                                class="btn btn-warning btn-sm" 
                                                data-bs-toggle="modal" 
                                                data-bs-target="#editPointModal{{ point.id }}">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <form method="POST" 
                                              action="{{ url_for('hr_points_mgmt.update_user_points_page') }}" 
                                              style="display: inline;">
                                            <input type="hidden" name="delete_point" value="1">
                                            <input type="hidden" name="point_id" value="{{ point.id }}">
                                            <input type="hidden" name="search_query" value="{{ search_query }}">
                                            <button type="submit" 
                                                    class="btn btn-danger btn-sm" 
                                                    onclick="return confirm('Are you sure you want to delete this point transaction?');">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </form>
                                    </div>

                                    <!-- Edit Point Modal -->
                                    <div class="modal fade" id="editPointModal{{ point.id }}" tabindex="-1" aria-hidden="true">
                                        <div class="modal-dialog">
                                            <div class="modal-content">
                                                <div class="modal-header">
                                                    <h5 class="modal-title">Edit Point Transaction</h5>
                                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                                </div>
                                                <form method="POST" action="{{ url_for('hr_points_mgmt.update_user_points_page') }}">
                                                    <div class="modal-body">
                                                        <input type="hidden" name="update_point" value="1">
                                                        <input type="hidden" name="point_id" value="{{ point.id }}">
                                                        <input type="hidden" name="search_query" value="{{ search_query }}">
                                                        
                                                        <div class="mb-3">
                                                            <label for="editPoints{{ point.id }}" class="form-label">Points *</label>
                                                            <input type="number" 
                                                                   class="form-control" 
                                                                   id="editPoints{{ point.id }}" 
                                                                   name="points" 
                                                                   value="{{ point.points }}" 
                                                                   required>
                                                        </div>
                                                        <div class="mb-3">
                                                            <label for="editNotes{{ point.id }}" class="form-label">Notes</label>
                                                            <textarea class="form-control" 
                                                                      id="editNotes{{ point.id }}" 
                                                                      name="notes" 
                                                                      rows="4">{{ point.notes }}</textarea>
                                                        </div>
                                                    </div>
                                                    <div class="modal-footer">
                                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                                        <button type="submit" class="btn btn-primary">
                                                            <i class="fas fa-save me-2"></i>Save Changes
                                                        </button>
                                                    </div>
                                                </form>
                                            </div>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        {% else %}
                            <tr class="no-data-row">
                                <td colspan="6" class="text-center py-4">No points history found.</td>
                            </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Employee List for Quick Access -->
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-light">
            <h5 class="mb-0"><i class="fas fa-users me-2"></i>Quick Access - All Employees</h5>
        </div>
        <div class="card-body">
            <!-- Filter Section -->
            <div class="row mb-3">
                <div class="col-md-3">
                    <label for="department-filter" class="form-label">Department</label>
                    <select id="department-filter" class="form-select">
                        <option value="">All Departments</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="grade-filter" class="form-label">Grade</label>
                    <select id="grade-filter" class="form-select">
                        <option value="">All Grades</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="location-filter" class="form-label">Location</label>
                    <select id="location-filter" class="form-select">
                        <option value="">All Locations</option>
                    </select>
                </div>
                <div class="col-md-3 d-flex align-items-end gap-2">
                    <button id="apply-employee-filters-btn" class="btn btn-primary flex-fill">Apply</button>
                    <button id="reset-employee-filters-btn" class="btn btn-secondary flex-fill">Reset</button>
                </div>
            </div>
            
            <div class="mb-2">
                <small id="employee-results-count" class="text-muted"></small>
            </div>

            <!-- Employee Table -->
            <div class="table-responsive">
                <table class="table table-striped table-hover table-sm">
                    <thead class="table-light">
                        <tr>
                            <th>Name</th>
                            <th>Employee ID</th>
                            <th>Grade</th>
                            <th>Department</th>
                            <th>Location</th>
                            <th>Manager</th>
                            <th>Joining Date</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="employee-table-body">
                        {% for employee in employees %}
                        <tr data-department="{{ employee.department }}" 
                            data-grade="{{ employee.grade }}" 
                            data-location="{{ employee.us_non_us }}">
                            <td>{{ employee.name }}</td>
                            <td>{{ employee.employee_id }}</td>
                            <td><span class="badge bg-info">{{ employee.grade }}</span></td>
                            <td>{{ employee.department }}</td>
                            <td>{{ employee.us_non_us }}</td>
                            <td>{{ employee.manager_name }}</td>
                            <td>{{ employee.joining_date.strftime('%d-%m-%Y') if employee.joining_date else 'N/A' }}</td>
                            <td>
                                <a href="{{ url_for('hr_points_mgmt.update_user_points_page', search_query=employee.employee_id) }}" 
                                   class="btn btn-primary btn-sm">
                                    <i class="fas fa-edit"></i> Update
                                </a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- View Notes Modal -->
<div class="modal fade" id="viewNotesModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title"><i class="fas fa-sticky-note me-2"></i>Notes</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" 
                 id="fullNotesText" 
                 style="min-height: 100px; max-height: 400px; overflow-y: auto; white-space: pre-wrap; word-break: break-word;">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

{% else %}
<div class="container mt-5">
    <div class="alert alert-danger" role="alert">
        <h4 class="alert-heading"><i class="fas fa-exclamation-triangle me-2"></i>Access Denied!</h4>
        <p>You do not have the necessary permissions to view or use this page. Please contact the administrator if you believe this is an error.</p>
    </div>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    
    // ========================================
    // Points History Table Filtering
    // ========================================
    const pointsHistoryTable = document.getElementById('pointsHistoryTable');
    const categoryFilter = document.getElementById('categoryFilter');
    const awardedByFilter = document.getElementById('awardedByFilter');
    const periodFilter = document.getElementById('periodFilter');
    const applyFiltersBtn = document.getElementById('applyFiltersBtn');
    const resetFiltersBtn = document.getElementById('resetFiltersBtn');

    if (pointsHistoryTable && applyFiltersBtn) {
        applyFiltersBtn.addEventListener('click', applyPointsFilters);
        
        if (resetFiltersBtn) {
            resetFiltersBtn.addEventListener('click', function() {
                if (categoryFilter) categoryFilter.value = 'all';
                if (awardedByFilter) awardedByFilter.value = 'all';
                if (periodFilter) periodFilter.value = 'all';
                applyPointsFilters();
            });
        }

        function applyPointsFilters() {
            const selectedCategory = categoryFilter.value;
            const selectedAwardedBy = awardedByFilter.value;
            const selectedPeriod = periodFilter.value;

            const rows = pointsHistoryTable.querySelectorAll('tbody tr:not(.no-data-row)');
            let visibleRows = 0;

            rows.forEach(function(row) {
                let showRow = true;

                if (selectedCategory !== 'all') {
                    const rowCategory = row.getAttribute('data-category');
                    if (rowCategory !== selectedCategory) showRow = false;
                }

                if (selectedAwardedBy !== 'all' && showRow) {
                    const rowAwardedBy = row.getAttribute('data-awarded-by');
                    if (rowAwardedBy !== selectedAwardedBy) showRow = false;
                }

                if (selectedPeriod !== 'all' && showRow) {
                    const rowPeriod = row.getAttribute('data-period');
                    if (rowPeriod !== selectedPeriod) showRow = false;
                }

                row.style.display = showRow ? '' : 'none';
                if (showRow) visibleRows++;
            });

            // Handle no data row
            let noDataRow = pointsHistoryTable.querySelector('tbody tr.no-data-row');
            if (visibleRows === 0) {
                if (!noDataRow) {
                    const tbody = pointsHistoryTable.querySelector('tbody');
                    const tr = document.createElement('tr');
                    tr.className = 'no-data-row';
                    const td = document.createElement('td');
                    td.colSpan = 6;
                    td.className = 'text-center py-4';
                    td.innerHTML = '<i class="fas fa-search text-muted mb-2"></i><br>No matching records found';
                    tr.appendChild(td);
                    tbody.appendChild(tr);
                }
            } else if (noDataRow) {
                noDataRow.remove();
            }
        }
    }

    // ========================================
    // Employee Table Filtering
    // ========================================
    const employeeTableBody = document.getElementById('employee-table-body');
    const departmentFilter = document.getElementById('department-filter');
    const gradeFilter = document.getElementById('grade-filter');
    const locationFilter = document.getElementById('location-filter');
    const applyEmployeeFiltersBtn = document.getElementById('apply-employee-filters-btn');
    const resetEmployeeFiltersBtn = document.getElementById('reset-employee-filters-btn');
    const employeeResultsCount = document.getElementById('employee-results-count');

    if (employeeTableBody) {
        let allEmployees = [];
        
        function initializeEmployeeFilters() {
            const rows = employeeTableBody.getElementsByTagName('tr');
            allEmployees = [];
            
            const departments = new Set();
            const grades = new Set();
            const locations = new Set();
            
            for (let i = 0; i < rows.length; i++) {
                const row = rows[i];
                const department = row.getAttribute('data-department');
                const grade = row.getAttribute('data-grade');
                const location = row.getAttribute('data-location');
                
                allEmployees.push({
                    element: row,
                    department: department,
                    grade: grade,
                    location: location
                });
                
                if (department) departments.add(department);
                if (grade) grades.add(grade);
                if (location) locations.add(location);
            }
            
            populateFilterOptions(departmentFilter, departments);
            populateFilterOptions(gradeFilter, grades);
            populateFilterOptions(locationFilter, locations);
            
            updateEmployeeResultsCount(allEmployees.length, allEmployees.length);
        }
        
        function populateFilterOptions(selectElement, optionsSet) {
            const currentValue = selectElement.value;
            const firstOption = selectElement.options[0].text;
            
            selectElement.innerHTML = `<option value="">${firstOption}</option>`;
            
            Array.from(optionsSet).sort().forEach(option => {
                const optionElement = document.createElement('option');
                optionElement.value = option;
                optionElement.textContent = option;
                selectElement.appendChild(optionElement);
            });
            
            if (currentValue) selectElement.value = currentValue;
        }
        
        function applyEmployeeFilters() {
            const departmentValue = departmentFilter.value;
            const gradeValue = gradeFilter.value;
            const locationValue = locationFilter.value;
            
            let visibleCount = 0;
            
            allEmployees.forEach(employee => {
                const departmentMatch = !departmentValue || employee.department === departmentValue;
                const gradeMatch = !gradeValue || employee.grade === gradeValue;
                const locationMatch = !locationValue || employee.location === locationValue;
                
                const show = departmentMatch && gradeMatch && locationMatch;
                employee.element.style.display = show ? '' : 'none';
                if (show) visibleCount++;
            });
            
            updateEmployeeResultsCount(visibleCount, allEmployees.length);
        }
        
        function resetEmployeeFilters() {
            departmentFilter.value = '';
            gradeFilter.value = '';
            locationFilter.value = '';
            applyEmployeeFilters();
        }
        
        function updateEmployeeResultsCount(visible, total) {
            if (employeeResultsCount) {
                employeeResultsCount.textContent = `Showing ${visible} of ${total} employees`;
            }
        }
        
        if (applyEmployeeFiltersBtn) {
            applyEmployeeFiltersBtn.addEventListener('click', applyEmployeeFilters);
        }
        
        if (resetEmployeeFiltersBtn) {
            resetEmployeeFiltersBtn.addEventListener('click', resetEmployeeFilters);
        }
        
        initializeEmployeeFilters();
    }

    // ========================================
    // Auto-refresh User Data
    // ========================================
    const isUserDisplayed = {{ 'true' if show_form and user else 'false' }};
    const currentUserId = '{{ user._id if user else '' }}';
    let refreshIntervalId;

    function fetchAndUpdateUserData(userId) {
        fetch(`/hr/api/user-points-data/${userId}`)
            .then(response => {
                if (!response.ok) throw new Error('Network response was not ok');
                return response.json();
            })
            .then(data => {
                if (data.error) {
                    console.error('Error fetching user data:', data.error);
                    return;
                }
                
                // Update summary
                const totalPointsBadge = document.getElementById('total_points_all_time_badge');
                if (totalPointsBadge) totalPointsBadge.textContent = data.total_points_all_time;
                
                // Update quarterly breakdown
                const quarterlyList = document.getElementById('quarterly_breakdown_list');
                if (quarterlyList) {
                    quarterlyList.innerHTML = '';
                    if (Object.keys(data.quarterly_breakdown).length > 0) {
                        for (const quarter in data.quarterly_breakdown) {
                            const li = document.createElement('li');
                            li.className = 'list-group-item d-flex justify-content-between align-items-center';
                            li.innerHTML = `${quarter} <span class="badge bg-primary rounded-pill">${data.quarterly_breakdown[quarter]}</span>`;
                            quarterlyList.appendChild(li);
                        }
                    } else {
                        quarterlyList.innerHTML = '<li class="list-group-item text-muted">No quarterly data available</li>';
                    }
                }
                
                // Update yearly summary
                const yearlyList = document.getElementById('yearly_summary_list');
                if (yearlyList) {
                    yearlyList.innerHTML = '';
                    if (Object.keys(data.yearly_summary).length > 0) {
                        for (const year in data.yearly_summary) {
                            const li = document.createElement('li');
                            li.className = 'list-group-item d-flex justify-content-between align-items-center';
                            li.innerHTML = `FY ${year} <span class="badge bg-success rounded-pill">${data.yearly_summary[year]}</span>`;
                            yearlyList.appendChild(li);
                        }
                    } else {
                        yearlyList.innerHTML = '<li class="list-group-item text-muted">No yearly data available</li>';
                    }
                }
            })
            .catch(error => console.error('Error during fetch operation:', error));
    }

    if (isUserDisplayed && currentUserId) {
        refreshIntervalId = setInterval(() => fetchAndUpdateUserData(currentUserId), 30000); // Refresh every 30 seconds
    }

    // Clear interval on form submission
    const searchForm = document.querySelector('form[action="{{ url_for("hr_points_mgmt.update_user_points_page") }}"]');
    if (searchForm) {
        searchForm.addEventListener('submit', () => {
            if (refreshIntervalId) clearInterval(refreshIntervalId);
        });
    }
});

// ========================================
// Show Full Notes Function
// ========================================
function showFullNotes(noteText) {
    const modalBody = document.getElementById('fullNotesText');
    modalBody.textContent = noteText || 'No notes available';
    const modal = new bootstrap.Modal(document.getElementById('viewNotesModal'));
    modal.show();
}
</script>
{% endblock %}