{% extends "ld_base.html" %}

{% block title %}L&D Validator Dashboard{% endblock %}
{% block dashboard_title %}L&D Validator Dashboard{% endblock %}

{% block sidebar_nav %}
<!-- Validator Navigation Items -->
<a href="javascript:void(0);" class="sidebar-nav-item tab-link active" data-tab="overview">
    <div>
        <i class="fas fa-tachometer-alt"></i>
        <span>Dashboard</span>
    </div>
</a>

<a href="javascript:void(0);" class="sidebar-nav-item tab-link" data-tab="pending" style="display: flex; align-items: center; justify-content: space-between; white-space: nowrap;">
    <div style="display: flex; align-items: center; gap: 8px;">
        <i class="fas fa-clock"></i>
        <span>Pending Requests</span>
    </div>
    <span class="badge bg-warning" id="pending-badge" style="flex-shrink: 0; margin-left: 8px;">{{ pending_count if pending_count else 0 }}</span>
</a>

<a href="javascript:void(0);" class="sidebar-nav-item tab-link" data-tab="history">
    <div>
        <i class="fas fa-history"></i>
        <span>History</span>
    </div>
</a>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Overview Tab (Dashboard Summary) -->
    <div class="tab-content-section active" id="overview-tab">
        <!-- Stats Cards Row -->
        <div class="row mb-4">
            <!-- Total Requests -->
            <div class="col-md-3 mb-3">
                <div class="card shadow-sm border-0" style="border-left: 4px solid #17a2b8 !important;">
                    <div class="card-body p-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <div class="text-uppercase text-muted mb-1" style="font-size: 0.75rem; font-weight: 600;">Total Requests</div>
                                <div class="h3 mb-0 font-weight-bold" id="total-requests-count">{{ (pending_count|default(0)) + (history_data|length if history_data else 0) }}</div>
                            </div>
                            <div class="text-info" style="opacity: 0.3;">
                                <i class="fas fa-list fa-2x"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Pending Requests -->
            <div class="col-md-3 mb-3">
                <div class="card shadow-sm border-0" style="border-left: 4px solid #ffc107 !important;">
                    <div class="card-body p-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <div class="text-uppercase text-muted mb-1" style="font-size: 0.75rem; font-weight: 600;">Pending Requests</div>
                                <div class="h3 mb-0 font-weight-bold">{{ pending_count if pending_count else 0 }}</div>
                            </div>
                            <div class="text-warning" style="opacity: 0.3;">
                                <i class="fas fa-clock fa-2x"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Approved -->
            <div class="col-md-3 mb-3">
                <div class="card shadow-sm border-0" style="border-left: 4px solid #28a745 !important;">
                    <div class="card-body p-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <div class="text-uppercase text-muted mb-1" style="font-size: 0.75rem; font-weight: 600;">Approved</div>
                                <div class="h3 mb-0 font-weight-bold" id="approved-count">{{ history_data|selectattr('status', 'equalto', 'Approved')|list|length if history_data else 0 }}</div>
                            </div>
                            <div class="text-success" style="opacity: 0.3;">
                                <i class="fas fa-check-circle fa-2x"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Rejected -->
            <div class="col-md-3 mb-3">
                <div class="card shadow-sm border-0" style="border-left: 4px solid #dc3545 !important;">
                    <div class="card-body p-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <div class="text-uppercase text-muted mb-1" style="font-size: 0.75rem; font-weight: 600;">Rejected</div>
                                <div class="h3 mb-0 font-weight-bold" id="rejected-count">{{ history_data|selectattr('status', 'equalto', 'Rejected')|list|length if history_data else 0 }}</div>
                            </div>
                            <div class="text-danger" style="opacity: 0.3;">
                                <i class="fas fa-times-circle fa-2x"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Requests Awaiting Review Section -->
        {% if pending_count > 0 %}
        <div class="row mb-4">
            <div class="col-12">
                <div class="card shadow-sm border-0 text-white" style="background: linear-gradient(135deg, #4a5f8f 0%, #5a7ab8 100%);">
                    <div class="card-body text-center py-4">
                        <h4 class="mb-3">
                            <i class="fas fa-bell me-2"></i>
                            {{ pending_count }} Request(s) Awaiting Your Review
                        </h4>
                        <button class="btn btn-light btn-lg px-4" onclick="switchTab('pending')" style="font-weight: 600;">
                            <i class="fas fa-clipboard-check me-2"></i>
                            Review Requests
                        </button>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Recent Activity and Categories Row -->
        <div class="row">
            <!-- Recent Activity Section - Shows ALL requests (Pending, Approved, Rejected) -->
            <div class="col-lg-8 mb-4">
                <div class="card shadow-sm border-0">
                    <div class="card-header text-white" style="background: linear-gradient(135deg, #1e5ba8 0%, #2874d4 100%); border-radius: 8px 8px 0 0;">
                        <h5 class="mb-0">
                            <i class="fas fa-history me-2"></i> Recent Activity
                        </h5>
                    </div>
                    <div class="card-body p-0" id="recent-activity-container">
                        {% if recent_activity_data %}
                            <div class="list-group list-group-flush">
                                {% for item in recent_activity_data[:5] %}
                                <div class="list-group-item">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <div class="flex-grow-1">
                                            <div class="d-flex align-items-center mb-1">
                                                {% if item.status == 'Approved' %}
                                                <span class="badge bg-success me-2">Approved</span>
                                                {% elif item.status == 'Rejected' %}
                                                <span class="badge bg-danger me-2">Rejected</span>
                                                {% else %}
                                                <span class="badge bg-warning text-dark me-2">Pending</span>
                                                {% endif %}
                                                <strong>{{ item.employee_name }}</strong>
                                            </div>
                                            <div class="text-muted small">
                                                <i class="fas fa-tag me-1"></i>{{ item.category_name }}
                                                {% if item.quantity > 1 %}
                                                <span class="mx-2">•</span>
                                                <i class="fas fa-hashtag me-1"></i>{{ item.quantity }} units
                                                {% endif %}
                                                <span class="mx-2">•</span>
                                                {{ item.points }} points
                                            </div>
                                        </div>
                                        <div class="text-end text-muted small">
                                            <i class="fas fa-calendar me-1"></i>{{ item.event_date }}
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        {% else %}
                            <div class="p-4 text-center text-muted">
                                <i class="fas fa-inbox fa-3x mb-3"></i>
                                <p>No activities yet</p>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Categories Section -->
            <div class="col-lg-4 mb-4">
                <div class="card shadow-sm border-0">
                    <div class="card-header text-white" style="background: linear-gradient(135deg, #17a2b8 0%, #20c9e0 100%); border-radius: 8px 8px 0 0;">
                        <h5 class="mb-0">
                            <i class="fas fa-th-large me-2"></i> Categories
                        </h5>
                    </div>
                    <div class="card-body p-0" id="categories-container">
                        {% if ld_categories %}
                            <div class="list-group list-group-flush">
                                {% for category in ld_categories %}
                                {% set pending_count = validator_requests|selectattr('category_name', 'equalto', category.name)|list|length %}
                                {% set history_count = history_data|selectattr('category', 'equalto', category.name)|list|length if history_data else 0 %}
                                {% set total_count = pending_count + history_count %}
                                <div class="list-group-item d-flex justify-content-between align-items-center">
                                    <div>
                                        <i class="fas fa-tag text-primary me-2"></i>
                                        <span>{{ category.name }}</span>
                                    </div>
                                    <span class="badge bg-primary rounded-pill">
                                        {{ total_count }}
                                    </span>
                                </div>
                                {% endfor %}
                            </div>
                        {% else %}
                            <div class="p-4 text-center text-muted">
                                <i class="fas fa-folder-open fa-3x mb-3"></i>
                                <p>No categories available</p>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Pending Requests Tab -->
    <div class="tab-content-section" id="pending-tab">
        <div class="row mb-4">
            <div class="col-12">
                <div class="card shadow-sm border-0">
                    <div class="card-header text-white" style="background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%); border-radius: 8px 8px 0 0;">
                        <h5 class="mb-0">
                            <i class="fas fa-clock me-2"></i> Pending Requests
                        </h5>
                    </div>
                    <div class="card-body p-0">
                        {% if validator_requests %}
                        <form method="POST" action="{{ url_for('ld.validator_dashboard') }}" id="bulkActionForm">
                            <!-- Show Entries and Search Bar Row - Outside scrollable area -->
                            <div class="p-3 d-flex justify-content-between align-items-center" style="background-color: #fff; border-bottom: 1px solid #dee2e6;">
                                <div>
                                    <span style="font-size: 13px; color: #495057; margin-right: 10px;">Show</span>
                                    <select class="form-select form-select-sm" style="font-size: 14px; width: auto; display: inline-block;">
                                        <option>10</option>
                                        <option>25</option>
                                        <option>50</option>
                                        <option>100</option>
                                    </select>
                                    <span style="font-size: 13px; color: #495057; margin-left: 10px;">entries</span>
                                </div>
                                <div style="width: 300px;">
                                    <label class="form-label mb-1" style="font-size: 13px; font-weight: 600; color: #495057;">Search:</label>
                                    <input type="text" class="form-control form-control-sm" id="pendingSearchInput" placeholder="Search in table..." style="font-size: 14px;">
                                </div>
                            </div>
                            <div id="pendingTableWrapper">
                                <div class="table-responsive">
                                    <table class="table table-hover mb-0" id="pendingTable" style="width:100%">
                                    <thead style="background-color: #f8f9fa; border-bottom: 2px solid #dee2e6;">
                                        <tr>
                                            <th style="padding: 12px; font-weight: 600; font-size: 13px; color: #495057; white-space: nowrap; text-align: center;">
                                                <input type="checkbox" id="selectAll" class="form-check-input">
                                            </th>
                                            <th style="padding: 12px; font-weight: 600; font-size: 13px; color: #495057; white-space: nowrap; text-align: center;">Request Date</th>
                                            <th style="padding: 12px; font-weight: 600; font-size: 13px; color: #495057; white-space: nowrap; text-align: center;">Event Date</th>
                                            <th style="padding: 12px; font-weight: 600; font-size: 13px; color: #495057; text-align: center; width: 200px; min-width: 200px; max-width: 200px;">Employee</th>
                                            <th style="padding: 12px; font-weight: 600; font-size: 13px; color: #495057; text-align: center;">Department</th>
                                            <th style="padding: 12px; font-weight: 600; font-size: 13px; color: #495057; text-align: center;">Grade</th>
                                            <th style="padding: 12px; font-weight: 600; font-size: 13px; color: #495057; text-align: center;">Quarter</th>
                                            <th style="padding: 12px; font-weight: 600; font-size: 13px; color: #495057; text-align: center; width: 200px; min-width: 200px; max-width: 200px;">Category</th>
                                            <th style="padding: 12px; font-weight: 600; font-size: 13px; color: #495057; text-align: center;">Number of Units</th>
                                            <th style="padding: 12px; font-weight: 600; font-size: 13px; color: #495057; text-align: center;">Points</th>
                                            <th style="padding: 12px; font-weight: 600; font-size: 13px; color: #495057; text-align: center;">Notes</th>
                                            <th style="padding: 12px; font-weight: 600; font-size: 13px; color: #495057; text-align: center;">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for req in validator_requests %}
                                        <tr style="border-bottom: 1px solid #e9ecef;">
                                            <td style="padding: 12px; white-space: nowrap; font-size: 14px; text-align: center;">
                                                <input type="checkbox" name="selected_requests" 
                                                       value="{{ req.request_id }}" class="form-check-input request-checkbox">
                                            </td>
                                            <td style="padding: 12px; white-space: nowrap; font-size: 14px; text-align: center;">{{ req.request_date }}</td>
                                            <td style="padding: 12px; white-space: nowrap; font-size: 14px; text-align: center;">{{ req.event_date }}</td>
                                            <td style="padding: 12px; font-size: 14px; text-align: center; width: 200px; min-width: 200px; max-width: 200px; word-wrap: break-word; white-space: normal;">
                                                <strong>{{ req.employee_name }}</strong><br>
                                                <small class="text-muted">{{ req.employee_id }}</small>
                                            </td>
                                            <td style="padding: 12px; font-size: 14px; text-align: center;">{{ req.department if req.department else 'N/A' }}</td>
                                            <td style="padding: 12px; text-align: center;">
                                                <span class="badge" style="background-color: #6c757d; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px;">{{ req.grade }}</span>
                                            </td>
                                            <td style="padding: 12px; text-align: center;">
                                                <span class="badge" style="background-color: #17a2b8; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px;">{{ req.quarter if req.quarter else 'N/A' }}</span>
                                            </td>
                                            <td style="padding: 12px; font-size: 14px; text-align: center; width: 200px; min-width: 200px; max-width: 200px; word-wrap: break-word; white-space: normal;">{{ req.category_name }}</td>
                                            <td style="padding: 12px; text-align: center; font-weight: 600; font-size: 14px;">{{ req.quantity }}</td>
                                            <td style="padding: 12px; text-align: center; font-weight: 600; font-size: 14px;">{{ req.points }}</td>
                                            <td style="padding: 12px; text-align: center;">
                                                <button type="button" class="btn btn-sm view-notes-btn" 
                                                        style="background-color: #17a2b8; color: white; border: none; padding: 6px 16px; border-radius: 20px; font-size: 13px;"
                                                        data-submission-notes="{{ req.notes|e }}"
                                                        data-response-notes="">
                                                    View
                                                </button>
                                            </td>
                                            <td style="padding: 12px; white-space: nowrap; text-align: center;">
                                                <button type="button" class="btn btn-sm btn-success" 
                                                        onclick="singleAction('{{ req.request_id }}', 'approve')">
                                                    <i class="fas fa-check"></i>
                                                </button>
                                                <button type="button" class="btn btn-sm btn-danger" 
                                                        onclick="singleAction('{{ req.request_id }}', 'reject')">
                                                    <i class="fas fa-times"></i>
                                                </button>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                            </div>
                            
                            <!-- Pagination Row - Outside table, above Response Notes -->
                            <div class="p-3 d-flex justify-content-between align-items-center" style="background-color: #fff; border-bottom: 1px solid #dee2e6;">
                                <div id="pendingPaginationInfo" style="font-size: 13px; color: #495057;"></div>
                                <div id="pendingPaginationControls"></div>
                            </div>
                            
                            <!-- Response Notes and Bulk Action Buttons - Outside table -->
                            <div class="p-3" style="background-color: #f8f9fa; border-top: 1px solid #dee2e6;">
                            <div class="row mt-2">
                                <div class="col-md-6 mb-3">
                                    <label for="response_notes" class="form-label">
                                        Response Notes <span class="text-danger">*</span>
                                    </label>
                                    <textarea class="form-control" id="response_notes" name="response_notes" 
                                              rows="2" placeholder="Enter reason for approval/rejection" required></textarea>
                                </div>
                                <div class="col-md-6 d-flex align-items-end mb-3">
                                    <div class="btn-group w-100" role="group">
                                        <button type="submit" name="action_type" value="bulk_approve" 
                                                class="btn btn-success btn-lg">
                                            <i class="fas fa-check"></i> Approve Selected
                                        </button>
                                        <button type="submit" name="action_type" value="bulk_reject" 
                                                class="btn btn-danger btn-lg">
                                            <i class="fas fa-times"></i> Reject Selected
                                        </button>
                                    </div>
                                </div>
                            </div>
                                </div>
                            </div>
                        </form>
                        {% else %}
                        <div class="alert alert-success m-3">
                            <i class="fas fa-check-circle"></i> No pending requests at this time.
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- History Tab -->
    <div class="tab-content-section" id="history-tab">
        <div class="row mb-4">
            <div class="col-12">
                <div class="card shadow-sm border-0">
                    <div class="card-header text-white" style="background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%); border-radius: 8px 8px 0 0;">
                        <h5 class="mb-0">
                            <i class="fas fa-history me-2"></i> L&D Assignment History
                        </h5>
                    </div>
                    <div class="card-body p-0">
                        <!-- Filter Section -->
                        <div class="p-3" style="background-color: #f8f9fa; border-bottom: 1px solid #dee2e6;">
                            <div class="row g-3 align-items-end">
                                <div class="col-md-2">
                                    <label class="form-label mb-1" style="font-size: 13px; font-weight: 600; color: #495057;">Year</label>
                                    <select class="form-select form-select-sm" id="filterYear" style="font-size: 14px;">
                                        <option value="">All Years</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label mb-1" style="font-size: 13px; font-weight: 600; color: #495057;">Quarter</label>
                                    <select class="form-select form-select-sm" id="filterQuarter" style="font-size: 14px;">
                                        <option value="">All</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label mb-1" style="font-size: 13px; font-weight: 600; color: #495057;">Category</label>
                                    <select class="form-select form-select-sm" id="filterCategory" style="font-size: 14px;">
                                        <option value="">All Categories</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label mb-1" style="font-size: 13px; font-weight: 600; color: #495057;">Grade</label>
                                    <select class="form-select form-select-sm" id="filterGrade" style="font-size: 14px;">
                                        <option value="">All Grades</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label mb-1" style="font-size: 13px; font-weight: 600; color: #495057;">Status</label>
                                    <select class="form-select form-select-sm" id="filterStatus" style="font-size: 14px;">
                                        <option value="">All Statuses</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <div class="btn-group w-100" role="group">
                                        <button type="button" class="btn btn-sm btn-primary" onclick="applyHistoryFilters()" style="font-size: 13px;">
                                            <i class="fas fa-filter me-1"></i> Apply Filters
                                        </button>
                                        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="resetHistoryFilters()" style="font-size: 13px;">
                                            <i class="fas fa-redo me-1"></i> Reset Filters
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- Show Entries and Search Bar Row -->
                        <div class="p-3 d-flex justify-content-between align-items-center" style="background-color: #fff; border-bottom: 1px solid #dee2e6;">
                            <div id="historyTableLength"></div>
                            <div style="width: 300px;">
                                <label class="form-label mb-1" style="font-size: 13px; font-weight: 600; color: #495057;">Search:</label>
                                <input type="text" class="form-control form-control-sm" id="historySearchInput" placeholder="Search in table..." style="font-size: 14px;">
                            </div>
                        </div>
                        <div id="historyTableWrapper">
                            <div class="table-responsive">
                                <table class="table table-hover mb-0" id="historyTable" style="width:100%">
                                <thead style="background-color: #f8f9fa; border-bottom: 2px solid #dee2e6;">
                                    <tr>
                                        <th style="padding: 12px; font-weight: 600; font-size: 13px; color: #495057; white-space: nowrap; text-align: center;">Date</th>
                                        <th style="padding: 12px; font-weight: 600; font-size: 13px; color: #495057; white-space: nowrap; text-align: center;">Event Date</th>
                                        <th style="padding: 12px; font-weight: 600; font-size: 13px; color: #495057; text-align: center; width: 200px; min-width: 200px; max-width: 200px;">Employee</th>
                                        <th style="padding: 12px; font-weight: 600; font-size: 13px; color: #495057; text-align: center;">Department</th>
                                        <th style="padding: 12px; font-weight: 600; font-size: 13px; color: #495057; text-align: center;">Grade</th>
                                        <th style="padding: 12px; font-weight: 600; font-size: 13px; color: #495057; text-align: center; width: 200px; min-width: 200px; max-width: 200px;">Category</th>
                                        <th style="padding: 12px; font-weight: 600; font-size: 13px; color: #495057; text-align: center;">Points</th>
                                        <th style="padding: 12px; font-weight: 600; font-size: 13px; color: #495057; text-align: center;">Status</th>
                                        <th style="padding: 12px; font-weight: 600; font-size: 13px; color: #495057; text-align: center;">Quarter</th>
                                        <th style="padding: 12px; font-weight: 600; font-size: 13px; color: #495057; text-align: center;">Notes</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% if history_data %}
                                    {% for record in history_data %}
                                    <tr style="border-bottom: 1px solid #e9ecef;">
                                        <td style="padding: 12px; white-space: nowrap; font-size: 14px; text-align: center;">{{ record.date }}</td>
                                        <td style="padding: 12px; white-space: nowrap; font-size: 14px; text-align: center;">{{ record.event_date }}</td>
                                        <td style="padding: 12px; font-size: 14px; text-align: center; width: 200px; min-width: 200px; max-width: 200px; word-wrap: break-word; white-space: normal;">
                                            <strong>{{ record.employee_name if record.employee_name else record.employee }}</strong><br>
                                            {% if record.employee_id and record.employee_id != 'N/A' %}
                                            <small class="text-muted">{{ record.employee_id }}</small>
                                            {% endif %}
                                        </td>
                                        <td style="padding: 12px; font-size: 14px; text-align: center;">{{ record.department if record.department else 'N/A' }}</td>
                                        <td style="padding: 12px; text-align: center;">
                                            <span class="badge" style="background-color: #6c757d; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px;">{{ record.grade }}</span>
                                        </td>
                                        <td style="padding: 12px; font-size: 14px; text-align: center; width: 200px; min-width: 200px; max-width: 200px; word-wrap: break-word; white-space: normal;">{{ record.category }}</td>
                                        <td style="padding: 12px; text-align: center; font-weight: 600; font-size: 14px;">{{ record.points }}</td>
                                        <td style="padding: 12px; text-align: center;">
                                            {% if record.status == 'Approved' %}
                                            <span class="badge" style="background-color: #28a745; color: white; padding: 4px 12px; border-radius: 4px; font-size: 12px;">Approved</span>
                                            {% elif record.status == 'Rejected' %}
                                            <span class="badge" style="background-color: #dc3545; color: white; padding: 4px 12px; border-radius: 4px; font-size: 12px;">Rejected</span>
                                            {% else %}
                                            <span class="badge" style="background-color: #ffc107; color: #000; padding: 4px 12px; border-radius: 4px; font-size: 12px;">Pending</span>
                                            {% endif %}
                                        </td>
                                        <td style="padding: 12px; text-align: center;">
                                            <span class="badge" style="background-color: #17a2b8; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px;">{{ record.quarter if record.quarter else 'N/A' }}</span>
                                        </td>
                                        <td style="padding: 12px; text-align: center;">
                                            <button type="button" class="btn btn-sm view-notes-btn" 
                                                    style="background-color: #17a2b8; color: white; border: none; padding: 6px 16px; border-radius: 20px; font-size: 13px;"
                                                    data-submission-notes="{{ record.notes|e }}"
                                                    data-response-notes="{{ record.response_notes|e if record.response_notes else '' }}">
                                                View
                                            </button>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                    {% else %}
                                    <tr>
                                        <td colspan="10" style="padding: 40px; text-align: center;">
                                            <i class="fas fa-inbox" style="font-size: 3rem; color: #ccc; margin-bottom: 10px;"></i>
                                            <p style="font-size: 1.1rem; color: #666; margin: 0;">No history records found</p>
                                        </td>
                                    </tr>
                                    {% endif %}
                                </tbody>
                            </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Single Action Modal -->
<div class="modal fade" id="singleActionModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="POST" action="{{ url_for('ld.validator_dashboard') }}" id="singleActionForm">
                <input type="hidden" name="action_type" value="single_action">
                <input type="hidden" name="request_id" id="modal_request_id">
                <input type="hidden" name="action" id="modal_action">
                
                <div class="modal-header" id="modalHeader">
                    <h5 class="modal-title" id="modalTitle">Confirm Action</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p id="modalMessage"></p>
                    <div id="notesSection">
                        <label for="modal_response_notes" class="form-label">
                            Notes <span class="text-danger">*</span>
                        </label>
                        <textarea class="form-control" id="modal_response_notes" 
                                  name="response_notes" rows="3" required
                                  placeholder="Enter notes for this action"></textarea>
                        <small class="text-muted" id="notesHint">Please provide a reason for your decision</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn" id="modalSubmitBtn">Confirm</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Bulk Action Confirmation Modal -->
<div class="modal fade" id="bulkActionConfirmModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header text-white" id="bulkActionModalHeader">
                <h5 class="modal-title" id="bulkActionModalTitle">
                    <i class="fas fa-check-circle"></i> Confirm Action
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info mb-3">
                    <strong>Selected Requests:</strong> <span id="bulkActionCount">0</span>
                </div>
                <div class="table-responsive" id="bulkActionTableContainer">
                    <table class="table table-sm table-hover">
                        <thead class="table-light sticky-top">
                            <tr>
                                <th style="text-align: center; white-space: nowrap;">Employee ID</th>
                                <th style="text-align: center; width: 250px; min-width: 250px; max-width: 250px;">Category</th>
                                <th style="text-align: center; white-space: nowrap;">Points</th>
                                <th style="text-align: center; white-space: nowrap;">Event Date</th>
                            </tr>
                        </thead>
                        <tbody id="bulkActionPreviewBody">
                        </tbody>
                    </table>
                </div>

            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i> Cancel
                </button>
                <button type="button" class="btn" id="bulkActionConfirmBtn" onclick="confirmBulkAction()">
                    <i class="fas fa-check"></i> Confirm
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Notes Modal -->
<div class="modal fade" id="notesModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title"><i class="fas fa-sticky-note me-2"></i>Notes Details</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" style="max-height: 65vh; overflow-y: auto;">
                <div class="mb-3">
                    <strong><i class="fas fa-file-alt me-1"></i> Submission Notes:</strong>
                    <div id="modalSubmissionNotes" class="mt-2 p-3 bg-light rounded border" style="white-space: pre-wrap; word-wrap: break-word;"></div>
                </div>
                <div id="modalResponseNotesSection" style="display:none;">
                    <strong><i class="fas fa-comment-dots me-1"></i> Response Notes:</strong>
                    <div id="modalResponseNotes" class="mt-2 p-3 bg-light rounded border" style="white-space: pre-wrap; word-wrap: break-word;"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal"><i class="fas fa-times me-1"></i> Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    /* Tab content styling */
    .tab-content-section {
        display: none;
    }
    
    .tab-content-section.active {
        display: block;
        animation: fadeIn 0.3s;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }
    
    .border-left-warning {
        border-left: 4px solid #f6c23e !important;
    }
    
    .border-left-success {
        border-left: 4px solid #1cc88a !important;
    }

    /* Checkbox Styling - Use default browser checkbox */
    .form-check-input {
        cursor: pointer !important;
    }
    
    /* Pending Table Styling */
    #pendingTable_wrapper {
        padding: 20px;
        background-color: #fff;
    }
    
    #pendingTable_wrapper .dataTables_length,
    #pendingTable_wrapper .dataTables_filter {
        display: none;
    }
    
    #pendingTable_wrapper .dataTables_filter {
        text-align: right;
    }
    
    #pendingTable_wrapper .dataTables_filter input {
        width: 300px;
        padding: 8px 12px;
        border: 1px solid #d1d3e2;
        border-radius: 4px;
        margin-left: 8px;
        font-size: 14px;
    }
    
    #pendingTable_wrapper .dataTables_length select {
        width: 80px;
        padding: 8px 12px;
        border: 1px solid #d1d3e2;
        border-radius: 4px;
        margin: 0 8px;
        font-size: 14px;
    }
    
    #pendingTable_wrapper .dataTables_info,
    #pendingTable_wrapper .dataTables_paginate {
        padding-top: 15px;
    }
    
    #pendingTable {
        border-collapse: separate !important;
        border-spacing: 0;
        width: 100% !important;
    }
    
    #pendingTable thead th {
        background-color: #f8f9fa;
        border-bottom: 2px solid #dee2e6;
        border-right: none;
        padding: 12px;
        font-weight: 600;
        font-size: 13px;
        color: #495057;
        white-space: nowrap;
        vertical-align: middle;
        text-align: center;
        line-height: 1.2;
    }
    
    #pendingTable tbody td {
        padding: 14px 12px;
        vertical-align: middle;
        border-bottom: 1px solid #e3e6f0;
        border-right: none;
        font-size: 14px;
        text-align: center;
    }
    
    #pendingTable tbody tr {
        transition: background-color 0.2s ease;
    }
    
    #pendingTable tbody tr:hover {
        background-color: #f8f9fc;
    }
    
    #pendingTable tbody tr:last-child td {
        border-bottom: none;
    }
    
    /* Hide scrollbar on larger screens (> 1536px) */
    @media (min-width: 1537px) {
        #pendingTableWrapper .table-responsive {
            overflow-x: visible !important;
            overflow-y: visible;
        }
    }
    
    /* Show scrollbar on smaller screens (<= 1536px) */
    @media (max-width: 1536px) {
        #pendingTableWrapper .table-responsive {
            overflow-x: auto !important;
            overflow-y: visible;
            -webkit-overflow-scrolling: touch;
            display: block;
        }
    }
    
    /* Checkbox column */
    #pendingTable tbody td:first-child,
    #pendingTable thead th:first-child {
        text-align: center;
        width: 50px;
        min-width: 50px;
    }
    
    /* Date columns - left align */
    #pendingTable tbody td:nth-child(2),
    #pendingTable tbody td:nth-child(3) {
        text-align: left;
        white-space: nowrap;
    }
    
    /* Employee name - left align */
    #pendingTable tbody td:nth-child(4) {
        text-align: left;
    }
    
    /* Department - left align */
    #pendingTable tbody td:nth-child(5) {
        text-align: left;
    }
    
    /* Grade, Quarter, Category - center */
    #pendingTable tbody td:nth-child(6),
    #pendingTable tbody td:nth-child(7),
    #pendingTable tbody td:nth-child(8) {
        text-align: center;
    }
    
    /* Category column - wider */
    #pendingTable thead th:nth-child(8),
    #pendingTable tbody td:nth-child(8) {
        min-width: 180px;
        max-width: 250px;
    }
    
    /* Number of Units, Points - center */
    #pendingTable tbody td:nth-child(9),
    #pendingTable tbody td:nth-child(10) {
        text-align: center;
        font-weight: 600;
    }
    
    /* Notes - center */
    #pendingTable tbody td:nth-child(11) {
        text-align: center;
    }
    
    /* Updater - left align */
    #pendingTable tbody td:nth-child(12) {
        text-align: left;
    }
    
    /* Actions column */
    #pendingTable tbody td:last-child {
        text-align: center;
        white-space: nowrap;
        width: 100px;
        min-width: 100px;
    }
    
    /* History Table Column Alignment - All centered */
    #historyTable tbody td {
        text-align: center;
    }
    
    /* Category column - wider */
    #historyTable thead th:nth-child(6),
    #historyTable tbody td:nth-child(6) {
        min-width: 180px;
        max-width: 250px;
    }
    
    /* Points - bold */
    #historyTable tbody td:nth-child(7) {
        font-weight: 600;
        color: #4e73df;
    }
    
    /* Badge styling in table */
    #pendingTable .badge {
        padding: 5px 10px;
        font-size: 12px;
        font-weight: 500;
        border-radius: 4px;
    }
    
    /* Button styling in table */
    #pendingTable .btn-sm {
        padding: 6px 12px;
        font-size: 13px;
        margin: 0 2px;
    }
    
    /* Info and pagination row */
    #pendingTable_wrapper .dataTables_info {
        padding-top: 15px;
        font-size: 14px;
        color: #5a5c69;
    }
    
    #pendingTable_wrapper .dataTables_paginate {
        padding-top: 15px;
        text-align: right;
    }
    
    #pendingTable_wrapper .dataTables_paginate .pagination {
        margin: 0;
    }
    
    /* Bulk action section styling */
    #bulkActionForm {
        background-color: #fff;
    }
    
    #bulkActionForm hr {
        margin: 20px 0;
        border-top: 2px solid #e3e6f0;
    }
    
    #bulkActionForm .row {
        padding: 0 20px 20px 20px;
    }
    
    #bulkActionForm textarea {
        border: 1px solid #d1d3e2;
        border-radius: 4px;
        padding: 10px;
    }
    
    #bulkActionForm .btn-group {
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    #bulkActionForm .btn-group .btn {
        padding: 12px 24px;
        font-size: 15px;
        font-weight: 500;
    }
    
    /* Responsive adjustments for pending table */
    @media (max-width: 768px) {
        #pendingTable_wrapper {
            padding: 15px;
        }
        
        #pendingTable_wrapper .dataTables_filter input {
            width: 100%;
            max-width: 100%;
        }
        
        #pendingTable thead th {
            font-size: 11px;
            padding: 8px 6px;
        }
        
        #pendingTable tbody td {
            font-size: 12px;
            padding: 8px 6px;
        }
        
        #bulkActionForm .row {
            padding: 0 15px 15px 15px;
        }
    }
    
    /* History Table Styling */
    #historyTable {
        border-collapse: separate !important;
        border-spacing: 0;
        width: 100% !important;
    }
    
    #historyTable thead th {
        background-color: #f8f9fa;
        border-bottom: 2px solid #dee2e6;
        border-right: none;
        padding: 12px;
        font-weight: 600;
        font-size: 13px;
        color: #495057;
        white-space: nowrap;
        vertical-align: middle;
        text-align: center;
        line-height: 1.2;
    }
    
    #historyTable thead th:last-child {
        border-right: none;
    }
    
    #historyTable tbody td {
        padding: 14px 12px;
        vertical-align: middle;
        border-bottom: 1px solid #e3e6f0;
        border-right: none;
        font-size: 14px;
        text-align: center;
    }
    
    #historyTable tbody td:last-child {
        border-right: none;
    }
    
    #historyTable tbody tr {
        transition: background-color 0.2s ease;
    }
    
    #historyTable tbody tr:hover {
        background-color: #f8f9fc;
    }
    
    /* DataTables Controls Styling */
    #historyTable_wrapper {
        padding: 20px;
        background-color: #fff;
    }
    
    #historyTable_wrapper .row {
        margin-bottom: 20px;
        display: flex;
        flex-wrap: wrap;
        align-items: center;
    }
    
    #historyTable_wrapper .dataTables_length {
        flex: 0 0 auto;
        margin-right: auto;
        margin-bottom: 0;
    }
    
    #historyTable_wrapper .dataTables_filter {
        flex: 0 0 auto;
        margin-left: auto;
        text-align: right;
        margin-bottom: 0;
    }
    
    #historyTable_wrapper .dataTables_length label,
    #historyTable_wrapper .dataTables_filter label {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 0;
        font-weight: 500;
        font-size: 14px;
        white-space: nowrap;
    }
    
    #historyTable_wrapper .dataTables_length select {
        width: auto;
        min-width: 70px;
        display: inline-block;
        padding: 6px 12px;
    }
    
    #historyTable_wrapper .dataTables_filter input {
        width: 250px;
        display: inline-block;
        padding: 6px 12px;
    }
    
    /* Table wrapper */
    #historyTable_wrapper .dataTables_scroll {
        margin-top: 15px;
    }
    
    /* Info and Pagination Row */
    #historyTable_wrapper .dataTables_info {
        flex: 0 0 auto;
        margin-right: auto;
        padding-top: 15px;
        margin-bottom: 0;
        font-size: 14px;
    }
    
    #historyTable_wrapper .dataTables_paginate {
        flex: 0 0 auto;
        margin-left: auto;
        text-align: right;
        padding-top: 15px;
        margin-bottom: 0;
    }
    
    /* Pagination buttons */
    #historyTable_wrapper .dataTables_paginate .pagination {
        margin-bottom: 0;
    }
    
    /* Clear floats */
    #historyTable_wrapper .row:after {
        content: "";
        display: table;
        clear: both;
    }
    
    /* Responsive adjustments */
    @media (max-width: 768px) {
        #historyTable_wrapper {
            padding: 15px;
        }
        
        #historyTable_wrapper .row {
            flex-direction: column;
            align-items: stretch;
        }
        
        #historyTable_wrapper .dataTables_length,
        #historyTable_wrapper .dataTables_filter {
            margin: 0 0 15px 0;
            text-align: left;
        }
        
        #historyTable_wrapper .dataTables_filter input {
            width: 100%;
            max-width: 100%;
        }
        
        #historyTable_wrapper .dataTables_info,
        #historyTable_wrapper .dataTables_paginate {
            margin: 10px 0 0 0;
            text-align: center;
        }
    }
    
    /* Keep pagination row outside scroll */
    .pagination-row {
        background: white;
        margin: 0 !important;
        padding: 15px 20px !important;
        border-top: 1px solid #e3e6f0;
        display: flex !important;
        justify-content: space-between;
        align-items: center;
    }
    
    .pagination-row .col-sm-6 {
        flex: 0 0 auto;
        width: auto;
    }
</style>
{% endblock %}

{% block scripts %}
<script>
// Show notes in modal - Make it globally accessible
window.showNotesModal = function(submissionNotes, responseNotes = null) {
    const modalElement = document.getElementById('notesModal');
    if (!modalElement) {
        return;
    }
    
    const submissionNotesEl = document.getElementById('modalSubmissionNotes');
    if (submissionNotesEl) {
        submissionNotesEl.textContent = submissionNotes || 'No notes provided';
    }
    
    const responseSection = document.getElementById('modalResponseNotesSection');
    const responseNotesEl = document.getElementById('modalResponseNotes');
    
    // Convert to string and check if it has content
    const responseNotesStr = responseNotes ? String(responseNotes).trim() : '';
    
    if (responseNotesStr.length > 0) {
        if (responseNotesEl) responseNotesEl.textContent = responseNotesStr;
        if (responseSection) responseSection.style.display = 'block';
    } else {
        if (responseSection) responseSection.style.display = 'none';
    }
    
    try {
        // Check if there's already a modal instance and dispose it
        const existingModal = bootstrap.Modal.getInstance(modalElement);
        if (existingModal) {
            existingModal.dispose();
        }
        
        // Create and show new modal
        const modal = new bootstrap.Modal(modalElement, {
            backdrop: true,
            keyboard: true,
            focus: true
        });
        modal.show();
    } catch (error) {
    }
};
</script>

<script>
// Event delegation for view notes buttons
$(document).on('click', '.view-notes-btn', function() {
    const submissionNotes = $(this).data('submission-notes') || '';
    const responseNotes = $(this).data('response-notes') || '';
    window.showNotesModal(submissionNotes, responseNotes || null);
});

// TAB PERSISTENCE - Store and restore active tab
function saveActiveTab(tabName) {
    localStorage.setItem('ld_validator_active_tab', tabName);
}

function restoreActiveTab() {
    const savedTab = localStorage.getItem('ld_validator_active_tab');
    if (savedTab && savedTab !== 'overview') {
        switchTab(savedTab);
    }
}

// Global function to switch tabs
function switchTab(targetTab) {
    // Remove active class from all tabs
    $('.tab-link').removeClass('active');
    $('.tab-content-section').removeClass('active');
    
    // Add active class to clicked tab
    $('.tab-link[data-tab="' + targetTab + '"]').addClass('active');
    $('#' + targetTab + '-tab').addClass('active');
    
    // Initialize history table if switching to history tab
    if (targetTab === 'history' && !$.fn.DataTable.isDataTable('#historyTable')) {
        initHistoryTable();
    }
    
    // Initialize pending table if switching to pending tab
    if (targetTab === 'pending' && !$.fn.DataTable.isDataTable('#pendingTable')) {
        initPendingTable();
    }
    
    // Close sidebar on mobile
    if (window.innerWidth < 992) {
        $('#sidebar').removeClass('active');
        $('#sidebarOverlay').removeClass('active');
    }
    
    // Save active tab
    saveActiveTab(targetTab);
    
    // Update URL to reflect current tab (without page reload)
    const url = new URL(window.location);
    if (targetTab === 'overview') {
        url.searchParams.delete('tab');
    } else {
        url.searchParams.set('tab', targetTab);
    }
    window.history.replaceState({}, '', url);
}
    
// Restore last active tab on page load
$(document).ready(function() {
    // Clear forms on page load (fixes Firefox form persistence issue)
    if ($('#bulkActionForm').length) {
        $('#bulkActionForm')[0].reset();
    }
    if ($('#singleActionForm').length) {
        $('#singleActionForm')[0].reset();
    }
    
    // Check if there's a tab parameter in the URL
    const urlParams = new URLSearchParams(window.location.search);
    const tabParam = urlParams.get('tab');
    
    if (tabParam) {
        // If URL has a tab parameter, switch to that tab
        switchTab(tabParam);
    } else {
        // Otherwise, restore the last active tab from localStorage
        restoreActiveTab();
    }
    
    // Tab switching functionality
    $('.tab-link').on('click', function(e) {
        e.preventDefault();
        const targetTab = $(this).data('tab');
        switchTab(targetTab);
    });
    
    // Add event listener for year filter to update quarters only (don't apply filters yet)
    $(document).on('change', '#filterYear', function() {
        filterQuartersByYear();
    });
});

// Function to restore selected checkboxes and update Select All state
function restoreSelectedCheckboxes() {
    setTimeout(function() {
        // Restore checkboxes from selectedRequests Set
        $('#pendingTable tbody tr:visible .request-checkbox').each(function() {
            const value = $(this).val();
            if (selectedRequests.has(value)) {
                $(this).prop('checked', true);
            }
        });
        
        // Update Select All checkbox based on CURRENT PAGE ONLY
        const visibleTotal = $('#pendingTable tbody tr:visible .request-checkbox').length;
        const visibleChecked = $('#pendingTable tbody tr:visible .request-checkbox:checked').length;
        const allChecked = visibleTotal > 0 && visibleTotal === visibleChecked;
        $('#selectAll').prop('checked', allChecked);
    }, 50);
}

// Initialize pending table if exists
function initPendingTable() {
        try {
            // Check if table exists first
            if ($('#pendingTable').length === 0) {
                return;
            }
            
            // Destroy existing DataTable if it exists
            if ($.fn.DataTable.isDataTable('#pendingTable')) {
                $('#pendingTable').DataTable().destroy();
            }
            
            // Always reinitialize (important for real-time updates)
            const table = $('#pendingTable').DataTable({
                order: [[1, 'asc']],
                pageLength: 10,
                responsive: true,
                columnDefs: [
                    { orderable: false, targets: [0, 10, 11] }  // ✅ Fixed: 12 columns (0-11)
                ],
                // ✅ Speed up initialization
                deferRender: true,
                processing: false,
                // ✅ Force pagination to show
                paging: true,
                pagingType: 'simple_numbers',
                dom: 'rt',  // No pagination in wrapper, we'll add it manually
                // ✅ Initialize immediately without delay
                initComplete: function(settings, json) {
                    // Restore checkboxes after initialization
                    restoreSelectedCheckboxes();
                }
            });
            
            // ✅ Create custom pagination controls
            table.on('draw.dt', function() {
                var info = table.page.info();
                var paginationHtml = '';
                
                // Info text
                $('#pendingPaginationInfo').html('Showing ' + (info.start + 1) + ' to ' + info.end + ' of ' + info.recordsTotal + ' entries');
                
                // Pagination buttons
                if (info.pages > 1) {
                    paginationHtml = '<nav><ul class="pagination mb-0">';
                    
                    // Previous button
                    if (info.page > 0) {
                        paginationHtml += '<li class="page-item"><a class="page-link" href="#" onclick="$(\'#pendingTable\').DataTable().page(0).draw(false); return false;">Previous</a></li>';
                    }
                    
                    // Page numbers
                    for (var i = 0; i < info.pages; i++) {
                        if (i === info.page) {
                            paginationHtml += '<li class="page-item active"><span class="page-link">' + (i + 1) + '</span></li>';
                        } else {
                            paginationHtml += '<li class="page-item"><a class="page-link" href="#" onclick="$(\'#pendingTable\').DataTable().page(' + i + ').draw(false); return false;">' + (i + 1) + '</a></li>';
                        }
                    }
                    
                    // Next button
                    if (info.page < info.pages - 1) {
                        paginationHtml += '<li class="page-item"><a class="page-link" href="#" onclick="$(\'#pendingTable\').DataTable().page(' + (info.pages - 1) + ').draw(false); return false;">Next</a></li>';
                    }
                    
                    paginationHtml += '</ul></nav>';
                }
                
                $('#pendingPaginationControls').html(paginationHtml);
                restoreSelectedCheckboxes();
            });
            
            // ✅ Bind page change event to restore checkboxes
            table.on('page.dt', function() {
                restoreSelectedCheckboxes();
            });
            
            // ✅ Connect manual show entries select - be specific to pending table controls
            $('#pendingTableWrapper').closest('.card-body').find('.p-3:first select').on('change', function() {
                table.page.len($(this).val()).draw();
            });
            
            // ✅ Connect manual search input
            $('#pendingSearchInput').on('keyup', function() {
                table.search(this.value).draw();
            });
            
            // ✅ Trigger initial draw to show pagination
            table.draw();
            
        } catch (error) {
            // Error initializing DataTable
        }
}

// Initialize history table if exists
function initHistoryTable() {
        {% if history_data %}
        var table = $('#historyTable').DataTable({
            order: [[0, 'desc']],
            pageLength: 10,
            lengthMenu: [[10, 25, 50, 100, -1], [10, 25, 50, 100, "All"]],
            responsive: true,
            dom: 'rt<"row pagination-row"<"col-sm-6"i><"col-sm-6"p>>',  // Remove default length and search, add pagination-row
            language: {
                lengthMenu: "Show _MENU_ entries"
            }
        });
        
        // Move pagination outside scrollable area
        $('#historyTableWrapper .table-responsive').after($('#historyTableWrapper .pagination-row'));
        
        // Create custom length menu with "All" first
        var lengthSelect = $('<label style="font-size: 14px; color: #495057;">Show <select class="form-select form-select-sm d-inline-block" style="width: auto; margin: 0 5px;">' +
            '<option value="-1">All</option>' +
            '<option value="10" selected>10</option>' +
            '<option value="25">25</option>' +
            '<option value="50">50</option>' +
            '<option value="100">100</option>' +
            '</select> entries</label>');
        
        // Add to page
        $('#historyTableLength').html(lengthSelect);
        
        // Handle length change
        $('#historyTableLength select').on('change', function() {
            table.page.len($(this).val()).draw();
        });
        
        // Connect custom search input to DataTables
        $('#historySearchInput').on('keyup', function() {
            table.search(this.value).draw();
        });
        
        // Store table reference globally for filter functions
        window.historyTableInstance = table;
        
        // Populate filter dropdowns from table data with a delay to ensure data is loaded
        setTimeout(function() {
            try {
                populateHistoryFilters(table);
            } catch (error) {
                console.error('Error populating filters:', error);
            }
        }, 500);
        {% endif %}
}

// Populate filter dropdowns dynamically
function populateHistoryFilters(table) {
        var quarters = new Set();
        var categories = new Set();
        var grades = new Set();
        var years = new Set();
        var statuses = new Set();
        
        table.rows().every(function() {
            var data = this.data();
            
            // Extract quarter from column 8 (inside badge) - extract only Q1, Q2, Q3, Q4
            var quarterText = '';
            if (data[8]) {
                quarterText = $(data[8]).text().trim();
                if (!quarterText) {
                    quarterText = data[8];
                }
            }
            if (quarterText && quarterText !== 'N/A' && quarterText.length > 0) {
                // Extract only the quarter part (Q1, Q2, Q3, Q4) from "Q4 2025" format
                var quarterMatch = quarterText.match(/Q[1-4]/);
                if (quarterMatch) {
                    quarters.add(quarterMatch[0]);
                }
            }
            
            // Extract category from column 5 (plain text, not in badge)
            var categoryText = data[5];
            if (typeof categoryText === 'string') {
                categoryText = categoryText.trim();
            } else {
                categoryText = $(categoryText).text().trim();
            }
            if (categoryText && categoryText !== 'N/A') {
                categories.add(categoryText);
            }
            
            // Extract grade from column 4 (inside badge)
            var gradeText = $(data[4]).text().trim();
            if (gradeText && gradeText !== 'N/A') {
                grades.add(gradeText);
            }
            
            // Extract year from date column 0 (DD-MM-YYYY format)
            // Extract year from Event Date column (column 1) instead of Date column (column 0)
            var eventDateText = data[1];
            if (typeof eventDateText === 'string') {
                eventDateText = eventDateText.trim();
            } else {
                eventDateText = $(eventDateText).text().trim();
            }
            if (eventDateText && eventDateText.length >= 10) {
                var parts = eventDateText.split('-');
                if (parts.length === 3) {
                    var year = parts[2]; // DD-MM-YYYY -> YYYY
                    if (year && year.length === 4) {
                        years.add(year);
                    }
                }
            }
            
            // Extract status from column 7 (inside badge)
            var statusText = '';
            if (typeof data[7] === 'string') {
                statusText = data[7].trim();
            } else {
                statusText = $(data[7]).text().trim();
            }
            // Extract only the status word (Approved, Rejected, Pending)
            if (statusText) {
                var statusMatch = statusText.match(/Approved|Rejected|Pending/);
                if (statusMatch) {
                    statuses.add(statusMatch[0]);
                }
            }
        });
        
        // Clear existing options (keep only the default "All" option)
        $('#filterQuarter').find('option:not(:first)').remove();
        $('#filterCategory').find('option:not(:first)').remove();
        $('#filterGrade').find('option:not(:first)').remove();
        $('#filterYear').find('option:not(:first)').remove();
        $('#filterStatus').find('option:not(:first)').remove();
        
        // Populate Quarter dropdown
        Array.from(quarters).sort().forEach(function(quarter) {
            $('#filterQuarter').append($('<option>', { value: quarter, text: quarter }));
        });
        
        // Populate Category dropdown
        Array.from(categories).sort().forEach(function(category) {
            $('#filterCategory').append($('<option>', { value: category, text: category }));
        });
        
        // Populate Grade dropdown
        Array.from(grades).sort().forEach(function(grade) {
            $('#filterGrade').append($('<option>', { value: grade, text: grade }));
        });
        
        // Populate Year dropdown
        Array.from(years).sort().reverse().forEach(function(year) {
            $('#filterYear').append($('<option>', { value: year, text: year }));
        });
        
        // Populate Status dropdown
        var statusArray = Array.from(statuses).sort();
        statusArray.forEach(function(status) {
            $('#filterStatus').append($('<option>', { value: status, text: status }));
        });
        
        // Store all quarters for year-based filtering
        window.allQuarters = Array.from(quarters);
    }
    
    // Filter quarters based on selected year
    function filterQuartersByYear() {
        var quarterDropdown = $('#filterQuarter');
        
        // Clear current quarter options (keep the "All" option)
        quarterDropdown.find('option:not(:first)').remove();
        
        // Show all quarters regardless of year (same as PMO)
        var allQuarters = window.allQuarters || [];
        
        // Populate quarter dropdown with all quarters
        allQuarters.sort().forEach(function(quarter) {
            quarterDropdown.append($('<option>', { value: quarter, text: quarter }));
        });
        
        // Clear quarter selection if it doesn't match the year
        var currentQuarter = quarterDropdown.val();
        if (currentQuarter && selectedYear && !currentQuarter.includes(selectedYear)) {
            quarterDropdown.val('');
        }
    }
    
    // Apply filters to table
    window.applyHistoryFilters = function() {
        var table = window.historyTableInstance;
        if (!table) return;
        var quarterFilter = $('#filterQuarter').val();
        var categoryFilter = $('#filterCategory').val();
        var gradeFilter = $('#filterGrade').val();
        var yearFilter = $('#filterYear').val();
        var statusFilter = $('#filterStatus').val();
        
        // Clear any existing custom search functions
        $.fn.dataTable.ext.search = [];
        
        // Add custom search function that works with DataTables pagination
        $.fn.dataTable.ext.search.push(
            function(settings, data, dataIndex) {
                // Only apply to history table
                if (settings.nTable.id !== 'historyTable') {
                    return true;
                }
                
                // Extract text content from HTML or string
                var quarterText = (typeof data[8] === 'string') ? data[8].trim() : $(data[8]).text().trim();
                var categoryText = (typeof data[5] === 'string') ? data[5].trim() : $(data[5]).text().trim();
                var gradeText = (typeof data[4] === 'string') ? data[4].trim() : $(data[4]).text().trim();
                var eventDateText = (typeof data[1] === 'string') ? data[1].trim() : $(data[1]).text().trim();
                var statusRaw = (typeof data[7] === 'string') ? data[7].trim() : $(data[7]).text().trim();
                
                // Extract only the status word (Approved, Rejected, Pending)
                var statusText = '';
                var statusMatch = statusRaw.match(/Approved|Rejected|Pending/);
                if (statusMatch) {
                    statusText = statusMatch[0];
                }
                
                // Filter by quarter - extract Q1-Q4 from "Q4 2025" format
                if (quarterFilter) {
                    var quarterMatch = quarterText.match(/Q[1-4]/);
                    var quarterOnly = quarterMatch ? quarterMatch[0] : '';
                    if (quarterOnly !== quarterFilter) {
                        return false;
                    }
                }
                
                // Filter by category
                if (categoryFilter && categoryText.indexOf(categoryFilter) === -1) {
                    return false;
                }
                
                // Filter by grade
                if (gradeFilter && gradeText.indexOf(gradeFilter) === -1) {
                    return false;
                }
                
                // Filter by year (using Event Date, not Request Date)
                if (yearFilter && eventDateText) {
                    var parts = eventDateText.split('-');
                    if (parts.length === 3) {
                        var year = parts[2]; // DD-MM-YYYY format
                        if (year !== yearFilter) {
                            return false;
                        }
                    } else {
                        return false;
                    }
                }
                
                // Filter by status - exact match
                if (statusFilter && statusText !== statusFilter) {
                    return false;
                }
                
                return true;
            }
        );
        
        table.draw();
    }
    
    // Reset all filters
    window.resetHistoryFilters = function() {
        // Clear filter dropdowns
        $('#filterQuarter, #filterCategory, #filterGrade, #filterYear, #filterStatus').val('');
        
        // Repopulate quarter dropdown with all quarters
        filterQuartersByYear();
        
        // Get table instance
        var table = window.historyTableInstance;
        if (!table) return;
        
        // Clear DataTables custom search
        $.fn.dataTable.ext.search = [];
        
        // Clear DataTables search box and visible input field
        table.search('').draw();
        
        // Clear the custom search input field
        $('#historySearchInput').val('');
    }
    
    // Initialize tables on page load for active tab
    initPendingTable();
    
    // Store selected checkboxes across pages and persist to localStorage
    let selectedRequests = new Set();
    
    // Load previously selected requests from localStorage
    function loadSelectedRequests() {
        try {
            // Check if this is a real-time reload or manual refresh
            const isRealtimeReload = sessionStorage.getItem('ld_realtime_reload') === 'true';
            
            if (isRealtimeReload) {
                // Real-time reload: restore selections
                const saved = localStorage.getItem('ld_selected_requests');
                if (saved) {
                    const parsed = JSON.parse(saved);
                    selectedRequests = new Set(parsed);
                }
                // Clear the flag
                sessionStorage.removeItem('ld_realtime_reload');
            } else {
                // Manual refresh: clear selections
                selectedRequests = new Set();
                localStorage.removeItem('ld_selected_requests');
            }
        } catch (e) {
            // Silent error handling
        }
    }
    
    // Save selected requests to localStorage
    function saveSelectedRequests() {
        try {
            localStorage.setItem('ld_selected_requests', JSON.stringify(Array.from(selectedRequests)));
        } catch (e) {
            // Silent error handling
        }
    }
    
    // Initialize: Load saved selections
    loadSelectedRequests();
    
    // Select All checkbox - only affects visible rows on current page
    // Use event delegation to handle dynamically replaced checkboxes
    $(document).on('change', '#selectAll', function() {
        const isChecked = this.checked;
        
        // Only check/uncheck visible checkboxes on current page
        $('#pendingTable tbody tr:visible .request-checkbox').each(function() {
            $(this).prop('checked', isChecked);
            const value = $(this).val();
            if (isChecked) {
                selectedRequests.add(value);
            } else {
                selectedRequests.delete(value);
            }
        });
        saveSelectedRequests(); // Save to localStorage
    });
    
    // Update select all based on visible checkboxes
    $(document).on('change', '.request-checkbox', function() {
        const value = $(this).val();
        if ($(this).is(':checked')) {
            selectedRequests.add(value);
        } else {
            selectedRequests.delete(value);
        }
        saveSelectedRequests(); // Save to localStorage
        
        const visibleTotal = $('#pendingTable tbody tr:visible .request-checkbox').length;
        const visibleChecked = $('#pendingTable tbody tr:visible .request-checkbox:checked').length;
        $('#selectAll').prop('checked', visibleTotal > 0 && visibleTotal === visibleChecked);
    });
    
    // Note: Page change event is now bound inside initPendingTable() function
    // This ensures it persists after table reinitialization
    
    // Store action type globally
    let pendingBulkAction = null;
    
    // Bulk action form validation
    // Handle bulk action buttons with event delegation
    $(document).on('click', 'button[name="action_type"][value="bulk_approve"], button[name="action_type"][value="bulk_reject"]', function(e) {
        e.preventDefault();
        
        const actionType = $(this).val();
        const checkedCount = $('.request-checkbox:checked').length;
        
        if (checkedCount === 0) {
            showCustomAlert('Please select at least one request.', 'warning');
            return false;
        }
        
        // Check response notes are mandatory for both approve and reject
        if (!$('#response_notes').val().trim()) {
            const actionName = actionType === 'bulk_approve' ? 'approval' : 'rejection';
            showCustomAlert(`Response notes are required for bulk ${actionName}.`, 'danger');
            $('#response_notes').focus();
            return false;
        }
        
        // Store action type
        pendingBulkAction = actionType;
        
        // Show confirmation modal
        showBulkActionConfirmation(actionType, checkedCount);
        
        return false;
    });
    
    // Show bulk action confirmation modal
    function showBulkActionConfirmation(actionType, count) {
        const isApprove = actionType === 'bulk_approve';
        const modalHeader = $('#bulkActionModalHeader');
        const modalTitle = $('#bulkActionModalTitle');
        const confirmBtn = $('#bulkActionConfirmBtn');
        
        // Set modal styling based on action
        if (isApprove) {
            modalHeader.css('background', 'linear-gradient(135deg, #28a745 0%, #20c997 100%)');
            modalTitle.html('<i class="fas fa-check-circle"></i> Confirm Approval');
            confirmBtn.removeClass('btn-danger').addClass('btn-success');
            confirmBtn.html('<i class="fas fa-check"></i> Approve ' + count + ' Request(s)');
        } else {
            modalHeader.css('background', 'linear-gradient(135deg, #dc3545 0%, #c82333 100%)');
            modalTitle.html('<i class="fas fa-times-circle"></i> Confirm Rejection');
            confirmBtn.removeClass('btn-success').addClass('btn-danger');
            confirmBtn.html('<i class="fas fa-times"></i> Reject ' + count + ' Request(s)');
        }
        
        // Update count
        $('#bulkActionCount').text(count);
        
        // Populate preview table
        let previewHtml = '';
        $('.request-checkbox:checked').each(function() {
            const row = $(this).closest('tr');
            const employeeCell = row.find('td:eq(3)');
            const employeeName = employeeCell.find('strong').text().trim();
            const employeeId = employeeCell.find('small').text().trim();
            const category = row.find('td:eq(7)').text().trim(); // Category column
            const points = row.find('td:eq(9)').text().trim(); // Points column
            const eventDate = row.find('td:eq(2)').text().trim(); // Event Date column
            
            previewHtml += `
                <tr>
                    <td style="text-align: center;">
                        <strong>${employeeName}</strong><br>
                        <small class="text-muted">${employeeId}</small>
                    </td>
                    <td style="text-align: center; word-wrap: break-word; white-space: normal; max-width: 250px;">${category}</td>
                    <td style="text-align: center; white-space: nowrap;" class="text-primary"><strong>${points}</strong></td>
                    <td style="text-align: center; white-space: nowrap;">${eventDate}</td>
                </tr>
            `;
        });
        $('#bulkActionPreviewBody').html(previewHtml);
        
        // Apply scroll only if more than 10 records
        const container = $('#bulkActionTableContainer');
        if (count > 10) {
            container.css({
                'max-height': '400px',
                'overflow-y': 'auto'
            });
        } else {
            container.css({
                'max-height': 'none',
                'overflow-y': 'visible'
            });
        }
        
        // Show modal - Get or create instance
        const modalElement = document.getElementById('bulkActionConfirmModal');
        let modal = bootstrap.Modal.getInstance(modalElement);
        
        if (!modal) {
            modal = new bootstrap.Modal(modalElement, {
                backdrop: 'static',
                keyboard: false
            });
        }
        
        modal.show();
    }
    
    // Confirm bulk action - Make it globally accessible
    window.confirmBulkAction = function() {
        
        // Close modal
        const modalElement = document.getElementById('bulkActionConfirmModal');
        const modal = bootstrap.Modal.getInstance(modalElement);
        
        if (modal) {
            modal.hide();
        } else {
            $(modalElement).modal('hide');
        }
        
        // Submit form
        const form = $('#bulkActionForm')[0];
        const submitBtn = pendingBulkAction === 'bulk_approve' ? 
            $('button[name="action_type"][value="bulk_approve"]')[0] : 
            $('button[name="action_type"][value="bulk_reject"]')[0];
        
        // Create a hidden input to preserve the action type
        const hiddenInput = $('<input>').attr({
            type: 'hidden',
            name: 'action_type',
            value: pendingBulkAction
        });
        $(form).append(hiddenInput);
        
        // Submit form
        form.submit();
    }
    
    // Custom alert function
    function showCustomAlert(message, type = 'info') {
        const alertDiv = $('<div>')
            .addClass(`alert alert-${type} alert-dismissible fade show`)
            .css({
                position: 'fixed',
                top: '80px',
                right: '20px',
                zIndex: 9999,
                minWidth: '300px'
            })
            .html(`
                <i class="fas fa-${type === 'warning' ? 'exclamation-triangle' : 'info-circle'}"></i>
                <strong>${message}</strong>
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `);
        
        $('body').append(alertDiv);
        
        setTimeout(() => alertDiv.remove(), 5000);
    }
    
    // Single action form validation
    $('#singleActionForm').on('submit', function(e) {
        const notes = $('#modal_response_notes').val().trim();
        
        if (!notes) {
            e.preventDefault();
            showCustomAlert('Please provide notes for your decision.', 'warning');
            $('#modal_response_notes').focus();
            return false;
        }
        
        return true;
    });

// Single action handler
function singleAction(requestId, action) {
    $('#modal_request_id').val(requestId);
    $('#modal_action').val(action);
    $('#modal_response_notes').val('');
    
    if (action === 'approve') {
        $('#modalTitle').text('Approve Request');
        $('#modalMessage').text('Are you sure you want to approve this request?');
        $('#modalSubmitBtn').removeClass('btn-danger').addClass('btn-success').text('Approve');
        $('#notesHint').text('Please provide notes explaining your approval');
        // Set green header for approve
        $('#modalHeader').css('background-color', '#28a745').css('color', 'white');
        $('.btn-close', '#modalHeader').addClass('btn-close-white');
    } else {
        $('#modalTitle').text('Reject Request');
        $('#modalMessage').text('Are you sure you want to reject this request?');
        $('#modalSubmitBtn').removeClass('btn-success').addClass('btn-danger').text('Reject');
        $('#notesHint').text('Please provide a reason for rejection');
        // Set red header for reject
        $('#modalHeader').css('background-color', '#dc3545').css('color', 'white');
        $('.btn-close', '#modalHeader').addClass('btn-close-white');
    }
    
    const modal = new bootstrap.Modal(document.getElementById('singleActionModal'));
    modal.show();
}


</script>
{% endblock %}
