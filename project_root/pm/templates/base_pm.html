<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}PM Dashboard - Points System{% endblock %}</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
    <!-- DataTables CSS -->
    <link href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css" rel="stylesheet">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="{{ url_for('pm.static', filename='pm_dashboard.css') }}">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@400;500;600&display=swap" rel="stylesheet">
    
    <style>
        /* Dashboard switcher styling */
        .dashboard-switcher-item {
            padding: 0.5rem 1rem;
            color: rgba(255, 255, 255, 0.8);
            text-decoration: none;
            display: flex;
            align-items: center;
            transition: all 0.3s ease;
            border-radius: 4px;
            margin: 0.25rem 0.5rem;
        }
        
        .dashboard-switcher-item:hover {
            background-color: rgba(255, 255, 255, 0.1);
            color: #fff;
        }
        
        .dashboard-switcher-item i {
            width: 20px;
            margin-right: 0.75rem;
            text-align: center;
        }
        
        /* Profile picture styling */
        .profile-pic-img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            overflow: hidden;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .profile-pic-letter {
            color: white;
            font-weight: bold;
            font-size: 18px;
        }
        
        /* Real-time notification animation */
        @keyframes slideInRight {
            from { transform: translateX(400px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        /* Notification badge pulse animation */
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        
        .badge-pulse {
            animation: pulse 2s infinite;
        }
    </style>
    
    {% block extra_css %}{% endblock %}
</head>
<body data-user-id="{{ user._id if user else '' }}">
    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="d-flex flex-column align-items-center">
                <img src="https://www.prowesssoft.com/wp-content/uploads/2025/05/Prowess-white-logo.png" 
                     alt="PS Logo" class="sidebar-logo mb-1" style="max-height: 40px;">
                <div class="text-success" style="font-size: 12px; font-weight: 500;">PROWESS SOFT</div>
            </div>
        </div>

        <div class="sidebar-nav">
            {% block sidebar_nav %}
            <!-- Dashboard -->
            <a href="{{ url_for('pm.dashboard') }}" class="sidebar-nav-item {% if request.endpoint == 'pm.dashboard' %}active{% endif %}">
                <div class="d-flex align-items-center">
                    <i class="fas fa-tachometer-alt"></i>
                    <span>Dashboard</span>
                </div>
            </a>
            
            <!-- Pending Requests -->
            <a href="{{ url_for('pm.pending_requests') }}" class="sidebar-nav-item {% if request.endpoint == 'pm.pending_requests' %}active{% endif %}">
                <div class="d-flex align-items-center">
                    <i class="fas fa-clock"></i>
                    <span>Pending Requests</span>
                </div>
                <span class="badge bg-warning" id="pending-badge">{{ pending_count if pending_count is defined else 0 }}</span>
            </a>
            
            <!-- Processed Requests History -->
            <a href="{{ url_for('pm.processed_requests') }}" class="sidebar-nav-item {% if request.endpoint == 'pm.processed_requests' %}active{% endif %}">
                <div class="d-flex align-items-center">
                    <i class="fas fa-check-circle"></i>
                    <span>Processed History</span>
                </div>
            </a>
            
            <div class="sidebar-divider"></div>
            
            <!-- Dashboard Switcher -->
            <div class="px-3 py-2">
                <small class="text-white-50 text-uppercase" style="font-size: 11px;">
                    <i class="fas fa-th-large me-1"></i> Switch Dashboard
                </small>
            </div>
            
            <!-- ALWAYS show Employee View as first option -->
            <a href="{{ url_for('employee_dashboard.dashboard') }}" class="dashboard-switcher-item">
                <i class="fas fa-user"></i>
                <span>Employee View</span>
            </a>
            
            <!-- Show other dashboards if user has access -->
            {% if user and user.dashboard_access %}
                {% set dashboard_list = user.dashboard_access if user.dashboard_access is iterable and user.dashboard_access is not string else [user.dashboard_access] %}
                
                {% for dashboard in dashboard_list %}
                    {# Don't show current dashboard (pm) in switcher #}
                    {% if dashboard == 'pmo_up' %}
                    <a href="{{ url_for('pmo.updater_dashboard') }}" class="dashboard-switcher-item">
                        <i class="fas fa-tasks"></i>
                        <span>PMO Updater</span>
                    </a>
                    {% elif dashboard == 'pmo_va' %}
                    <a href="{{ url_for('pmo.validator_dashboard') }}" class="dashboard-switcher-item">
                        <i class="fas fa-clipboard-check"></i>
                        <span>PMO Validator</span>
                    </a>
                    {% elif dashboard == 'pm_arch' or dashboard == 'pmarch' %}
                    <a href="{{ url_for('pm_arch.dashboard') }}" class="dashboard-switcher-item">
                        <i class="fas fa-drafting-compass"></i>
                        <span>PM/Arch Dashboard</span>
                    </a>
                    {% elif dashboard == 'ta_up' %}
                    <a href="{{ url_for('ta.updater_dashboard') }}" class="dashboard-switcher-item">
                        <i class="fas fa-user-plus"></i>
                        <span>TA Updater</span>
                    </a>
                    {% elif dashboard == 'ta_va' %}
                    <a href="{{ url_for('ta.validator_dashboard') }}" class="dashboard-switcher-item">
                        <i class="fas fa-user-check"></i>
                        <span>TA Validator</span>
                    </a>
                    {% elif dashboard == 'ld' %}
                    <a href="{{ url_for('ld.dashboard') }}" class="dashboard-switcher-item">
                        <i class="fas fa-graduation-cap"></i>
                        <span>L&D Dashboard</span>
                    </a>
                    {% elif dashboard == 'ld_up' %}
                    <a href="{{ url_for('ld.updater_dashboard') }}" class="dashboard-switcher-item">
                        <i class="fas fa-user-edit"></i>
                        <span>L&D Updater</span>
                    </a>
                    {% elif dashboard == 'ld_va' %}
                    <a href="{{ url_for('ld.validator_dashboard') }}" class="dashboard-switcher-item">
                        <i class="fas fa-book-reader"></i>
                        <span>L&D Validator</span>
                    </a>
                    {% elif dashboard == 'hr_up' %}
                    <a href="{{ url_for('hr_roles.updater_dashboard') }}" class="dashboard-switcher-item">
                        <i class="fas fa-user-edit"></i>
                        <span>HR Updater</span>
                    </a>
                    {% elif dashboard == 'hr_va' %}
                    <a href="{{ url_for('hr_roles.validator_dashboard') }}" class="dashboard-switcher-item">
                        <i class="fas fa-user-check"></i>
                        <span>HR Validator</span>
                    </a>
                    {% elif dashboard == 'hr' %}
                    <a href="{{ url_for('hr_analytics.pbs_analytics') }}" class="dashboard-switcher-item">
                        <i class="fas fa-chart-line"></i>
                        <span>HR Analytics</span>
                    </a>
                    {% elif dashboard == 'marketing' %}
                    <a href="{{ url_for('marketing_dashboard.dashboard') }}" class="dashboard-switcher-item">
                        <i class="fas fa-bullhorn"></i>
                        <span>Marketing Dashboard</span>
                    </a>
                    {% elif dashboard == 'presales' %}
                    <a href="{{ url_for('presales.dashboard') }}" class="dashboard-switcher-item">
                        <i class="fas fa-handshake"></i>
                        <span>Presales Dashboard</span>
                    </a>
                    {% elif dashboard == 'dp' %}
                    <a href="{{ url_for('dp.dashboard') }}" class="dashboard-switcher-item">
                        <i class="fas fa-hands-helping"></i>
                        <span>DP Dashboard</span>
                    </a>
                    {% elif dashboard == 'central' %}
                    <a href="{{ url_for('central.dashboard') }}" class="dashboard-switcher-item">
                        <i class="fas fa-building"></i>
                        <span>Central Dashboard</span>
                    </a>
                    {% endif %}
                {% endfor %}
            {% endif %}
            
            <div class="sidebar-divider"></div>
            
            <!-- Logout -->
            <a href="{{ url_for('auth.logout') }}" class="sidebar-nav-item">
                <div>
                    <i class="fas fa-sign-out-alt"></i>
                    <span>Logout</span>
                </div>
            </a>
            {% endblock %}
        </div>
    </div>
    
    <!-- Sidebar Overlay -->
    <div class="sidebar-overlay" id="sidebarOverlay"></div>
    
    <!-- Topbar -->
    <div class="topbar">
        <div class="topbar-left">
            <button class="sidebar-toggle" id="sidebarToggle">
                <i class="fas fa-bars"></i>
            </button>
            <div class="topbar-icon">
                {% block topbar_icon %}<i class="fas fa-project-diagram"></i>{% endblock %}
            </div>
            <div class="topbar-info">
                <div class="topbar-title">{% block topbar_title %}PM Dashboard{% endblock %}</div>
                <div class="topbar-subtitle">
                    {% block topbar_subtitle %}
                    <span class="topbar-badge bg-primary">{{ display_quarter if display_quarter is defined else 'Q1 FY2025' }}</span>
                    <span class="topbar-badge bg-secondary">{{ display_month if display_month is defined else 'JAN 2025' }}</span>
                    {% endblock %}
                </div>
            </div>
        </div>
        
        <div class="topbar-center">
            <h6 class="topbar-heading">
                <i class="fas fa-award me-2" style="color: gold;"></i>
                <span>POINTS BASED SYSTEM</span>
            </h6>
        </div>
        
        <div class="topbar-right">
            <div class="d-flex align-items-center">
                {% if user %}
                <div class="text-white me-3 text-end">
                    <small>pm</small>
                    <br><small class="text-white-50">
                        <i class="fas fa-th-large"></i> 
                        {{ user.dashboard_access|length if user.dashboard_access is iterable and user.dashboard_access is not string else 1 }} Dashboard(s)
                    </small>
                </div>
                {% endif %}
                <div class="profile-pic-img">
                    {% if user %}
                    <div class="profile-pic-letter">P</div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
    <!-- Main Content -->
    <div class="content-wrapper">
        <!-- Flash Messages -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }} alert-dismissible fade show">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}
        
        {% block content %}{% endblock %}
    </div>
    
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- DataTables JS -->
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
    
    <!-- Common JS -->
    <script>
        // Sidebar Toggle
        document.addEventListener('DOMContentLoaded', function() {
            const sidebar = document.getElementById('sidebar');
            const sidebarToggle = document.getElementById('sidebarToggle');
            const sidebarOverlay = document.getElementById('sidebarOverlay');
            
            sidebarToggle.addEventListener('click', function() {
                sidebar.classList.toggle('show');
                sidebarOverlay.classList.toggle('show');
            });
            
            sidebarOverlay.addEventListener('click', function() {
                sidebar.classList.remove('show');
                sidebarOverlay.classList.remove('show');
            });
            
            // Close sidebar when clicking a nav item (on mobile)
            document.querySelectorAll('.sidebar-nav-item, .dashboard-switcher-item').forEach(function(item) {
                item.addEventListener('click', function() {
                    if (window.innerWidth < 992) {
                        sidebar.classList.remove('show');
                        sidebarOverlay.classList.remove('show');
                    }
                });
            });
            
            // Auto-dismiss flash messages
            setTimeout(function() {
                document.querySelectorAll('.alert-dismissible').forEach(alert => {
                    const bsAlert = new bootstrap.Alert(alert);
                    bsAlert.close();
                });
            }, 5000);
        });
    </script>
    
    <!-- âœ… SOCKET.IO -->
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    
    <!-- âœ… REAL-TIME PM MANAGER -->
    <script>
        (function() {
            'use strict';
            
            class PMRealtimeManager {
                constructor() {
                    this.socket = null;
                    this.userId = null;
                    this.connected = false;
                }
                
                init(userId) {
                    if (!userId) {
                        console.error('âŒ User ID required');
                        return;
                    }
                    this.userId = userId;
                    this.connect();
                }
                
                connect() {
                    // âœ… BROWSER COMPATIBILITY CHECK
                    const isOperaMini = navigator.userAgent.indexOf('Opera Mini') > -1;
                    const isOldFirefox = /Firefox\/([0-9]+)/.test(navigator.userAgent) && parseInt(RegExp.$1) < 48;
                    const hasLimitedSupport = isOperaMini || isOldFirefox;
                    
                    if (hasLimitedSupport) {
                        console.warn('âš ï¸ Browser has limited WebSocket support. Real-time notifications may not work. Please use Chrome, Edge, or updated Firefox for best experience.');
                        this.showBrowserWarning();
                        return; // Don't attempt connection on unsupported browsers
                    }
                    
                    this.socket = io({
                        transports: ['polling', 'websocket'],  // Try polling first for better browser compatibility
                        reconnection: true,
                        reconnectionAttempts: 10,
                        reconnectionDelay: 1000,
                        reconnectionDelayMax: 5000,
                        timeout: 20000,
                        upgrade: true,  // Allow upgrade from polling to websocket
                        rememberUpgrade: true,  // Remember successful upgrade
                        forceNew: false
                    });
                    this.setupEventHandlers();
                }
                
                showBrowserWarning() {
                    const warning = document.createElement('div');
                    warning.className = 'alert alert-warning alert-dismissible fade show';
                    warning.style.cssText = `
                        position: fixed;
                        top: 80px;
                        right: 20px;
                        z-index: 9999;
                        max-width: 400px;
                        box-shadow: 0 4px 20px rgba(0,0,0,0.2);
                    `;
                    warning.innerHTML = `
                        <div class="d-flex align-items-start">
                            <i class="fas fa-exclamation-triangle me-2 mt-1"></i>
                            <div class="flex-grow-1">
                                <strong>Browser Not Supported</strong><br>
                                <small>Real-time notifications are not supported in Opera Mini or older Firefox versions. Please use Chrome, Edge, Safari, or updated Firefox for real-time updates. You can still use the system by manually refreshing the page.</small>
                            </div>
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>
                    `;
                    document.body.appendChild(warning);
                }
                
                setupEventHandlers() {
                    this.socket.on('connect', () => {
                        this.connected = true;
                        this.registerUser();
                    });
                    
                    this.socket.on('disconnect', () => {
                        this.connected = false;
                    });
                    
                    this.socket.on('connected', (data) => {
                    });
                    
                    // âœ… LISTEN FOR NEW REQUESTS
                    this.socket.on('employee_request_raised', (data) => this.handleNewRequest(data));
                    
                    // âœ… LISTEN FOR TA WORKING ON REQUESTS
                    this.socket.on('ta_working_on_request', (data) => this.handleTAWorking(data));
                    
                    // âœ… LISTEN FOR LEADERBOARD UPDATES
                    this.socket.on('leaderboard_update', (data) => this.handleLeaderboardUpdate(data));
                }
                
                registerUser() {
                    if (!this.socket || !this.connected) return;
                    this.socket.emit('register_user', {
                        user_id: this.userId,
                        user_type: 'pm',
                        role: 'pm'
                    });
                }
                
                // ===== NEW REQUEST HANDLER =====
                handleNewRequest(data) {
                    const source = data.is_ta_created ? `TA (${data.ta_updater_name})` : data.employee_name;
                    const message = data.is_ta_created 
                        ? `ðŸ”” New request from ${source} for ${data.employee_name} - ${data.category_name} (${data.points} points)`
                        : `ðŸ”” New request: ${data.employee_name} - ${data.category_name} (${data.points} points)`;
                    
                    this.showNotification(message, 'info');
                    this.playSound();
                    // Update badge after a small delay to ensure DB is updated
                    setTimeout(() => this.updatePendingBadge(), 500);
                    // Reload page to show new request
                    setTimeout(() => window.location.reload(), 2000);
                }
                
                // ===== TA WORKING HANDLER =====
                handleTAWorking(data) {
                    const actionText = data.action === 'approving' ? 'âœ… approving' : 
                                     data.action === 'rejecting' ? 'âŒ rejecting' : 'ðŸ‘ï¸ reviewing';
                    const alertType = data.action === 'approving' ? 'success' : 
                                    data.action === 'rejecting' ? 'warning' : 'info';
                    
                    this.showNotification(
                        `TA Validator (${data.ta_validator_name}) is ${actionText} request for ${data.employee_name} - ${data.category_name}`,
                        alertType
                    );
                    
                    // Reload after a delay to show updated status
                    if (data.action === 'approving' || data.action === 'rejecting') {
                        setTimeout(() => window.location.reload(), 2000);
                    }
                }
                
                // ===== LEADERBOARD UPDATE HANDLER =====
                handleLeaderboardUpdate(data) {
                    // Optional: Update leaderboard without full refresh
                }
                
                updatePendingBadge() {
                    // Fetch actual current count from server
                    fetch('/pm/api/pending-count')
                        .then(response => response.json())
                        .then(data => {
                            const badge = document.getElementById('pending-badge');
                            if (badge && data.count !== undefined) {
                                badge.textContent = data.count;
                                badge.classList.add('badge-pulse');
                                setTimeout(() => badge.classList.remove('badge-pulse'), 2000);
                            }
                        })
                        .catch(error => {
                            console.error('Error fetching pending count:', error);
                            // Fallback to increment if API fails
                            const badge = document.getElementById('pending-badge');
                            if (badge) {
                                const currentCount = parseInt(badge.textContent) || 0;
                                badge.textContent = currentCount + 1;
                            }
                        });
                }
                
                showNotification(message, type = 'info') {
                    const notification = document.createElement('div');
                    notification.className = `alert alert-${type} alert-dismissible fade show`;
                    notification.style.cssText = `
                        position: fixed;
                        top: 80px;
                        right: 20px;
                        z-index: 9999;
                        min-width: 350px;
                        box-shadow: 0 4px 20px rgba(0,0,0,0.2);
                        animation: slideInRight 0.4s ease-out;
                    `;
                    notification.innerHTML = `
                        <div class="d-flex align-items-center">
                            <div class="flex-grow-1"><strong>${message}</strong></div>
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>
                    `;
                    document.body.appendChild(notification);
                    setTimeout(() => notification.remove(), 5000);
                }
                
                playSound() {
                    try {
                        const audio = new Audio('/static/sounds/notification.mp3');
                        audio.volume = 0.5;
                        audio.play().catch(() => {});
                    } catch (e) {}
                }
                
                ping() {
                    if (this.socket && this.connected) {
                        this.socket.emit('ping');
                    }
                }
            }
            
            window.PMRealtimeManager = new PMRealtimeManager();
        })();
    </script>
    
    <!-- âœ… AUTO-INITIALIZE PM REAL-TIME -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            {% if user and user._id %}
            const userId = '{{ user._id }}';
            window.PMRealtimeManager.init(userId);
            setInterval(() => window.PMRealtimeManager.ping(), 30000);
            {% endif %}
        });
    </script>
    
    {% block extra_js %}{% endblock %}
</body>
</html>