{% extends "central_base.html" %}

{% block title %}Export Data - Central Dashboard{% endblock %}

{% block content %}
<div class="content-wrapper">
    <!-- Page Header -->
    <div class="dashboard-header">
        <h4 class="mb-0">Central Dashboard</h4>
        <div>
            <button class="btn btn-outline-success" onclick="window.print()">
                <i class="fas fa-print"></i> Print
            </button>
        </div>
    </div>

    <!-- Export Data with Date Range -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="card-title mb-0">
                <i class="fas fa-file-export text-success me-2"></i>Export Data with Date Range
            </h5>
        </div>
        <div class="card-body">
            <div class="row g-3 align-items-end">
                <div class="col-md-3">
                    <label for="exportStartDate" class="form-label">Start Date</label>
                    <input type="date" class="form-control" id="exportStartDate" required>
                </div>
                <div class="col-md-3">
                    <label for="exportEndDate" class="form-label">End Date</label>
                    <input type="date" class="form-control" id="exportEndDate" required>
                </div>
                <div class="col-md-6 d-flex justify-content-md-start justify-content-end">
                    <button type="button" id="exportToExcel" class="btn btn-success">
                        <i class="fas fa-file-excel me-2"></i> Export to Excel
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Exportable Data Section -->
    <div class="card mb-4 card-shadow">
        <div class="card-header" style="background: linear-gradient(135deg, #1e3a5f 0%, #2d5a8c 100%); color: white;">
            <div class="d-flex align-items-center justify-content-between">
                <div>
                    <i class="fas fa-file-export me-2"></i>
                    <span class="fw-bold">Exportable Data</span>
                </div>
                <div class="export-actions">
                    <button class="btn btn-sm btn-success me-2" id="exportCSV">
                        <i class="fas fa-file-csv me-1"></i> Export CSV
                    </button>
                    <button class="btn btn-sm btn-primary me-2" id="exportExcel">
                        <i class="fas fa-file-excel me-1"></i> Export Excel
                    </button>
                    <button class="btn btn-sm btn-light" id="printTable">
                        <i class="fas fa-print me-1"></i> Print
                    </button>
                </div>
            </div>
        </div>
        <div class="card-body p-0">
            <!-- Filters -->
            <div class="p-3 bg-light border-bottom">
                <div class="row g-3">
                    <div class="col-md-2">
                        <label for="exportDeptFilter" class="form-label">Department</label>
                        <select class="form-select form-select-sm" id="exportDeptFilter">
                            <option value="">All Departments</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label for="exportGradeFilter" class="form-label">Grade</label>
                        <select class="form-select form-select-sm" id="exportGradeFilter">
                            <option value="">All Grades</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label for="exportStatusFilter" class="form-label">Status</label>
                        <select class="form-select form-select-sm" id="exportStatusFilter">
                            <option value="">All Status</option>
                            <option value="eligible">Eligible</option>
                            <option value="not-eligible">Not Eligible</option>
                            <option value="awarded">Awarded</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="exportSearch" class="form-label">Search</label>
                        <div class="input-group input-group-sm">
                            <input type="text" class="form-control" id="exportSearch" placeholder="Search employees...">
                            <span class="input-group-text"><i class="fas fa-search"></i></span>
                        </div>
                    </div>
                    <div class="col-md-3 d-flex align-items-end">
                        <button class="btn btn-sm btn-outline-secondary w-100" id="resetExportFilters">
                            <i class="fas fa-undo me-1"></i> Reset Filters
                        </button>
                    </div>
                </div>
            </div>

            <!-- Table -->
            <div class="table-responsive">
                <table class="table table-striped table-hover align-middle mb-0" id="exportTable">
                    <thead class="table-light">
                        <tr>
                            <th class="ps-3 sortable" data-sort="name" style="white-space: nowrap;">Employee Name</th>
                            <th class="sortable" data-sort="email" style="white-space: nowrap;">Email</th>
                            <th class="sortable" data-sort="department" style="white-space: nowrap;">Department</th>
                            <th class="sortable" data-sort="grade" style="white-space: nowrap;">Grade</th>
                            <th class="sortable" data-sort="total_points" style="white-space: nowrap;">Total Points</th>
                            <th class="sortable" data-sort="quarterly_points" style="white-space: nowrap;">Quarterly Points</th>
                            <th class="sortable" data-sort="bonus_points" style="white-space: nowrap;">Bonus Points</th>
                            <th class="sortable" data-sort="yearly_bonus_points" style="white-space: nowrap;">Yearly Bonus</th>
                            <th class="sortable" data-sort="quarterly_bonus" style="white-space: nowrap;">Quarterly Bonus</th>
                            <th style="white-space: nowrap;">All Quarters</th>
                            <th class="sortable" data-sort="status" style="white-space: nowrap;">Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for employee in employee_data %}
                        <tr class="export-employee-row"
                            data-department="{{ employee.department }}"
                            data-grade="{{ employee.grade }}"
                            data-status="{{ employee.status }}"
                            data-name="{{ employee.name }}">
                            <td class="ps-3">{{ employee.name }}</td>
                            <td>{{ employee.email }}</td>
                            <td>{{ employee.department }}</td>
                            <td><span class="badge bg-secondary">{{ employee.grade }}</span></td>
                            <td>{{ employee.total_points }}</td>
                            <td>{{ employee.quarterly_points }}</td>
                            <td>{{ employee.bonus_points }}</td>
                            <td>{{ employee.yearly_bonus_points }}</td>
                            <td>{{ employee.quarterly_bonus }}</td>
                            <td>
                                {% for qtr, qtr_data in employee.all_quarters.items() %}
                                    {{ qtr }}: {{ qtr_data.regular }}{% if qtr_data.bonus > 0 %} (+{{ qtr_data.bonus }}){% endif %}<br>
                                {% endfor %}
                            </td>
                            <td>
                                <span class="badge {% if employee.status == 'eligible' %}bg-success{% elif employee.status == 'awarded' %}bg-primary{% else %}bg-secondary{% endif %}">
                                    {{ employee.status|title|replace('-', ' ') }}
                                </span>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        <div class="card-footer">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <span class="text-muted small">Showing <span id="exportVisibleRows">{{ employee_data|length }}</span> employees</span>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Populate filter dropdowns
    const employees = {{ employee_data|tojson }};
    const departments = new Set();
    const grades = new Set();
    
    employees.forEach(emp => {
        departments.add(emp.department);
        grades.add(emp.grade);
    });
    
    const deptFilter = document.getElementById('exportDeptFilter');
    departments.forEach(dept => {
        const option = document.createElement('option');
        option.value = dept;
        option.textContent = dept;
        deptFilter.appendChild(option);
    });
    
    const gradeFilter = document.getElementById('exportGradeFilter');
    grades.forEach(grade => {
        const option = document.createElement('option');
        option.value = grade;
        option.textContent = grade;
        gradeFilter.appendChild(option);
    });
    
    // Filter functionality
    function applyFilters() {
        const dept = deptFilter.value;
        const grade = gradeFilter.value;
        const status = document.getElementById('exportStatusFilter').value;
        const search = document.getElementById('exportSearch').value.toLowerCase();
        
        const rows = document.querySelectorAll('.export-employee-row');
        let visibleCount = 0;
        
        rows.forEach(row => {
            const rowDept = row.getAttribute('data-department');
            const rowGrade = row.getAttribute('data-grade');
            const rowStatus = row.getAttribute('data-status');
            const rowName = row.getAttribute('data-name').toLowerCase();
            
            const deptMatch = !dept || dept === rowDept;
            const gradeMatch = !grade || grade === rowGrade;
            const statusMatch = !status || status === rowStatus;
            const searchMatch = !search || rowName.includes(search);
            
            const isVisible = deptMatch && gradeMatch && statusMatch && searchMatch;
            row.style.display = isVisible ? '' : 'none';
            if (isVisible) visibleCount++;
        });
        
        document.getElementById('exportVisibleRows').textContent = visibleCount;
    }
    
    deptFilter.addEventListener('change', applyFilters);
    gradeFilter.addEventListener('change', applyFilters);
    document.getElementById('exportStatusFilter').addEventListener('change', applyFilters);
    document.getElementById('exportSearch').addEventListener('input', applyFilters);
    
    document.getElementById('resetExportFilters').addEventListener('click', function() {
        deptFilter.value = '';
        gradeFilter.value = '';
        document.getElementById('exportStatusFilter').value = '';
        document.getElementById('exportSearch').value = '';
        applyFilters();
    });
    
    // Export to Excel with date range
    document.getElementById('exportToExcel').addEventListener('click', function() {
        const startDate = document.getElementById('exportStartDate').value;
        const endDate = document.getElementById('exportEndDate').value;
        
        if (!startDate || !endDate) {
            alert('Please select both start and end dates');
            return;
        }
        
        window.location.href = `/central/export/excel?start_date=${startDate}&end_date=${endDate}`;
    });
    
    // Export current table to CSV
    document.getElementById('exportCSV').addEventListener('click', function() {
        const table = document.getElementById('exportTable');
        const rows = Array.from(table.querySelectorAll('tbody tr')).filter(row => row.style.display !== 'none');
        
        let csv = 'Name,Email,Department,Grade,Total Points,Quarterly Points,Bonus Points,Yearly Bonus,Quarterly Bonus,Status\n';
        
        rows.forEach(row => {
            const cells = row.querySelectorAll('td');
            const rowData = [
                cells[0].textContent,
                cells[1].textContent,
                cells[2].textContent,
                cells[3].textContent.trim(),
                cells[4].textContent,
                cells[5].textContent,
                cells[6].textContent,
                cells[7].textContent,
                cells[8].textContent,
                cells[10].textContent.trim()
            ];
            csv += rowData.map(val => `"${val}"`).join(',') + '\n';
        });
        
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = 'employee_data.csv';
        link.click();
    });
    
    // Print table
    document.getElementById('printTable').addEventListener('click', function() {
        window.print();
    });
});
</script>
{% endblock %}
