{% extends 'base2.html' %}

{% block title %}Milestone Management{% endblock %}

{% block styles %}
<style>
    .milestone-card {
        border-radius: 10px;
        border-left: 5px solid #3498db;
        transition: all 0.3s ease;
        margin-bottom: 20px;
    }
    .milestone-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0,0,0,0.1);
    }
    .card-milestone-1 { border-left-color: #43a047; }
    .card-milestone-2 { border-left-color: #fb8c00; }
    .card-milestone-3 { border-left-color: #e53935; }
    .card-milestone-4 { border-left-color: #8e24aa; }
    
    .milestone-badge {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 15px;
        color: white;
        font-size: 30px;
    }
    .milestone-badge-1 { background: linear-gradient(135deg, #43a047, #2e7d32); }
    .milestone-badge-2 { background: linear-gradient(135deg, #fb8c00, #ef6c00); }
    .milestone-badge-3 { background: linear-gradient(135deg, #e53935, #c62828); }
    .milestone-badge-4 { background: linear-gradient(135deg, #8e24aa, #6a1b9a); }
    
    .employee-milestone-row {
        border-left: 3px solid #3498db;
        margin-bottom: 10px;
        padding: 10px 15px;
        background-color: #f8f9fa;
        border-radius: 0 5px 5px 0;
        transition: all 0.3s ease;
    }
    .employee-milestone-row:hover { background-color: #e9ecef; }
    
    .quarter-badge {
        width: 30px;
        height: 30px;
        border-radius: 50%;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
        font-size: 12px;
        margin: 0 3px;
    }
    .quarter-badge-1 { background-color: #1e88e5; }
    .quarter-badge-2 { background-color: #43a047; }
    .quarter-badge-3 { background-color: #fb8c00; }
    .quarter-badge-4 { background-color: #e53935; }
    
    .progress-yearly { height: 8px; border-radius: 4px; }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row mb-4">
        <div class="col">
            <h1 class="display-4"><i class="fas fa-trophy text-warning"></i> Milestone Management</h1>
            <p class="lead text-muted">Configure and award milestone bonuses to employees</p>
        </div>
    </div>

    <!-- Milestone Levels -->
    <div class="row mb-4">
        {% for i in range(1, 5) %}
        <div class="col-md-3">
            <div class="card milestone-card card-milestone-{{ i }}">
                <div class="card-body text-center">
                    <div class="milestone-badge milestone-badge-{{ i }}">
                        <i class="fas fa-award"></i>
                    </div>
                    <h4>Milestone {{ i }}</h4>
                    <h6 class="text-muted">
                        {% if i == 1 %}100% of Quarterly Target
                        {% elif i == 2 %}50% of Yearly Target
                        {% elif i == 3 %}75% of Yearly Target
                        {% else %}100% of Yearly Target{% endif %}
                    </h6>
                    <div class="mt-3">
                        <span class="badge bg-success">{{ [milestone1_achieved, milestone2_achieved, milestone3_achieved, milestone4_achieved][i-1] }} Achieved</span>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Employee Milestone Progress -->
    <div class="row mb-4">
        <div class="col-md-8">
            <div class="card shadow-sm">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">Employee Milestone Progress</h5>
                    <input type="text" id="search-employee" class="form-control" style="width: 250px;" placeholder="Search employees...">
                </div>
                <div class="card-body">
                    {% set sorted_employees = employees|sort(attribute='points_data.total_points', reverse=true) %}
                    {% for employee in sorted_employees %}
                    <div class="employee-milestone-row" data-name="{{ employee.name.lower() }}">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-1">{{ employee.name }}</h6>
                                <small class="text-muted">{{ employee.department }} | {{ employee.grade }}</small>
                            </div>
                            <div class="text-end">
                                <span class="badge bg-primary">{{ employee.points_data.total_points }} points</span>
                                {% set actual_billability = employee.actual_billability|default(0) %}
                                {% set required_billability = milestone_config.billability_requirements.get(employee.grade, 80) %}
                                {% if actual_billability >= required_billability %}
                                <span class="badge bg-success ms-1"><i class="fas fa-check-circle me-1"></i> {{ actual_billability }}%</span>
                                {% else %}
                                <span class="badge bg-danger ms-1"><i class="fas fa-times-circle me-1"></i> {{ actual_billability }}%</span>
                                {% endif %}
                            </div>
                        </div>
                        
                        {% set yearly_target = milestone_config.yearly_targets.get(employee.grade, 14500) %}
                        {% set yearly_progress = (employee.points_data.total_points / yearly_target * 100)|round %}
                        
                        <div class="mt-2 mb-1">
                            <div class="d-flex justify-content-between align-items-center">
                                <small class="text-muted">Yearly Progress ({{ employee.points_data.total_points }} / {{ yearly_target }})</small>
                                <small class="fw-bold">{{ yearly_progress }}%</small>
                            </div>
                            <div class="progress progress-yearly mt-1">
                                <div class="progress-bar bg-success" style="width: {{ yearly_progress }}%;"></div>
                            </div>
                        </div>
                        
                        <div class="d-flex justify-content-between mt-2 mb-2">
                            {% for q in range(1, 5) %}
                            <div class="text-center">
                                <span class="badge quarter-badge-{{ q }} d-block mx-auto mb-1">Q{{ q }}</span>
                                <small class="d-block">{{ employee.points_data.quarterly_points['qtr' ~ q] }}</small>
                            </div>
                            {% endfor %}
                        </div>
                        
                        {% set meets_billability = actual_billability >= required_billability %}
                        {% if meets_billability %}
                        <div class="text-end mt-3">
                            <div class="btn-group">
                                <button class="btn btn-sm btn-outline-primary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                    <i class="fas fa-trophy"></i> Award Milestone
                                </button>
                                <ul class="dropdown-menu dropdown-menu-end">
                                    {% set quarterly_target = milestone_config.quarterly_targets.get(employee.grade, 3650) %}
                                    {% for qtr_key, qtr_points in employee.points_data.quarterly_points.items() %}
                                    {% if qtr_points >= quarterly_target %}
                                    <li>
                                        <a class="dropdown-item award-milestone-btn" href="#" 
                                           data-employee-id="{{ employee.id }}"
                                           data-employee-name="{{ employee.name }}"
                                           data-milestone-level="1"
                                           data-quarter="{{ qtr_key }}"
                                           data-bonus-points="{{ milestone_config.milestones[0].bonus_points[qtr_key] }}">
                                            Milestone 1 - {{ qtr_key|upper }} ({{ milestone_config.milestones[0].bonus_points[qtr_key] }} pts)
                                        </a>
                                    </li>
                                    {% endif %}
                                    {% endfor %}
                                </ul>
                            </div>
                        </div>
                        {% else %}
                        <div class="alert alert-warning py-1 mt-2 mb-0">
                            <small><i class="fas fa-exclamation-triangle me-1"></i> Not eligible - Billability: {{ actual_billability }}%</small>
                        </div>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        
        <div class="col-md-4">
            <div class="card shadow-sm">
                <div class="card-header bg-white">
                    <h5 class="card-title mb-0">Recent Milestone Awards</h5>
                </div>
                <div class="card-body p-0">
                    <div class="list-group list-group-flush">
                        {% for award in recent_awards %}
                        <div class="list-group-item">
                            <h6 class="mb-1">{{ award.employee_name }}</h6>
                            <p class="mb-1">
                                <span class="badge bg-warning text-dark">{{ award.milestone_label }}</span>
                                <span class="badge bg-primary">{{ award.quarter|upper }}</span>
                                <span class="badge bg-success">+{{ award.bonus_points }} points</span>
                            </p>
                            <small class="text-muted">
                                <i class="far fa-calendar-alt me-1"></i>{{ award.award_date.strftime('%Y-%m-%d') }}
                            </small>
                        </div>
                        {% else %}
                        <div class="list-group-item text-center py-3">
                            <p class="text-muted mb-0">No recent milestone awards</p>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Award Milestone Modal -->
<div class="modal fade" id="awardMilestoneModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Award Milestone Bonus</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="text-center mb-4">
                    <div id="modal-milestone-badge" class="milestone-badge milestone-badge-1 mx-auto">
                        <i class="fas fa-award"></i>
                    </div>
                    <h4 id="modal-milestone-label">Milestone 1</h4>
                    <div>
                        <span id="modal-quarter-badge" class="quarter-badge quarter-badge-1">Q1</span>
                    </div>
                </div>
                
                <p>You are about to award a milestone bonus to:</p>
                <h5 id="modal-employee-name" class="mb-3">Employee Name</h5>
                
                <div class="alert alert-info">
                    <p class="mb-0">
                        <i class="fas fa-info-circle me-2"></i> 
                        This will award <span id="modal-bonus-points" class="fw-bold">1000</span> bonus points.
                    </p>
                    <p class="mb-0 mt-2">This action cannot be undone.</p>
                </div>
                
                <div class="mb-3">
                    <label for="modal-notes" class="form-label">Notes (optional)</label>
                    <textarea id="modal-notes" class="form-control" rows="3"></textarea>
                </div>
                
                <input type="hidden" id="modal-employee-id">
                <input type="hidden" id="modal-milestone-level">
                <input type="hidden" id="modal-quarter">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" id="confirmAwardBtn">
                    <i class="fas fa-trophy me-1"></i> Award Milestone
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Search functionality
    document.getElementById('search-employee')?.addEventListener('input', function() {
        const searchTerm = this.value.toLowerCase();
        document.querySelectorAll('.employee-milestone-row').forEach(row => {
            row.style.display = row.dataset.name.includes(searchTerm) ? 'block' : 'none';
        });
    });
    
    // Award milestone modal
    const modal = new bootstrap.Modal(document.getElementById('awardMilestoneModal'));
    
    document.querySelectorAll('.award-milestone-btn').forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.preventDefault();
            document.getElementById('modal-employee-name').textContent = this.dataset.employeeName;
            document.getElementById('modal-employee-id').value = this.dataset.employeeId;
            document.getElementById('modal-milestone-level').value = this.dataset.milestoneLevel;
            document.getElementById('modal-quarter').value = this.dataset.quarter;
            document.getElementById('modal-bonus-points').textContent = this.dataset.bonusPoints;
            
            const qNum = this.dataset.quarter.substring(3);
            document.getElementById('modal-quarter-badge').className = `quarter-badge quarter-badge-${qNum}`;
            document.getElementById('modal-quarter-badge').textContent = `Q${qNum}`;
            document.getElementById('modal-milestone-badge').className = `milestone-badge milestone-badge-${this.dataset.milestoneLevel} mx-auto`;
            
            modal.show();
        });
    });
    
    // Confirm award
    document.getElementById('confirmAwardBtn')?.addEventListener('click', function() {
        const data = {
            employee_id: document.getElementById('modal-employee-id').value,
            milestone_level: document.getElementById('modal-milestone-level').value,
            quarter: document.getElementById('modal-quarter').value,
            notes: document.getElementById('modal-notes').value
        };
        
        fetch('/central/api/award-milestone', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        })
        .then(res => res.json())
        .then(result => {
            modal.hide();
            if (result.success) {
                const alert = document.createElement('div');
                alert.className = 'alert alert-success alert-dismissible fade show';
                alert.innerHTML = `<strong>Success!</strong> ${result.message}<button type="button" class="btn-close" data-bs-dismiss="alert"></button>`;
                document.querySelector('.container-fluid').insertBefore(alert, document.querySelector('.container-fluid').firstChild);
                setTimeout(() => window.location.reload(), 2000);
            } else {
                const alert = document.createElement('div');
                alert.className = 'alert alert-danger alert-dismissible fade show';
                alert.innerHTML = `<strong>Error!</strong> ${result.error}<button type="button" class="btn-close" data-bs-dismiss="alert"></button>`;
                document.querySelector('.container-fluid').insertBefore(alert, document.querySelector('.container-fluid').firstChild);
            }
        })
        .catch(error => {
            modal.hide();
            console.error('Error:', error);
            const alert = document.createElement('div');
            alert.className = 'alert alert-danger alert-dismissible fade show';
            alert.innerHTML = `<strong>Error!</strong> Failed to award milestone<button type="button" class="btn-close" data-bs-dismiss="alert"></button>`;
            document.querySelector('.container-fluid').insertBefore(alert, document.querySelector('.container-fluid').firstChild);
        });
    });
});
</script>
{% endblock %}