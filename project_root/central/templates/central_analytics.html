{% extends "base2.html" %}

{% block title %}Central Analytics - Dashboard{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">
                        <i class="fas fa-chart-bar"></i> Dashboard Analytics
                    </h4>
                </div>
                <div class="card-body">
                    <p class="text-muted">
                        Comprehensive analytics view showing employee performance, points distribution, and category breakdown across all departments.
                    </p>
                    
                    <!-- Filter Section -->
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label for="quarterFilter" class="form-label">Quarter</label>
                            <select class="form-select" id="quarterFilter">
                                <option value="">All Time</option>
                                {% if quarters %}
                                    {% for quarter in quarters %}
                                    <option value="{{ quarter.name }}" {% if quarter.name == selected_quarter %}selected{% endif %}>
                                        {{ quarter.name }}
                                    </option>
                                    {% endfor %}
                                {% endif %}
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="yearFilter" class="form-label">Year</label>
                            <select class="form-select" id="yearFilter">
                                <option value="">Current Year</option>
                                {% if available_years %}
                                    {% for year in available_years %}
                                    <option value="{{ year }}" {% if year|string == selected_year %}selected{% endif %}>
                                        FY {{ year }}-{{ year + 1 }}
                                    </option>
                                    {% endfor %}
                                {% endif %}
                            </select>
                        </div>
                        <div class="col-md-4 d-flex align-items-end">
                            <button class="btn btn-primary" onclick="applyFilters()">
                                <i class="fas fa-filter"></i> Apply Filters
                            </button>
                            <button class="btn btn-secondary ms-2" onclick="clearFilters()">
                                <i class="fas fa-times"></i> Clear
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Summary Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h6 class="text-muted">Total Employees</h6>
                    <h2 class="text-primary">{{ employees|length }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h6 class="text-muted">Total Points</h6>
                    <h2 class="text-success">{{ employees|sum(attribute='points_data.total_points')|int }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h6 class="text-muted">Bonus Points</h6>
                    <h2 class="text-warning">{{ employees|sum(attribute='points_data.bonus_points')|int }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h6 class="text-muted">Analysis Period</h6>
                    <h2 class="text-info">{{ analysis_label }}</h2>
                </div>
            </div>
        </div>
    </div>

    <!-- Employee Analytics Table -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-users"></i> Employee Performance Analytics
                    </h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover" id="analyticsTable">
                            <thead>
                                <tr>
                                    <th>Rank</th>
                                    <th>Name</th>
                                    <th>Department</th>
                                    <th>Grade</th>
                                    <th>Role</th>
                                    <th>Total Points</th>
                                    <th>Bonus Points</th>
                                    <th>Regular Points</th>
                                    <th>Utilization %</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for emp in employees %}
                                <tr>
                                    <td>{{ loop.index }}</td>
                                    <td>{{ emp.name }}</td>
                                    <td>{{ emp.department }}</td>
                                    <td><span class="badge bg-info">{{ emp.grade }}</span></td>
                                    <td><span class="badge bg-secondary">{{ emp.role }}</span></td>
                                    <td><strong>{{ emp.points_data.total_points }}</strong></td>
                                    <td class="text-warning">{{ emp.points_data.bonus_points }}</td>
                                    <td class="text-success">{{ emp.points_data.regular_points }}</td>
                                    <td>
                                        {% if emp.points_data.avg_utilization %}
                                        <span class="badge {% if emp.points_data.avg_utilization >= 80 %}bg-success{% elif emp.points_data.avg_utilization >= 60 %}bg-warning{% else %}bg-danger{% endif %}">
                                            {{ emp.points_data.avg_utilization }}%
                                        </span>
                                        {% else %}
                                        <span class="badge bg-secondary">N/A</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <button class="btn btn-sm btn-primary" onclick="viewDetails('{{ emp.id }}')">
                                            <i class="fas fa-eye"></i> Details
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Category Breakdown -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-tags"></i> Category Distribution
                    </h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-bordered" id="categoryTable">
                            <thead>
                                <tr>
                                    <th>Category</th>
                                    <th>Total Points</th>
                                    <th>Employees</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% set category_totals = {} %}
                                {% for emp in employees %}
                                    {% for cat_id, cat_data in emp.points_data.points_by_category.items() %}
                                        {% if cat_data.name not in category_totals %}
                                            {% set _ = category_totals.update({cat_data.name: {'points': 0, 'count': 0}}) %}
                                        {% endif %}
                                        {% set _ = category_totals[cat_data.name].update({'points': category_totals[cat_data.name].points + cat_data.points, 'count': category_totals[cat_data.name].count + 1}) %}
                                    {% endfor %}
                                {% endfor %}
                                
                                {% for cat_name, cat_info in category_totals.items()|sort(attribute='1.points', reverse=True) %}
                                <tr>
                                    <td>{{ cat_name }}</td>
                                    <td><strong>{{ cat_info.points }}</strong></td>
                                    <td>{{ cat_info.count }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
$(document).ready(function() {
    $('#analyticsTable').DataTable({
        order: [[5, 'desc']],
        pageLength: 25,
        dom: 'Bfrtip',
        buttons: ['copy', 'csv', 'excel', 'pdf']
    });
    
    $('#categoryTable').DataTable({
        order: [[1, 'desc']],
        pageLength: 10
    });
});

function applyFilters() {
    const quarter = document.getElementById('quarterFilter').value;
    const year = document.getElementById('yearFilter').value;
    
    let url = '{{ url_for("central.analytics") }}?';
    if (quarter) url += 'quarter=' + quarter + '&';
    if (year) url += 'year=' + year;
    
    window.location.href = url;
}

function clearFilters() {
    window.location.href = '{{ url_for("central.analytics") }}';
}

function viewDetails(empId) {
    window.location.href = '{{ url_for("central.dashboard") }}?employee=' + empId;
}
</script>
{% endblock %}
