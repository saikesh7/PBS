<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Central Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('central.static', filename='central.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        html { scroll-behavior: auto !important; }
        #all, #exportable { scroll-margin-top: 0 !important; }
        .tab-pane, .tab-content { scroll-margin-top: 0 !important; }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <img src="https://www.prowesssoft.com/wp-content/uploads/2023/06/Prowess_soft_logo1.png" alt="Prowess Soft Logo" class="sidebar-logo">
        </div>
        <div class="pt-2 pb-2 ps-3 pe-3 text-white">
            <div>Dashboard</div>
        </div>
        <div class="sidebar-nav">
            <a href="#all" class="sidebar-nav-item active" data-tab="all">
                <div><i class="fas fa-users"></i><span>All Employees</span></div>
            </a>
            <a href="/central/export-data" class="sidebar-nav-item">
                <div><i class="fas fa-file-export"></i><span>Export Data</span></div>
            </a>
            <div class="sidebar-divider"></div>
            <a href="/central/config" class="sidebar-nav-item">
                <div><i class="fas fa-cog"></i><span>Configure Rewards</span></div>
            </a>
            <a href="/central/leaderboard" class="sidebar-nav-item">
                <div><i class="fas fa-trophy"></i><span>Leaderboard</span></div>
            </a>
            
            <a href="#" class="sidebar-nav-item" data-bs-toggle="modal" data-bs-target="#helpModal">
                <div><i class="fas fa-question-circle"></i><span>Help</span></div>
            </a>
            
            <div class="sidebar-divider"></div>
            
            <!-- Dashboard Switcher -->
            <div class="px-3 py-2">
                <small class="text-white-50 text-uppercase" style="font-size: 11px;">
                    <i class="fas fa-th-large me-1"></i> Switch Dashboard
                </small>
            </div>
            
            <!-- ALWAYS show Employee View as first option -->
            <a href="{{ url_for('employee_dashboard.dashboard') }}" class="sidebar-nav-item">
                <div><i class="fas fa-user"></i><span>Employee View</span></div>
            </a>
            
            <!-- Show other dashboards if user has access -->
            {% if user and user.dashboard_access %}
                {% set dashboard_list = user.dashboard_access if user.dashboard_access is iterable and user.dashboard_access is not string else [user.dashboard_access] %}
                
                {% for dashboard in dashboard_list %}
                    {# Don't show current dashboard (central) in switcher #}
                    {% if dashboard == 'pmo_up' %}
                    <a href="{{ url_for('pmo.updater_dashboard') }}" class="sidebar-nav-item">
                        <div><i class="fas fa-tasks"></i><span>PMO Updater</span></div>
                    </a>
                    {% elif dashboard == 'pmo_va' %}
                    <a href="{{ url_for('pmo.validator_dashboard') }}" class="sidebar-nav-item">
                        <div><i class="fas fa-clipboard-check"></i><span>PMO Validator</span></div>
                    </a>
                    {% elif dashboard == 'pm_arch' or dashboard == 'pmarch' %}
                    <a href="{{ url_for('pm_arch.dashboard') }}" class="sidebar-nav-item">
                        <div><i class=""fting-compass"></i><span>PM/Arch Dashboard</span></div>
                    </a>
                    {% elif dashboard == 'pm' %}
                    <a href="{{ url_for('pm.dashboard') }}" class="sidebar-nav-item">
                        <div><i class="fas fa-project-diagram"></i><span>PM Dashboard</span></div>
                    </a>
                    {% elif dashboard == 'ta_up' %}
                    <a href="{{ url_for('ta.updater_dashboard') }}" class="sidebar-nav-item">
                        <div><i class="fas fa-user-plus"></i><span>TA Updater</span></div>
                    </a>
                    {% elif dashboard == 'ta_va' %}
                    <a href="{{ url_for('ta.validator_dashboard') }}" class="sidebar-nav-item">
                        <div><i class="fas fa-user-check"></i><span>TA Validator</span></div>
                    </a>
                    {% elif dashboard == 'ld' %}
                    <a href="{{ url_for('ld.dashboard') }}" class="sidebar-nav-item">
                        <div><i class="fas fa-graduation-cap"></i><span>L&D Dashboard</span></div>
                    </a>
                    {% elif dashboard == 'ld_up' %}
                    <a href="{{ url_for('ld.updater_dashboard') }}" class="sidebar-nav-item">
                        <div><i class="fas fa-user-edit"></i><span>L&D Updater</span></div>
                    </a>
                    {% elif dashboard == 'ld_va' %}
                    <a href="{{ url_for('ld.validator_dashboard') }}" class="sidebar-nav-item">
                        <div><i class="fas fa-book-reader"></i><span>L&D Validator</span></div>
                    </a>
                    {% elif dashboard == 'hr_up' %}
                    <a href="{{ url_for('hr_roles.updater_dashboard') }}" class="sidebar-nav-item">
                        <div><i class="fas fa-user-edit"></i><span>HR Updater</span></div>
                    </a>
                    {% elif dashboard == 'hr_va' %}
                    <a href="{{ url_for('hr_roles.validator_dashboard') }}" class="sidebar-nav-item">
                        <div><i class="fas fa-user-check"></i><span>HR Validator</span></div>
                    </a>
                    {% elif dashboard == 'hr' %}
                    <a href="{{ url_for('hr_analytics.pbs_analytics') }}" class="sidebar-nav-item">
                        <div><i class="fas fa-chart-line"></i><span>HR Analytics</span></div>
                    </a>
                    {% elif dashboard == 'marketing' %}
                    <a href="{{ url_for('marketing_dashboard.dashboard') }}" class="sidebar-nav-item">
                        <div><i class="fas fa-bullhorn"></i><span>Marketing Dashboard</span></div>
                    </a>
                    {% elif dashboard == 'presales' %}
                    <a href="{{ url_for('presales.dashboard') }}" class="sidebar-nav-item">
                        <div><i class="fas fa-handshake"></i><span>Presales Dashboard</span></div>
                    </a>
                    {% elif dashboard == 'dp' %}
                    <a href="{{ url_for('dp.dashboard') }}" class="sidebar-nav-item">
                        <div><i class="fas fa-hands-helping"></i><span>DP Dashboard</span></div>
                    </a>
                    {% endif %}
                {% endfor %}
            {% endif %}
            
            <div class="sidebar-divider"></div>
            <a href="{{ url_for('auth.logout') }}" class="sidebar-nav-item">
                <div><i class="fas fa-sign-out-alt"></i><span>Logout</span></div>
            </a>""
        </div>
    </div>

    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <!-- Topbar -->
    <div class="topbar">
        <div class="topbar-left">
            <button class="sidebar-toggle d-lg-none" id="sidebarToggle">
                <i class="fas fa-bars"></i>
            </button>
            <div class="topbar-icon"><i class="fas fa-tachometer-alt"></i></div>
            <div class="topbar-info">
                <div class="topbar-title">Central Dashboard</div>
                <div class="topbar-subtitle">
                    <span class="topbar-badge bg-primary">Admin View</span>
                </div>
            </div>
        </div>
        <div class="topbar-center">
            <h6 class="topbar-heading">
                <i class="fas fa-award me-2" style="color: gold;"></i>
                <span>POINTS BASED SYSTEM</span>
            </h6>
        </div>
    </div>

    <!-- Main Content -->
    <div class="content-wrapper">
        <div class="dashboard-header">
            <h4 class="mb-0">Central Dashboard - {{ current_quarter }}</h4>
            <div>
                <button class="btn btn-outline-success" onclick="window.print()">
                    <i class="fas fa-print"></i> Print
                </button>
            </div>
        </div>

        <!-- Tab Content -->
        <div class="tab-content" id="employeeTabsContent">
            <!-- Export: Date Range + Button -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-file-export text-success me-2"></i>Export Data with Date Range
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row g-3 align-items-end">
                        <div class="col-md-3">
                            <label for="exportStartDate" class="form-label">Start Date</label>
                            <input type="date" class="form-control" id="exportStartDate" required>
                        </div>
                        <div class="col-md-3">
                            <label for="exportEndDate" class="form-label">End Date</label>
                            <input type="date" class="form-control" id="exportEndDate" required>
                        </div>
                        <div class="col-md-6 d-flex justify-content-md-start justify-content-end gap-2">
                            <button type="button" id="exportToExcel" class="btn btn-success">
                                <i class="fas fa-file-excel me-2"></i> Export to Excel
                            </button>
                            <button type="button" id="sendBonusAnalysis" class="btn btn-primary">
                                <i class="fas fa-paper-plane me-2"></i> Send Bonus Analysis
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- All Employees Tab -->
            <div class="tab-pane fade show active" id="all" role="tabpanel">
                <div class="card mb-4 card-shadow">
                    <div class="card-header blue-gradient">
                        <div class="d-flex align-items-center justify-content-between">
                            <div>
                                <i class="fas fa-users me-2"></i>
                                <span class="fw-bold">All Employees ({{ employee_data|length }})</span>
                            </div>
                            <div>
                                <div class="input-group input-group-sm">
                                    <input type="text" class="form-control" id="employeeSearch" placeholder="Search employees...">
                                    <span class="input-group-text"><i class="fas fa-search"></i></span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover align-middle mb-0" id="employeesTable">
                                <thead class="thead-dark">
                                    <tr>
                                        <th class="ps-3 sortable" data-sort="name">
                                            <div class="d-flex align-items-center">
                                                <span>Employee</span>
                                                <i class="fas fa-sort ms-1 text-muted"></i>
                                            </div>
                                        </th>
                                        <th class="sortable" data-sort="department">
                                            <div class="d-flex align-items-center">
                                                <span>Department</span>
                                                <i class="fas fa-sort ms-1 text-muted"></i>
                                            </div>
                                        </th>
                                        <th class="sortable" data-sort="grade">
                                            <div class="d-flex align-items-center">
                                                <span>Grade</span>
                                                <i class="fas fa-sort ms-1 text-muted"></i>
                                            </div>
                                        </th>
                                        <th class="sortable" data-sort="points">
                                            <div class="d-flex align-items-center">
                                                <span>Progress</span>
                                                <i class="fas fa-sort ms-1 text-muted"></i>
                                            </div>
                                        </th>
                                        <th>Points by Quarter</th>
                                        <th>Status/Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for employee in employee_data %}
                                    <tr class="employee-row {% if employee.is_eligible %}bg-light-success{% else %}bg-light-danger{% endif %}"
                                        data-department="{{ employee.department }}"
                                        data-grade="{{ employee.grade }}"
                                        data-name="{{ employee.name }}"
                                        data-points="{{ employee.total_points }}"
                                        data-eligibility="{% if employee.bonus_already_awarded %}awarded{% elif employee.is_eligible %}eligible{% else %}not-eligible{% endif %}">
                                        
                                        <td class="ps-3">
                                            <div class="d-flex align-items-center">
                                                <div class="avatar-circle me-2 {% if employee.is_eligible %}border-success{% else %}border-danger{% endif %}">
                                                    {{ employee.name[:1] }}
                                                </div>
                                                <div>
                                                    <div class="fw-bold">{{ employee.name }}</div>
                                                    <div class="text-muted small">{{ employee.email }}</div>
                                                </div>
                                            </div>
                                        </td>

                                        <td><span class="department-badge">{{ employee.department }}</span></td>
                                        <td><span class="badge bg-secondary">{{ employee.grade }}</span></td>

                                        <td>
                                            <div class="progress-container">
                                                <div class="d-flex justify-content-between mb-1">
                                                    <span class="small">Yearly Target</span>
                                                    <span class="small fw-bold {% if employee.yearly_progress >= 100 %}text-success{% endif %}">
                                                        {{ employee.yearly_progress }}%
                                                    </span>
                                                </div>
                                                <div class="progress mb-2" style="height: 8px;">
                                                    <div class="progress-bar rounded {{ 'bg-success' if employee.yearly_progress >= 100 else 'progress-striped' }}"
                                                        style="width: {{ employee.yearly_progress }}%;">
                                                    </div>
                                                </div>
                                                <div class="d-flex justify-content-between small">
                                                    <span>{{ employee.total_points }} / {{ employee.yearly_target }}</span>
                                                    {% if employee.bonus_points > 0 %}
                                                    <span class="text-primary">+{{ employee.bonus_points }} bonus</span>
                                                    {% endif %}
                                                </div>

                                                <div class="d-flex justify-content-between mb-1 mt-2">
                                                    <span class="small">Current Quarter</span>
                                                    <span class="small fw-bold {% if employee.quarterly_progress >= 100 %}text-success{% endif %}">
                                                        {{ employee.quarterly_progress }}%
                                                    </span>
                                                </div>
                                                <div class="progress" style="height: 8px;">
                                                    <div class="progress-bar rounded {{ 'bg-success' if employee.quarterly_progress >= 100 else '' }}"
                                                        style="width: {{ employee.quarterly_progress }}%;">
                                                    </div>
                                                </div>

                                                {% if employee.billable_utilization > 0 %}
                                                <div class="utilization-badge mt-2">
                                                    <i class="fas fa-chart-pie me-1"></i> {{ employee.billable_utilization }}%
                                                </div>
                                                {% endif %}
                                            </div>
                                        </td>

                                        <td>
                                            <div class="quarters-container">
                                                {% for qtr, qtr_data in employee.all_quarters.items() %}
                                                <div class="quarter-item {% if qtr == current_quarter %}current-quarter{% endif %}">
                                                    <div class="d-flex justify-content-between">
                                                        <span class="quarter-label">{{ qtr }}</span>
                                                        <span class="quarter-points">
                                                            <span class="fw-bold">{{ qtr_data.regular }}</span>
                                                            {% if qtr_data.bonus > 0 %}
                                                            <span class="text-primary">(+{{ qtr_data.bonus }})</span>
                                                            {% endif %}
                                                        </span>
                                                    </div>
                                                    <div class="progress quarter-progress" style="height: 5px;">
                                                        <div class="progress-bar {% if qtr == current_quarter %}bg-highlight{% endif %}"
                                                            style="width: {{ (qtr_data.regular / employee.quarterly_target * 100)|round if employee.quarterly_target > 0 else 0 }}%;">
                                                        </div>
                                                    </div>
                                                </div>
                                                {% endfor %}

                                                <div class="categories-popover" data-bs-toggle="popover" data-bs-placement="left"
                                                    data-bs-trigger="hover" data-bs-html="true" data-bs-title="Category Breakdown by Quarter"
                                                    data-bs-content="{% for qtr, categories in employee.categories_by_quarter.items() %}{% if categories %}<div class='quarter-category-section'><strong>{{ qtr }}</strong>{% for category_id, category_data in categories.items() %}<div class='category-item'><span>{{ category_data.name }}</span><span class='category-points'>{{ category_data.points }}</span></div>{% endfor %}</div>{% endif %}{% endfor %}">
                                                    <i class="fas fa-tags"></i> Categories
                                                </div>
                                            </div>
                                        </td>

                                        <td>
                                            <div class="status-container">
                                                {% if employee.bonus_already_awarded %}
                                                <div class="status-badge awarded">
                                                    <i class="fas fa-check-circle"></i> Bonus Awarded
                                                </div>
                                                {% elif employee.is_eligible %}
                                                <div class="status-badge eligible">
                                                    <div class="d-flex justify-content-between align-items-center">
                                                        <span><i class="fas fa-check-circle"></i> Eligible</span>
                                                        <span class="fw-bold">{{ employee.potential_bonus }}</span>
                                                    </div>
                                                </div>
                                                <button class="btn btn-sm btn-success award-bonus-btn w-100 mt-2"
                                                    data-employee-id="{{ employee.id }}"
                                                    data-employee-name="{{ employee.name }}"
                                                    data-potential-bonus="{{ employee.potential_bonus }}"
                                                    data-milestones="{% for milestone in employee.achieved_milestones %}{{ milestone.name }}{% if not loop.last %}, {% endif %}{% endfor %}">
                                                    <i class="fas fa-award me-1"></i> Award Bonus
                                                </button>
                                                {% else %}
                                                <div class="status-badge not-eligible" data-bs-toggle="tooltip" title="{{ employee.eligibility_reason }}">
                                                    <i class="fas fa-times-circle"></i> Not Eligible
                                                </div>
                                                {% endif %}

                                                <button class="btn btn-sm btn-outline-primary w-100 mt-2 details-button"
                                                    data-employee-id="{{ employee.id }}">
                                                    <i class="fas fa-info-circle me-1"></i> Details
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="card-footer">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <span class="text-muted small">Showing <span id="pageRange">1-25</span> of <span id="totalRows">{{ employee_data|length }}</span> employees</span>
                            </div>
                            <div class="pagination-container" id="tablePagination"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Exportable Tab -->
            <div class="tab-pane fade" id="exportable" role="tabpanel">
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-file-export text-success me-2"></i>
                            Export Data with Date Range
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3 align-items-end">
                            <div class="col-md-3">
                                <label for="exportStartDate" class="form-label">Start Date</label>
                                <input type="date" class="form-control" id="exportStartDate" required>
                            </div>
                            <div class="col-md-3">
                                <label for="exportEndDate" class="form-label">End Date</label>
                                <input type="date" class="form-control" id="exportEndDate" required>
                            </div>
                            <div class="col-md-6">
                                <button type="button" id="exportToExcel" class="btn btn-success">
                                    <i class="fas fa-file-excel me-2"></i> Export to Excel
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Employee Details Modal -->
        <div class="modal fade" id="employeeDetailsModal" tabindex="-1">
            <div class="modal-dialog" style="max-width: 900px;">
                <div class="modal-content" style="border-radius: 14px; border: none; box-shadow: 0 8px 24px rgba(0,0,0,0.15);">
                    <div class="modal-header" style="background: #0f3c78; color: white; border-radius: 14px 14px 0 0; padding: 20px 24px; border: none;">
                        <h5 class="modal-title" style="font-weight: 600; font-size: 1.25rem;">
                            <i class="fas fa-user-circle me-2"></i>Employee Details
                        </h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body" style="padding: 0; max-height: 75vh; overflow-y: auto;">
                        <div id="employeeDetailsContent">
                            <div class="text-center py-5">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Award Bonus Modal -->
        <div class="modal fade" id="awardBonusModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Award Bonus Points</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <form id="awardBonusForm" method="POST">
                        <div class="modal-body">
                            <div class="mb-3">
                                <label for="employeeName" class="form-label">Employee</label>
                                <input type="text" class="form-control" id="employeeName" readonly>
                            </div>
                            <div class="mb-3">
                                <label for="milestones" class="form-label">Milestones Achieved</label>
                                <input type="text" class="form-control" id="milestones" name="milestones" readonly>
                            </div>
                            <div class="mb-3">
                                <label for="bonusPoints" class="form-label">Bonus Points</label>
                                <input type="number" class="form-control" id="bonusPoints" name="bonus_points" readonly>
                            </div>
                            <div class="mb-3">
                                <label for="bonusNotes" class="form-label">Notes</label>
                                <textarea class="form-control" id="bonusNotes" name="notes" rows="3"></textarea>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="submit" class="btn btn-primary">Award Bonus</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Help Modal -->
        <div class="modal fade" id="helpModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Dashboard Help</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <h5>Eligibility Requirements</h5>
                        <ul>
                            <li>Employees must reach their quarterly target using regular points</li>
                            <li>Maintain minimum billable utilization (averaged across the quarter)</li>
                            <li>Only one bonus award per quarter</li>
                            <li>Total bonus points for the year cannot exceed {{ config.yearly_bonus_limit }} points</li>
                        </ul>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Notes Modal -->
        <div class="modal fade" id="notesModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Notes</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div id="notesModalContent" style="white-space: pre-wrap;"></div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            if (history.scrollRestoration) history.scrollRestoration = 'manual';
            window.scrollTo(0, 0);

            initializeSidebar();
            initializeTabNavigation();
            initializeTooltipsAndPopovers();
            initializeTableFeatures();
            initializeAwardBonus();
            initializeDetailsButton();
            initializeExport();
            initializePagination();
        });

        // Sidebar
        function initializeSidebar() {
            const sidebar = document.getElementById('sidebar');
            const toggle = document.getElementById('sidebarToggle');
            const overlay = document.getElementById('sidebarOverlay');

            toggle?.addEventListener('click', () => {
                sidebar.classList.toggle('show');
                overlay.classList.toggle('show');
            });

            overlay?.addEventListener('click', () => {
                sidebar.classList.remove('show');
                overlay.classList.remove('show');
            });
        }

        // Tab Navigation
        function initializeTabNavigation() {
            const navItems = document.querySelectorAll('.sidebar-nav-item[data-tab]');
            const tabPanes = document.querySelectorAll('.tab-pane');

            function activateTab(tabId) {
                navItems.forEach(link => link.classList.remove('active'));
                tabPanes.forEach(pane => pane.classList.remove('active', 'show'));

                const targetLink = document.querySelector(`[data-tab="${tabId}"]`);
                const targetPane = document.getElementById(tabId);

                targetLink?.classList.add('active');
                targetPane?.classList.add('active', 'show');
                window.scrollTo(0, 0);
            }

            const urlHash = window.location.hash.substring(1);
            activateTab(urlHash && (urlHash === 'all' || urlHash === 'exportable') ? urlHash : 'all');

            navItems.forEach(item => {
                item.addEventListener('click', function(e) {
                    e.preventDefault();
                    const tabId = this.getAttribute('data-tab');
                    window.location.hash = tabId;
                    activateTab(tabId);
                });
            });
        }

        // Tooltips and Popovers
        function initializeTooltipsAndPopovers() {
            document.querySelectorAll('[data-bs-toggle="tooltip"]').forEach(el => new bootstrap.Tooltip(el));
            document.querySelectorAll('[data-bs-toggle="popover"]').forEach(el => {
                new bootstrap.Popover(el, { html: true, container: 'body', trigger: 'hover focus', sanitize: false });
            });
        }

        // Table Features (Search, Sort)
        function initializeTableFeatures() {
            const table = document.getElementById('employeesTable');
            const searchInput = document.getElementById('employeeSearch');

            // Search
            searchInput?.addEventListener('input', function() {
                const term = this.value.toLowerCase();
                const rows = table.querySelectorAll('tbody tr');

                rows.forEach(row => {
                    const name = row.getAttribute('data-name').toLowerCase();
                    const match = name.includes(term);
                    
                    if (match) {
                        row.removeAttribute('data-filtered');
                    } else {
                        row.setAttribute('data-filtered', 'true');
                    }
                });

                // Reset to page 1 when filtering
                currentPage = 1;
                updatePagination();
            });

            // Sort
            document.querySelectorAll('.sortable').forEach(th => {
                th.addEventListener('click', function() {
                    const column = this.getAttribute('data-sort');
                    const direction = this.classList.contains('asc') ? 'desc' : 'asc';
                    
                    document.querySelectorAll('.sortable').forEach(h => h.classList.remove('asc', 'desc'));
                    this.classList.add(direction);

                    sortTable(column, direction);
                });
            });
        }

        function sortTable(column, direction) {
            const tbody = document.querySelector('#employeesTable tbody');
            const rows = Array.from(tbody.querySelectorAll('tr'));

            rows.sort((a, b) => {
                const aVal = a.getAttribute(`data-${column}`);
                const bVal = b.getAttribute(`data-${column}`);

                if (column === 'points') {
                    return direction === 'asc' ? parseInt(aVal) - parseInt(bVal) : parseInt(bVal) - parseInt(aVal);
                }
                return direction === 'asc' ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
            });

            rows.forEach(row => tbody.appendChild(row));
            
            // Reset to page 1 when sorting
            currentPage = 1;
            updatePagination();
        }

        // Award Bonus
        function initializeAwardBonus() {
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('award-bonus-btn') || e.target.parentElement.classList.contains('award-bonus-btn')) {
                    const btn = e.target.classList.contains('award-bonus-btn') ? e.target : e.target.parentElement;
                    const employeeId = btn.getAttribute('data-employee-id');
                    const employeeName = btn.getAttribute('data-employee-name');
                    const potentialBonus = btn.getAttribute('data-potential-bonus');
                    const milestones = btn.getAttribute('data-milestones');

                    document.getElementById('employeeName').value = employeeName;
                    document.getElementById('milestones').value = milestones || 'Quarterly Bonus';
                    document.getElementById('bonusPoints').value = potentialBonus;
                    document.getElementById('awardBonusForm').setAttribute('action', `/central/award-bonus/${employeeId}`);

                    new bootstrap.Modal(document.getElementById('awardBonusModal')).show();
                }
            });

            document.getElementById('awardBonusForm').addEventListener('submit', function(e) {
                e.preventDefault();
                const formData = new FormData(this);
                const url = this.getAttribute('action');

                fetch(url, {
                    method: 'POST',
                    body: new URLSearchParams(formData)
                })
                .then(res => res.json())
                .then(data => {
                    bootstrap.Modal.getInstance(document.getElementById('awardBonusModal')).hide();
                    showAlert('success', data.message);
                    setTimeout(() => window.location.reload(), 2000);
                })
                .catch(error => showAlert('danger', 'Error: ' + error.message));
            });
        }

        // Details Button
        let currentEmployeeId = null;
        let currentSelectedQuarter = '{{ current_quarter }}';
        
        function initializeDetailsButton() {
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('details-button') || e.target.parentElement.classList.contains('details-button')) {
                    const btn = e.target.classList.contains('details-button') ? e.target : e.target.parentElement;
                    currentEmployeeId = btn.getAttribute('data-employee-id');
                    currentSelectedQuarter = '{{ current_quarter }}';

                    document.getElementById('employeeDetailsContent').innerHTML = '<div class="text-center py-5"><div class="spinner-border text-primary"></div></div>';
                    new bootstrap.Modal(document.getElementById('employeeDetailsModal')).show();

                    loadEmployeeDetails(currentEmployeeId, currentSelectedQuarter);
                }
            });
        }
        
        function loadEmployeeDetails(employeeId, quarter) {
            fetch(`/central/employee-details/${employeeId}?quarter=${quarter}`)
                .then(res => res.json())
                .then(data => {
                    document.getElementById('employeeDetailsContent').innerHTML = buildDetailsHTML(data);
                    initializeQuarterTabs();
                })
                .catch(error => {
                    document.getElementById('employeeDetailsContent').innerHTML = `<div class="alert alert-danger m-4">Error: ${error.message}</div>`;
                });
        }
        
        function initializeQuarterTabs() {
            document.querySelectorAll('.quarter-tab-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const quarter = this.getAttribute('data-quarter');
                    currentSelectedQuarter = quarter;
                    
                    // Update active state
                    document.querySelectorAll('.quarter-tab-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    
                    // Show loading in content area only
                    const contentArea = document.getElementById('quarterContentArea');
                    contentArea.innerHTML = '<div class="text-center py-4"><div class="spinner-border spinner-border-sm text-primary"></div></div>';
                    
                    // Load new quarter data
                    fetch(`/central/employee-details/${currentEmployeeId}?quarter=${quarter}`)
                        .then(res => res.json())
                        .then(data => {
                            contentArea.innerHTML = buildQuarterContent(data);
                        })
                        .catch(error => {
                            contentArea.innerHTML = `<div class="alert alert-danger">Error: ${error.message}</div>`;
                        });
                });
            });
        }

        function buildDetailsHTML(data) {
            const quarters = ['Q1-2025', 'Q2-2025', 'Q3-2025', 'Q4-2025'];
            const currentQuarter = data.quarter;
            
            let html = `
                <!-- Employee Header -->
                <div style="padding: 24px 32px 20px 32px; background: white;">
                    <div style="margin-bottom: 12px;">
                        <h3 style="margin: 0 0 4px 0; font-weight: 700; color: #1a1a1a; font-size: 1.75rem;">${data.employee.name}</h3>
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <span style="background: #e3f2fd; color: #1976d2; padding: 4px 14px; border-radius: 16px; font-size: 0.85rem; font-weight: 600;">${data.employee.grade}</span>
                            <span style="color: #6c757d; font-size: 0.9rem;">${data.employee.email}</span>
                        </div>
                    </div>
                </div>
                
                <!-- Quarter Tabs -->
                <div style="padding: 16px 32px 20px 32px; background: white; border-bottom: 1px solid #e9ecef;">
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        ${quarters.map(q => `
                            <button class="quarter-tab-btn ${q === currentQuarter ? 'active' : ''}" 
                                    data-quarter="${q}"
                                    style="padding: 10px 24px; border: none; border-radius: 24px; background: ${q === currentQuarter ? '#0f3c78' : '#f0f0f0'}; color: ${q === currentQuarter ? 'white' : '#666'}; font-weight: 600; font-size: 0.9rem; cursor: pointer; transition: all 0.2s ease;">
                                ${q}
                            </button>
                        `).join('')}
                    </div>
                </div>
                
                <!-- Quarter Content Area -->
                <div id="quarterContentArea" style="padding: 24px 32px; background: #fafbfc;">
                    ${buildQuarterContent(data)}
                </div>
            `;
            return html;
        }
        
        function buildQuarterContent(data) {
            return `
                <!-- Summary Cards Row - Clean Simple Design -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 24px;">
                    <!-- Regular Points Card -->
                    <div style="background: white; border-radius: 12px; padding: 24px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                        <div style="color: #6c757d; font-size: 0.9rem; font-weight: 500; margin-bottom: 8px;">Regular Points</div>
                        <div style="font-size: 2.5rem; font-weight: 700; color: #1a1a1a;">${data.total_regular_points}</div>
                    </div>
                    
                    <!-- Bonus Points Card -->
                    <div style="background: white; border-radius: 12px; padding: 24px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                        <div style="color: #6c757d; font-size: 0.9rem; font-weight: 500; margin-bottom: 8px;">Bonus Points</div>
                        <div style="font-size: 2.5rem; font-weight: 700; color: #0f3c78;">${data.total_bonus_points}</div>
                    </div>
                </div>
                
                <!-- Utilization & Yearly Bonus - Two Column Layout -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 24px;">
                    <!-- Left Card: Average Utilization -->
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px; padding: 32px; text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                        <div style="color: rgba(255,255,255,0.95); font-size: 0.95rem; font-weight: 600; margin-bottom: 12px;">
                            <i class="fas fa-chart-pie me-2"></i>Average Utilization
                        </div>
                        <div style="font-size: 3rem; font-weight: 700; color: white;">
                            ${data.average_utilization}<span style="font-size: 2rem;">%</span>
                        </div>
                    </div>
                    
                    <!-- Right Card: Yearly Bonus -->
                    <div style="background: white; border-radius: 12px; padding: 32px; text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.08); display: flex; flex-direction: column; align-items: center; justify-content: center;">
                        <div style="width: 50px; height: 50px; background: #fff3cd; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-bottom: 12px;">
                            <i class="fas fa-medal" style="color: #ffc107; font-size: 1.5rem;"></i>
                        </div>
                        <div style="color: #6c757d; font-size: 0.95rem; font-weight: 600; margin-bottom: 8px;">Yearly Bonus</div>
                        <div style="font-size: 2rem; font-weight: 700; color: #1a1a1a;">
                            ${data.yearly_bonus_points} <span style="color: #6c757d; font-weight: 500; font-size: 1.2rem;">/ ${data.yearly_bonus_limit}</span>
                        </div>
                    </div>
                </div>
                
                <!-- Points by Category Section - Modern Side-by-Side Split Bar Design -->
                <div style="background: white; border-radius: 12px; padding: 28px; box-shadow: 0 2px 12px rgba(0,0,0,0.08); margin-bottom: 24px;">
                    <h6 style="color: #1a1a1a; font-weight: 700; margin: 0 0 24px 0; font-size: 1.1rem; letter-spacing: -0.3px;">
                        <i class="fas fa-chart-bar me-2" style="color: #4A90E2;"></i>Points Overview by Category
                    </h6>
                    
                    ${(() => {
                        // Merge regular and bonus categories
                        const categoryMap = new Map();
                        
                        // Add regular points
                        if (data.summary_by_category && data.summary_by_category.length > 0) {
                            data.summary_by_category.forEach(cat => {
                                categoryMap.set(cat.category, { regular: cat.points, bonus: 0 });
                            });
                        }
                        
                        // Add bonus points
                        if (data.bonus_by_category && data.bonus_by_category.length > 0) {
                            data.bonus_by_category.forEach(cat => {
                                if (categoryMap.has(cat.category)) {
                                    categoryMap.get(cat.category).bonus = cat.points;
                                } else {
                                    categoryMap.set(cat.category, { regular: 0, bonus: cat.points });
                                }
                            });
                        }
                        
                        if (categoryMap.size === 0) {
                            return '<div style="color: #adb5bd; font-size: 0.95rem; padding: 20px; background: #f8f9fa; border-radius: 10px; text-align: center; border: 2px dashed #dee2e6;"><i class="fas fa-inbox me-2"></i>No points recorded yet</div>';
                        }
                        
                        // Find max value for scaling
                        let maxValue = 0;
                        categoryMap.forEach(values => {
                            const total = values.regular + values.bonus;
                            if (total > maxValue) maxValue = total;
                        });
                        
                        // Generate rows
                        let rows = '';
                        categoryMap.forEach((values, category) => {
                            const regularWidth = maxValue > 0 ? (values.regular / maxValue * 100) : 0;
                            const bonusWidth = maxValue > 0 ? (values.bonus / maxValue * 100) : 0;
                            const totalWidth = regularWidth + bonusWidth;
                            
                            rows += `
                                <div style="margin-bottom: 16px;">
                                    <!-- Category Label -->
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                        <span style="color: #495057; font-size: 0.9rem; font-weight: 600;">${category}</span>
                                        <span style="color: #6c757d; font-size: 0.85rem; font-weight: 500;">Total: ${values.regular + values.bonus}</span>
                                    </div>
                                    
                                    <!-- Split Bar Container -->
                                    <div style="background: #f0f0f0; border-radius: 10px; overflow: hidden; height: 44px; display: flex; align-items: center; box-shadow: inset 0 1px 3px rgba(0,0,0,0.1); position: relative;">
                                        ${totalWidth > 0 ? `
                                            <!-- Regular Points (Left) -->
                                            ${values.regular > 0 ? `
                                                <div style="background: linear-gradient(135deg, #4A90E2 0%, #357ABD 100%); height: 100%; width: ${regularWidth}%; display: flex; align-items: center; justify-content: center; position: relative; transition: all 0.3s ease;">
                                                    <span style="color: white; font-weight: 700; font-size: 0.95rem; text-shadow: 0 1px 2px rgba(0,0,0,0.2);">${values.regular}</span>
                                                </div>
                                            ` : ''}
                                            
                                            <!-- Bonus Points (Right) -->
                                            ${values.bonus > 0 ? `
                                                <div style="background: linear-gradient(135deg, #50C878 0%, #3DA35D 100%); height: 100%; width: ${bonusWidth}%; display: flex; align-items: center; justify-content: center; position: relative; transition: all 0.3s ease;">
                                                    <span style="color: white; font-weight: 700; font-size: 0.95rem; text-shadow: 0 1px 2px rgba(0,0,0,0.2);">+${values.bonus}</span>
                                                </div>
                                            ` : ''}
                                        ` : `
                                            <span style="color: #adb5bd; font-size: 0.85rem; margin-left: 16px;">No points</span>
                                        `}
                                    </div>
                                </div>
                            `;
                        });
                        
                        return rows;
                    })()}
                    
                    <!-- Legend -->
                    <div style="display: flex; gap: 24px; margin-top: 24px; padding-top: 20px; border-top: 1px solid #e9ecef; justify-content: center;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <div style="width: 20px; height: 20px; background: linear-gradient(135deg, #4A90E2 0%, #357ABD 100%); border-radius: 4px; box-shadow: 0 2px 4px rgba(74,144,226,0.3);"></div>
                            <span style="color: #495057; font-size: 0.9rem; font-weight: 500;">Regular Points</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <div style="width: 20px; height: 20px; background: linear-gradient(135deg, #50C878 0%, #3DA35D 100%); border-radius: 4px; box-shadow: 0 2px 4px rgba(80,200,120,0.3);"></div>
                            <span style="color: #495057; font-size: 0.9rem; font-weight: 500;">Bonus Points</span>
                        </div>
                    </div>
                </div>
                
                <!-- Detailed Records Table - Clean Simple Design -->
                <div style="background: white; border-radius: 12px; padding: 24px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                    <h6 style="color: #333; font-weight: 600; margin: 0 0 16px 0; font-size: 1rem;">Detailed Records</h6>
                    
                    <div style="border-radius: 8px; overflow: hidden; border: 1px solid #e9ecef;">
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="background: #f7f7f7;">
                                    <th style="padding: 12px 16px; text-align: left; font-size: 0.85rem; font-weight: 600; color: #495057; border-bottom: 1px solid #dee2e6;">Date</th>
                                    <th style="padding: 12px 16px; text-align: left; font-size: 0.85rem; font-weight: 600; color: #495057; border-bottom: 1px solid #dee2e6;">Category</th>
                                    <th style="padding: 12px 16px; text-align: left; font-size: 0.85rem; font-weight: 600; color: #495057; border-bottom: 1px solid #dee2e6;">Value</th>
                                    <th style="padding: 12px 16px; text-align: left; font-size: 0.85rem; font-weight: 600; color: #495057; border-bottom: 1px solid #dee2e6;">Notes</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.points_records && data.points_records.length > 0 ? data.points_records.map(rec => `
                                    <tr style="border-bottom: 1px solid #f0f0f0; transition: background 0.15s ease;" onmouseover="this.style.background='#f8f9fa'" onmouseout="this.style.background='white'">
                                        <td style="padding: 12px 16px; font-size: 0.9rem; color: #495057;">${rec.date}</td>
                                        <td style="padding: 12px 16px; font-size: 0.9rem; color: #495057;">
                                            ${rec.category}
                                            ${rec.is_bonus ? '<span style="background: #ffc107; color: #000; padding: 2px 8px; border-radius: 10px; font-size: 0.75rem; font-weight: 600; margin-left: 6px;">Bonus</span>' : ''}
                                        </td>
                                        <td style="padding: 12px 16px; font-size: 0.9rem; color: #495057;">
                                            ${rec.is_utilization ? `
                                                <span style="background: #17a2b8; color: white; padding: 4px 10px; border-radius: 6px; font-size: 0.85rem; font-weight: 600;">
                                                    <i class="fas fa-percentage me-1"></i>${rec.utilization || 'N/A'}
                                                </span>
                                            ` : `
                                                <strong style="color: #333;">${rec.points}</strong>
                                            `}
                                        </td>
                                        <td style="padding: 12px 16px;">
                                            ${rec.manager_notes || rec.submission_notes ? `
                                                <button class="view-notes-btn" 
                                                        data-notes="${(rec.manager_notes || rec.submission_notes).replace(/"/g, '&quot;')}"
                                                        style="background: linear-gradient(135deg, #20B2AA, #48D1CC); color: white; border: none; border-radius: 8px; padding: 6px 12px; font-size: 0.85rem; font-weight: 500; cursor: pointer; transition: all 0.15s ease;">
                                                    <i class="fas fa-eye me-1"></i> View
                                                </button>
                                            ` : '<span style="color: #adb5bd; font-size: 0.85rem;">No notes</span>'}
                                        </td>
                                    </tr>
                                `).join('') : '<tr><td colspan="4" style="padding: 24px; text-align: center; color: #6c757d;">No records found</td></tr>'}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        // Export
        function initializeExport() {
            document.getElementById('exportToExcel')?.addEventListener('click', function() {
                const startDate = document.getElementById('exportStartDate').value;
                const endDate = document.getElementById('exportEndDate').value;

                if (!startDate || !endDate) {
                    alert('Please select both dates');
                    return;
                }

                if (new Date(startDate) > new Date(endDate)) {
                    alert('Start date cannot be after end date');
                    return;
                }

                window.location.href = `/central/export/excel?start_date=${startDate}&end_date=${endDate}`;
            });
            
            // Send Bonus Analysis
            document.getElementById('sendBonusAnalysis')?.addEventListener('click', function() {
                if (!confirm('Send bonus analysis emails to all eligible employees for this quarter?')) {
                    return;
                }
                
                const btn = this;
                const originalText = btn.innerHTML;
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i> Sending...';
                
                fetch('/central/send-bonus-analysis', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                .then(res => res.json())
                .then(data => {
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                    
                    if (data.success) {
                        showAlert('success', data.message);
                    } else {
                        showAlert('danger', data.error || 'Failed to send bonus analysis');
                    }
                })
                .catch(error => {
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                    showAlert('danger', 'Error: ' + error.message);
                });
            });
        }

        // Pagination
        let currentPage = 1;
        const rowsPerPage = 25;  // Changed from 10 to 25 records per page

        function initializePagination() {
            updatePagination();
        }

        function updatePagination() {
            const table = document.getElementById('employeesTable');
            // Get ALL rows first (before any display filtering)
            const allRows = Array.from(table.querySelectorAll('tbody tr'));
            
            // Filter to get rows that should be visible based on search/filter (not pagination)
            // Check if row has been filtered out by search (has display:none set by search, not by pagination)
            const filteredRows = allRows.filter(row => {
                // If row has data-filtered attribute, it was filtered by search
                return !row.hasAttribute('data-filtered');
            });
            
            const pageCount = Math.ceil(filteredRows.length / rowsPerPage);
            const container = document.getElementById('tablePagination');

            container.innerHTML = '';

            if (pageCount <= 1) {
                // Show all filtered rows if only 1 page
                filteredRows.forEach(row => row.style.display = '');
                // Update the display counter
                const pageRangeSpan = document.getElementById('pageRange');
                const totalRowsSpan = document.getElementById('totalRows');
                if (pageRangeSpan && filteredRows.length > 0) {
                    pageRangeSpan.textContent = `1-${filteredRows.length}`;
                }
                if (totalRowsSpan) {
                    totalRowsSpan.textContent = filteredRows.length;
                }
                return;
            }

            // Previous button
            const prevBtn = document.createElement('button');
            prevBtn.className = 'pagination-btn';
            prevBtn.textContent = '';
            prevBtn.disabled = currentPage === 1;
            prevBtn.onclick = () => changePage(currentPage - 1);
            container.appendChild(prevBtn);

            // Page numbers
            for (let i = 1; i <= Math.min(pageCount, 5); i++) {
                const btn = document.createElement('button');
                btn.className = `pagination-btn ${i === currentPage ? 'active' : ''}`;
                btn.textContent = i;
                btn.onclick = () => changePage(i);
                container.appendChild(btn);
            }

            // Next button
            const nextBtn = document.createElement('button');
            nextBtn.className = 'pagination-btn';
            nextBtn.textContent = '';
            nextBtn.disabled = currentPage === pageCount;
            nextBtn.onclick = () => changePage(currentPage + 1);
            container.appendChild(nextBtn);

            showPage(currentPage, filteredRows);
        }

        function changePage(page) {
            currentPage = page;
            updatePagination();
        }

        function showPage(page, rows) {
            const allRows = document.querySelectorAll('#employeesTable tbody tr');
            allRows.forEach(row => row.style.display = 'none');

            const start = (page - 1) * rowsPerPage;
            const end = Math.min(start + rowsPerPage, rows.length);
            
            for (let i = start; i < end; i++) {
                rows[i].style.display = '';
            }
            
            // Update the page range display (e.g., "1-25" or "26-50")
            const pageRangeSpan = document.getElementById('pageRange');
            const totalRowsSpan = document.getElementById('totalRows');
            
            if (pageRangeSpan) {
                const startNum = rows.length > 0 ? start + 1 : 0;
                const endNum = end;
                pageRangeSpan.textContent = `${startNum}-${endNum}`;
            }
            
            if (totalRowsSpan) {
                totalRowsSpan.textContent = rows.length;
            }
        }

        // Helper Functions
        function showAlert(type, message) {
            const alert = document.createElement('div');
            alert.className = `alert alert-${type} alert-dismissible fade show`;
            alert.style.cssText = 'position:fixed;top:20px;right:20px;z-index:9999;';
            alert.innerHTML = `${message}<button type="button" class="btn-close" data-bs-dismiss="alert"></button>`;
            document.body.appendChild(alert);
            setTimeout(() => alert.remove(), 5000);
        }

        // View Notes
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('view-notes-btn')) {
                const notes = e.target.getAttribute('data-notes') || 'No notes available';
                document.getElementById('notesModalContent').textContent = notes;
                new bootstrap.Modal(document.getElementById('notesModal')).show();
            }
        });

        // === EXPORT FUNCTIONALITY ===
        (function() {
            const BACKEND_EXPORT_URL = '/central/export/excel';

            function validateDateFormat(dateStr) {
                const regex = /^\d{4}-\d{2}-\d{2}$/;
                return regex.test(dateStr);
            }

            function validateDateRange(startDate, endDate) {
                if (!startDate || !endDate) {
                    alert("Please select both start date and end date for the export.");
                    return false;
                }
                
                if (!validateDateFormat(startDate) || !validateDateFormat(endDate)) {
                    alert("Invalid date format. Please use YYYY-MM-DD.");
                    return false;
                }
                
                const start = new Date(startDate);
                const end = new Date(endDate);
                
                if (start > end) {
                    alert("Start date cannot be later than end date.");
                    return false;
                }
                
                if (end > new Date()) {
                    alert("End date cannot be in the future.");
                    return false;
                }
                
                return true;
            }

            function showButtonLoading(button, loadingText) {
                button.dataset.originalText = button.textContent;
                button.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>' + loadingText;
                button.disabled = true;
            }

            function resetButton(button) {
                button.innerHTML = button.dataset.originalText || '<i class="fas fa-file-excel me-2"></i> Export to Excel';
                button.disabled = false;
            }

            function setupExport() {
                const exportBtn = document.getElementById('exportToExcel');
                if (!exportBtn) {
                    console.log("Export button #exportToExcel not found");
                    return;
                }

                exportBtn.addEventListener('click', function(event) {
                    event.preventDefault();
                    
                    const startDateInput = document.getElementById('exportStartDate');
                    const endDateInput = document.getElementById('exportEndDate');
                    
                    if (!startDateInput || !endDateInput) {
                        alert("Date range inputs not found. Please ensure the page has start and end date fields.");
                        return;
                    }
                    
                    const startDate = startDateInput.value;
                    const endDate = endDateInput.value;
                    
                    if (!validateDateRange(startDate, endDate)) {
                        return;
                    }
                    
                    showButtonLoading(exportBtn, 'Generating Excel...');
                    
                    // Create the export URL with date parameters
                    const exportUrl = `${BACKEND_EXPORT_URL}?start_date=${startDate}&end_date=${endDate}`;
                    
                    // Direct navigation to download the file
                    window.location.href = exportUrl;
                    
                    // Reset button after delay
                    setTimeout(() => {
                        resetButton(exportBtn);
                    }, 3000);
                });
                
                console.log("Export functionality initialized");
            }

            // Initialize export on page load
            setupExport();

            // Emergency export function for console debugging
            window.emergencyExport = function(startDate, endDate) {
                startDate = startDate || document.getElementById('exportStartDate')?.value || '';
                endDate = endDate || document.getElementById('exportEndDate')?.value || '';
                
                if (!validateDateRange(startDate, endDate)) return;
                
                const exportUrl = `${BACKEND_EXPORT_URL}?start_date=${startDate}&end_date=${endDate}`;
                console.log("Emergency export:", exportUrl);
                window.location.href = exportUrl;
            };
        })();
    </script>
</body>
</html>