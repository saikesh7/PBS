{% extends "ta_base.html" %}

{% block title %}TA Updater Dashboard{% endblock %}
{% block dashboard_title %}TA Updater Dashboard{% endblock %}

{% block extra_css %}
<!-- Preserve tab state on page reload -->
<!-- Prevent flash of wrong tab on page load -->
<script>
    // Flag to prevent base template's tab initialization from interfering
    // This MUST be set before any other scripts run
    window.TA_UPDATER_PAGE = true;
    
    // This runs IMMEDIATELY before page renders to prevent flash
    (function() {
        // ✅ Check URL parameter FIRST (primary source of truth)
        const urlParams = new URLSearchParams(window.location.search);
        const urlTab = urlParams.get('tab');
        
        // Use URL tab if present, otherwise fall back to localStorage
        const activeTab = urlTab || localStorage.getItem('ta_updater_current_tab') || 'overview';
        
        if (activeTab && activeTab !== 'overview') {
            // Add CSS to hide overview tab and show active tab
            document.write('<style id="tab-preload-style">');
            document.write('#overview-tab { display: none !important; }');
            document.write('#' + activeTab + '-tab { display: block !important; }');
            document.write('</style>');
        }
    })();
</script>
{% endblock %}

{% block sidebar_nav %}
<!-- Updater Navigation Items -->
<a href="javascript:void(0);" class="sidebar-nav-item tab-link active" data-tab="overview">
    <div>
        <i class="fas fa-tachometer-alt"></i>
        <span>Dashboard</span>
    </div>
</a>

<a href="javascript:void(0);" class="sidebar-nav-item tab-link" data-tab="single-request">
    <div>
        <i class="fas fa-plus-circle"></i>
        <span>Single Request</span>
    </div>
</a>

<a href="javascript:void(0);" class="sidebar-nav-item tab-link" data-tab="bulk-upload">
    <div>
        <i class="fas fa-upload"></i>
        <span>Bulk Upload</span>
    </div>
</a>

<a href="javascript:void(0);" class="sidebar-nav-item tab-link" data-tab="history">
    <div>
        <i class="fas fa-history"></i>
        <span>History</span>
    </div>
</a>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Overview Tab (Dashboard Summary) -->
    <div class="tab-content-section active" id="overview-tab">
        <!-- Stats Cards Row -->
        <div class="row mb-4">
            <div class="col-xl-3 col-md-6 mb-3">
                <div class="card border-left-primary shadow h-100">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col">
                                <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">Total Submitted</div>
                                <div class="h5 mb-0 font-weight-bold">{{ history|length if history else 0 }}</div>
                            </div>
                            <div class="col-auto">
                                <i class="fas fa-paper-plane fa-2x text-primary" style="opacity: 0.3;"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-xl-3 col-md-6 mb-3">
                <div class="card border-left-success shadow h-100">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col">
                                <div class="text-xs font-weight-bold text-success text-uppercase mb-1">Approved</div>
                                <div class="h5 mb-0 font-weight-bold">{{ history|selectattr('status', 'equalto', 'Approved')|list|length if history else 0 }}</div>
                            </div>
                            <div class="col-auto">
                                <i class="fas fa-check-circle fa-2x text-success" style="opacity: 0.3;"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-xl-3 col-md-6 mb-3">
                <div class="card border-left-danger shadow h-100">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col">
                                <div class="text-xs font-weight-bold text-danger text-uppercase mb-1">Rejected</div>
                                <div class="h5 mb-0 font-weight-bold">{{ history|selectattr('status', 'equalto', 'Rejected')|list|length if history else 0 }}</div>
                            </div>
                            <div class="col-auto">
                                <i class="fas fa-times-circle fa-2x text-danger" style="opacity: 0.3;"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-xl-3 col-md-6 mb-3">
                <div class="card border-left-warning shadow h-100">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col">
                                <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">Pending</div>
                                <div class="h5 mb-0 font-weight-bold">{{ history|selectattr('status', 'equalto', 'Pending')|list|length if history else 0 }}</div>
                            </div>
                            <div class="col-auto">
                                <i class="fas fa-clock fa-2x text-warning" style="opacity: 0.3;"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Activity & Category Breakdown -->
        <div class="row mb-4">
            <!-- Recent Activity Timeline -->
            <div class="col-lg-8 mb-4">
                <div class="card shadow-sm h-100">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="fas fa-clock me-2"></i>Recent Activity</h5>
                    </div>
                    <div class="card-body">
                        {% if history %}
                        <div class="timeline">
                            {% for item in history[:5] %}
                            <div class="timeline-item mb-3 pb-3 border-bottom">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div class="flex-grow-1">
                                        <div class="d-flex align-items-center mb-1">
                                            <span class="badge bg-{{ 'success' if item.status == 'Approved' else 'danger' if item.status == 'Rejected' else 'warning' }} me-2">
                                                {{ item.status }}
                                            </span>
                                            <strong>{{ item.employee_name }}</strong>
                                        </div>
                                        <div class="text-muted small">
                                            <i class="fas fa-tag me-1"></i>{{ item.category_name }}
                                            <span class="mx-2">•</span>
                                            <i class="fas fa-coins me-1"></i>{{ item.points }} points
                                            {% if item.quantity and item.quantity > 1 %}
                                            <span class="mx-2">•</span>
                                            <i class="fas fa-hashtag me-1"></i>Qty: {{ item.quantity }}
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="text-end text-muted small">
                                        {{ item.request_date.strftime('%d %b') }}
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        {% else %}
                        <div class="text-center text-muted py-4">
                            <i class="fas fa-inbox fa-3x mb-3 d-block opacity-25"></i>
                            <p>No activity yet. Start assigning points!</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Category Breakdown -->
            <div class="col-lg-4 mb-4">
                <div class="card shadow-sm h-100">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0"><i class="fas fa-chart-pie me-2"></i>Categories</h5>
                    </div>
                    <div class="card-body">
                        {% if ta_categories %}
                        <div class="list-group list-group-flush">
                            {% for category in ta_categories[:5] %}
                            <div class="list-group-item px-0 d-flex justify-content-between align-items-center">
                                <div>
                                    <i class="fas fa-tag text-primary me-2"></i>
                                    <span class="small">{{ category.name }}</span>
                                </div>
                                <span class="badge bg-primary rounded-pill">
                                    {{ history|selectattr('category_name', 'equalto', category.name)|list|length }}
                                </span>
                            </div>
                            {% endfor %}
                        </div>
                        {% else %}
                        <div class="text-center text-muted py-4">
                            <i class="fas fa-tags fa-3x mb-3 d-block opacity-25"></i>
                            <p class="small">No categories available</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- Single Request Tab -->
    <div class="tab-content-section" id="single-request-tab">
        <div class="row mb-4">
            <div class="col-12">
                <div class="card shadow-sm">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-user-plus"></i> Create Single Request
                        </h5>
                    </div>
                    <div class="card-body">
                        <form method="POST" action="{{ url_for('ta.updater_dashboard') }}" id="singleRequestForm">
                            <input type="hidden" name="action_type" value="assign_points">
                            
                            <!-- Row 1: Department and Grade -->
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="department" class="form-label">
                                        <i></i> Department <span class="text-danger">*</span>
                                    </label>
                                    <select class="form-select" id="department" name="department">
                                        <option value="">-- Select Department --</option>
                                        <option value="all">All Departments</option>
                                        {% for dept in departments.keys() %}
                                        {% if dept and dept.strip() %}
                                        <option value="{{ dept }}">{{ dept }}</option>
                                        {% endif %}
                                        {% endfor %}
                                    </select>
                                </div>
                                
                                <div class="col-md-6 mb-3">
                                    <label for="grade" class="form-label">
                                        <i></i> Grade <span class="text-danger">*</span>
                                    </label>
                                    <select class="form-select" id="grade" name="grade" disabled>
                                        <option value="">-- Select Department First --</option>
                                    </select>
                                </div>
                            </div>
                            
                            <!-- Row 2: Employee and Category -->
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="employee_id" class="form-label">
                                        <i></i> Employee <span class="text-danger">*</span>
                                    </label>
                                    <select class="form-select" id="employee_id" name="employee_id" required disabled>
                                        <option value="">-- Select Grade First --</option>
                                    </select>
                                </div>
                                
                                <div class="col-md-6 mb-3">
                                    <label for="category_id" class="form-label">
                                        <i></i> Category <span class="text-danger">*</span>
                                    </label>
                                    <select class="form-select" id="category_id" name="category_id" required>
                                        <option value="">-- Select Category --</option>
                                        {% for category in ta_categories %}
                                        <option value="{{ category._id }}" 
                                                data-points="{{ category.points_per_unit.base if category.points_per_unit is mapping else category.points_per_unit }}"
                                                data-name="{{ category.name }}">
                                            {{ category.name }} ({{ category.points_per_unit.base if category.points_per_unit is mapping else category.points_per_unit }} pts/unit)
                                        </option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                            
                            <!-- Row 3: Validator and Quantity -->
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="validator_id" class="form-label">
                                        <i></i> Validator <span class="text-danger">*</span>
                                    </label>
                                    <select class="form-select" id="validator_id" name="validator_id" required>
                                        <option value="">-- Select Validator --</option>
                                        {% for validator in ta_validators %}
                                        <option value="{{ validator._id }}" 
                                                data-name="{{ validator.name }}"
                                                data-emp-id="{{ validator.employee_id }}">
                                            {{ validator.name }} - {{ validator.employee_id }}
                                        </option>
                                        {% endfor %}
                                    </select>
                                </div>
                                
                                <div class="col-md-6 mb-3">
                                    <label for="quantity" class="form-label">
                                        <i></i> Quantity <span class="text-danger">*</span>
                                    </label>
                                    <input type="number" class="form-control" id="quantity" 
                                           name="quantity" required min="1" value="1">
                                    <small class="text-muted" id="points_preview">Total points: 0</small>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="event_date" class="form-label">
                                        <i></i> Event Date
                                    </label>
                                    <input type="date" class="form-control" id="event_date" 
                                           name="event_date">
                                </div>
                                
                                <div class="col-md-6 mb-3">
                                    <label for="award_month_year" class="form-label">
                                        <i></i> Award Month
                                    </label>
                                    <select class="form-select" id="award_month_year" name="award_month_year">
                                        <option value="">-- Use Event Date --</option>
                                        {% for month_opt in month_year_options %}
                                        <option value="{{ month_opt.value }}">{{ month_opt.label }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-12 mb-3">
                                    <label for="notes" class="form-label">
                                        <i></i> Notes <span class="text-danger">*</span>
                                    </label>
                                    <textarea class="form-control" id="notes" name="notes" 
                                              rows="3" required placeholder="Enter detailed notes"></textarea>
                                </div>
                            </div>
                            
                            <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                                <button type="reset" class="btn btn-secondary">
                                    <i></i> Reset
                                </button>
                                <button type="button" class="btn btn-primary" onclick="confirmSingleRequest()">
                                    <i class="fas fa-paper-plane"></i> Submit Request
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bulk Upload Tab -->
    <div class="tab-content-section" id="bulk-upload-tab">
        <div class="row mb-4">
            <div class="col-12">
                <div class="card shadow-sm">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-upload"></i> Bulk Upload Points
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-info border-0" style="background-color: #e7f3ff; border-left: 4px solid #0d6efd !important;">
                            <div class="d-flex">
                                <div class="me-3">
                                    <i class="fas fa-info-circle" style="font-size: 1.5rem; color: #0d6efd;"></i>
                                </div>
                                <div class="flex-grow-1">
                                    <h6 class="fw-bold mb-2" style="color: #0d6efd;">CSV Format Instructions</h6>
                                    <p class="mb-2">Upload a CSV with the following columns:</p>
                                    <ul class="mb-0" style="line-height: 1.8;">
                                        <li><strong>employee_id</strong> - Employee ID (required)</li>
                                        <li><strong>validator_employee_id</strong> - Validator's Employee ID (required)</li>
                                        <li><strong>event_date</strong> - Event date (required, format: DD-MM-YYYY)</li>
                                        <li>
                                            <strong>category_code</strong> - Category code (required)
                                            <div id="validCategoriesDiv" style="margin-top: 8px; padding: 12px; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border-left: 4px solid #0d6efd; border-radius: 6px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                                                <div style="display: flex; align-items: center; margin-bottom: 8px;">
                                                    <i class="fas fa-tags" style="color: #0d6efd; margin-right: 8px; font-size: 1.1rem;"></i>
                                                    <strong style="color: #0d6efd; font-size: 0.95rem;">Valid Category Codes:</strong>
                                                </div>
                                                <div id="validCategoriesList" style="display: flex; flex-wrap: wrap; gap: 8px; margin-top: 8px;">
                                                    <span class="badge bg-secondary" style="font-size: 0.85rem; padding: 6px 10px;">
                                                        <i class="fas fa-spinner fa-spin"></i> Loading...
                                                    </span>
                                                </div>
                                            </div>
                                        </li>
                                        <li><strong>quantity</strong> - Quantity (required, must be positive integer)</li>
                                        <li><strong>notes</strong> - Notes (required)</li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <div class="text-end mb-3">
                            <a href="{{ url_for('ta.download_bulk_template') }}" class="btn btn-outline-primary">
                                <i class="fas fa-download"></i> Download Template
                            </a>
                        </div>
                        
                        <form id="bulkUploadForm" enctype="multipart/form-data">
                            <div class="mb-3">
                                <label for="csv_file" class="form-label fw-bold">CSV File</label>
                                <input type="file" class="form-control" id="csv_file" 
                                       name="csv_file" accept=".csv" required>
                            </div>
                            
                            <div class="d-flex justify-content-between">
                                <button type="button" class="btn text-white" style="background-color: #17a2b8;" id="validateBulkButton" onclick="validateBulkUpload()">
                                    <i class="fas fa-search"></i> Validate CSV
                                </button>
                                <button type="button" class="btn text-white" style="background-color: #6c757d;" id="reviewBulkButton" disabled>
                                    <i class="fas fa-check-circle"></i> Review & Upload
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- History Tab -->
    <div class="tab-content-section" id="history-tab">
        <div class="row mb-4">
            <div class="col-12">
                <div class="card shadow-sm">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-history"></i> Assignment History
                        </h5>
                    </div>
                    <div class="card-body">
                        <!-- Filters Row -->
                        <div class="row mb-3 g-2">
                            <div class="col-md-2">
                                <label class="form-label small text-muted mb-1">Year</label>
                                <select class="form-select form-select-sm" id="historyYearFilter">
                                    <option value="">All</option>
                                    {% for year in year_options %}
                                    <option value="{{ year }}">{{ year }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label small text-muted mb-1">Quarter</label>
                                <select class="form-select form-select-sm" id="historyQuarterFilter">
                                    <option value="">All</option>
                                    {% for q in quarter_options %}
                                    <option value="{{ q }}">{{ q }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label small text-muted mb-1">Grade</label>
                                <select class="form-select form-select-sm" id="historyGradeFilter">
                                    <option value="">All</option>
                                    {% for grade in grades %}
                                    <option value="{{ grade }}">{{ grade }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label small text-muted mb-1">Status</label>
                                <select class="form-select form-select-sm" id="historyStatusFilter">
                                    <option value="">All</option>
                                    {% if history %}
                                        {% set statuses = [] %}
                                        {% for record in history %}
                                            {% if record.status not in statuses %}
                                                {% set _ = statuses.append(record.status) %}
                                            {% endif %}
                                        {% endfor %}
                                        {% if 'Approved' in statuses %}
                                        <option value="Approved">Approved</option>
                                        {% endif %}
                                        {% if 'Rejected' in statuses %}
                                        <option value="Rejected">Rejected</option>
                                        {% endif %}
                                        {% if 'Pending' in statuses %}
                                        <option value="Pending">Pending</option>
                                        {% endif %}
                                    {% endif %}
                                </select>
                            </div>
                            <div class="col-md-4 d-flex align-items-end gap-1">
                                <button class="btn btn-sm btn-primary" onclick="filterHistoryTable()" style="flex: 1;">
                                    <i class="fas fa-filter"></i> Apply
                                </button>
                                <button class="btn btn-sm btn-outline-secondary" onclick="resetHistoryFilters()" style="flex: 1;">
                                    <i class="fas fa-redo"></i> Reset
                                </button>
                            </div>
                        </div>

                        <!-- Show entries and Search row -->
                        <div class="row mb-3 align-items-center">
                            <div class="col-md-3">
                                <div class="d-flex align-items-center">
                                    <span class="me-2 small">Show</span>
                                    <select class="form-select form-select-sm" style="width: 80px;" id="historyPageSize" onchange="changeHistoryPageSize()">
                                        <option value="10" selected>10</option>
                                        <option value="25">25</option>
                                        <option value="50">50</option>
                                    </select>
                                    <span class="ms-2 small">entries</span>
                                </div>
                            </div>
                            <div class="col-md-6"></div>
                            <div class="col-md-3">
                                <div class="d-flex gap-2 align-items-center justify-content-end">
                                    <span class="small">Search:</span>
                                    <input type="text" class="form-control form-control-sm" placeholder="Search..." id="historySearchInput" onkeyup="filterHistoryTable()" style="max-width: 200px;">
                                </div>
                            </div>
                        </div>
                        
                        <div class="table-responsive">
                            <table class="table table-hover mb-0" id="historyTable" style="font-size: 0.9rem;">
                                <thead style="position: sticky; top: 0; z-index: 10; background-color: #f8f9fa;">
                                    <tr style="border-bottom: 2px solid #dee2e6;">
                                        <th style="padding: 12px 8px; font-weight: 600; color: #495057; white-space: nowrap; text-transform: uppercase; font-size: 0.75rem;">REQUEST DATE</th>
                                        <th style="padding: 12px 8px; font-weight: 600; color: #495057; white-space: nowrap; text-transform: uppercase; font-size: 0.75rem;">EVENT DATE</th>
                                        <th style="padding: 12px 8px; font-weight: 600; color: #495057; white-space: nowrap; text-transform: uppercase; font-size: 0.75rem;">EMPLOYEE</th>
                                        <th style="padding: 12px 8px; font-weight: 600; color: #495057; white-space: nowrap; text-transform: uppercase; font-size: 0.75rem;">GRADE</th>
                                        <th style="padding: 12px 8px; font-weight: 600; color: #495057; white-space: nowrap; text-transform: uppercase; font-size: 0.75rem;">CATEGORY</th>
                                        <th style="padding: 12px 8px; font-weight: 600; color: #495057; white-space: nowrap; text-transform: uppercase; font-size: 0.75rem; text-align: center;">QUANTITY</th>
                                        <th style="padding: 12px 8px; font-weight: 600; color: #495057; white-space: nowrap; text-transform: uppercase; font-size: 0.75rem; text-align: center;">POINTS</th>
                                        <th style="padding: 12px 8px; font-weight: 600; color: #495057; white-space: nowrap; text-transform: uppercase; font-size: 0.75rem;">VALIDATOR</th>
                                        <th style="padding: 12px 8px; font-weight: 600; color: #495057; white-space: nowrap; text-transform: uppercase; font-size: 0.75rem; text-align: center;">STATUS</th>
                                        <th style="padding: 12px 8px; font-weight: 600; color: #495057; white-space: nowrap; text-transform: uppercase; font-size: 0.75rem; text-align: center;">NOTES</th>
                                    </tr>
                                </thead>
                                <tbody id="historyTableBody">
                                    {% if history %}
                                    {% for record in history %}
                                    {% set month = record.request_date.month %}
                                    {% set year = record.request_date.year %}
                                    {% set quarter = 'Q1' if month in [4,5,6] else 'Q2' if month in [7,8,9] else 'Q3' if month in [10,11,12] else 'Q4' %}
                                    <tr class="history-row"
                                        data-year="{{ year }}"
                                        data-quarter="{{ quarter }}"
                                        data-grade="{{ record.employee_grade }}"
                                        data-status="{{ record.status }}">
                                        <td style="padding: 10px 8px; white-space: nowrap;">{{ record.request_date.strftime('%d-%m-%Y') }}</td>
                                        <td style="padding: 10px 8px; white-space: nowrap;">{{ record.event_date.strftime('%d-%m-%Y') }}</td>
                                        <td style="padding: 10px 8px; white-space: nowrap;">{{ record.employee_name }}</td>
                                        <td style="padding: 10px 8px;"><span class="badge bg-secondary">{{ record.employee_grade }}</span></td>
                                        <td style="padding: 10px 8px;">{{ record.category_name }}</td>
                                        <td style="padding: 10px 8px; text-align: center;">{{ record.quantity }}</td>
                                        <td style="padding: 10px 8px; text-align: center;">{{ record.points }}</td>
                                        <td style="padding: 10px 8px;">{{ record.validator_name }}</td>
                                        <td style="padding: 10px 8px; text-align: center;">
                                            <span class="badge" style="background-color: {{ '#ffc107' if record.status == 'Pending' else '#28a745' if record.status == 'Approved' else '#dc3545' }}; color: {{ '#000' if record.status == 'Pending' else '#fff' }}; font-weight: 600; padding: 4px 12px;">
                                                {{ record.status }}
                                            </span>
                                        </td>
                                        <td style="padding: 10px 8px; text-align: center;">
                                            {% set notes_to_display = record.response_notes or record.submission_notes %}
                                            {% if notes_to_display %}
                                            <button type="button" class="btn btn-sm btn-info btn-view-notes" style="padding: 4px 12px; white-space: nowrap;" 
                                                    data-notes="{{ notes_to_display | replace('"', '&quot;') | replace("'", '&#39;') }}"
                                                    data-employee="{{ record.employee_name }}"
                                                    data-status="{{ record.status }}"
                                                    title="View Notes">
                                                View
                                            </button>
                                            {% else %}
                                            <button type="button" class="btn btn-sm btn-info btn-view-notes" style="padding: 4px 12px; white-space: nowrap;" 
                                                    data-notes="No notes provided"
                                                    data-employee="{{ record.employee_name }}"
                                                    data-status="{{ record.status }}"
                                                    title="View Notes">
                                                View
                                            </button>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                    {% else %}
                                    <tr>
                                        <td colspan="10" class="text-center text-muted py-4">No entries found</td>
                                    </tr>
                                    {% endif %}
                                </tbody>
                            </table>
                        </div>

                        <!-- Pagination -->
                        <div class="d-flex justify-content-between align-items-center mt-3">
                            <div class="small text-muted" id="historyInfo">Showing 1 to 10 of entries</div>
                            <nav>
                                <ul class="pagination pagination-sm mb-0" id="historyPagination">
                                    <li class="page-item disabled"><a class="page-link" href="#">Previous</a></li>
                                    <li class="page-item active"><a class="page-link" href="#">1</a></li>
                                    <li class="page-item"><a class="page-link" href="#">Next</a></li>
                                </ul>
                            </nav>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- MODALS -->
<div class="modal fade" id="notesModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title"><i class="fas fa-file-alt me-2"></i>Notes</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3"><strong>Employee:</strong> <span id="modalEmployeeName" class="text-info fw-bold"></span></div>
                <div class="mb-3"><strong>Status:</strong> <span id="modalStatus"></span></div>
                <div><strong>Notes:</strong>
                    <div class="p-3 bg-light rounded mt-2 border-start border-info border-4" id="modalNotesContent" style="white-space: pre-wrap; max-height: 400px; overflow-y: auto;"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal"><i class="fas fa-times me-1"></i>Close</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="singleRequestConfirmModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title"><i class="fas fa-check-circle"></i> Confirm Request Submission</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <table class="table table-bordered">
                    <tr><th style="width: 30%;">Category:</th><td id="confirm_category"></td></tr>
                    <tr><th>Validator:</th><td id="confirm_validator"></td></tr>
                    <tr><th>Employee ID:</th><td id="confirm_employee_id"></td></tr>
                    <tr><th>Quantity:</th><td id="confirm_quantity"></td></tr>
                    <tr><th>Total Points:</th><td class="text-primary"><strong id="confirm_points"></strong></td></tr>
                    <tr><th>Event Date:</th><td id="confirm_event_date"></td></tr>
                    <tr>
                        <th style="vertical-align: top;">Notes:</th>
                        <td>
                            <div id="confirm_notes" class="p-2 bg-light rounded border" style="white-space: pre-wrap; word-wrap: break-word; max-height: 300px; overflow-y: auto;"></div>
                        </td>
                    </tr>
                </table>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal"><i class="fas fa-times"></i> Cancel</button>
                <button type="button" class="btn btn-primary" onclick="submitSingleRequest()"><i class="fas fa-paper-plane"></i> Submit</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="bulkUploadConfirmModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title"><i class="fas fa-check-circle"></i> Confirm Bulk Upload</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row mb-3">
                    <div class="col-md-4">
                        <div class="card border-primary">
                            <div class="card-body text-center">
                                <h3 class="text-primary mb-0" id="bulk_total_count">0</h3>
                                <small>Total</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card border-success">
                            <div class="card-body text-center">
                                <h3 class="text-success mb-0" id="bulk_valid_count">0</h3>
                                <small>Valid</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card border-danger">
                            <div class="card-body text-center">
                                <h3 class="text-danger mb-0" id="bulk_invalid_count">0</h3>
                                <small>Invalid</small>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="alert alert-info"><strong>Category:</strong> <span id="bulk_category_name"></span></div>
                <ul class="nav nav-tabs">
                    <li class="nav-item">
                        <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#valid-rows">Valid (<span id="valid_tab_count">0</span>)</button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#invalid-rows">Invalid (<span id="invalid_tab_count">0</span>)</button>
                    </li>
                </ul>
                <div class="tab-content border border-top-0 p-3">
                    <div class="tab-pane fade show active" id="valid-rows">
                        <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                            <table class="table table-sm">
                                <thead class="table-success sticky-top">
                                    <tr><th>#</th><th>Employee</th><th>Validator</th><th>Date</th><th>Qty</th><th>Points</th><th>Notes</th></tr>
                                </thead>
                                <tbody id="valid_rows_body"></tbody>
                            </table>
                        </div>
                    </div>
                    <div class="tab-pane fade" id="invalid-rows">
                        <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                            <table class="table table-sm">
                                <thead class="table-danger sticky-top">
                                    <tr><th>Row</th><th>Employee ID</th><th>Employee Name</th><th>Grade</th><th>Validator</th><th>Error</th></tr>
                                </thead>
                                <tbody id="invalid_rows_body"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="alert alert-warning mt-3" id="invalid_warning" style="display: none;">Only valid rows will be submitted.</div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" onclick="submitBulkUpload()" id="bulk_submit_btn">Submit <span id="bulk_submit_count">0</span> Requests</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<style>
    /* Tab switching - ensure only active tab is visible */
    .tab-content-section {
        display: none !important;
    }
    .tab-content-section.active {
        display: block !important;
    }
    
    /* Override any preload styles after page loads */
    #overview-tab:not(.active),
    #single-request-tab:not(.active),
    #bulk-upload-tab:not(.active),
    #history-tab:not(.active) {
        display: none !important;
    }
    
    /* Stat Cards - Match PMO exactly */
    .card {
        margin-bottom: 1.5rem;
        border: none;
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        transition: transform 0.2s, box-shadow 0.2s;
    }
    
    .card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.15) !important;
    }
    
    .border-left-primary {
        border-left: 4px solid #4e73df !important;
    }
    
    .border-left-success {
        border-left: 4px solid #1cc88a !important;
    }
    
    .border-left-danger {
        border-left: 4px solid #e74a3b !important;
    }
    
    .border-left-warning {
        border-left: 4px solid #f6c23e !important;
    }
    
    .text-xs {
        font-size: 0.7rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .h5 {
        font-size: 1.75rem;
        font-weight: 700;
    }
    
    .card-body {
        padding: 1.25rem;
    }
    
    /* Card Headers - Match PMO */
    .card-header {
        font-weight: 600;
        padding: 1rem 1.25rem;
        border-bottom: none;
    }
    
    .card-header h5 {
        margin: 0;
        font-size: 1.1rem;
    }
    
    /* Recent Activity */
    .timeline {
        max-height: 400px;
        overflow-y: auto;
    }
    
    .timeline-item {
        transition: all 0.2s;
        padding: 0.75rem;
        border-radius: 6px;
        margin-bottom: 0.5rem;
    }
    
    .timeline-item:hover {
        background-color: #f8f9fa;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    
    .timeline-item:last-child {
        border-bottom: none !important;
    }
    
    .timeline-item strong {
        font-size: 0.95rem;
        color: #2c3e50;
    }
    
    .timeline-item .text-muted {
        font-size: 0.85rem;
    }
    
    /* Scrollbar styling */
    .timeline::-webkit-scrollbar {
        width: 6px;
    }
    
    .timeline::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 10px;
    }
    
    .timeline::-webkit-scrollbar-thumb {
        background: #888;
        border-radius: 10px;
    }
    
    .timeline::-webkit-scrollbar-thumb:hover {
        background: #555;
    }
    
    /* Badge styling - Match PMO */
    .badge {
        font-weight: 600;
        padding: 0.35rem 0.65rem;
        font-size: 0.75rem;
    }
    
    .bg-warning {
        background-color: #f6c23e !important;
        color: #1f2937 !important;
    }
    
    .bg-success {
        background-color: #1cc88a !important;
    }
    
    .bg-danger {
        background-color: #e74a3b !important;
    }
    
    .bg-primary {
        background-color: #4e73df !important;
    }
    
    .bg-info {
        background-color: #36b9cc !important;
    }
    
    /* Fix DataTable scrollbar - Only table body scrolls, not pagination */
    .table-responsive {
        overflow-x: auto !important;
        overflow-y: visible !important;
    }
    
    /* Ensure table wrapper doesn't create horizontal scroll */
    .dataTables_wrapper {
        overflow-x: visible !important;
    }
    
    /* Table container with fixed height and scrollable body */
    #historyTable {
        width: 100% !important;
        table-layout: auto !important;
        min-width: 1200px;
    }
    
    #historyTable thead {
        display: table-header-group;
        width: 100%;
    }
    
    #historyTable thead th {
        white-space: nowrap !important;
        padding: 12px 15px !important;
        vertical-align: middle !important;
        min-width: fit-content !important;
    }
    
    #historyTable tbody {
        display: table-row-group;
        max-height: 400px;
        overflow-y: auto;
        overflow-x: hidden;
        width: 100%;
    }
    
    #historyTable tbody tr {
        display: table-row;
        width: 100%;
    }
    
    #historyTable tbody td {
        white-space: nowrap !important;
        padding: 10px 15px !important;
        vertical-align: middle !important;
    }
    
    /* Specific column widths for better spacing */
    #historyTable th:nth-child(1),
    #historyTable td:nth-child(1) {
        min-width: 110px;
    }
    
    #historyTable th:nth-child(2),
    #historyTable td:nth-child(2) {
        min-width: 110px;
    }
    
    #historyTable th:nth-child(3),
    #historyTable td:nth-child(3) {
        min-width: 150px;
    }
    
    #historyTable th:nth-child(4),
    #historyTable td:nth-child(4) {
        min-width: 80px;
    }
    
    #historyTable th:nth-child(5),
    #historyTable td:nth-child(5) {
        min-width: 180px;
    }
    
    #historyTable th:nth-child(6),
    #historyTable td:nth-child(6) {
        min-width: 90px;
        text-align: center;
    }
    
    #historyTable th:nth-child(7),
    #historyTable td:nth-child(7) {
        min-width: 80px;
        text-align: center;
    }
    
    #historyTable th:nth-child(8),
    #historyTable td:nth-child(8) {
        min-width: 120px;
    }
    
    #historyTable th:nth-child(9),
    #historyTable td:nth-child(9) {
        min-width: 100px;
        text-align: center;
    }
    
    #historyTable th:nth-child(10),
    #historyTable td:nth-child(10) {
        min-width: 90px;
        text-align: center;
    }
    
    /* Custom scrollbar for table container */
    .table-responsive::-webkit-scrollbar {
        height: 8px;
    }
    
    .table-responsive::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 4px;
    }
    
    .table-responsive::-webkit-scrollbar-thumb {
        background: #888;
        border-radius: 4px;
    }
    
    .table-responsive::-webkit-scrollbar-thumb:hover {
        background: #555;
    }
    
    /* Ensure pagination and info stay outside scroll area */
    .pagination, #historyInfo {
        margin-top: 1rem;
    }
    
    /* Category List */
    .list-group-item {
        border: none;
        padding: 0.75rem 0;
        transition: background-color 0.2s;
    }
    
    .list-group-item:hover {
        background-color: #f8f9fa;
    }
    
    .rounded-pill {
        padding: 0.35rem 0.75rem;
        font-weight: 600;
        font-size: 0.85rem;
    }
    
    /* Quick Action Buttons */
    .quick-action-btn {
        height: 120px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        transition: all 0.3s;
    }
    
    .quick-action-btn:hover {
        transform: translateY(-4px);
        box-shadow: 0 6px 20px rgba(0,0,0,0.15);
    }
    
    /* View Notes Button */
    .btn-view-notes {
        padding: 0.25rem 0.75rem;
        font-size: 0.85rem;
    }
    
    /* Empty states */
    .opacity-25 {
        opacity: 0.25 !important;
    }
    
    /* Table styling */
    .table thead th {
        background-color: #f8f9fa;
        font-weight: 600;
        border-bottom: 1px solid #dee2e6;
    }
    
    .table tbody tr:hover {
        background-color: #f8f9fa;
    }
</style>

<script>
let validatedData = null;

// Tab switching function
function switchUpdaterTab(tabName) {
    // Remove preload styles if they exist
    const preloadStyle = document.getElementById('tab-preload-style');
    if (preloadStyle) {
        preloadStyle.remove();
    }
    
    // Hide all tabs
    document.querySelectorAll('.tab-content-section').forEach(tab => {
        tab.classList.remove('active');
    });
    
    // Show selected tab
    const targetTab = document.getElementById(tabName + '-tab');
    if (targetTab) {
        targetTab.classList.add('active');
    } else {
        console.error('❌ Tab not found:', tabName + '-tab');
    }
    
    // Update sidebar active state
    document.querySelectorAll('.sidebar-nav-item.tab-link').forEach(link => {
        link.classList.remove('active');
    });
    const activeLink = document.querySelector(`[data-tab="${tabName}"]`);
    if (activeLink) {
        activeLink.classList.add('active');
    }
    
    // ✅ Update URL with ?tab= parameter (ensures refresh stays on same tab)
    const url = new URL(window.location);
    url.searchParams.set('tab', tabName);
    window.history.replaceState({}, '', url);
    
    // Save current tab to localStorage (backup mechanism)
    localStorage.setItem('ta_updater_current_tab', tabName);
    
    // Init DataTable if history tab
    if (tabName === 'history' && typeof $ !== 'undefined' && $.fn.DataTable) {
        {% if history %}
        setTimeout(function() {
            if ($.fn.DataTable.isDataTable('#historyTable')) {
                $('#historyTable').DataTable().destroy();
            }
            $('#historyTable').DataTable({
                order: [[0, 'desc']],
                pageLength: 25,
                responsive: true,
                dom: 'Bfrtip',
                buttons: ['csv', 'excel']
            });
        }, 100);
        {% endif %}
    }
    
    // Close mobile sidebar
    if (window.innerWidth < 992) {
        $('#sidebar, #sidebarOverlay').removeClass('active');
    }
    
    // Scroll to top
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

// Override the base template's switchTab for this page
window.switchTab = switchUpdaterTab;

$(document).ready(function() {
    // Fetch and display valid category codes
    const validCategoriesList = document.getElementById('validCategoriesList');
    
    if (validCategoriesList) {
        fetch("{{ url_for('ta.get_valid_category_codes') }}")
            .then(response => response.json())
            .then(data => {
                if (data.success && data.categories) {
                    validCategoriesList.innerHTML = '';
                    if (data.categories.length === 0) {
                        validCategoriesList.innerHTML = '<span class="badge bg-warning" style="font-size: 0.85rem; padding: 6px 10px;">No categories available</span>';
                    } else {
                        data.categories.forEach(cat => {
                            const badge = document.createElement('span');
                            badge.className = 'badge';
                            badge.style.cssText = 'background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); font-size: 0.85rem; padding: 6px 12px; font-weight: 500; box-shadow: 0 2px 4px rgba(0,0,0,0.1);';
                            badge.innerHTML = `<i class="fas fa-code" style="margin-right: 4px; font-size: 0.75rem;"></i><code style="color: white; background: transparent; padding: 0;">${cat.code}</code>`;
                            badge.title = cat.name;
                            validCategoriesList.appendChild(badge);
                        });
                    }
                } else {
                    validCategoriesList.innerHTML = '<span class="badge bg-danger" style="font-size: 0.85rem; padding: 6px 10px;"><i class="fas fa-exclamation-triangle"></i> Failed to load categories</span>';
                }
            })
            .catch(error => {
                console.error('Error fetching categories:', error);
                validCategoriesList.innerHTML = '<span class="badge bg-danger" style="font-size: 0.85rem; padding: 6px 10px;"><i class="fas fa-exclamation-triangle"></i> Error loading categories</span>';
            });
    }
    
    // Dashboard switch detection and tab management
    const urlParams = new URLSearchParams(window.location.search);
    const urlTab = urlParams.get('tab');
    const lastDashboard = sessionStorage.getItem('last_dashboard');
    const currentDashboard = 'ta_updater';
    
    // ✅ FIX: Detect cross-dashboard navigation
    // Check both sessionStorage tracker AND referrer URL to catch all dashboard switches
    let isDashboardSwitch = false;
    
    if (lastDashboard !== null && lastDashboard !== currentDashboard) {
        // Coming from a tracked dashboard that's different
        isDashboardSwitch = true;
    } else if (document.referrer) {
        // Check if referrer is from a different dashboard path
        const referrerPath = new URL(document.referrer).pathname;
        const currentPath = window.location.pathname;
        // If referrer has a different dashboard path (not /ta/), it's a switch
        if (referrerPath.includes('/') && !referrerPath.includes('/ta/') && currentPath.includes('/ta/')) {
            isDashboardSwitch = true;
        }
    }
    
    // Always update current dashboard tracker
    sessionStorage.setItem('last_dashboard', currentDashboard);
    
    let activeTabName;
    
    if (isDashboardSwitch) {
        // Coming from a different dashboard → force overview tab
        activeTabName = 'overview';
        localStorage.removeItem('ta_updater_current_tab');
        const url = new URL(window.location);
        url.searchParams.set('tab', 'overview');
        window.history.replaceState({}, '', url);
    } else if (urlTab) {
        // URL has explicit tab parameter → use it
        const validTabs = ['overview', 'single-request', 'bulk-upload', 'history'];
        activeTabName = validTabs.includes(urlTab) ? urlTab : 'overview';
    } else {
        // Same dashboard refresh → restore last active tab
        activeTabName = localStorage.getItem('ta_updater_current_tab') || 'overview';
    }
    
    // Remove all active states first
    document.querySelectorAll('.tab-content-section').forEach(tab => {
        tab.classList.remove('active');
    });
    document.querySelectorAll('.sidebar-nav-item.tab-link').forEach(link => {
        link.classList.remove('active');
    });
    
    // Activate the saved tab
    const activeTab = document.getElementById(activeTabName + '-tab');
    if (activeTab) {
        activeTab.classList.add('active');
    }
    const activeLink = document.querySelector('[data-tab="' + activeTabName + '"]');
    if (activeLink) {
        activeLink.classList.add('active');
    }
    
    // Update URL with tab parameter
    const url = new URL(window.location);
    url.searchParams.set('tab', activeTabName);
    window.history.replaceState({}, '', url);
    
    // Tab click handlers
    $('.tab-link').on('click', function(e) {
        e.preventDefault();
        switchUpdaterTab($(this).data('tab'));
    });
    
    // Points preview
    function updatePointsPreview() {
        const points = parseInt($('#category_id option:selected').data('points')) || 0;
        const qty = parseInt($('#quantity').val()) || 0;
        $('#points_preview').text('Total points: ' + (points * qty));
    }
    $('#category_id, #quantity').on('change keyup', updatePointsPreview);
    
    // Date exclusivity
    $('#award_month_year').on('change', function() {
        $('#event_date').prop('disabled', !!$(this).val()).val('');
    });
    $('#event_date').on('change', function() {
        $('#award_month_year').prop('disabled', !!$(this).val()).val('');
    });
    
    // View notes modal
    $(document).on('click', '.btn-view-notes', function() {
        const notes = $(this).data('notes');
        const employee = $(this).data('employee');
        const status = $(this).data('status');
        
        $('#modalEmployeeName').text(employee);
        $('#modalNotesContent').text(notes);
        
        let badge = '';
        if (status === 'Approved') badge = '<span class="badge bg-success"><i class="fas fa-check-circle"></i> Approved</span>';
        else if (status === 'Rejected') badge = '<span class="badge bg-danger"><i class="fas fa-times-circle"></i> Rejected</span>';
        else badge = '<span class="badge bg-warning text-dark"><i class="fas fa-clock"></i> Pending</span>';
        $('#modalStatus').html(badge);
        
        new bootstrap.Modal($('#notesModal')).show();
    });
});

// Single request confirm
function confirmSingleRequest() {
    const form = $('#singleRequestForm')[0];
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }
    
    const cat = $('#category_id option:selected');
    const val = $('#validator_id option:selected');
    const empId = $('#employee_id').val();
    const qty = $('#quantity').val();
    const points = parseInt(cat.data('points')) * parseInt(qty);
    const dateValue = $('#event_date').val();
    const month = $('#award_month_year option:selected').text();
    const notes = $('#notes').val();
    
    // Convert date from YYYY-MM-DD to DD-MM-YYYY format
    let formattedDate = 'Current Date';
    if (dateValue) {
        const dateParts = dateValue.split('-');
        formattedDate = `${dateParts[2]}-${dateParts[1]}-${dateParts[0]}`;
    }
    
    $('#confirm_category').text(cat.data('name'));
    $('#confirm_validator').text(val.data('name') + ' (' + val.data('emp-id') + ')');
    $('#confirm_employee_id').text(empId);
    $('#confirm_quantity').text(qty);
    $('#confirm_points').text(points);
    $('#confirm_event_date').text(month !== '-- Use Event Date --' ? month : formattedDate);
    // Use text() to preserve line breaks and prevent XSS
    $('#confirm_notes').text(notes);
    
    new bootstrap.Modal($('#singleRequestConfirmModal')).show();
}

function submitSingleRequest() {
    bootstrap.Modal.getInstance($('#singleRequestConfirmModal')).hide();
    $('#singleRequestForm').submit();
}

// Bulk upload
function validateBulkUpload() {
    const form = $('#bulkUploadForm')[0];
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }
    
    const btn = event.target;
    const orig = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Validating...';
    
    fetch("{{ url_for('ta.validate_bulk_upload') }}", {
        method: 'POST',
        body: new FormData(form)
    })
    .then(r => r.json())
    .then(data => {
        btn.disabled = false;
        btn.innerHTML = orig;
        if (!data.success) {
            alert('Error: ' + data.error);
            return;
        }
        validatedData = data;
        displayBulkConfirmation(data);
    })
    .catch(e => {
        btn.disabled = false;
        btn.innerHTML = orig;
        alert('Error: ' + e);
    });
}

function displayBulkConfirmation(data) {
    const {valid_rows, invalid_rows, category_name} = data;
    
    $('#bulk_total_count').text(valid_rows.length + invalid_rows.length);
    $('#bulk_valid_count').text(valid_rows.length);
    $('#bulk_invalid_count').text(invalid_rows.length);
    $('#valid_tab_count').text(valid_rows.length);
    $('#invalid_tab_count').text(invalid_rows.length);
    $('#bulk_category_name').text(category_name);
    $('#bulk_submit_count').text(valid_rows.length);
    
    $('#invalid_warning').toggle(invalid_rows.length > 0);
    $('#bulk_submit_btn').prop('disabled', valid_rows.length === 0);
    
    let validHtml = '';
    valid_rows.forEach((r, i) => {
        validHtml += `<tr><td>${i+1}</td><td><strong>${r.employee_id}</strong></td><td>${r.validator_name}</td><td>${r.event_date}</td><td>${r.quantity}</td><td><strong>${r.points}</strong></td><td><small>${r.notes.substring(0,40)}...</small></td></tr>`;
    });
    $('#valid_rows_body').html(validHtml || '<tr><td colspan="7" class="text-center text-muted">None</td></tr>');
    
    let invalidHtml = '';
    invalid_rows.forEach(r => {
        const employeeName = r.employee_name || 'N/A';
        const employeeGrade = r.employee_grade ? `<span class="badge bg-secondary">${r.employee_grade}</span>` : 'N/A';
        invalidHtml += `<tr>
            <td><span class="badge bg-danger">${r.row_number}</span></td>
            <td>${r.employee_id||'N/A'}</td>
            <td>${employeeName}</td>
            <td>${employeeGrade}</td>
            <td>${r.validator_employee_id||'N/A'}</td>
            <td class="text-danger"><small><strong>${r.error}</strong></small></td>
        </tr>`;
    });
    $('#invalid_rows_body').html(invalidHtml || '<tr><td colspan="6" class="text-center text-muted">None</td></tr>');
    
    new bootstrap.Modal($('#bulkUploadConfirmModal')).show();
}

function submitBulkUpload() {
    if (!validatedData?.valid_rows?.length) {
        alert('No valid rows');
        return;
    }
    
    bootstrap.Modal.getInstance($('#bulkUploadConfirmModal')).hide();
    
    const fd = new FormData($('#bulkUploadForm')[0]);
    fd.append('validated_data', JSON.stringify(validatedData.valid_rows));
    fd.append('action_type', 'bulk_upload_confirmed');
    
    // Ensure category_id is included
    if (validatedData.category_id) {
        fd.append('bulk_category_id', validatedData.category_id);
    }
    
    fetch("{{ url_for('ta.updater_dashboard') }}", {
        method: 'POST',
        body: fd
    }).then(r => {
        if (r.redirected) {
            window.location.href = r.url;
        } else {
            return r.text().then(text => {
                alert('Unexpected response: ' + text);
            });
        }
    }).catch(e => {
        console.error('Fetch error:', e);
        alert('Error: ' + e);
    });
}

// Department-Grade-Employee cascading dropdowns (like PMO)
$(document).ready(function() {
    const departmentGradesMap = {{ department_grades_map|tojson|safe }};
    
    const deptSelect = $('#department');
    const gradeSelect = $('#grade');
    const empSelect = $('#employee_id');
    
    if (!deptSelect.length || !gradeSelect.length || !empSelect.length) {
        console.warn('Department/Grade/Employee selects not found');
        return;
    }
    
    // Department change handler
    deptSelect.on('change', function() {
        const dept = this.value;
        
        // Clear and disable grade and employee dropdowns
        gradeSelect.html('<option value="">-- Select Grade --</option>').prop('disabled', !dept);
        empSelect.html('<option value="">-- Select Grade First --</option>').prop('disabled', true);
        
        if (!dept) return;
        
        // Populate grades
        if (dept === 'all') {
            // Add "All Grades" option
            gradeSelect.append('<option value="all">All Grades</option>');
            
            // Get unique grades from all departments
            const allGrades = [...new Set(Object.values(departmentGradesMap).flat())].sort();
            allGrades.forEach(grade => {
                if (grade && grade.trim()) {
                    gradeSelect.append(`<option value="${grade}">${grade}</option>`);
                }
            });
        } else if (departmentGradesMap[dept]) {
            // Populate grades for selected department
            departmentGradesMap[dept].forEach(grade => {
                if (grade && grade.trim()) {
                    gradeSelect.append(`<option value="${grade}">${grade}</option>`);
                }
            });
        }
    });
    
    // Grade change handler
    gradeSelect.on('change', async function() {
        const grade = this.value;
        const dept = deptSelect.val();
        
        // Clear and disable employee dropdown if no grade selected
        if (!grade) {
            empSelect.html('<option value="">-- Select Grade First --</option>').prop('disabled', true);
            return;
        }
        
        // Enable and show loading
        empSelect.prop('disabled', false).html('<option value="">Loading...</option>');
        
        try {
            const formData = new FormData();
            formData.append('department', dept);
            formData.append('grade', grade);
            
            const response = await fetch('{{ url_for("ta.get_employees_by_department_grade") }}', {
                method: 'POST',
                body: formData
            });
            const data = await response.json();
            
            empSelect.html('<option value="">-- Select Employee --</option>');
            
            if (data.success && data.employees) {
                data.employees.forEach(emp => {
                    empSelect.append(`<option value="${emp.employee_id}">${emp.name} (${emp.employee_id})</option>`);
                });
            } else {
                console.error('Error fetching employees:', data.error);
                empSelect.html('<option value="">No employees found</option>');
            }
        } catch (error) {
            console.error('Fetch error:', error);
            empSelect.html('<option value="">Error loading employees</option>');
        }
    });
});

// History table filtering functions
let currentPage = 1;
let pageSize = 10;
let filteredRows = [];

function filterHistoryTable() {
    const year = document.getElementById('historyYearFilter').value;
    const quarter = document.getElementById('historyQuarterFilter').value;
    const grade = document.getElementById('historyGradeFilter').value;
    const status = document.getElementById('historyStatusFilter').value;
    const searchText = document.getElementById('historySearchInput').value.toLowerCase();
    
    const rows = document.querySelectorAll('#historyTableBody .history-row');
    filteredRows = [];
    
    rows.forEach(row => {
        const matchYear = !year || row.getAttribute('data-year') === year;
        const matchQuarter = !quarter || row.getAttribute('data-quarter') === quarter;
        const matchGrade = !grade || row.getAttribute('data-grade') === grade;
        const matchStatus = !status || row.getAttribute('data-status') === status;
        
        // Search in all text content
        const matchSearch = !searchText || row.textContent.toLowerCase().includes(searchText);
        
        const isVisible = matchYear && matchQuarter && matchGrade && matchStatus && matchSearch;
        
        if (isVisible) {
            filteredRows.push(row);
        }
        
        row.style.display = 'none'; // Hide all initially
    });
    
    // Reset to first page
    currentPage = 1;
    updateHistoryPagination();
}

function resetHistoryFilters() {
    document.getElementById('historyYearFilter').value = '';
    document.getElementById('historyQuarterFilter').value = '';
    document.getElementById('historyGradeFilter').value = '';
    document.getElementById('historyStatusFilter').value = '';
    document.getElementById('historySearchInput').value = '';
    
    // Reset filtered rows to all rows
    filteredRows = Array.from(document.querySelectorAll('#historyTableBody .history-row'));
    currentPage = 1;
    updateHistoryPagination();
}

function changeHistoryPageSize() {
    pageSize = parseInt(document.getElementById('historyPageSize').value);
    currentPage = 1;
    updateHistoryPagination();
}

function updateHistoryPagination() {
    const totalRows = filteredRows.length;
    const totalPages = Math.ceil(totalRows / pageSize);
    
    // Hide all rows first
    document.querySelectorAll('#historyTableBody .history-row').forEach(row => {
        row.style.display = 'none';
    });
    
    // Show only current page rows
    const startIndex = (currentPage - 1) * pageSize;
    const endIndex = Math.min(startIndex + pageSize, totalRows);
    
    for (let i = startIndex; i < endIndex; i++) {
        if (filteredRows[i]) {
            filteredRows[i].style.display = '';
        }
    }
    
    // Update info text
    const infoText = totalRows === 0 
        ? 'Showing 0 to 0 of 0 entries'
        : `Showing ${startIndex + 1} to ${endIndex} of ${totalRows} entries`;
    document.getElementById('historyInfo').textContent = infoText;
    
    // Update pagination buttons
    const paginationEl = document.getElementById('historyPagination');
    let paginationHTML = '';
    
    // Previous button
    paginationHTML += `<li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
        <a class="page-link" href="#" onclick="goToHistoryPage(${currentPage - 1}); return false;">Previous</a>
    </li>`;
    
    // Page numbers
    const maxVisiblePages = 5;
    let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
    let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
    
    if (endPage - startPage < maxVisiblePages - 1) {
        startPage = Math.max(1, endPage - maxVisiblePages + 1);
    }
    
    for (let i = startPage; i <= endPage; i++) {
        paginationHTML += `<li class="page-item ${i === currentPage ? 'active' : ''}">
            <a class="page-link" href="#" onclick="goToHistoryPage(${i}); return false;">${i}</a>
        </li>`;
    }
    
    // Next button
    paginationHTML += `<li class="page-item ${currentPage === totalPages || totalPages === 0 ? 'disabled' : ''}">
        <a class="page-link" href="#" onclick="goToHistoryPage(${currentPage + 1}); return false;">Next</a>
    </li>`;
    
    paginationEl.innerHTML = paginationHTML;
}

function goToHistoryPage(page) {
    const totalPages = Math.ceil(filteredRows.length / pageSize);
    if (page < 1 || page > totalPages) return;
    currentPage = page;
    updateHistoryPagination();
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    // Initialize filtered rows with all rows
    filteredRows = Array.from(document.querySelectorAll('#historyTableBody .history-row'));
    updateHistoryPagination();
});
</script>
{% endblock %}