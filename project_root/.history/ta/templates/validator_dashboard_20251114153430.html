{% extends "ta_base.html" %}

{% block title %}TA Validator Dashboard{% endblock %}
{% block dashboard_title %}TA Validator Dashboard{% endblock %}

{% block extra_css %}

{% endblock %}

{% block sidebar_nav %}
<!-- Validator Navigation Items -->
<a href="javascript:void(0);" class="sidebar-nav-item tab-link" data-tab="overview" onclick="switchTab('overview')">
    <div>
        <i class="fas fa-tachometer-alt"></i>
        <span>Dashboard</span>
    </div>
</a>

<a href="javascript:void(0);" class="sidebar-nav-item tab-link" data-tab="review" onclick="switchTab('review')">
    <div>
        <i class="fas fa-check-square"></i>
        <span>Review Requests</span>
        <span class="badge bg-warning" style="display: {{ 'inline-block' if pending_count > 0 else 'none' }};">{{ pending_count if pending_count > 0 else '0' }}</span>
    </div>
</a>

<a href="javascript:void(0);" class="sidebar-nav-item tab-link" data-tab="history" onclick="switchTab('history')">
    <div>
        <i class="fas fa-history"></i>
        <span>History</span>
    </div>
</a>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Overview Tab (Dashboard Summary) -->
    <div class="tab-content-section" id="overview-tab">
        <!-- Stats Cards Row -->
        <div class="row mb-4">
            <div class="col-xl-4 col-md-6 mb-3">
                <div class="card border-left-warning shadow h-100">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col">
                                <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">Pending Requests</div>
                                <div class="h5 mb-0 font-weight-bold" data-pending-count>{{ pending_count }}</div>
                            </div>
                            <div class="col-auto">
                                <i class="fas fa-clock fa-2x text-warning" style="opacity: 0.3;"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-xl-4 col-md-6 mb-3">
                <div class="card border-left-success shadow h-100">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col">
                                <div class="text-xs font-weight-bold text-success text-uppercase mb-1">Approved</div>
                                <div class="h5 mb-0 font-weight-bold">{{ history_data|selectattr('status', 'equalto', 'Approved')|list|length if history_data else 0 }}</div>
                            </div>
                            <div class="col-auto">
                                <i class="fas fa-check-circle fa-2x text-success" style="opacity: 0.3;"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-xl-4 col-md-6 mb-3">
                <div class="card border-left-danger shadow h-100">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col">
                                <div class="text-xs font-weight-bold text-danger text-uppercase mb-1">Rejected</div>
                                <div class="h5 mb-0 font-weight-bold">{{ history_data|selectattr('status', 'equalto', 'Rejected')|list|length if history_data else 0 }}</div>
                            </div>
                            <div class="col-auto">
                                <i class="fas fa-times-circle fa-2x text-danger" style="opacity: 0.3;"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Action Button -->
        {% if pending_count > 0 %}
        <div class="row mb-4">
            <div class="col-12">
                <div class="card shadow-sm border-0" style="background-color: #2c5aa0;">
                    <div class="card-body text-white text-center py-4">
                        <h4 class="mb-3"><i class="fas fa-bell me-2"></i>{{ pending_count }} Request(s) Awaiting Your Review</h4>
                        <button class="btn btn-light btn-lg px-5" onclick="switchTab('review')">
                            <i class="fas fa-check-square me-2"></i>Review Requests
                        </button>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Recent Activity -->
        <div class="row">
            <div class="col-12">
                <div class="card shadow-sm">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="fas fa-clock me-2"></i>Recent Activity</h5>
                    </div>
                    <div class="card-body">
                        {% if history_data %}
                        <div class="timeline">
                            {% for item in history_data[:5] %}
                            <div class="timeline-item mb-3 pb-3 border-bottom">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div class="flex-grow-1">
                                        <div class="d-flex align-items-center mb-1">
                                            <span class="badge bg-{{ 'success' if item.status == 'Approved' else 'danger' if item.status == 'Rejected' else 'warning' }} me-2">
                                                {{ item.status }}
                                            </span>
                                            <strong>{{ item.employee }}</strong>
                                        </div>
                                        <div class="text-muted small">
                                            <i class="fas fa-tag me-1"></i>{{ item.category }}
                                            <span class="mx-2">â€¢</span>
                                            <i class="fas fa-coins me-1"></i>{{ item.points }} points
                                        </div>
                                    </div>
                                    <div class="text-end text-muted small">
                                        {{ item.event_date if item.event_date else 'N/A' }}
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        {% else %}
                        <div class="text-center text-muted py-4">
                            <i class="fas fa-inbox fa-3x mb-3 d-block opacity-25"></i>
                            <p>No activity yet.</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Review Requests Tab -->
    <div class="tab-content-section" id="review-tab">
        <div class="card shadow-sm border-0">
            <div class="card-header" style="background-color: #2c5aa0; padding: 15px 20px;">
                <h5 class="mb-0 text-white" style="font-weight: 600;">
                    <i class="fas fa-check-square"></i> Review Pending Requests
                </h5>
            </div>
            <div class="card-body p-4" style="background-color: #ffffff;">
                {% if validator_requests %}
                <form method="POST" action="{{ url_for('ta.validator_dashboard') }}" id="reviewForm">
                    <input type="hidden" name="action_type" id="action_type">
                    
                    <!-- Pagination Controls Top -->
                    <div class="row mb-3 align-items-center">
                        <div class="col-md-6">
                            <div class="d-flex align-items-center">
                                <span class="me-2 small">Show</span>
                                <select class="form-select form-select-sm" style="width: 80px;" id="reviewPageSize" onchange="changeReviewPageSize()">
                                    <option value="10" selected>10</option>
                                    <option value="25">25</option>
                                    <option value="50">50</option>
                                </select>
                                <span class="ms-2 small">entries</span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="d-flex gap-2 align-items-center justify-content-end">
                                <span class="small">Search:</span>
                                <input type="text" class="form-control form-control-sm" placeholder="Search..." id="reviewSearchInput" onkeyup="searchReviewTable()" onkeydown="if(event.key === 'Enter') event.preventDefault();" style="max-width: 200px;">
                            </div>
                        </div>
                    </div>

                    
                    <div class="table-responsive" style="max-height: 500px; overflow-y: auto;">
                        <table class="table table-hover mb-0" style="font-size: 0.9rem;" id="reviewRequestsTable">
                            <thead style="position: sticky; top: 0; z-index: 10; background-color: #f8f9fa;">
                                <tr style="border-bottom: 2px solid #dee2e6;">
                                    <th style="width: 50px; padding: 12px 8px; white-space: nowrap;"><input type="checkbox" id="selectAll"></th>
                                    <th style="width: 120px; padding: 12px 8px; font-weight: 600; color: #495057; white-space: nowrap; text-transform: uppercase; font-size: 0.75rem;">EVENT DATE</th>
                                    <th style="width: 180px; padding: 12px 8px; font-weight: 600; color: #495057; white-space: nowrap; text-transform: uppercase; font-size: 0.75rem;">EMPLOYEE</th>
                                    <th style="width: 130px; padding: 12px 8px; font-weight: 600; color: #495057; white-space: nowrap; text-transform: uppercase; font-size: 0.75rem; text-align: center;">SUBMITTED BY</th>
                                    <th style="width: 160px; padding: 12px 8px; font-weight: 600; color: #495057; white-space: nowrap; text-transform: uppercase; font-size: 0.75rem;">CATEGORY</th>
                                    <th style="width: 100px; padding: 12px 8px; font-weight: 600; color: #495057; white-space: nowrap; text-transform: uppercase; font-size: 0.75rem; text-align: center;">POINTS</th>
                                    <th style="width: 150px; padding: 12px 8px; font-weight: 600; color: #495057; white-space: nowrap; text-transform: uppercase; font-size: 0.75rem; text-align: center;">REQUEST NOTES</th>
                                    <th style="width: 130px; padding: 12px 8px; font-weight: 600; color: #495057; white-space: nowrap; text-transform: uppercase; font-size: 0.75rem; text-align: center;">ACTIONS</th>
                                </tr>
                            </thead>
                            <tbody id="reviewRequestsBody">
                                {% for req in validator_requests %}
                                <tr class="review-row">
                                    <td style="padding: 10px 8px;"><input type="checkbox" name="selected_requests" value="{{ req.request_id }}"></td>
                                    <td style="padding: 10px 8px;">{{ req.event_date }}</td>
                                    <td style="padding: 10px 8px;">{{ req.employee_name }} ({{ req.employee_id }})</td>
                                    <td style="padding: 10px 8px; text-align: center;">{{ req.updater_name }}</td>
                                    <td style="padding: 10px 8px;">{{ req.category_name }}</td>
                                    <td style="padding: 10px 8px; text-align: center;">{{ req.points }} pts</td>
                                    <td style="padding: 10px 8px; text-align: center;">
                                        <button type="button" class="btn btn-sm btn-info view-notes-btn" style="padding: 4px 12px; white-space: nowrap;" 
                                                data-notes="{{ (req.notes if req.notes else 'No notes provided') | replace('"', '&quot;') | replace("'", '&#39;') }}" 
                                                title="View Notes">
                                            View
                                        </button>
                                    </td>
                                    <td style="padding: 10px 8px; text-align: center;">
                                        <button type="button" class="btn btn-sm btn-success me-1" 
                                                onclick="singleAction('{{ req.request_id }}', 'approve')" style="padding: 4px 8px;">
                                            <i class="fas fa-check"></i>
                                        </button>
                                        <button type="button" class="btn btn-sm btn-danger" 
                                                onclick="singleAction('{{ req.request_id }}', 'reject')" style="padding: 4px 8px;">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    <!-- Pagination Bottom -->
                    <div class="d-flex justify-content-between align-items-center mt-3">
                        <div class="small text-muted" id="reviewInfoBottom">Showing 1 to 10 of {{ validator_requests|length }} entries</div>
                        <nav>
                            <ul class="pagination pagination-sm mb-0" id="reviewPagination">
                                <li class="page-item disabled"><a class="page-link" href="#" onclick="changeReviewPage('prev'); return false;">Previous</a></li>
                                <li class="page-item active"><a class="page-link" href="#" onclick="changeReviewPage(1); return false;">1</a></li>
                                <li class="page-item"><a class="page-link" href="#" onclick="changeReviewPage('next'); return false;">Next</a></li>
                            </ul>
                        </nav>
                    </div>
                    
                    <!-- Bulk Action Buttons -->
                    <div class="d-flex justify-content-end gap-2 mt-3">
                        <button type="button" class="btn btn-success" onclick="bulkAction('bulk_approve')">
                            <i class="fas fa-check me-2"></i>Approve Selected
                        </button>
                        <button type="button" class="btn btn-danger" onclick="bulkAction('bulk_reject')">
                            <i class="fas fa-times me-2"></i>Reject Selected
                        </button>
                    </div>
                </form>
                {% else %}
                <div class="alert alert-info text-center">
                    <i class="fas fa-info-circle fa-3x mb-3"></i>
                    <h5>No Pending Requests</h5>
                    <p class="mb-0">All requests have been reviewed</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- History Tab -->
    <div class="tab-content-section" id="history-tab">
        <div class="card shadow-sm border-0">
            <div class="card-header" style="background-color: #2c5aa0; padding: 15px 20px;">
                <h5 class="mb-0 text-white" style="font-weight: 600;">
                    <i class="fas fa-history"></i> Action History
                </h5>
            </div>
            <div class="card-body p-4">
                {% if history_data %}
                <!-- Filters Row -->
                <div class="row mb-3 g-2">
                    <div class="col-md-2">
                        <label class="form-label small text-muted mb-1">Year</label>
                        <select class="form-select form-select-sm" id="historyYearFilter">
                            <option value="">All</option>
                            {% for year in year_options %}
                            <option value="{{ year }}">{{ year }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label small text-muted mb-1">Quarter</label>
                        <select class="form-select form-select-sm" id="historyQuarterFilter">
                            <option value="">All</option>
                            {% for q in quarter_options %}
                            <option value="{{ q }}">{{ q }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label small text-muted mb-1">Grade</label>
                        <select class="form-select form-select-sm" id="historyGradeFilter">
                            <option value="">All</option>
                            {% for grade in grades %}
                            <option value="{{ grade }}">{{ grade }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label small text-muted mb-1">Status</label>
                        <select class="form-select form-select-sm" id="historyStatusFilter">
                            <option value="">All</option>
                            <option value="Approved">Approved</option>
                            <option value="Rejected">Rejected</option>
                        </select>
                    </div>
                    <div class="col-md-4 d-flex align-items-end gap-1">
                        <button class="btn btn-sm btn-primary" onclick="filterHistoryTable()" style="flex: 1;">
                            <i class="fas fa-filter"></i> Apply
                        </button>
                        <button class="btn btn-sm btn-outline-secondary" onclick="resetHistoryFilters()" style="flex: 1;">
                            <i class="fas fa-redo"></i> Reset
                        </button>
                    </div>
                </div>

                <div class="row mb-3 align-items-center">
                    <div class="col-md-3">
                        <div class="d-flex align-items-center">
                            <span class="me-2 small">Show</span>
                            <select class="form-select form-select-sm" style="width: 80px;" id="historyPageSize" onchange="changeHistoryPageSize()">
                                <option value="10" selected>10</option>
                                <option value="25">25</option>
                                <option value="50">50</option>
                            </select>
                            <span class="ms-2 small">entries</span>
                        </div>
                    </div>
                    <div class="col-md-6"></div>
                    <div class="col-md-3">
                        <div class="d-flex gap-2 align-items-center justify-content-end">
                            <span class="small">Search:</span>
                            <input type="text" class="form-control form-control-sm" placeholder="Search..." id="historySearchInput" onkeyup="filterHistoryTable()" style="max-width: 200px;">
                        </div>
                    </div>
                </div>

                <!-- Table -->
                <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                    <table class="table table-hover mb-0" style="font-size: 0.9rem;">
                        <thead style="position: sticky; top: 0; z-index: 10; background-color: #f8f9fa;">
                            <tr style="border-bottom: 2px solid #dee2e6;">
                                <th style="padding: 12px 8px; font-weight: 600; color: #495057; white-space: nowrap; text-transform: uppercase; font-size: 0.75rem;">EVENT DATE</th>
                                <th style="padding: 12px 8px; font-weight: 600; color: #495057; white-space: nowrap; text-transform: uppercase; font-size: 0.75rem;">EMPLOYEE</th>
                                <th style="padding: 12px 8px; font-weight: 600; color: #495057; white-space: nowrap; text-transform: uppercase; font-size: 0.75rem;">GRADE</th>
                                <th style="padding: 12px 8px; font-weight: 600; color: #495057; white-space: nowrap; text-transform: uppercase; font-size: 0.75rem;">CATEGORY</th>
                                <th style="padding: 12px 8px; font-weight: 600; color: #495057; white-space: nowrap; text-transform: uppercase; font-size: 0.75rem; text-align: center;">POINTS</th>
                                <th style="padding: 12px 8px; font-weight: 600; color: #495057; white-space: nowrap; text-transform: uppercase; font-size: 0.75rem; text-align: center;">STATUS</th>
                                <th style="padding: 12px 8px; font-weight: 600; color: #495057; white-space: nowrap; text-transform: uppercase; font-size: 0.75rem; text-align: center;">NOTES</th>
                            </tr>
                        </thead>
                        <tbody id="historyTableBody">
                            {% for h in history_data %}
                            {% set month = h.date.split('-')[1]|int %}
                            {% set year = h.date.split('-')[2] %}
                            {% set quarter = 'Q1' if month in [4,5,6] else 'Q2' if month in [7,8,9] else 'Q3' if month in [10,11,12] else 'Q4' if month in [1,2,3] else '' %}
                            <tr class="history-row"
                                data-year="{{ year }}"
                                data-quarter="{{ quarter }}"
                                data-grade="{{ h.grade }}"
                                data-status="{{ h.status }}">
                                <td style="padding: 10px 8px; white-space: nowrap;">{{ h.event_date }}</td>
                                <td style="padding: 10px 8px; white-space: nowrap;">{{ h.employee }}</td>
                                <td style="padding: 10px 8px;"><span class="badge bg-secondary">{{ h.grade }}</span></td>
                                <td style="padding: 10px 8px;">{{ h.category }}</td>
                                <td style="padding: 10px 8px; text-align: center;">{{ h.points }}</td>
                                <td style="padding: 10px 8px; text-align: center;">
                                    <span class="badge" style="background-color: {{ '#28a745' if h.status == 'Approved' else '#dc3545' }}; color: #fff; font-weight: 600; padding: 4px 12px;">
                                        {{ h.status }}
                                    </span>
                                </td>
                                <td style="padding: 10px 8px; text-align: center;">
                                    <button type="button" class="btn btn-sm btn-info view-history-notes-btn" style="padding: 4px 12px;" 
                                            data-notes="{{ (h.notes if h.notes else 'No notes') | replace('"', '&quot;') | replace("'", '&#39;') }}"
                                            title="View Notes">
                                        View
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <!-- Pagination -->
                <div class="d-flex justify-content-between align-items-center mt-3">
                    <div class="small text-muted" id="historyInfo">Showing 1 to 10 of entries</div>
                    <nav>
                        <ul class="pagination pagination-sm mb-0" id="historyPagination">
                            <li class="page-item disabled"><a class="page-link" href="#">Previous</a></li>
                            <li class="page-item active"><a class="page-link" href="#">1</a></li>
                            <li class="page-item"><a class="page-link" href="#">Next</a></li>
                        </ul>
                    </nav>
                </div>
                {% else %}
                <div class="alert alert-info text-center">
                    <i class="fas fa-info-circle fa-3x mb-3"></i>
                    <h5>No History</h5>
                    <p class="mb-0">No requests have been processed yet</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Notes Modal -->
    <div class="modal fade" id="notesModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header" style="background-color: #2c5aa0; color: white;">
                    <h5 class="modal-title"><i class="fas fa-sticky-note me-2"></i>Request Notes</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
                    <div id="modalNotes" class="p-3" style="background-color: #f8f9fa; border-radius: 4px; min-height: 100px; white-space: pre-wrap; word-wrap: break-word;"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal"><i class="fas fa-times me-1"></i>Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Action Confirmation Modal -->
    <div class="modal fade" id="actionConfirmModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header" id="actionModalHeader">
                    <h5 class="modal-title" id="actionModalTitle"></h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <form id="actionConfirmForm">
                    <div class="modal-body">
                        <input type="hidden" id="action_request_id">
                        <input type="hidden" id="action_type_value">
                        
                        <div class="mb-3">
                            <p id="actionConfirmMessage" class="mb-3"></p>
                        </div>
                        
                        <div class="mb-3">
                            <label for="action_notes" class="form-label fw-bold">
                                Notes <span class="text-danger">*</span>
                            </label>
                            <textarea class="form-control" id="action_notes" name="notes" rows="4" 
                                      placeholder="Enter your notes for this action..." required></textarea>
                            <small class="text-muted">Please provide a reason or comment for this action</small>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            <i class="fas fa-times me-1"></i> Cancel
                        </button>
                        <button type="submit" class="btn" id="actionConfirmBtn">
                            <i class="fas fa-check me-1"></i> Confirm
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Bulk Confirmation Modal -->
    <div class="modal fade" id="bulkConfirmModal" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header" id="bulkModalHeader">
                    <h5 class="modal-title" id="bulkModalTitle"></h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info mb-3" id="bulkSummary"></div>
                    
                    <h6 class="mb-3">Selected Requests:</h6>
                    <div class="table-responsive" style="max-height: 400px;">
                        <table class="table table-sm table-hover">
                            <thead class="table-light sticky-top">
                                <tr>
                                    <th>Employee</th>
                                    <th>Category</th>
                                    <th>Points</th>
                                    <th>Date</th>
                                </tr>
                            </thead>
                            <tbody id="bulkRequestsList"></tbody>
                        </table>
                    </div>
                    
                    <div class="mt-3" id="bulkNotesSection" style="display: none;">
                        <label for="bulk_notes" class="form-label fw-bold">
                            Notes <span class="text-danger">*</span>
                        </label>
                        <textarea class="form-control" id="bulk_notes" rows="3" 
                                  placeholder="Enter notes for this bulk action..." required></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i> Cancel
                    </button>
                    <button type="button" class="btn" id="bulkConfirmBtn" onclick="confirmBulkAction()">
                        <i class="fas fa-check me-1"></i> Confirm
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<style>
    /* Tab visibility control - ensure only active tab shows */
    .tab-content-section {
        display: none !important;
    }
    .tab-content-section.active {
        display: block !important;
    }
    
    /* Stat card styling */
    .border-left-warning {
        border-left: 4px solid #f6c23e;
    }
    .border-left-success {
        border-left: 4px solid #1cc88a;
    }
    .border-left-danger {
        border-left: 4px solid #e74a3b;
    }
    .text-xs {
        font-size: 0.7rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    .h5 {
        font-size: 1.75rem;
        font-weight: 700;
    }
    
    /* Timeline styling */
    .timeline {
        max-height: 400px;
        overflow-y: auto;
    }
    .timeline-item {
        transition: all 0.2s;
        padding: 0.75rem;
        border-radius: 6px;
    }
    .timeline-item:hover {
        background-color: #f8f9fa;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    .opacity-25 {
        opacity: 0.25 !important;
    }
</style>

<script>
let currentReviewPage = 1;
let reviewPageSize = 10;
let currentHistoryPage = 1;
let historyPageSize = 10;

function switchTab(tabName) {
    // Hide all tabs
    document.querySelectorAll('.tab-content-section').forEach(tab => {
        tab.classList.remove('active');
    });
    
    // Show selected tab
    document.getElementById(tabName + '-tab').classList.add('active');
    
    // Update sidebar
    document.querySelectorAll('.sidebar-nav-item.tab-link').forEach(link => {
        link.classList.remove('active');
    });
    document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
    
    // Save to localStorage so it persists on refresh
    localStorage.setItem('ta_validator_current_tab', tabName);
    
    // Scroll to top
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

// Restore tab on page load
document.addEventListener('DOMContentLoaded', function() {
    // Restore saved tab or default to overview
    const savedTab = localStorage.getItem('ta_validator_current_tab') || 'overview';
    switchTab(savedTab);
    
    // Select all checkbox
    document.getElementById('selectAll').addEventListener('change', function() {
        document.querySelectorAll('input[name="selected_requests"]').forEach(cb => cb.checked = this.checked);
    });
    
    // View notes buttons
    document.querySelectorAll('.view-notes-btn, .view-history-notes-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const notes = this.getAttribute('data-notes');
            document.getElementById('modalNotes').textContent = notes;
            new bootstrap.Modal(document.getElementById('notesModal')).show();
        });
    });
});

function singleAction(requestId, action) {
    const modal = document.getElementById('actionConfirmModal');
    const header = document.getElementById('actionModalHeader');
    const title = document.getElementById('actionModalTitle');
    const message = document.getElementById('actionConfirmMessage');
    const btn = document.getElementById('actionConfirmBtn');
    
    document.getElementById('action_request_id').value = requestId;
    document.getElementById('action_type_value').value = action;
    document.getElementById('action_notes').value = '';
    
    if (action === 'approve') {
        header.style.backgroundColor = '#28a745';
        header.style.color = 'white';
        title.innerHTML = '<i class="fas fa-check-circle me-2"></i>Approve Request';
        message.textContent = 'Are you sure you want to approve this request?';
        btn.className = 'btn btn-success';
        btn.innerHTML = '<i class="fas fa-check me-1"></i> Approve';
    } else {
        header.style.backgroundColor = '#dc3545';
        header.style.color = 'white';
        title.innerHTML = '<i class="fas fa-times-circle me-2"></i>Reject Request';
        message.textContent = 'Are you sure you want to reject this request?';
        btn.className = 'btn btn-danger';
        btn.innerHTML = '<i class="fas fa-times me-1"></i> Reject';
    }
    
    new bootstrap.Modal(modal).show();
}

document.getElementById('actionConfirmForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const form = document.getElementById('reviewForm');
    const requestId = document.getElementById('action_request_id').value;
    const action = document.getElementById('action_type_value').value;
    const notes = document.getElementById('action_notes').value;
    
    form.querySelector('#action_type').value = 'single_action';
    
    // Add hidden fields for single action
    let requestIdInput = form.querySelector('input[name="request_id"]');
    if (!requestIdInput) {
        requestIdInput = document.createElement('input');
        requestIdInput.type = 'hidden';
        requestIdInput.name = 'request_id';
        form.appendChild(requestIdInput);
    }
    requestIdInput.value = requestId;
    
    let actionInput = form.querySelector('input[name="action"]');
    if (!actionInput) {
        actionInput = document.createElement('input');
        actionInput.type = 'hidden';
        actionInput.name = 'action';
        form.appendChild(actionInput);
    }
    actionInput.value = action;
    
    let notesInput = form.querySelector('input[name="response_notes"]');
    if (!notesInput) {
        notesInput = document.createElement('input');
        notesInput.type = 'hidden';
        notesInput.name = 'response_notes';
        form.appendChild(notesInput);
    }
    notesInput.value = notes;
    
    bootstrap.Modal.getInstance(document.getElementById('actionConfirmModal')).hide();
    form.submit();
});

function bulkAction(actionType) {
    const checkboxes = document.querySelectorAll('input[name="selected_requests"]:checked');
    if (checkboxes.length === 0) {
        alert('Please select at least one request');
        return;
    }
    
    const modal = document.getElementById('bulkConfirmModal');
    const header = document.getElementById('bulkModalHeader');
    const title = document.getElementById('bulkModalTitle');
    const summary = document.getElementById('bulkSummary');
    const btn = document.getElementById('bulkConfirmBtn');
    const notesSection = document.getElementById('bulkNotesSection');
    
    if (actionType === 'bulk_approve') {
        header.style.backgroundColor = '#28a745';
        header.style.color = 'white';
        title.innerHTML = '<i class="fas fa-check-circle me-2"></i>Bulk Approve';
        summary.innerHTML = `<i class="fas fa-info-circle me-2"></i>You are about to approve <strong>${checkboxes.length}</strong> request(s).`;
        btn.className = 'btn btn-success';
        btn.innerHTML = '<i class="fas fa-check me-1"></i> Approve All';
        notesSection.style.display = 'none';
    } else {
        header.style.backgroundColor = '#dc3545';
        header.style.color = 'white';
        title.innerHTML = '<i class="fas fa-times-circle me-2"></i>Bulk Reject';
        summary.innerHTML = `<i class="fas fa-exclamation-triangle me-2"></i>You are about to reject <strong>${checkboxes.length}</strong> request(s).`;
        btn.className = 'btn btn-danger';
        btn.innerHTML = '<i class="fas fa-times me-1"></i> Reject All';
        notesSection.style.display = 'block';
        document.getElementById('bulk_notes').value = '';
    }
    
    // Build list of selected requests
    const tbody = document.getElementById('bulkRequestsList');
    tbody.innerHTML = '';
    checkboxes.forEach(cb => {
        const row = cb.closest('tr');
        const cells = row.querySelectorAll('td');
        tbody.innerHTML += `<tr>
            <td>${cells[2].textContent}</td>
            <td>${cells[4].textContent}</td>
            <td>${cells[5].textContent}</td>
            <td>${cells[1].textContent}</td>
        </tr>`;
    });
    
    btn.setAttribute('data-action', actionType);
    new bootstrap.Modal(modal).show();
}

function confirmBulkAction() {
    const actionType = document.getElementById('bulkConfirmBtn').getAttribute('data-action');
    const form = document.getElementById('reviewForm');
    
    if (actionType === 'bulk_reject') {
        const notes = document.getElementById('bulk_notes').value.trim();
        if (!notes) {
            alert('Please provide rejection notes');
            return;
        }
        let notesInput = form.querySelector('input[name="rejection_notes"]');
        if (!notesInput) {
            notesInput = document.createElement('input');
            notesInput.type = 'hidden';
            notesInput.name = 'rejection_notes';
            form.appendChild(notesInput);
        }
        notesInput.value = notes;
    }
    
    form.querySelector('#action_type').value = actionType;
    bootstrap.Modal.getInstance(document.getElementById('bulkConfirmModal')).hide();
    form.submit();
}

// Review table pagination and search
function searchReviewTable() {
    const input = document.getElementById('reviewSearchInput').value.toLowerCase();
    const rows = document.querySelectorAll('#reviewRequestsBody .review-row');
    
    rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(input) ? '' : 'none';
    });
    
    currentReviewPage = 1;
    updateReviewPagination();
}

function changeReviewPageSize() {
    reviewPageSize = parseInt(document.getElementById('reviewPageSize').value);
    currentReviewPage = 1;
    updateReviewPagination();
}

function changeReviewPage(page) {
    const rows = Array.from(document.querySelectorAll('#reviewRequestsBody .review-row')).filter(r => r.style.display !== 'none');
    const totalPages = Math.ceil(rows.length / reviewPageSize);
    
    if (page === 'prev') currentReviewPage = Math.max(1, currentReviewPage - 1);
    else if (page === 'next') currentReviewPage = Math.min(totalPages, currentReviewPage + 1);
    else currentReviewPage = page;
    
    updateReviewPagination();
}

function updateReviewPagination() {
    const rows = Array.from(document.querySelectorAll('#reviewRequestsBody .review-row'));
    const visibleRows = rows.filter(r => r.style.display !== 'none');
    const totalPages = Math.ceil(visibleRows.length / reviewPageSize);
    
    // Hide all rows first
    rows.forEach(r => r.classList.add('d-none'));
    
    // Show current page rows
    const start = (currentReviewPage - 1) * reviewPageSize;
    const end = start + reviewPageSize;
    visibleRows.slice(start, end).forEach(r => r.classList.remove('d-none'));
    
    // Update info
    document.getElementById('reviewInfoBottom').textContent = 
        `Showing ${start + 1} to ${Math.min(end, visibleRows.length)} of ${visibleRows.length} entries`;
    
    // Update pagination buttons
    const pagination = document.getElementById('reviewPagination');
    pagination.innerHTML = '';
    
    // Previous button
    const prevLi = document.createElement('li');
    prevLi.className = `page-item ${currentReviewPage === 1 ? 'disabled' : ''}`;
    prevLi.innerHTML = `<a class="page-link" href="#" onclick="changeReviewPage('prev'); return false;">Previous</a>`;
    pagination.appendChild(prevLi);
    
    // Page numbers
    for (let i = 1; i <= totalPages; i++) {
        if (i === 1 || i === totalPages || (i >= currentReviewPage - 1 && i <= currentReviewPage + 1)) {
            const li = document.createElement('li');
            li.className = `page-item ${i === currentReviewPage ? 'active' : ''}`;
            li.innerHTML = `<a class="page-link" href="#" onclick="changeReviewPage(${i}); return false;">${i}</a>`;
            pagination.appendChild(li);
        } else if (i === currentReviewPage - 2 || i === currentReviewPage + 2) {
            const li = document.createElement('li');
            li.className = 'page-item disabled';
            li.innerHTML = '<a class="page-link" href="#">...</a>';
            pagination.appendChild(li);
        }
    }
    
    // Next button
    const nextLi = document.createElement('li');
    nextLi.className = `page-item ${currentReviewPage === totalPages ? 'disabled' : ''}`;
    nextLi.innerHTML = `<a class="page-link" href="#" onclick="changeReviewPage('next'); return false;">Next</a>`;
    pagination.appendChild(nextLi);
}

// History table filtering and pagination
function filterHistoryTable() {
    const year = document.getElementById('historyYearFilter').value;
    const quarter = document.getElementById('historyQuarterFilter').value;
    const grade = document.getElementById('historyGradeFilter').value;
    const status = document.getElementById('historyStatusFilter').value;
    const search = document.getElementById('historySearchInput').value.toLowerCase();
    
    const rows = document.querySelectorAll('#historyTableBody .history-row');
    
    rows.forEach(row => {
        const matchYear = !year || row.getAttribute('data-year') === year;
        const matchQuarter = !quarter || row.getAttribute('data-quarter') === quarter;
        const matchGrade = !grade || row.getAttribute('data-grade') === grade;
        const matchStatus = !status || row.getAttribute('data-status') === status;
        const matchSearch = !search || row.textContent.toLowerCase().includes(search);
        
        row.style.display = (matchYear && matchQuarter && matchGrade && matchStatus && matchSearch) ? '' : 'none';
    });
    
    currentHistoryPage = 1;
    updateHistoryPagination();
}

function resetHistoryFilters() {
    document.getElementById('historyYearFilter').value = '';
    document.getElementById('historyQuarterFilter').value = '';
    document.getElementById('historyGradeFilter').value = '';
    document.getElementById('historyStatusFilter').value = '';
    document.getElementById('historySearchInput').value = '';
    filterHistoryTable();
}

function changeHistoryPageSize() {
    historyPageSize = parseInt(document.getElementById('historyPageSize').value);
    currentHistoryPage = 1;
    updateHistoryPagination();
}

function updateHistoryPagination() {
    const rows = Array.from(document.querySelectorAll('#historyTableBody .history-row'));
    const visibleRows = rows.filter(r => r.style.display !== 'none');
    const totalPages = Math.ceil(visibleRows.length / historyPageSize);
    
    // Hide all rows first
    rows.forEach(r => r.classList.add('d-none'));
    
    // Show current page rows
    const start = (currentHistoryPage - 1) * historyPageSize;
    const end = start + historyPageSize;
    visibleRows.slice(start, end).forEach(r => r.classList.remove('d-none'));
    
    // Update info
    document.getElementById('historyInfo').textContent = 
        `Showing ${start + 1} to ${Math.min(end, visibleRows.length)} of ${visibleRows.length} entries`;
    
    // Update pagination buttons
    const pagination = document.getElementById('historyPagination');
    pagination.innerHTML = '';
    
    // Previous button
    const prevLi = document.createElement('li');
    prevLi.className = `page-item ${currentHistoryPage === 1 ? 'disabled' : ''}`;
    prevLi.innerHTML = `<a class="page-link" href="#" onclick="currentHistoryPage = Math.max(1, currentHistoryPage - 1); updateHistoryPagination(); return false;">Previous</a>`;
    pagination.appendChild(prevLi);
    
    // Page numbers
    for (let i = 1; i <= totalPages; i++) {
        if (i === 1 || i === totalPages || (i >= currentHistoryPage - 1 && i <= currentHistoryPage + 1)) {
            const li = document.createElement('li');
            li.className = `page-item ${i === currentHistoryPage ? 'active' : ''}`;
            li.innerHTML = `<a class="page-link" href="#" onclick="currentHistoryPage = ${i}; updateHistoryPagination(); return false;">${i}</a>`;
            pagination.appendChild(li);
        } else if (i === currentHistoryPage - 2 || i === currentHistoryPage + 2) {
            const li = document.createElement('li');
            li.className = 'page-item disabled';
            li.innerHTML = '<a class="page-link" href="#">...</a>';
            pagination.appendChild(li);
        }
    }
    
    // Next button
    const nextLi = document.createElement('li');
    nextLi.className = `page-item ${currentHistoryPage === totalPages ? 'disabled' : ''}`;
    nextLi.innerHTML = `<a class="page-link" href="#" onclick="currentHistoryPage = Math.min(${totalPages}, currentHistoryPage + 1); updateHistoryPagination(); return false;">Next</a>`;
    pagination.appendChild(nextLi);
}
</script>
{% endblock %}
