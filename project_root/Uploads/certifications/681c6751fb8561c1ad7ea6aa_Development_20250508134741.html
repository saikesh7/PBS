<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PMO Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        .modal-confirm .modal-content {
            border-radius: 0.5rem;
        }
        .modal-confirm .modal-header {
            border-bottom: none;
            position: relative;
        }
        .modal-confirm .modal-footer {
            border-top: none;
        }
        .modal-confirm .icon-box {
            color: #fff;
            width: 80px;
            height: 80px;
            margin: 0 auto;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
        }
        .modal-success .icon-box {
            background: #28a745;
        }
        .modal-warning .icon-box {
            background: #ffc107;
        }
        .file-icon {
            background: #007bff;
            color: white;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            margin-right: 15px;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-md-2 bg-dark text-white min-vh-100 py-3">
                <h4 class="text-center">Reward System</h4>
                <p class="text-center text-secondary">PMO Dashboard</p>
                <div class="list-group mt-4">
                    <a href="#" class="list-group-item list-group-item-action bg-dark text-white border-0 active">Dashboard</a>
                    <a href="#" class="list-group-item list-group-item-action bg-dark text-white border-0">Employees</a>
                    <a href="#" class="list-group-item list-group-item-action bg-dark text-white border-0">Reports</a>
                    <a href="{{ url_for('auth.logout') }}" class="list-group-item list-group-item-action bg-dark text-white border-0">Logout</a>
                </div>
            </div>
            
            <!-- Main Content -->
            <div class="col-md-10 p-4">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div>
                        <h2>PMO Dashboard</h2>
                        <p class="text-muted">Manage employee rewards</p>
                    </div>
                    <div>
                        <span class="badge bg-primary">{{ current_quarter }}</span>
                        <span class="badge bg-secondary">{{ current_month }}</span>
                    </div>
                </div>
                
                <!-- Flash Messages -->
                {% with messages = get_flashed_messages(with_categories=true) %}
                    {% if messages %}
                        {% for category, message in messages %}
                            <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                                {{ message }}
                                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                            </div>
                        {% endfor %}
                    {% endif %}
                {% endwith %}
                
                <!-- Main Tabs -->
                <ul class="nav nav-tabs mb-4" id="mainTab" role="tablist">
                    <li class="nav-item">
                        <button class="nav-link active" id="assign-tab" data-bs-toggle="tab" data-bs-target="#assign">
                            Assign Rewards
                        </button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link" id="review-tab" data-bs-toggle="tab" data-bs-target="#review">
                            Review Requests 
                            {% if pending_requests|length > 0 %}
                            <span class="badge bg-danger">{{ pending_requests|length }}</span>
                            {% endif %}
                        </button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link" id="bulk-tab" data-bs-toggle="tab" data-bs-target="#bulk">
                            Bulk Upload
                        </button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link" id="history-tab" data-bs-toggle="tab" data-bs-target="#history">
                            History
                        </button>
                    </li>
                </ul>
                
                <!-- CSV Errors (if any) -->
                {% if bulk_upload_errors %}
                <div class="alert alert-danger mb-4">
                    <h5><i class="fas fa-exclamation-triangle me-2"></i>CSV Upload Errors</h5>
                    <ul class="mb-0">
                        {% for error in bulk_upload_errors %}
                            <li>{{ error }}</li>
                        {% endfor %}
                    </ul>
                </div>
                {% endif %}
                
                <!-- Tab Content -->
                <div class="tab-content">
                    <!-- Assign Rewards Tab -->
                    <div class="tab-pane fade show active" id="assign">
                        <div class="card">
                            <div class="card-header">Assign New Reward</div>
                            <div class="card-body">
                                <form id="assignRewardForm">
                                    <div class="row mb-3">
                                        <div class="col-md-4">
                                            <label for="departmentSelect" class="form-label">Department</label>
                                            <select class="form-select" id="departmentSelect">
                                                <option value="" selected disabled>Select department</option>
                                                <option value="all">All Departments</option>
                                                {% for department in departments.keys() %}
                                                    <option value="{{ department }}">{{ department }}</option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                        <div class="col-md-4">
                                            <label for="gradeSelect" class="form-label">Grade</label>
                                            <select class="form-select" id="gradeSelect" disabled>
                                                <option value="" selected disabled>Select department first</option>
                                            </select>
                                        </div>
                                        <div class="col-md-4">
                                            <label for="employeeSelect" class="form-label">Employee</label>
                                            <select class="form-select" id="employeeSelect" required>
                                                <option value="" selected disabled>Select employee</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <div class="row mb-3">
                                        <div class="col-md-6">
                                            <label for="categorySelect" class="form-label">Award Category</label>
                                            <select class="form-select" id="categorySelect" required>
                                                <option value="" selected disabled>Select category</option>
                                                {% for category in pmo_categories %}
                                                    <option value="{{ category._id }}">{{ category.name }} ({{ category.frequency }})</option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                        <div class="col-md-6">
                                            <label for="notesInput" class="form-label">Notes/Reason</label>
                                            <textarea class="form-control" id="notesInput" rows="1" placeholder="Reason for award"></textarea>
                                        </div>
                                    </div>
                                    
                                    <div id="categoryInfo" class="alert alert-info mb-3" style="display: none"></div>
                                    <div id="validationWarning" class="alert alert-warning mb-3" style="display: none"></div>
                                    
                                    <div class="form-check mb-3">
                                        <input class="form-check-input" type="checkbox" id="confirmAssign" value="true" required>
                                        <label class="form-check-label" for="confirmAssign">
                                            I confirm this award complies with all policies
                                        </label>
                                    </div>
                                    
                                    <button type="button" class="btn btn-primary" id="previewButton" disabled>Review & Assign</button>
                                </form>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Review Tab -->
                    <div class="tab-pane fade" id="review">
                        <div class="card">
                            <div class="card-header">Review Pending Requests</div>
                            <div class="card-body">
                                {% if pending_requests|length > 0 %}
                                <form action="{{ url_for('manager.pmo_dashboard') }}" method="POST" id="reviewRequestsForm">
                                    <input type="hidden" name="action_type" value="review_requests">
                                    
                                    <div class="mb-3">
                                        <label class="form-label">Notes for Selected Requests</label>
                                        <textarea class="form-control" name="review_notes" id="reviewNotes" rows="2"></textarea>
                                    </div>
                                    
                                    <div class="btn-group mb-3">
                                        <button type="button" class="btn btn-success" id="previewApproveButton">Approve Selected</button>
                                        <button type="button" class="btn btn-danger" id="previewRejectButton">Reject Selected</button>
                                        <input type="hidden" name="action" id="reviewAction" value="">
                                    </div>
                                    
                                    <div class="table-responsive">
                                        <table class="table table-striped table-hover">
                                            <thead class="table-dark">
                                                <tr>
                                                    <th>
                                                        <input class="form-check-input" type="checkbox" id="selectAll">
                                                    </th>
                                                    <th>Employee</th>
                                                    <th>Grade</th>
                                                    <th>Department</th>
                                                    <th>Category</th>
                                                    <th>Points</th>
                                                    <th>Requested</th>
                                                    <th>Notes</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for req in pending_requests %}
                                                <tr>
                                                    <td>
                                                        <input class="form-check-input request-check" type="checkbox" name="request_ids[]" value="{{ req.id }}">
                                                    </td>
                                                    <td>{{ req.employee_name }}</td>
                                                    <td>{{ req.employee_grade }}</td>
                                                    <td>{{ req.employee_department }}</td>
                                                    <td>{{ req.category }}</td>
                                                    <td>{{ req.points }}</td>
                                                    <td>{{ req.request_date.strftime('%Y-%m-%d') }}</td>
                                                    <td>{{ req.request_notes[:30] }}{% if req.request_notes|length > 30 %}...{% endif %}</td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                </form>
                                {% else %}
                                <div class="alert alert-info">No pending requests to review</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Bulk Upload Tab -->
                    <div class="tab-pane fade" id="bulk">
                        <div class="card">
                            <div class="card-header">Bulk Upload Rewards</div>
                            <div class="card-body">
                                <form id="bulkUploadForm">
                                    <div class="mb-3">
                                        <p>Upload a CSV with the following columns:</p>
                                        <ul>
                                            <li><strong>employee_id</strong> - Employee ID (required)</li>
                                            <li><strong>category_code</strong> - Award category code (required)</li>
                                            <li><strong>department</strong> - Department (optional)</li>
                                            <li><strong>notes</strong> - Award reason (optional)</li>
                                        </ul>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="csvFile" class="form-label">CSV File</label>
                                        <input class="form-control" type="file" id="csvFile" accept=".csv" required>
                                    </div>
                                    
                                    <div id="validationSummary" class="alert alert-info d-none mb-3"></div>
                                    
                                    <div class="d-flex justify-content-between">
                                        <button type="button" id="validateButton" class="btn btn-secondary">Validate CSV</button>
                                        <button type="button" id="previewBulkButton" class="btn btn-primary" disabled>Review & Upload</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                    
                    <!-- History Tab -->
                    <div class="tab-pane fade" id="history">
                        <div class="card">
                            <div class="card-header">Award History</div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-striped">
                                        <thead>
                                            <tr>
                                                <th>Date</th>
                                                <th>Employee</th>
                                                <th>Category</th>
                                                <th>Points</th>
                                                <th>Status</th>
                                                <th>Notes</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for request in all_requests %}
                                                <tr>
                                                    <td>{{ request.request_date.strftime('%Y-%m-%d') }}</td>
                                                    <td>{{ request.employee_name }}</td>
                                                    <td>{{ request.category }}</td>
                                                    <td>{{ request.points }}</td>
                                                    <td>
                                                        {% if request.status == 'Pending' %}
                                                            <span class="badge bg-warning text-dark">Pending</span>
                                                        {% elif request.status == 'Approved' %}
                                                            <span class="badge bg-success">Approved</span>
                                                        {% elif request.status == 'Rejected' %}
                                                            <span class="badge bg-danger">Rejected</span>
                                                        {% endif %}
                                                    </td>
                                                    <td>{{ request.notes[:30] }}{% if request.notes|length > 30 %}...{% endif %}</td>
                                                </tr>
                                            {% else %}
                                                <tr>
                                                    <td colspan="6" class="text-center">No awards found</td>
                                                </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    
    <!-- Single Award Preview Modal -->
    <div class="modal fade" id="awardPreviewModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content modal-confirm modal-success">
                <div class="modal-header">
                    <h5 class="modal-title">Confirm Award Assignment</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body text-center">
                    <div class="icon-box mb-4">
                        <i class="fas fa-trophy"></i>
                    </div>
                    <h4>Award Details</h4>
                    <div class="award-details text-start mt-3">
                        <p><strong>Employee:</strong> <span id="modal-employee"></span></p>
                        <p><strong>Category:</strong> <span id="modal-category"></span></p>
                        <p><strong>Points:</strong> <span id="modal-points"></span></p>
                        <p><strong>Notes:</strong> <span id="modal-notes"></span></p>
                    </div>
                    <div id="modal-validation" class="alert alert-warning mt-3 d-none"></div>
                </div>
                <div class="modal-footer justify-content-center">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-success" id="confirmAwardButton">Confirm Assignment</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Bulk Upload Preview Modal -->
    <div class="modal fade" id="bulkPreviewModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Confirm Bulk Upload</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="d-flex mb-4">
                        <div class="file-icon">
                            <i class="fas fa-file-upload"></i>
                        </div>
                        <div>
                            <h5 class="mb-1">Upload Summary</h5>
                            <p class="mb-1"><strong>File:</strong> <span id="modal-filename"></span></p>
                            <p class="mb-1"><strong>Total Rows:</strong> <span id="modal-total-rows"></span></p>
                            <p class="mb-1"><strong>Valid Rows:</strong> <span id="modal-valid-rows"></span></p>
                            <p class="mb-0"><strong>Invalid Rows:</strong> <span id="modal-invalid-rows"></span></p>
                        </div>
                    </div>

                    <div id="validation-results" class="alert alert-warning mb-4">
                        <strong>Validation Results:</strong> 
                        <span id="validation-message"></span>
                    </div>

                    <h5>Sample Records</h5>
                    <div class="table-responsive">
                        <table class="table table-bordered table-striped" id="csv-preview-table">
                            <thead>
                                <tr>
                                    <th>Employee</th>
                                    <th>Category</th>
                                    <th>Points</th>
                                    <th>Notes</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Preview records will be inserted here -->
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="confirmBulkButton">Confirm Upload</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Review Requests Preview Modal -->
    <div class="modal fade" id="reviewPreviewModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content modal-confirm">
                <div class="modal-header">
                    <h5 class="modal-title" id="reviewModalTitle">Confirm Action</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body text-center">
                    <div class="icon-box mb-4" id="reviewIconBox">
                        <i class="fas fa-check-circle" id="reviewIcon"></i>
                    </div>
                    <h4 id="reviewActionText">Review Requests</h4>
                    <p>You are about to <span id="reviewActionType">process</span> the following requests:</p>
                    <div class="text-start mt-3">
                        <p><strong>Number of requests:</strong> <span id="reviewCount">0</span></p>
                        <p><strong>Notes:</strong> <span id="reviewNotesText">None</span></p>
                    </div>
                </div>
                <div class="modal-footer justify-content-center">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-success" id="confirmReviewButton">Confirm</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.0/papaparse.min.js"></script>
    <script>
       // Data structures
let employeeData = {}, categoryData = {}, validationResults = null, bulkValidationResults = null, csvParsedData = null;
let awardPreviewModal, bulkPreviewModal, reviewPreviewModal;

// Category points map - Using individual assignments to avoid template syntax errors
let categoryPointsMap = {};
{% for category in pmo_categories %}
categoryPointsMap["{{ category.code }}"] = {{ category.points_per_unit }};
{% endfor %}

// Department -> Grades map - Using individual assignments to avoid template syntax errors
let departmentGradesMap = {};
{% for dept, grades in departments.items() %}
departmentGradesMap["{{ dept }}"] = {{ grades.keys() | list | tojson }};
{% endfor %}

document.addEventListener('DOMContentLoaded', function() {
    // Initialize modals
    awardPreviewModal = new bootstrap.Modal(document.getElementById('awardPreviewModal'));
    bulkPreviewModal = new bootstrap.Modal(document.getElementById('bulkPreviewModal'));
    reviewPreviewModal = new bootstrap.Modal(document.getElementById('reviewPreviewModal'));

    // Department selection handler
    document.getElementById('departmentSelect').addEventListener('change', function() {
        const department = this.value;
        const gradeSelect = document.getElementById('gradeSelect');
        
        gradeSelect.innerHTML = '<option value="" selected disabled>Choose a grade...</option>';
        gradeSelect.disabled = false;
        
        if (department === 'all') {
            const allGrades = new Set();
            Object.values(departmentGradesMap).forEach(grades => {
                grades.forEach(grade => allGrades.add(grade));
            });
            
            gradeSelect.innerHTML += '<option value="all">All Grades</option>';
            [...allGrades].sort().forEach(grade => {
                gradeSelect.innerHTML += `<option value="${grade}">${grade}</option>`;
            });
        } else {
            gradeSelect.innerHTML += '<option value="all">All Grades</option>';
            
            if (departmentGradesMap[department]) {
                departmentGradesMap[department].forEach(grade => {
                    gradeSelect.innerHTML += `<option value="${grade}">${grade}</option>`;
                });
            }
        }
    });
    
    // Grade selection -> load employees
    document.getElementById('gradeSelect').addEventListener('change', function() {
        const department = document.getElementById('departmentSelect').value;
        const grade = this.value;
        
        const formData = new FormData();
        formData.append('department', department);
        formData.append('grade', grade);
        
        fetch("{{ url_for('manager.get_employees_by_department_grade') }}", {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const employeeSelect = document.getElementById('employeeSelect');
                employeeSelect.innerHTML = '<option value="" selected disabled>Select employee</option>';
                
                data.employees.forEach(emp => {
                    employeeSelect.innerHTML += `<option value="${emp.id}">${emp.name} (${emp.employee_id})</option>`;
                    employeeData[emp.id] = {
                        name: emp.name,
                        employee_id: emp.employee_id
                    };
                });
            }
        });
    });
    
    // Category selection -> get details
    document.getElementById('categorySelect').addEventListener('change', function() {
        const employeeId = document.getElementById('employeeSelect').value;
        const categoryId = this.value;
        
        if (!employeeId || !categoryId) return;
        
        const formData = new FormData();
        formData.append('category_id', categoryId);
        formData.append('employee_id', employeeId);
        
        fetch("{{ url_for('manager.get_category_details') }}", {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            const infoDiv = document.getElementById('categoryInfo');
            categoryData = data;
            
            // Show category info
            let infoHtml = `<strong>${data.name}:</strong> ${data.points_per_unit} points per award`;
            
            if (data.employee_grade) {
                if (data.frequency === 'Quarterly') {
                    infoHtml += `<div>Grade ${data.employee_grade}: ${data.existing_count} of ${data.max_limit} awards used this quarter</div>`;
                } else if (data.threshold) {
                    infoHtml += `<div>Grade ${data.employee_grade}: Threshold ${(data.threshold * 100).toFixed(0)}%, Current ${(data.utilization * 100).toFixed(0)}%</div>`;
                }
            }
            
            infoDiv.innerHTML = infoHtml;
            infoDiv.style.display = 'block';
            
            // Show warning if applicable
            if (data.error) {
                document.getElementById('validationWarning').innerHTML = data.error;
                document.getElementById('validationWarning').style.display = 'block';
                document.getElementById('previewButton').disabled = true;
            } else {
                document.getElementById('validationWarning').style.display = 'none';
                document.getElementById('previewButton').disabled = false;
            }
        });
    });
    
    // Enable/disable preview button based on confirmation checkbox
    document.getElementById('confirmAssign').addEventListener('change', function() {
        const previewButton = document.getElementById('previewButton');
        const employeeId = document.getElementById('employeeSelect').value;
        const categoryId = document.getElementById('categorySelect').value;
        
        if (this.checked && employeeId && categoryId && !document.getElementById('validationWarning').offsetParent) {
            previewButton.disabled = false;
        } else {
            previewButton.disabled = true;
        }
    });
    
    // Preview award assignment
    document.getElementById('previewButton').addEventListener('click', function() {
        const employeeId = document.getElementById('employeeSelect').value;
        const categoryId = document.getElementById('categorySelect').value;
        const notes = document.getElementById('notesInput').value;
        
        if (!employeeId || !categoryId) return;
        
        // Set modal content
        const employeeSelect = document.getElementById('employeeSelect');
        const employeeName = employeeSelect.options[employeeSelect.selectedIndex].text;
        const categorySelect = document.getElementById('categorySelect');
        const categoryName = categorySelect.options[categorySelect.selectedIndex].text;
        
        document.getElementById('modal-employee').textContent = employeeName;
        document.getElementById('modal-category').textContent = categoryName;
        document.getElementById('modal-points').textContent = categoryData.points_per_unit + ' points';
        document.getElementById('modal-notes').textContent = notes || 'None provided';
        
        // Check for warnings
        if (categoryData.error) {
            document.getElementById('modal-validation').textContent = categoryData.error;
            document.getElementById('modal-validation').classList.remove('d-none');
            document.getElementById('confirmAwardButton').disabled = true;
        } else {
            document.getElementById('modal-validation').classList.add('d-none');
            document.getElementById('confirmAwardButton').disabled = false;
        }
        
        // Show modal
        awardPreviewModal.show();
    });
    
    // Confirm award assignment
    document.getElementById('confirmAwardButton').addEventListener('click', function() {
        // Create and submit form
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = "{{ url_for('manager.pmo_dashboard') }}";
        
        // Add form fields
        const fields = {
            'action_type': 'assign_reward',
            'employee_id': document.getElementById('employeeSelect').value,
            'category_id': document.getElementById('categorySelect').value,
            'notes': document.getElementById('notesInput').value,
            'confirmed': 'true'
        };
        
        for (const [name, value] of Object.entries(fields)) {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = name;
            input.value = value;
            form.appendChild(input);
        }
        
        // Submit form
        document.body.appendChild(form);
        form.submit();
    });
    
    // Select All checkbox for review requests
    const selectAllCheckbox = document.getElementById('selectAll');
    if (selectAllCheckbox) {
        selectAllCheckbox.addEventListener('change', function() {
            document.querySelectorAll('.request-check').forEach(checkbox => {
                checkbox.checked = this.checked;
            });
        });
    }
    
    // Preview approve requests
    const previewApproveButton = document.getElementById('previewApproveButton');
    if (previewApproveButton) {
        previewApproveButton.addEventListener('click', function() {
            const selectedRequests = document.querySelectorAll('.request-check:checked');
            if (selectedRequests.length === 0) {
                alert('Please select at least one request to approve');
                return;
            }
            
            // Configure modal for approval
            document.getElementById('reviewModalTitle').textContent = 'Confirm Approval';
            document.getElementById('reviewIconBox').style.background = '#28a745';
            document.getElementById('reviewIcon').className = 'fas fa-check-circle';
            document.getElementById('reviewActionText').textContent = 'Approve Requests';
            document.getElementById('reviewActionType').textContent = 'approve';
            document.getElementById('reviewCount').textContent = selectedRequests.length;
            document.getElementById('reviewNotesText').textContent = document.getElementById('reviewNotes').value || 'None provided';
            document.getElementById('confirmReviewButton').className = 'btn btn-success';
            document.getElementById('reviewAction').value = 'approve';
            
            // Show modal
            reviewPreviewModal.show();
        });
    }
    
    // Preview reject requests
    const previewRejectButton = document.getElementById('previewRejectButton');
    if (previewRejectButton) {
        previewRejectButton.addEventListener('click', function() {
            const selectedRequests = document.querySelectorAll('.request-check:checked');
            if (selectedRequests.length === 0) {
                alert('Please select at least one request to reject');
                return;
            }
            
            // Configure modal for rejection
            document.getElementById('reviewModalTitle').textContent = 'Confirm Rejection';
            document.getElementById('reviewIconBox').style.background = '#dc3545';
            document.getElementById('reviewIcon').className = 'fas fa-times-circle';
            document.getElementById('reviewActionText').textContent = 'Reject Requests';
            document.getElementById('reviewActionType').textContent = 'reject';
            document.getElementById('reviewCount').textContent = selectedRequests.length;
            document.getElementById('reviewNotesText').textContent = document.getElementById('reviewNotes').value || 'None provided';
            document.getElementById('confirmReviewButton').className = 'btn btn-danger';
            document.getElementById('reviewAction').value = 'reject';
            
            // Show modal
            reviewPreviewModal.show();
        });
    }
    
    // Confirm review action
    document.getElementById('confirmReviewButton').addEventListener('click', function() {
        document.getElementById('reviewRequestsForm').submit();
    });
    
    // Parse CSV file and extract data
    function parseCSVFile(file) {
        return new Promise((resolve, reject) => {
            Papa.parse(file, {
                header: true,
                skipEmptyLines: true,
                complete: function(results) {
                    resolve(results.data);
                },
                error: function(error) {
                    reject(error);
                }
            });
        });
    }
    
    // Validate CSV before upload
    const validateButton = document.getElementById('validateButton');
    if (validateButton) {
        validateButton.addEventListener('click', async function() {
            const fileInput = document.getElementById('csvFile');
            if (!fileInput.files.length) {
                alert('Please select a CSV file first');
                return;
            }
            
            // Parse CSV file
            try {
                csvParsedData = await parseCSVFile(fileInput.files[0]);
            } catch (error) {
                console.error("Error parsing CSV:", error);
                document.getElementById('validationSummary').innerHTML = `<strong>Error:</strong> Could not parse CSV file. Please check file format.`;
                document.getElementById('validationSummary').className = 'alert alert-danger';
                document.getElementById('validationSummary').classList.remove('d-none');
                return;
            }
            
            const formData = new FormData();
            formData.append('csv_file', fileInput.files[0]);
            
            fetch("{{ url_for('manager.validate_bulk_upload') }}", {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                const summaryDiv = document.getElementById('validationSummary');
                bulkValidationResults = data;
                
                let html = `<strong>CSV Validation:</strong> `;
                
                if (data.error) {
                    html += data.error;
                    summaryDiv.className = 'alert alert-danger';
                    document.getElementById('previewBulkButton').disabled = true;
                } else {
                    html += `${data.valid_rows} valid rows, ${data.invalid_rows} invalid rows`;
                    
                    if (data.errors && data.errors.length) {
                        html += `<ul class="mt-2 mb-0">`;
                        data.errors.slice(0, 5).forEach(error => {
                            html += `<li>${error}</li>`;
                        });
                        if (data.errors.length > 5) {
                            html += `<li>...and ${data.errors.length - 5} more errors</li>`;
                        }
                        html += `</ul>`;
                    }
                    
                    if (data.valid_rows === 0) {
                        summaryDiv.className = 'alert alert-danger';
                        document.getElementById('previewBulkButton').disabled = true;
                    } else if (data.invalid_rows > 0) {
                        summaryDiv.className = 'alert alert-warning';
                        document.getElementById('previewBulkButton').disabled = false;
                    } else {
                        summaryDiv.className = 'alert alert-success';
                        document.getElementById('previewBulkButton').disabled = false;
                    }
                }
                
                summaryDiv.innerHTML = html;
                summaryDiv.classList.remove('d-none');
            });
        });
    }
    
    // Preview bulk upload
    const previewBulkButton = document.getElementById('previewBulkButton');
    if (previewBulkButton) {
        previewBulkButton.addEventListener('click', function() {
            if (!bulkValidationResults || bulkValidationResults.valid_rows === 0 || !csvParsedData) {
                alert('Please validate the CSV file first and ensure it has valid rows');
                return;
            }
            
            // Set modal content for filename and counts
            document.getElementById('modal-filename').textContent = document.getElementById('csvFile').files[0].name;
            document.getElementById('modal-total-rows').textContent = bulkValidationResults.total_rows;
            document.getElementById('modal-valid-rows').textContent = bulkValidationResults.valid_rows;
            document.getElementById('modal-invalid-rows').textContent = bulkValidationResults.invalid_rows;
            
            // Set validation message and style
            const validationDiv = document.getElementById('validation-results');
            if (bulkValidationResults.invalid_rows > 0) {
                document.getElementById('validation-message').textContent = "The CSV has some invalid rows that will be skipped.";
                validationDiv.className = "alert alert-warning mb-4";
            } else {
                document.getElementById('validation-message').textContent = "All rows in the CSV are valid and will be processed.";
                validationDiv.className = "alert alert-success mb-4";
            }
            
            // Populate preview table
            const tableBody = document.getElementById('csv-preview-table').querySelector('tbody');
            tableBody.innerHTML = '';
            
            // Get up to 5 valid rows to display
            let validRows = csvParsedData.filter(row => row.employee_id && row.category_code).slice(0, 5);
            
            if (validRows.length > 0) {
                // Add rows to preview table
                validRows.forEach(row => {
                    const points = categoryPointsMap[row.category_code] || 'Unknown';
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${row.employee_id}</td>
                        <td>${row.category_code}</td>
                        <td>${points}</td>
                        <td>${row.notes || 'None'}</td>
                    `;
                    tableBody.appendChild(tr);
                });
            } else {
                // No valid rows to display
                const tr = document.createElement('tr');
                tr.innerHTML = `<td colspan="4" class="text-center">No valid records found for preview</td>`;
                tableBody.appendChild(tr);
            }
            
            // Show modal
            bulkPreviewModal.show();
        });
    }
    
    // Confirm bulk upload
    document.getElementById('confirmBulkButton').addEventListener('click', function() {
        // Create and submit form
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = "{{ url_for('manager.pmo_dashboard') }}";
        form.enctype = 'multipart/form-data';
        
        // Add hidden action type
        const actionInput = document.createElement('input');
        actionInput.type = 'hidden';
        actionInput.name = 'action_type';
        actionInput.value = 'bulk_upload';
        form.appendChild(actionInput);
        
        // Add file
        const fileInput = document.getElementById('csvFile').cloneNode(true);
        fileInput.name = 'csv_file';
        form.appendChild(fileInput);
        
        // Submit form
        document.body.appendChild(form);
        form.submit();
    });

    // Handle all forms to prevent multiple submissions
    const forms = document.querySelectorAll('form');
    forms.forEach(form => {
        form.addEventListener('submit', function(e) {
            // Check if form was already submitted
            if (this.dataset.submitted === 'true') {
                e.preventDefault();
                return;
            }
            
            // Mark the form as submitted
            this.dataset.submitted = 'true';
            
            // Disable all submit buttons in the form
            const submitButtons = this.querySelectorAll('button[type="submit"]');
            submitButtons.forEach(button => {
                button.disabled = true;
                
                if (!button.dataset.originalText) {
                    button.dataset.originalText = button.innerHTML;
                }
                button.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i> Processing...';
            });
        });
    });
    
    // Apply similar logic to programmatic form submissions
    ['confirmAwardButton', 'confirmBulkButton', 'confirmReviewButton'].forEach(id => {
        const button = document.getElementById(id);
        if (button) {
            button.addEventListener('click', function(e) {
                if (this.dataset.clicked === 'true') {
                    e.preventDefault();
                    return;
                }
                
                this.dataset.clicked = 'true';
                this.disabled = true;
                this.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i> Processing...';
            });
        }
    });
    
    // Reset form submission status when switching tabs
    const tabButtons = document.querySelectorAll('[data-bs-toggle="tab"]');
    tabButtons.forEach(button => {
        button.addEventListener('shown.bs.tab', function() {
            forms.forEach(form => {
                delete form.dataset.submitted;
                
                // Re-enable all submit buttons
                const submitButtons = form.querySelectorAll('button[type="submit"]');
                submitButtons.forEach(button => {
                    button.disabled = false;
                    if (button.dataset.originalText) {
                        button.innerHTML = button.dataset.originalText;
                    }
                });
            });
            
            // Reset programmatic buttons too
            ['confirmAwardButton', 'confirmBulkButton', 'confirmReviewButton'].forEach(id => {
                const button = document.getElementById(id);
                if (button) {
                    delete button.dataset.clicked;
                    button.disabled = false;
                    if (button.dataset.originalText) {
                        button.innerHTML = button.dataset.originalText;
                    }
                }
            });
        });
    });
});
    </script>
</body>
</html>